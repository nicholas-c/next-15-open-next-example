"use strict";function _export(e,t){for(var s in t)Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{checkCustomRoutes:function(){return checkCustomRoutes},default:function(){return loadCustomRoutes},normalizeRouteRegex:function(){return normalizeRouteRegex}});const _picocolors=require("./picocolors"),_escaperegexp=require("../shared/lib/escape-regexp"),_trytoparsepath=require("./try-to-parse-path"),_redirectstatus=require("./redirect-status"),_url=require("./url"),allowedHasTypes=new Set(["header","cookie","query","host"]),namedGroupsRegex=/\(\?<([a-zA-Z][a-zA-Z0-9]*)>/g;function normalizeRouteRegex(e){return e.replace(/\\\//g,"/")}function checkRedirect(e){const t=[];let s=!1;return e.statusCode&&!_redirectstatus.allowedStatusCodes.has(e.statusCode)&&(s=!0,t.push("`statusCode` is not undefined or valid statusCode")),"boolean"==typeof e.permanent||e.statusCode||t.push("`permanent` is not set to `true` or `false`"),{invalidParts:t,hadInvalidStatus:s}}function checkHeader(e){const t=[];if(Array.isArray(e.headers))if(0===e.headers.length)t.push("`headers` field cannot be empty");else for(const s of e.headers){if(!s||"object"!=typeof s){t.push("`headers` items must be object with { key: '', value: '' }");break}if("string"!=typeof s.key){t.push("`key` in header item must be string");break}if("string"!=typeof s.value){t.push("`value` in header item must be string");break}}else t.push("`headers` field must be an array");return t}function checkCustomRoutes(e,t){Array.isArray(e)||(console.error(`Error: ${t}s must return an array, received ${typeof e}.\nSee here for more info: https://nextjs.org/docs/messages/routes-must-be-array`),process.exit(1));let s=0,r=!1,o=!1,a=!1;const n=new Set(["source","locale","has","missing"]);"rewrite"===t&&(n.add("basePath"),n.add("destination")),"redirect"===t&&(n.add("basePath"),n.add("statusCode"),n.add("permanent"),n.add("destination")),"header"===t&&(n.add("basePath"),n.add("headers"));for(const i of e){if(!i||"object"!=typeof i){console.error(`The route ${JSON.stringify(i)} is not a valid object with \`source\`${"middleware"!==t?` and \`${"header"===t?"headers":"destination"}\``:""}`),s++;continue}if("rewrite"===t&&!1===i.basePath&&!i.destination.startsWith("http://")&&!i.destination.startsWith("https://")){console.error(`The route ${i.source} rewrites urls outside of the basePath. Please use a destination that starts with \`http://\` or \`https://\` https://nextjs.org/docs/messages/invalid-external-rewrite`),s++;continue}const e=Object.keys(i).filter((e=>!n.has(e))),l=[];"basePath"in i&&void 0!==i.basePath&&!1!==i.basePath&&l.push("`basePath` must be undefined or false"),void 0!==i.locale&&!1!==i.locale&&l.push("`locale` must be undefined or false");const c=(e,t)=>{let s=!1;if(void 0===e||Array.isArray(e)){if(e){const r=[];for(const t of e){let e=[];allowedHasTypes.has(t.type)||e.push(`invalid type "${t.type}"`),"string"!=typeof t.key&&"host"!==t.type&&e.push(`invalid key "${t.key}"`),void 0!==t.value&&"string"!=typeof t.value&&e.push(`invalid value "${t.value}"`),void 0===t.value&&"host"===t.type&&e.push('value is required for "host" type'),e.length>0&&r.push(`${e.join(", ")} for ${JSON.stringify(t)}`)}if(r.length>0){s=!0;const e="item"+(1===r.length?"":"s");console.error(`Invalid \`${t}\` ${e}:\n`+r.join("\n")),console.error(),l.push(`invalid \`${t}\` ${e} found`)}}}else l.push(`\`${t}\` must be undefined or valid has object`),s=!0;return s};if(c(i.has,"has")&&(o=!0),c(i.missing,"missing")&&(a=!0),i.source?"string"!=typeof i.source?l.push("`source` is not a string"):i.source.startsWith("/")||l.push("`source` does not start with /"):l.push("`source` is missing"),"header"===t)l.push(...checkHeader(i));else if("middleware"!==t){let e=i;e.destination?"string"!=typeof e.destination?l.push("`destination` is not a string"):"rewrite"!==t||e.destination.match(/^(\/|https:\/\/|http:\/\/)/)||l.push("`destination` does not start with `/`, `http://`, or `https://`"):l.push("`destination` is missing")}if("redirect"===t){const e=checkRedirect(i);r=r||e.hadInvalidStatus,l.push(...e.invalidParts)}let u;if("string"==typeof i.source&&i.source.startsWith("/")){const{tokens:e,error:t,regexStr:s}=(0,_trytoparsepath.tryToParsePath)(i.source);t&&l.push("`source` parse failed"),s&&s.length>4096&&l.push("`source` exceeds max built length of 4096"),u=e}const d=new Set;if(i.has)for(const e of i.has)if(!e.value&&e.key&&d.add(e.key),e.value){for(const t of e.value.matchAll(namedGroupsRegex))t[1]&&d.add(t[1]);"host"===e.type&&d.add("host")}if("string"==typeof i.destination&&i.destination.startsWith("/")&&Array.isArray(u)){const e=new Set;for(const t of u)if("object"==typeof t&&"number"==typeof t.name){const s=new RegExp(`:${t.name}(?!\\d)`);i.destination.match(s)&&e.add(`:${t.name}`)}if(e.size>0)l.push(`\`destination\` has unnamed params ${[...e].join(", ")}`);else{const{tokens:e,regexStr:t,error:s}=(0,_trytoparsepath.tryToParsePath)(i.destination,{handleUrl:!0});if(t&&t.length>4096&&l.push("`destination` exceeds max built length of 4096"),s)l.push("`destination` parse failed");else{const t=new Set(u.map((e=>"object"==typeof e&&e.name)).filter(Boolean)),s=new Set;for(const r of e)"object"!=typeof r||t.has(r.name)||d.has(r.name)||s.add(r.name);s.size&&l.push(`\`destination\` has segments not in \`source\` or \`has\` (${[...s].join(", ")})`)}}}const h=e.length>0,f=l.length>0;(h||f)&&(console.error(`${l.join(", ")}${e.length?(f?",":"")+` invalid field${1===e.length?"":"s"}: `+e.join(","):""} for route ${JSON.stringify(i)}`),console.error(),s++)}s>0&&(r&&console.error(`\nValid redirect statusCode values are ${[..._redirectstatus.allowedStatusCodes].join(", ")}`),o&&console.error(`\nValid \`has\` object shape is ${JSON.stringify({type:[...allowedHasTypes].join(", "),key:"the key to check for",value:"undefined or a value string to match against"},null,2)}`),a&&console.error(`\nValid \`missing\` object shape is ${JSON.stringify({type:[...allowedHasTypes].join(", "),key:"the key to check for",value:"undefined or a value string to match against"},null,2)}`),console.error(),console.error(`Error: Invalid ${t}${1===s?"":"s"} found`),process.exit(1))}function processRoutes(e,t,s){const r=e,o=[],a=[];if(t.i18n&&"redirect"===s){var n;for(const e of(null==(n=t.i18n)?void 0:n.domains)||[])a.push({locale:e.defaultLocale,base:`http${e.http?"":"s"}://${e.domain}`});a.push({locale:t.i18n.defaultLocale,base:""})}for(const e of r){var i;const s=t.basePath&&!1!==e.basePath?t.basePath:"",r=!(null==(i=e.destination)?void 0:i.startsWith("/")),n=s&&!r?s:"";var l;if(t.i18n&&!1!==e.locale)r||a.forEach((r=>{let a;e.destination&&(a=r.base?`${r.base}${n}${e.destination}`:`${n}${e.destination}`),o.push({...e,destination:a,source:`${s}/${r.locale}${"/"!==e.source||t.trailingSlash?e.source:""}`})})),e.source=`/:nextInternalLocale(${t.i18n.locales.map((e=>(0,_escaperegexp.escapeStringRegexp)(e))).join("|")})${"/"!==e.source||t.trailingSlash?e.source:""}`,e.destination&&(null==(l=e.destination)?void 0:l.startsWith("/"))&&(e.destination=`/:nextInternalLocale${"/"!==e.destination||t.trailingSlash?e.destination:""}`);e.source=`${s}${"/"===e.source&&s?"":e.source}`,e.destination&&(e.destination=`${n}${"/"===e.destination&&n?"":e.destination}`),o.push(e)}return o}async function loadRedirects(e){if("function"!=typeof e.redirects)return[];let t=await e.redirects();return checkCustomRoutes(t,"redirect"),Array.isArray(t)&&(e._originalRedirects=t.map((e=>({...e})))),t=processRoutes(t,e,"redirect"),checkCustomRoutes(t,"redirect"),t}async function loadRewrites(e){let t=[];if(e.assetPrefix&&!(0,_url.isFullStringUrl)(e.assetPrefix)){const s=e.assetPrefix.startsWith("/")?e.assetPrefix:`/${e.assetPrefix}`,r=e.basePath||"";s!==r&&t.push({source:`${s}/_next/:path+`,destination:`${r}/_next/:path+`})}if("function"!=typeof e.rewrites)return{beforeFiles:[...t],afterFiles:[],fallback:[]};const s=await e.rewrites();let r=[],o=[],a=[];return!Array.isArray(s)&&"object"==typeof s&&Object.keys(s).every((e=>"beforeFiles"===e||"afterFiles"===e||"fallback"===e))?(r=s.beforeFiles||[],o=s.afterFiles||[],a=s.fallback||[]):o=s,checkCustomRoutes(r,"rewrite"),checkCustomRoutes(o,"rewrite"),checkCustomRoutes(a,"rewrite"),e._originalRewrites={beforeFiles:r.map((e=>({...e}))),afterFiles:o.map((e=>({...e}))),fallback:a.map((e=>({...e})))},r=[...t,...processRoutes(r,e,"rewrite")],o=processRoutes(o,e,"rewrite"),a=processRoutes(a,e,"rewrite"),checkCustomRoutes(r,"rewrite"),checkCustomRoutes(o,"rewrite"),checkCustomRoutes(a,"rewrite"),{beforeFiles:r,afterFiles:o,fallback:a}}async function loadHeaders(e){if("function"!=typeof e.headers)return[];let t=await e.headers();return checkCustomRoutes(t,"header"),t=processRoutes(t,e,"header"),checkCustomRoutes(t,"header"),t}async function loadCustomRoutes(e){const[t,s,r]=await Promise.all([loadHeaders(e),loadRewrites(e),loadRedirects(e)]),o=s.beforeFiles.length+s.afterFiles.length+s.fallback.length;return t.length+r.length+o>1e3&&console.warn((0,_picocolors.bold)((0,_picocolors.yellow)("Warning: "))+"total number of custom routes exceeds 1000, this can reduce performance. Route counts:\n"+`headers: ${t.length}\n`+`rewrites: ${o}\n`+`redirects: ${r.length}\nSee more info: https://nextjs.org/docs/messages/max-custom-routes-reached`),e.skipTrailingSlashRedirect||(e.trailingSlash?(r.unshift({source:"/:file((?!\\.well-known(?:/.*)?)(?:[^/]+/)*[^/]+\\.\\w+)/",destination:"/:file",permanent:!0,locale:!e.i18n&&void 0,internal:!0,missing:[{type:"header",key:"x-nextjs-data"}]},{source:"/:notfile((?!\\.well-known(?:/.*)?)(?:[^/]+/)*[^/\\.]+)",destination:"/:notfile/",permanent:!0,locale:!e.i18n&&void 0,internal:!0}),e.basePath&&r.unshift({source:e.basePath,destination:e.basePath+"/",permanent:!0,basePath:!1,locale:!e.i18n&&void 0,internal:!0})):(r.unshift({source:"/:path+/",destination:"/:path+",permanent:!0,locale:!e.i18n&&void 0,internal:!0}),e.basePath&&r.unshift({source:e.basePath+"/",destination:e.basePath,permanent:!0,basePath:!1,locale:!e.i18n&&void 0,internal:!0}))),{headers:t,rewrites:s,redirects:r}}