"use strict";function _export(e,o){for(var t in o)Object.defineProperty(e,t,{enumerable:!0,get:o[t]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{getRequiredConfiguration:function(){return getRequiredConfiguration},writeConfigurationDefaults:function(){return writeConfigurationDefaults}});const _fs=require("fs"),_picocolors=require("../picocolors"),_commentjson=_interop_require_wildcard(require("next/dist/compiled/comment-json")),_semver=_interop_require_default(require("next/dist/compiled/semver")),_os=_interop_require_default(require("os")),_getTypeScriptConfiguration=require("./getTypeScriptConfiguration"),_log=_interop_require_wildcard(require("../../build/output/log"));function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var o=new WeakMap,t=new WeakMap;return(_getRequireWildcardCache=function(e){return e?t:o})(e)}function _interop_require_wildcard(e,o){if(!o&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(o);if(t&&t.has(e))return t.get(e);var i={__proto__:null},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var r=n?Object.getOwnPropertyDescriptor(e,s):null;r&&(r.get||r.set)?Object.defineProperty(i,s,r):i[s]=e[s]}return i.default=e,t&&t.set(e,i),i}function getDesiredCompilerOptions(e,o){return{target:{suggested:"ES2017",reason:"For top-level `await`. Note: Next.js only polyfills for the esmodules target."},lib:{suggested:["dom","dom.iterable","esnext"]},allowJs:{suggested:!0},skipLibCheck:{suggested:!0},strict:{suggested:!1},..._semver.default.lt(e.version,"5.0.0")?{forceConsistentCasingInFileNames:{suggested:!0}}:void 0,noEmit:{suggested:!0},..._semver.default.gte(e.version,"4.4.2")?{incremental:{suggested:!0}}:void 0,module:{parsedValue:e.ModuleKind.ESNext,parsedValues:[_semver.default.gte(e.version,"5.4.0")&&e.ModuleKind.Preserve,e.ModuleKind.ES2020,e.ModuleKind.ESNext,e.ModuleKind.CommonJS,e.ModuleKind.AMD,e.ModuleKind.NodeNext,e.ModuleKind.Node16],value:"esnext",reason:"for dynamic import() support"},..._semver.default.gte(e.version,"5.4.0")&&(null==o?void 0:o.module)===e.ModuleKind.Preserve?{}:{esModuleInterop:{value:!0,reason:"requirement for SWC / babel"},moduleResolution:{parsedValue:e.ModuleResolutionKind.Bundler??e.ModuleResolutionKind.NodeNext??e.ModuleResolutionKind.Node10??e.ModuleResolutionKind.NodeJs,parsedValues:[e.ModuleResolutionKind.Node10??e.ModuleResolutionKind.NodeJs,e.ModuleResolutionKind.Node12,e.ModuleResolutionKind.Node16,e.ModuleResolutionKind.NodeNext,e.ModuleResolutionKind.Bundler].filter((e=>void 0!==e)),value:"node",reason:"to match webpack resolution"},resolveJsonModule:{value:!0,reason:"to match webpack resolution"}},...!0===(null==o?void 0:o.verbatimModuleSyntax)?void 0:{isolatedModules:{value:!0,reason:"requirement for SWC / Babel"}},jsx:{parsedValue:e.JsxEmit.Preserve,value:"preserve",reason:"next.js implements its own optimized jsx transform"}}}function getRequiredConfiguration(e){const o={},t=getDesiredCompilerOptions(e);for(const e of Object.keys(t)){const i=t[e];"value"in i&&(o[e]=i.parsedValue??i.value)}return o}const localDevTestFilesExcludeAction="NEXT_PRIVATE_LOCAL_DEV_TEST_FILES_EXCLUDE";async function writeConfigurationDefaults(e,o,t,i,n,s){var r;t&&await _fs.promises.writeFile(o,"{}"+_os.default.EOL);const{options:l,raw:u}=await(0,_getTypeScriptConfiguration.getTypeScriptConfiguration)(e,o,!0),c=await _fs.promises.readFile(o,{encoding:"utf8"}),d=_commentjson.parse(c);null!=d.compilerOptions||"extends"in u||(d.compilerOptions={},t=!0);const a=getDesiredCompilerOptions(e,l),p=[],f=[];for(const e of Object.keys(a)){const o=a[e];if("suggested"in o)e in l||(d.compilerOptions||(d.compilerOptions={}),d.compilerOptions[e]=o.suggested,p.push((0,_picocolors.cyan)(e)+" was set to "+(0,_picocolors.bold)(o.suggested)+(o.reason?` (${o.reason})`:"")));else if("value"in o){var g;const t=l[e];("parsedValues"in o?null==(g=o.parsedValues)?void 0:g.includes(t):"parsedValue"in o?o.parsedValue===t:o.value===t)||(d.compilerOptions||(d.compilerOptions={}),d.compilerOptions[e]=o.value,f.push((0,_picocolors.cyan)(e)+" was set to "+(0,_picocolors.bold)(o.value)+` (${o.reason})`))}else{}}const _=`${n}/types/**/*.ts`;if("include"in u?i&&!u.include.includes(_)&&(Array.isArray(d.include)||(d.include=[]),u.include.length!==d.include.length||JSON.stringify(u.include.sort())!==JSON.stringify(d.include.sort())?(d.include.push(...u.include,_),p.push((0,_picocolors.cyan)("include")+" was set to "+(0,_picocolors.bold)(`[${[...u.include,_].map((e=>`'${e}'`)).join(", ")}]`))):(d.include.push(_),p.push((0,_picocolors.cyan)("include")+" was updated to add "+(0,_picocolors.bold)(`'${_}'`)))):(d.include=i?["next-env.d.ts",_,"**/*.ts","**/*.tsx"]:["next-env.d.ts","**/*.ts","**/*.tsx"],p.push((0,_picocolors.cyan)("include")+" was set to "+(0,_picocolors.bold)(i?`['next-env.d.ts', '${_}', '**/*.ts', '**/*.tsx']`:"['next-env.d.ts', '**/*.ts', '**/*.tsx']"))),i){const e=[...Array.isArray(l.plugins)?l.plugins:[],...d.compilerOptions&&Array.isArray(d.compilerOptions.plugins)?d.compilerOptions.plugins:[]],o=e.some((({name:e})=>"next"===e));d.compilerOptions&&(!e.length||o||!("extends"in u)||u.compilerOptions&&u.compilerOptions.plugins)?o||("plugins"in d.compilerOptions||(d.compilerOptions.plugins=[]),d.compilerOptions.plugins.push({name:"next"}),p.push((0,_picocolors.cyan)("plugins")+" was updated to add "+(0,_picocolors.bold)("{ name: 'next' }"))):_log.info(`\nYour ${(0,_picocolors.bold)("tsconfig.json")} extends another configuration, which means we cannot add the Next.js TypeScript plugin automatically. To improve your development experience, we recommend adding the Next.js plugin (\`${(0,_picocolors.cyan)('"plugins": [{ "name": "next" }]')}\`) manually to your TypeScript configuration. Learn more: https://nextjs.org/docs/app/api-reference/config/typescript#the-typescript-plugin\n`),s&&i&&!l.strict&&!("strictNullChecks"in l)&&(d.compilerOptions.strictNullChecks=!0,p.push((0,_picocolors.cyan)("strictNullChecks")+" was set to "+(0,_picocolors.bold)("true")))}if("exclude"in u||(d.exclude=["node_modules"],p.push((0,_picocolors.cyan)("exclude")+" was set to "+(0,_picocolors.bold)("['node_modules']"))),process.env.NEXT_PRIVATE_LOCAL_DEV&&d.exclude){const e="**/*.test.ts",o="**/*.test.tsx";let t=!1;d.exclude.includes(e)||(d.exclude.push(e),t=!0),d.exclude.includes(o)||(d.exclude.push(o),t=!0),t&&f.push(localDevTestFilesExcludeAction)}if(p.length<1&&f.length<1)return;if(await _fs.promises.writeFile(o,_commentjson.stringify(d,null,2)+_os.default.EOL),_log.info(""),t)return void _log.info(`We detected TypeScript in your project and created a ${(0,_picocolors.cyan)("tsconfig.json")} file for you.`);_log.info(`We detected TypeScript in your project and reconfigured your ${(0,_picocolors.cyan)("tsconfig.json")} file for you.${(null==(r=d.compilerOptions)?void 0:r.strict)?"":` Strict-mode is set to ${(0,_picocolors.cyan)("false")} by default.`}`),p.length&&(_log.info(`The following suggested values were added to your ${(0,_picocolors.cyan)("tsconfig.json")}. These values ${(0,_picocolors.cyan)("can be changed")} to fit your project's needs:\n`),p.forEach((e=>_log.info(`\t- ${e}`))),_log.info(""));const m=process.env.NEXT_PRIVATE_LOCAL_DEV?f.filter((e=>e!==localDevTestFilesExcludeAction)):f;m.length&&(_log.info(`The following ${(0,_picocolors.white)("mandatory changes")} were made to your ${(0,_picocolors.cyan)("tsconfig.json")}:\n`),m.forEach((e=>_log.info(`\t- ${e}`))),_log.info(""))}