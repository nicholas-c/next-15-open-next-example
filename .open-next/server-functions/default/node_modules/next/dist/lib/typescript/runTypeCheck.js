"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"runTypeCheck",{enumerable:!0,get:function(){return runTypeCheck}});const _path=_interop_require_default(require("path")),_diagnosticFormatter=require("./diagnosticFormatter"),_getTypeScriptConfiguration=require("./getTypeScriptConfiguration"),_writeConfigurationDefaults=require("./writeConfigurationDefaults"),_compileerror=require("../compile-error"),_log=require("../../build/output/log");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}async function runTypeCheck(e,t,r,i,o,n){const a=await(0,_getTypeScriptConfiguration.getTypeScriptConfiguration)(e,i);if(a.fileNames.length<1)return{hasWarnings:!1,inputFilesCount:0,totalFilesCount:0,incremental:!1};const s={...(0,_writeConfigurationDefaults.getRequiredConfiguration)(e),...a.options,declarationMap:!1,emitDeclarationOnly:!1,noEmit:!0};let c,l=!1;(s.incremental||s.composite)&&o?(s.composite&&(0,_log.warn)("TypeScript project references are not fully supported. Attempting to build in incremental mode."),l=!0,c=e.createIncrementalProgram({rootNames:a.fileNames,options:{...s,composite:!1,incremental:!0,tsBuildInfoFile:_path.default.join(o,".tsbuildinfo")}})):c=e.createProgram(a.fileNames,s);const g=c.emit(),u=new RegExp([/[\\/]__(?:tests|mocks)__[\\/]/,/(?<=[\\/.])(?:spec|test)\.[^\\/]+$/].map((e=>e.source)).join("|")),m=e.getPreEmitDiagnostics(c).concat(g.diagnostics).filter((e=>!(e.file&&u.test(e.file.fileName)))),p=m.find((e=>e.category===_diagnosticFormatter.DiagnosticCategory.Error&&Boolean(e.file)))??m.find((e=>e.category===_diagnosticFormatter.DiagnosticCategory.Error));if(process.env.__NEXT_TEST_MODE&&p){const i=m.filter((e=>e.category===_diagnosticFormatter.DiagnosticCategory.Error)).map((i=>"[Test Mode] "+(0,_diagnosticFormatter.getFormattedDiagnostic)(e,t,r,i,n)));console.error("\n\n===== TS errors =====\n\n"+i.join("\n\n")+"\n\n===== TS errors =====\n\n"),await new Promise((e=>setTimeout(e,100)))}if(p)throw Object.defineProperty(new _compileerror.CompileError((0,_diagnosticFormatter.getFormattedDiagnostic)(e,t,r,p,n)),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});return{hasWarnings:!0,warnings:m.filter((e=>e.category===_diagnosticFormatter.DiagnosticCategory.Warning)).map((i=>(0,_diagnosticFormatter.getFormattedDiagnostic)(e,t,r,i,n))),inputFilesCount:a.fileNames.length,totalFilesCount:c.getSourceFiles().length,incremental:l}}