"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"validateTurboNextConfig",{enumerable:!0,get:function(){return validateTurboNextConfig}});const _path=_interop_require_default(require("path")),_config=_interop_require_default(require("../server/config")),_log=_interop_require_wildcard(require("../build/output/log")),_constants=require("../shared/lib/constants");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(_getRequireWildcardCache=function(e){return e?r:t})(e)}function _interop_require_wildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=_getRequireWildcardCache(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var i in e)if("default"!==i&&Object.prototype.hasOwnProperty.call(e,i)){var a=o?Object.getOwnPropertyDescriptor(e,i):null;a&&(a.get||a.set)?Object.defineProperty(n,i,a):n[i]=e[i]}return n.default=e,r&&r.set(e,n),n}const unsupportedTurbopackNextConfigOptions=["experimental.fetchCacheKeyPrefix","experimental.clientRouterFilterAllowedRate","experimental.allowedRevalidateHeaderKeys","experimental.extensionAlias","experimental.fallbackNodePolyfills","experimental.sri.algorithm","experimental.swcTraceProfiling","experimental.typedRoutes","experimental.craCompat","experimental.disablePostcssPresetEnv","experimental.esmExternals","experimental.forceSwcTransforms","experimental.fullySpecified","experimental.urlImports","experimental.slowModuleDetection"],unsupportedProductionSpecificTurbopackNextConfigOptions=[];async function validateTurboNextConfig({dir:e,isDev:t}){const{getPkgManager:r}=require("../lib/helpers/get-pkg-manager"),{getBabelConfigFile:n}=require("../build/get-babel-config-file"),{defaultConfig:o}=require("../server/config-shared"),{bold:i,cyan:a,red:u,underline:l}=require("../lib/picocolors"),{interopDefault:p}=require("../lib/interop-default");let c="",s=await n(e);s&&(s=_path.default.basename(s));let f=!1,d=!1,g=[],b={};const x=t?_constants.PHASE_DEVELOPMENT_SERVER:_constants.PHASE_PRODUCTION_BUILD;try{b=p(await(0,_config.default)(x,e,{rawConfig:!0})),"function"==typeof b&&(b=b(x,{defaultConfig:o}));const r=(e,t="")=>{let n=[];for(const o in e){if(void 0===(null==e?void 0:e[o]))continue;const i=t.length?`${t}.`:"";"object"!=typeof e[o]||Array.isArray(e[o])||null===e[o]?n.push(i+o):n=n.concat(r(e[o],i+o))}return n},n=(e,t)=>("string"==typeof t&&(t=t.split(".")),1===t.length?null==e?void 0:e[null==t?void 0:t[0]]:n(null==e?void 0:e[null==t?void 0:t[0]],t.slice(1))),i=r(b);let a=t?unsupportedTurbopackNextConfigOptions:[...unsupportedTurbopackNextConfigOptions,...unsupportedProductionSpecificTurbopackNextConfigOptions];for(const e of i){e.startsWith("webpack")&&b.webpack&&(f=!0),e.startsWith("experimental.turbo")&&(d=!0),a.some((t=>e.startsWith(t)||t.startsWith(`${e}.`)))&&n(b,e)!==n(o,e)&&g.push(e)}}catch(e){_log.error("Unexpected error occurred while checking config",e)}const _=`Learn more about Next.js and Turbopack: ${l("https://nextjs.org/docs/architecture/turbopack")}\n`;if(f&&!d&&(_log.warn("Webpack is configured while Turbopack is not, which may cause problems."),_log.warn("See instructions if you need to configure Turbopack:\n  https://nextjs.org/docs/app/api-reference/next-config-js/turbo\n")),s&&(c+=`Babel detected (${a(s)})\n  Babel is not yet supported. To use Turbopack at the moment,\n  you'll need to remove your usage of Babel.`),1===g.length&&"experimental.optimizePackageImports"===g[0]?_log.warn("'experimental.optimizePackageImports' is not yet supported by Turbopack and will be ignored."):g.length&&(c+=`\n\n- Unsupported Next.js configuration option(s) (${a("next.config.js")})\n  To use Turbopack, remove the following configuration options:\n${g.map((e=>`    - ${u(e)}\n`)).join("")}`),c){const t=r(e);_log.error(`You are using configuration and/or tools that are not yet\nsupported by Next.js with Turbopack:\n${c}\n\nIf you cannot make the changes above, but still want to try out\nNext.js with Turbopack, create the Next.js playground app\nby running the following commands:\n\n  ${i(a(("npm"===t?"npx create-next-app":`${t} create next-app`)+" --example with-turbopack with-turbopack-app"))}\n  cd with-turbopack-app\n  ${t} run dev\n        `),_log.warn(_),process.exit(1)}return b}