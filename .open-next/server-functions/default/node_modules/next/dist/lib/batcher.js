"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"Batcher",{enumerable:!0,get:function(){return Batcher}});const _detachedpromise=require("./detached-promise");class Batcher{constructor(e,t=(e=>e())){this.cacheKeyFn=e,this.schedulerFn=t,this.pending=new Map}static create(e){return new Batcher(null==e?void 0:e.cacheKeyFn,null==e?void 0:e.schedulerFn)}async batch(e,t){const n=this.cacheKeyFn?await this.cacheKeyFn(e):e;if(null===n)return t(n,Promise.resolve);const r=this.pending.get(n);if(r)return r;const{promise:c,resolve:s,reject:i}=new _detachedpromise.DetachedPromise;return this.pending.set(n,c),this.schedulerFn((async()=>{try{const e=await t(n,s);s(e)}catch(e){i(e)}finally{this.pending.delete(n)}})),c}}