"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"serverActionReducer",{enumerable:!0,get:function(){return serverActionReducer}});const _appcallserver=require("../../../app-call-server"),_appfindsourcemapurl=require("../../../app-find-source-map-url"),_approuterheaders=require("../../app-router-headers"),_routerreducertypes=require("../router-reducer-types"),_assignlocation=require("../../../assign-location"),_createhreffromurl=require("../create-href-from-url"),_navigatereducer=require("./navigate-reducer"),_applyrouterstatepatchtotree=require("../apply-router-state-patch-to-tree"),_isnavigatingtonewrootlayout=require("../is-navigating-to-new-root-layout"),_handlemutable=require("../handle-mutable"),_filllazyitemstillleafwithhead=require("../fill-lazy-items-till-leaf-with-head"),_approuter=require("../../app-router"),_hasinterceptionrouteincurrenttree=require("./has-interception-route-in-current-tree"),_handlesegmentmismatch=require("../handle-segment-mismatch"),_refetchinactiveparallelsegments=require("../refetch-inactive-parallel-segments"),_flightdatahelpers=require("../../../flight-data-helpers"),_redirect=require("../../redirect"),_redirecterror=require("../../redirect-error"),_prefetchcacheutils=require("../prefetch-cache-utils"),_removebasepath=require("../../../remove-base-path"),_hasbasepath=require("../../../has-base-path"),_serverreferenceinfo=require("../../../../shared/lib/server-reference-info"),_cache=require("../../segment-cache/cache"),{createFromFetch:createFromFetch,createTemporaryReferenceSet:createTemporaryReferenceSet,encodeReply:encodeReply}=process.env.NEXT_RUNTIME?require("react-server-dom-webpack/client.edge"):require("react-server-dom-webpack/client");async function fetchServerAction(e,r,t){let{actionId:a,actionArgs:c}=t;const i=createTemporaryReferenceSet(),n=(0,_serverreferenceinfo.extractInfoFromServerReferenceId)(a),o="use-cache"===n.type?(0,_serverreferenceinfo.omitUnusedArgs)(c,n):c,s=await encodeReply(o,{temporaryReferences:i}),l=await fetch("",{method:"POST",headers:{Accept:_approuterheaders.RSC_CONTENT_TYPE_HEADER,[_approuterheaders.ACTION_HEADER]:a,[_approuterheaders.NEXT_ROUTER_STATE_TREE_HEADER]:encodeURIComponent(JSON.stringify(e.tree)),...process.env.NEXT_DEPLOYMENT_ID?{"x-deployment-id":process.env.NEXT_DEPLOYMENT_ID}:{},...r?{[_approuterheaders.NEXT_URL]:r}:{}},body:s}),p=l.headers.get("x-action-redirect"),[d,u]=(null==p?void 0:p.split(";"))||[];let h;switch(u){case"push":h=_redirecterror.RedirectType.push;break;case"replace":h=_redirecterror.RedirectType.replace;break;default:h=void 0}const f=!!l.headers.get(_approuterheaders.NEXT_IS_PRERENDER_HEADER);let _;try{const e=JSON.parse(l.headers.get("x-action-revalidated")||"[[],0,0]");_={paths:e[0]||[],tag:!!e[1],cookie:e[2]}}catch(e){_={paths:[],tag:!1,cookie:!1}}const g=d?(0,_assignlocation.assignLocation)(d,new URL(e.canonicalUrl,window.location.href)):void 0,v=l.headers.get("content-type");if(null==v?void 0:v.startsWith(_approuterheaders.RSC_CONTENT_TYPE_HEADER)){const e=await createFromFetch(Promise.resolve(l),{callServer:_appcallserver.callServer,findSourceMapURL:_appfindsourcemapurl.findSourceMapURL,temporaryReferences:i});return d?{actionFlightData:(0,_flightdatahelpers.normalizeFlightData)(e.f),redirectLocation:g,redirectType:h,revalidatedParts:_,isPrerender:f}:{actionResult:e.a,actionFlightData:(0,_flightdatahelpers.normalizeFlightData)(e.f),redirectLocation:g,redirectType:h,revalidatedParts:_,isPrerender:f}}if(l.status>=400){const e="text/plain"===v?await l.text():"An unexpected response was received from the server.";throw Object.defineProperty(new Error(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0})}return{redirectLocation:g,redirectType:h,revalidatedParts:_,isPrerender:f}}function serverActionReducer(e,r){const{resolve:t,reject:a}=r,c={};let i=e.tree;c.preserveCustomHistoryState=!1;const n=e.nextUrl&&(0,_hasinterceptionrouteincurrenttree.hasInterceptionRouteInCurrentTree)(e.tree)?e.nextUrl:null;return fetchServerAction(e,n,r).then((async o=>{let s,{actionResult:l,actionFlightData:p,redirectLocation:d,redirectType:u,isPrerender:h,revalidatedParts:f}=o;if(d&&(u===_redirecterror.RedirectType.replace?(e.pushRef.pendingPush=!1,c.pendingPush=!1):(e.pushRef.pendingPush=!0,c.pendingPush=!0),s=(0,_createhreffromurl.createHrefFromUrl)(d,!1),c.canonicalUrl=s),!p)return t(l),d?(0,_navigatereducer.handleExternalUrl)(e,c,d.href,e.pushRef.pendingPush):e;if("string"==typeof p)return t(l),(0,_navigatereducer.handleExternalUrl)(e,c,p,e.pushRef.pendingPush);const _=f.paths.length>0||f.tag||f.cookie;for(const a of p){const{tree:o,seedData:p,head:d,isRootRender:u}=a;if(!u)return console.log("SERVER ACTION APPLY FAILED"),t(l),e;const h=(0,_applyrouterstatepatchtotree.applyRouterStatePatchToTree)([""],i,o,s||e.canonicalUrl);if(null===h)return t(l),(0,_handlesegmentmismatch.handleSegmentMismatch)(e,r,o);if((0,_isnavigatingtonewrootlayout.isNavigatingToNewRootLayout)(i,h))return t(l),(0,_navigatereducer.handleExternalUrl)(e,c,s||e.canonicalUrl,e.pushRef.pendingPush);if(null!==p){const r=p[1],t=(0,_approuter.createEmptyCacheNode)();t.rsc=r,t.prefetchRsc=null,t.loading=p[3],(0,_filllazyitemstillleafwithhead.fillLazyItemsTillLeafWithHead)(t,void 0,o,p,d,void 0),c.cache=t,process.env.__NEXT_CLIENT_SEGMENT_CACHE?(0,_cache.revalidateEntireCache)(e.nextUrl,h):c.prefetchCache=new Map,_&&await(0,_refetchinactiveparallelsegments.refreshInactiveParallelSegments)({state:e,updatedTree:h,updatedCache:t,includeNextUrl:Boolean(n),canonicalUrl:c.canonicalUrl||e.canonicalUrl})}c.patchedTree=h,i=h}return d&&s?(_||((0,_prefetchcacheutils.createSeededPrefetchCacheEntry)({url:d,data:{flightData:p,canonicalUrl:void 0,couldBeIntercepted:!1,prerendered:!1,postponed:!1,staleTime:-1},tree:e.tree,prefetchCache:e.prefetchCache,nextUrl:e.nextUrl,kind:h?_routerreducertypes.PrefetchKind.FULL:_routerreducertypes.PrefetchKind.AUTO}),c.prefetchCache=e.prefetchCache),a((0,_redirect.getRedirectError)((0,_hasbasepath.hasBasePath)(s)?(0,_removebasepath.removeBasePath)(s):s,u||_redirecterror.RedirectType.push))):t(l),(0,_handlemutable.handleMutable)(e,c)}),(r=>(a(r),e)))}("function"==typeof exports.default||"object"==typeof exports.default&&null!==exports.default)&&void 0===exports.default.__esModule&&(Object.defineProperty(exports.default,"__esModule",{value:!0}),Object.assign(exports.default,exports),module.exports=exports.default);