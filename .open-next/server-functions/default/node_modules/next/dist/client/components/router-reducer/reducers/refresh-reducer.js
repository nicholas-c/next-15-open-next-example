"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"refreshReducer",{enumerable:!0,get:function(){return refreshReducer}});const _fetchserverresponse=require("../fetch-server-response"),_createhreffromurl=require("../create-href-from-url"),_applyrouterstatepatchtotree=require("../apply-router-state-patch-to-tree"),_isnavigatingtonewrootlayout=require("../is-navigating-to-new-root-layout"),_navigatereducer=require("./navigate-reducer"),_handlemutable=require("../handle-mutable"),_filllazyitemstillleafwithhead=require("../fill-lazy-items-till-leaf-with-head"),_approuter=require("../../app-router"),_handlesegmentmismatch=require("../handle-segment-mismatch"),_hasinterceptionrouteincurrenttree=require("./has-interception-route-in-current-tree"),_refetchinactiveparallelsegments=require("../refetch-inactive-parallel-segments"),_cache=require("../../segment-cache/cache");function refreshReducer(e,t){const{origin:r}=t,a={},n=e.canonicalUrl;let l=e.tree;a.preserveCustomHistoryState=!1;const i=(0,_approuter.createEmptyCacheNode)(),o=(0,_hasinterceptionrouteincurrenttree.hasInterceptionRouteInCurrentTree)(e.tree);return i.lazyData=(0,_fetchserverresponse.fetchServerResponse)(new URL(n,r),{flightRouterState:[l[0],l[1],l[2],"refetch"],nextUrl:o?e.nextUrl:null}),i.lazyData.then((async r=>{let{flightData:c,canonicalUrl:s}=r;if("string"==typeof c)return(0,_navigatereducer.handleExternalUrl)(e,a,c,e.pushRef.pendingPush);i.lazyData=null;for(const r of c){const{tree:c,seedData:u,head:h,isRootRender:p}=r;if(!p)return console.log("REFRESH FAILED"),e;const f=(0,_applyrouterstatepatchtotree.applyRouterStatePatchToTree)([""],l,c,e.canonicalUrl);if(null===f)return(0,_handlesegmentmismatch.handleSegmentMismatch)(e,t,c);if((0,_isnavigatingtonewrootlayout.isNavigatingToNewRootLayout)(l,f))return(0,_navigatereducer.handleExternalUrl)(e,a,n,e.pushRef.pendingPush);const d=s?(0,_createhreffromurl.createHrefFromUrl)(s):void 0;if(s&&(a.canonicalUrl=d),null!==u){const t=u[1],r=u[3];i.rsc=t,i.prefetchRsc=null,i.loading=r,(0,_filllazyitemstillleafwithhead.fillLazyItemsTillLeafWithHead)(i,void 0,c,u,h,void 0),process.env.__NEXT_CLIENT_SEGMENT_CACHE?(0,_cache.revalidateEntireCache)(e.nextUrl,f):a.prefetchCache=new Map}await(0,_refetchinactiveparallelsegments.refreshInactiveParallelSegments)({state:e,updatedTree:f,updatedCache:i,includeNextUrl:o,canonicalUrl:a.canonicalUrl||e.canonicalUrl}),a.cache=i,a.patchedTree=f,l=f}return(0,_handlemutable.handleMutable)(e,a)}),(()=>e))}("function"==typeof exports.default||"object"==typeof exports.default&&null!==exports.default)&&void 0===exports.default.__esModule&&(Object.defineProperty(exports.default,"__esModule",{value:!0}),Object.assign(exports.default,exports),module.exports=exports.default);