"use strict";function _export(e,r){for(var t in r)Object.defineProperty(e,t,{enumerable:!0,get:r[t]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{default:function(){return HotReload},waitForWebpackRuntimeHotUpdate:function(){return waitForWebpackRuntimeHotUpdate}});const _interop_require_default=require("@swc/helpers/_/_interop_require_default"),_jsxruntime=require("react/jsx-runtime"),_react=require("react"),_stripansi=_interop_require_default._(require("next/dist/compiled/strip-ansi")),_formatwebpackmessages=_interop_require_default._(require("../utils/format-webpack-messages")),_navigation=require("../../navigation"),_shared=require("../shared"),_parsestack=require("../utils/parse-stack"),_appdevoverlay=require("./app-dev-overlay"),_useerrorhandler=require("../../errors/use-error-handler"),_runtimeerrorhandler=require("../../errors/runtime-error-handler"),_usewebsocket=require("../utils/use-websocket"),_parsecomponentstack=require("../utils/parse-component-stack"),_hotreloadertypes=require("../../../../server/dev/hot-reloader-types"),_extractmodulesfromturbopackmessage=require("../../../../server/dev/extract-modules-from-turbopack-message"),_navigationuntracked=require("../../navigation-untracked"),_stitchederror=require("../../errors/stitched-error"),_iserrorthrownwhilerenderingrsc=require("../../../lib/is-error-thrown-while-rendering-rsc"),_handledevbuildindicatorhmrevents=require("../../../dev/dev-build-indicator/internal/handle-dev-build-indicator-hmr-events");let mostRecentCompilationHash=null,__nextDevClientId=Math.round(100*Math.random()+Date.now()),reloading=!1,startLatency=null,turbopackLastUpdateLatency=null,turbopackUpdatedModules=new Set,pendingHotUpdateWebpack=Promise.resolve(),resolvePendingHotUpdateWebpack=()=>{};function setPendingHotUpdateWebpack(){pendingHotUpdateWebpack=new Promise((e=>{resolvePendingHotUpdateWebpack=()=>{e()}}))}function waitForWebpackRuntimeHotUpdate(){return pendingHotUpdateWebpack}function handleBeforeHotUpdateWebpack(e,r){r&&e.onBeforeRefresh()}function handleSuccessfulHotUpdateWebpack(e,r,t){resolvePendingHotUpdateWebpack(),e.onBuildOk(),reportHmrLatency(r,t),e.onRefresh()}function reportHmrLatency(e,r){if(!startLatency)return;let t=null!=turbopackLastUpdateLatency?turbopackLastUpdateLatency:Date.now();const n=t-startLatency;console.log("[Fast Refresh] done in "+n+"ms"),e(JSON.stringify({event:"client-hmr-latency",id:window.__nextDevClientId,startTime:startLatency,endTime:t,page:window.location.pathname,updatedModules:r,isPageHidden:"hidden"===document.visibilityState}))}function handleAvailableHash(e){mostRecentCompilationHash=e}function isUpdateAvailable(){return!!process.env.TURBOPACK||mostRecentCompilationHash!==__webpack_hash__}function canApplyUpdates(){return"idle"===module.hot.status()}function afterApplyUpdates(e){if(canApplyUpdates())e();else{function r(t){"idle"===t&&(module.hot.removeStatusHandler(r),e())}module.hot.addStatusHandler(r)}}function performFullReload(e,r){const t=e&&(e.stack&&e.stack.split("\n").slice(0,5).join("\n")||e.message||e+"");r(JSON.stringify({event:"client-full-reload",stackTrace:t,hadRuntimeError:!!_runtimeerrorhandler.RuntimeErrorHandler.hadRuntimeError,dependencyChain:e?e.dependencyChain:void 0})),reloading||(reloading=!0,window.location.reload())}function tryApplyUpdates(e,r,t,n){if(!isUpdateAvailable()||!canApplyUpdates())return resolvePendingHotUpdateWebpack(),n.onBuildOk(),void reportHmrLatency(t,[]);function a(a,o){if(a||_runtimeerrorhandler.RuntimeErrorHandler.hadRuntimeError||!o)return a?console.warn("[Fast Refresh] performing full reload\n\nFast Refresh will perform a full reload when you edit a file that's imported by modules outside of the React rendering tree.\nYou might have a file which exports a React component but also exports a value that is imported by a non-React component file.\nConsider migrating the non-React component export to a separate file and importing it into both files.\n\nIt is also possible the parent component of the component you edited is a class component, which disables Fast Refresh.\nFast Refresh requires at least one parent function component in your React tree."):_runtimeerrorhandler.RuntimeErrorHandler.hadRuntimeError&&console.warn(_shared.REACT_REFRESH_FULL_RELOAD_FROM_ERROR),void performFullReload(a,t);const s=Boolean(o.length);"function"==typeof r&&r(o),isUpdateAvailable()?tryApplyUpdates(s?()=>{}:e,s?()=>n.onBuildOk():r,t,n):(n.onBuildOk(),process.env.__NEXT_TEST_MODE&&afterApplyUpdates((()=>{self.__NEXT_HMR_CB&&(self.__NEXT_HMR_CB(),self.__NEXT_HMR_CB=null)})))}module.hot.check(!1).then((r=>{if(!r)return null;if("function"==typeof e){const t=Boolean(r.length);e(t)}return module.hot.apply()})).then((e=>{a(null,e)}),(e=>{a(e,null)}))}function processMessage(e,r,t,n,a,o,s){if("action"in e)switch(e.action){case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.ISR_MANIFEST:process.env.__NEXT_DEV_INDICATOR&&o&&(o.current=e.data,s.current in e.data?a.onStaticIndicator(!0):a.onStaticIndicator(!1));break;case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.BUILDING:startLatency=Date.now(),turbopackLastUpdateLatency=null,turbopackUpdatedModules.clear(),process.env.TURBOPACK||setPendingHotUpdateWebpack(),console.log("[Fast Refresh] rebuilding");break;case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.BUILT:case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.SYNC:{e.hash&&handleAvailableHash(e.hash);const{errors:t,warnings:n}=e;"versionInfo"in e&&a.onVersionInfo(e.versionInfo),"debug"in e&&e.debug&&a.onDebugInfo(e.debug),"devIndicator"in e&&a.onDevIndicator(e.devIndicator);if(Boolean(t&&t.length))return r(JSON.stringify({event:"client-error",errorCount:t.length,clientId:__nextDevClientId})),void i(t);if(Boolean(n&&n.length)){r(JSON.stringify({event:"client-warning",warningCount:n.length,clientId:__nextDevClientId}));const e=(0,_formatwebpackmessages.default)({warnings:n,errors:[]});for(let r=0;r<e.warnings.length;r++){if(5===r){console.warn("There were more warnings in other files.\nYou can find a complete log in the terminal.");break}console.warn((0,_stripansi.default)(e.warnings[r]))}}return r(JSON.stringify({event:"client-success",clientId:__nextDevClientId})),void(e.action===_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.BUILT&&l())}case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_CONNECTED:t({type:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_CONNECTED,data:{sessionId:e.data.sessionId}});break;case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_MESSAGE:a.onBeforeRefresh(),t({type:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_MESSAGE,data:e.data}),a.onRefresh(),_runtimeerrorhandler.RuntimeErrorHandler.hadRuntimeError&&(console.warn(_shared.REACT_REFRESH_FULL_RELOAD_FROM_ERROR),performFullReload(null,r));for(const r of(0,_extractmodulesfromturbopackmessage.extractModulesFromTurbopackMessage)(e.data))turbopackUpdatedModules.add(r);turbopackLastUpdateLatency=Date.now();break;case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.SERVER_COMPONENT_CHANGES:if(r(JSON.stringify({event:"server-component-reload-page",clientId:__nextDevClientId,hash:e.hash})),document.cookie="__next_hmr_refresh_hash__="+e.hash,_runtimeerrorhandler.RuntimeErrorHandler.hadRuntimeError){if(reloading)return;return reloading=!0,window.location.reload()}return(0,_react.startTransition)((()=>{n.hmrRefresh(),a.onRefresh()})),void(process.env.__NEXT_TEST_MODE&&self.__NEXT_HMR_CB&&(self.__NEXT_HMR_CB(),self.__NEXT_HMR_CB=null));case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.RELOAD_PAGE:if(r(JSON.stringify({event:"client-reload-page",clientId:__nextDevClientId})),reloading)return;return reloading=!0,window.location.reload();case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.ADDED_PAGE:case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.REMOVED_PAGE:return n.hmrRefresh();case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.SERVER_ERROR:{const{errorJSON:r}=e;if(r){const{message:e,stack:t}=JSON.parse(r),n=Object.defineProperty(new Error(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});n.stack=t,i([n])}return}case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.DEV_PAGES_MANIFEST_UPDATE:return}function i(e){const r=(0,_formatwebpackmessages.default)({errors:e,warnings:[]});a.onBuildError(r.errors[0]);for(let e=0;e<r.errors.length;e++)console.error((0,_stripansi.default)(r.errors[e]));process.env.__NEXT_TEST_MODE&&self.__NEXT_HMR_CB&&(self.__NEXT_HMR_CB(r.errors[0]),self.__NEXT_HMR_CB=null)}function l(){process.env.TURBOPACK?(a.onBuildOk(),reportHmrLatency(r,[...turbopackUpdatedModules])):tryApplyUpdates((function(e){handleBeforeHotUpdateWebpack(a,e)}),(function(e){handleSuccessfulHotUpdateWebpack(a,r,e)}),r,a)}}function HotReload(e){let{assetPrefix:r,children:t,globalError:n}=e;const[a,o]=(0,_shared.useErrorOverlayReducer)("app"),s=(0,_react.useMemo)((()=>({onBuildOk(){o({type:_shared.ACTION_BUILD_OK})},onBuildError(e){o({type:_shared.ACTION_BUILD_ERROR,message:e})},onBeforeRefresh(){o({type:_shared.ACTION_BEFORE_REFRESH})},onRefresh(){o({type:_shared.ACTION_REFRESH})},onVersionInfo(e){o({type:_shared.ACTION_VERSION_INFO,versionInfo:e})},onStaticIndicator(e){o({type:_shared.ACTION_STATIC_INDICATOR,staticIndicator:e})},onDebugInfo(e){o({type:_shared.ACTION_DEBUG_INFO,debugInfo:e})},onDevIndicator(e){o({type:_shared.ACTION_DEV_INDICATOR,devIndicator:e})}})),[o]),i=(0,_react.useSyncExternalStore)((()=>()=>{}),(()=>!(0,_iserrorthrownwhilerenderingrsc.shouldRenderRootLevelErrorOverlay)()),(()=>!0)),l=(0,_react.useCallback)((e=>{const r=e.details,t=e._componentStack||(null==r?void 0:r.componentStack),n=null==r?void 0:r.warning;o({type:_shared.ACTION_UNHANDLED_ERROR,reason:e,frames:(0,_parsestack.parseStack)(e.stack||""),componentStackFrames:"string"==typeof t?(0,_parsecomponentstack.parseComponentStack)(t):void 0,warning:n})}),[o]),d=(0,_react.useCallback)((e=>{const r=(0,_stitchederror.getReactStitchedError)(e);o({type:_shared.ACTION_UNHANDLED_REJECTION,reason:r,frames:(0,_parsestack.parseStack)(r.stack||"")})}),[o]);(0,_useerrorhandler.useErrorHandler)(l,d);const c=(0,_usewebsocket.useWebsocket)(r);(0,_usewebsocket.useWebsocketPing)(c);const _=(0,_usewebsocket.useSendMessage)(c),u=(0,_usewebsocket.useTurbopack)(_,(e=>performFullReload(e,_))),p=(0,_navigation.useRouter)(),f=(0,_navigationuntracked.useUntrackedPathname)(),R=(0,_react.useRef)({}),h=(0,_react.useRef)(f);return process.env.__NEXT_DEV_INDICATOR&&(0,_react.useEffect)((()=>{h.current=f;const e=R.current;if(e)if(f&&f in e)try{s.onStaticIndicator(!0)}catch(e){let n="";var r;if(e instanceof DOMException)n=null!=(r=e.stack)?r:e.message;else if(e instanceof Error){var t;n="Error: "+e.message+"\n"+(null!=(t=e.stack)?t:"")}else n="Unexpected Exception: "+e;console.warn("[HMR] "+n)}else s.onStaticIndicator(!1)}),[f,s]),(0,_react.useEffect)((()=>{const e=c.current;if(!e)return;const r=e=>{try{const r=JSON.parse(e.data);(0,_handledevbuildindicatorhmrevents.handleDevBuildIndicatorHmrEvents)(r),processMessage(r,_,u,p,s,R,h)}catch(t){var r;console.warn("[HMR] Invalid message: "+JSON.stringify(e.data)+"\n"+(null!=(r=null==t?void 0:t.stack)?r:""))}};return e.addEventListener("message",r),()=>e.removeEventListener("message",r)}),[_,p,c,s,u,R]),i?(0,_jsxruntime.jsx)(_appdevoverlay.AppDevOverlay,{state:a,globalError:n,children:t}):t}("function"==typeof exports.default||"object"==typeof exports.default&&null!==exports.default)&&void 0===exports.default.__esModule&&(Object.defineProperty(exports.default,"__esModule",{value:!0}),Object.assign(exports.default,exports),module.exports=exports.default);