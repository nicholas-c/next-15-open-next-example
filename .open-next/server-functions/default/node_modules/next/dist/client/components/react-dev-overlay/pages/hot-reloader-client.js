"use strict";function _export(e,r){for(var t in r)Object.defineProperty(e,t,{enumerable:!0,get:r[t]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{default:function(){return connect},handleStaticIndicator:function(){return handleStaticIndicator},performFullReload:function(){return performFullReload}});const _interop_require_default=require("@swc/helpers/_/_interop_require_default"),_client=require("./client"),_stripansi=_interop_require_default._(require("next/dist/compiled/strip-ansi")),_websocket=require("./websocket"),_formatwebpackmessages=_interop_require_default._(require("../utils/format-webpack-messages")),_hotreloadertypes=require("../../../../server/dev/hot-reloader-types"),_extractmodulesfromturbopackmessage=require("../../../../server/dev/extract-modules-from-turbopack-message"),_shared=require("../shared"),_runtimeerrorhandler=require("../../errors/runtime-error-handler");let customHmrEventHandler;window.__nextDevClientId=Math.round(100*Math.random()+Date.now());let turbopackMessageListeners=[],MODE="webpack";function connect(e){return MODE=e,(0,_client.register)(),(0,_websocket.addMessageListener)((e=>{if("action"in e)try{processMessage(e)}catch(t){var r;console.warn("[HMR] Invalid message: "+JSON.stringify(e)+"\n"+(null!=(r=null==t?void 0:t.stack)?r:""))}})),{subscribeToHmrEvent(e){customHmrEventHandler=e},onUnrecoverableError(){_runtimeerrorhandler.RuntimeErrorHandler.hadRuntimeError=!0},addTurbopackMessageListener(e){turbopackMessageListeners.push(e)},sendTurbopackMessage(e){(0,_websocket.sendMessage)(e)},handleUpdateError(e){performFullReload(e)}}}var isFirstCompilation=!0,mostRecentCompilationHash=null,hasCompileErrors=!1;function clearOutdatedErrors(){"undefined"!=typeof console&&"function"==typeof console.clear&&hasCompileErrors&&console.clear()}function handleSuccess(){if(clearOutdatedErrors(),"webpack"===MODE){const e=!isFirstCompilation||"/_error"!==window.__NEXT_DATA__.page&&isUpdateAvailable();isFirstCompilation=!1,hasCompileErrors=!1,e&&tryApplyUpdates(onBeforeFastRefresh,onFastRefresh)}else reportHmrLatency([...turbopackUpdatedModules]),(0,_client.onBuildOk)()}function handleWarnings(e){clearOutdatedErrors();const r=!isFirstCompilation;function t(){const r=(0,_formatwebpackmessages.default)({warnings:e,errors:[]});var t;if("undefined"!=typeof console&&"function"==typeof console.warn)for(let e=0;e<(null==(t=r.warnings)?void 0:t.length);e++){if(5===e){console.warn("There were more warnings in other files.\nYou can find a complete log in the terminal.");break}console.warn((0,_stripansi.default)(r.warnings[e]))}}isFirstCompilation=!1,hasCompileErrors=!1,t(),r&&tryApplyUpdates(onBeforeFastRefresh,onFastRefresh)}function handleErrors(e){clearOutdatedErrors(),isFirstCompilation=!1,hasCompileErrors=!0;var r=(0,_formatwebpackmessages.default)({errors:e,warnings:[]});if((0,_client.onBuildError)(r.errors[0]),"undefined"!=typeof console&&"function"==typeof console.error)for(var t=0;t<r.errors.length;t++)console.error((0,_stripansi.default)(r.errors[t]));process.env.__NEXT_TEST_MODE&&self.__NEXT_HMR_CB&&(self.__NEXT_HMR_CB(r.errors[0]),self.__NEXT_HMR_CB=null)}let startLatency=null,turbopackLastUpdateLatency=null,turbopackUpdatedModules=new Set,isrManifest={};function onBeforeFastRefresh(e){e.length>0&&(0,_client.onBeforeRefresh)()}function onFastRefresh(e){void 0===e&&(e=[]),(0,_client.onBuildOk)(),0!==e.length&&((0,_client.onRefresh)(),reportHmrLatency())}function reportHmrLatency(e){if(void 0===e&&(e=[]),!startLatency)return;let r=null!=turbopackLastUpdateLatency?turbopackLastUpdateLatency:Date.now();const t=r-startLatency;console.log("[Fast Refresh] done in "+t+"ms"),(0,_websocket.sendMessage)(JSON.stringify({event:"client-hmr-latency",id:window.__nextDevClientId,startTime:startLatency,endTime:r,page:window.location.pathname,updatedModules:e,isPageHidden:"hidden"===document.visibilityState})),self.__NEXT_HMR_LATENCY_CB&&self.__NEXT_HMR_LATENCY_CB(t)}function handleAvailableHash(e){mostRecentCompilationHash=e}function handleStaticIndicator(){if(process.env.__NEXT_DEV_INDICATOR){var e;const r=window.next.router.components[window.next.router.pathname],t=null==r?void 0:r.Component,n=null==(e=window.next.router.components["/_app"])?void 0:e.Component,o=Boolean(null==t?void 0:t.getInitialProps)||Boolean(r.__N_SSP),a=Boolean(null==n?void 0:n.getInitialProps)&&(null==n?void 0:n.getInitialProps)!==(null==n?void 0:n.origGetInitialProps),s=window.location.pathname in isrManifest||!o&&!a;(0,_client.onStaticIndicator)(s)}}function processMessage(e){if("action"in e)switch(e.action){case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.ISR_MANIFEST:isrManifest=e.data,handleStaticIndicator();break;case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.BUILDING:startLatency=Date.now(),turbopackLastUpdateLatency=null,turbopackUpdatedModules.clear(),console.log("[Fast Refresh] rebuilding");break;case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.BUILT:case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.SYNC:{e.hash&&handleAvailableHash(e.hash);const{errors:r,warnings:t}=e;"versionInfo"in e&&(0,_client.onVersionInfo)(e.versionInfo),"devIndicator"in e&&(0,_client.onDevIndicator)(e.devIndicator);if(Boolean(r&&r.length))return(0,_websocket.sendMessage)(JSON.stringify({event:"client-error",errorCount:r.length,clientId:window.__nextDevClientId})),handleErrors(r);return Boolean(t&&t.length)?((0,_websocket.sendMessage)(JSON.stringify({event:"client-warning",warningCount:t.length,clientId:window.__nextDevClientId})),handleWarnings(t)):((0,_websocket.sendMessage)(JSON.stringify({event:"client-success",clientId:window.__nextDevClientId})),handleSuccess())}case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.SERVER_COMPONENT_CHANGES:return void((hasCompileErrors||_runtimeerrorhandler.RuntimeErrorHandler.hadRuntimeError)&&window.location.reload());case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.SERVER_ERROR:{const{errorJSON:r}=e;if(r){const{message:e,stack:t}=JSON.parse(r),n=Object.defineProperty(new Error(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});n.stack=t,handleErrors([n])}return}case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_CONNECTED:for(const r of turbopackMessageListeners)r({type:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_CONNECTED,data:e.data});break;case _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_MESSAGE:{const r=(0,_extractmodulesfromturbopackmessage.extractModulesFromTurbopackMessage)(e.data);onBeforeFastRefresh([...r]);for(const r of turbopackMessageListeners)r({type:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_MESSAGE,data:e.data});_runtimeerrorhandler.RuntimeErrorHandler.hadRuntimeError&&(console.warn(_shared.REACT_REFRESH_FULL_RELOAD_FROM_ERROR),performFullReload(null)),(0,_client.onRefresh)();for(const e of r)turbopackUpdatedModules.add(e);turbopackLastUpdateLatency=Date.now();break}default:if(customHmrEventHandler){customHmrEventHandler(e);break}}}function isUpdateAvailable(){return mostRecentCompilationHash!==__webpack_hash__}function canApplyUpdates(){return"idle"===module.hot.status()}function afterApplyUpdates(e){if(canApplyUpdates())e();else{function r(t){"idle"===t&&(module.hot.removeStatusHandler(r),e())}module.hot.addStatusHandler(r)}}function tryApplyUpdates(e,r){function t(t,n){if(t||_runtimeerrorhandler.RuntimeErrorHandler.hadRuntimeError||!n)return t?console.warn("[Fast Refresh] performing full reload\n\nFast Refresh will perform a full reload when you edit a file that's imported by modules outside of the React rendering tree.\nYou might have a file which exports a React component but also exports a value that is imported by a non-React component file.\nConsider migrating the non-React component export to a separate file and importing it into both files.\n\nIt is also possible the parent component of the component you edited is a class component, which disables Fast Refresh.\nFast Refresh requires at least one parent function component in your React tree."):_runtimeerrorhandler.RuntimeErrorHandler.hadRuntimeError&&console.warn("[Fast Refresh] performing full reload because your application had an unrecoverable error"),void performFullReload(t);"function"==typeof r&&r(n),isUpdateAvailable()?tryApplyUpdates(n.length>0?void 0:e,n.length>0?_client.onBuildOk:r):((0,_client.onBuildOk)(),process.env.__NEXT_TEST_MODE&&afterApplyUpdates((()=>{self.__NEXT_HMR_CB&&(self.__NEXT_HMR_CB(),self.__NEXT_HMR_CB=null)})))}module.hot?isUpdateAvailable()&&canApplyUpdates()?module.hot.check(!1).then((r=>r?("function"==typeof e&&e(r),module.hot.apply()):null)).then((e=>{t(null,e)}),(e=>{t(e,null)})):(0,_client.onBuildOk)():console.error("HotModuleReplacementPlugin is not in Webpack configuration.")}function performFullReload(e){const r=e&&(e.stack&&e.stack.split("\n").slice(0,5).join("\n")||e.message||e+"");(0,_websocket.sendMessage)(JSON.stringify({event:"client-full-reload",stackTrace:r,hadRuntimeError:!!_runtimeerrorhandler.RuntimeErrorHandler.hadRuntimeError,dependencyChain:e?e.dependencyChain:void 0})),window.location.reload()}("function"==typeof exports.default||"object"==typeof exports.default&&null!==exports.default)&&void 0===exports.default.__esModule&&(Object.defineProperty(exports.default,"__esModule",{value:!0}),Object.assign(exports.default,exports),module.exports=exports.default);