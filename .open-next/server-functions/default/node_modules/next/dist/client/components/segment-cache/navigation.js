"use strict";function _export(e,t){for(var n in t)Object.defineProperty(e,n,{enumerable:!0,get:t[n]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{NavigationResultTag:function(){return NavigationResultTag},navigate:function(){return navigate}});const _fetchserverresponse=require("../router-reducer/fetch-server-response"),_pprnavigations=require("../router-reducer/ppr-navigations"),_createhreffromurl=require("../router-reducer/create-href-from-url"),_cache=require("./cache"),_cachekey=require("./cache-key");var NavigationResultTag=function(e){return e[e.MPA=0]="MPA",e[e.Success=1]="Success",e[e.NoOp=2]="NoOp",e[e.Async=3]="Async",e}({});const noOpNavigationResult={tag:2,data:null};function navigate(e,t,n,r,a){const o=Date.now(),c=(0,_cachekey.createCacheKey)(e.href,r),s=(0,_cache.readRouteCacheEntry)(o,c);if(null!==s&&s.status===_cache.EntryStatus.Fulfilled){const c=readRenderSnapshotFromCache(o,s.tree);return navigateUsingPrefetchedRouteTree(e,r,t,n,c.flightRouterState,c.seedData,s.head,s.isHeadPartial,s.canonicalUrl,a)}return{tag:3,data:navigateDynamicallyWithNoPrefetch(e,r,t,n,a)}}function navigateUsingPrefetchedRouteTree(e,t,n,r,a,o,c,s,i,l){const u=[],f=(0,_pprnavigations.startPPRNavigation)(n,r,a,o,c,s,u);if(null!==f){const r=f.dynamicRequestTree;if(null!==r){const n=(0,_fetchserverresponse.fetchServerResponse)(e,{flightRouterState:r,nextUrl:t});(0,_pprnavigations.listenForDynamicRequest)(f,n)}return navigationTaskToResult(f,n,i,u,l)}return noOpNavigationResult}function navigationTaskToResult(e,t,n,r,a){const o=e.route;if(null===o)return{tag:0,data:n};const c=e.node;return{tag:1,data:{flightRouterState:o,cacheNode:null!==c?c:t,canonicalUrl:n,scrollableSegments:r,shouldScroll:a}}}function readRenderSnapshotFromCache(e,t){let n={},r={};const a=t.slots;if(null!==a)for(const t in a){const o=readRenderSnapshotFromCache(e,a[t]);n[t]=o.flightRouterState,r[t]=o.seedData}let o=null,c=null,s=!0;const i=(0,_cache.readSegmentCacheEntry)(e,t.key);if(null!==i)switch(i.status){case _cache.EntryStatus.Fulfilled:o=i.rsc,c=i.loading,s=i.isPartial;break;case _cache.EntryStatus.Pending:{const e=(0,_cache.waitForSegmentCacheEntry)(i);o=e.then((e=>null!==e?e.rsc:null)),c=e.then((e=>null!==e?e.loading:null)),s=!0;break}case _cache.EntryStatus.Empty:case _cache.EntryStatus.Rejected:}return{flightRouterState:[t.segment,n,null,null,t.isRootLayout],seedData:[t.segment,o,r,c,s]}}async function navigateDynamicallyWithNoPrefetch(e,t,n,r,a){const o=(0,_fetchserverresponse.fetchServerResponse)(e,{flightRouterState:r,nextUrl:t}),{flightData:c,canonicalUrl:s}=await o;if("string"==typeof c){return{tag:0,data:c}}const i=simulatePrefetchTreeUsingDynamicTreePatch(r,c),l=null,u=null,f=!0,h=(0,_createhreffromurl.createHrefFromUrl)(s||e),g=[],d=(0,_pprnavigations.startPPRNavigation)(n,r,i,l,u,f,g);if(null!==d){return null!==d.dynamicRequestTree&&(0,_pprnavigations.listenForDynamicRequest)(d,o),navigationTaskToResult(d,n,h,g,a)}return noOpNavigationResult}function simulatePrefetchTreeUsingDynamicTreePatch(e,t){let n=e;for(const{segmentPath:r,tree:a}of t){n=simulatePrefetchTreeUsingDynamicTreePatchImpl(n,a,r,n!==e,0)}return n}function simulatePrefetchTreeUsingDynamicTreePatchImpl(e,t,n,r,a){if(a===n.length)return t;const o=n[a],c=e[1],s={};for(const e in c)if(e===o){const o=c[e];s[e]=simulatePrefetchTreeUsingDynamicTreePatchImpl(o,t,n,r,a+2)}else s[e]=c[e];if(r)return e[1]=s,e;const i=[e[0],s];return 2 in e&&(i[2]=e[2]),3 in e&&(i[3]=e[3]),4 in e&&(i[4]=e[4]),i}("function"==typeof exports.default||"object"==typeof exports.default&&null!==exports.default)&&void 0===exports.default.__esModule&&(Object.defineProperty(exports.default,"__esModule",{value:!0}),Object.assign(exports.default,exports),module.exports=exports.default);