"use strict";function _export(e,r){for(var t in r)Object.defineProperty(e,t,{enumerable:!0,get:r[t]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{createFetch:function(){return createFetch},createFromNextReadableStream:function(){return createFromNextReadableStream},fetchServerResponse:function(){return fetchServerResponse},urlToUrlWithoutFlightMarker:function(){return urlToUrlWithoutFlightMarker}});const _approuterheaders=require("../app-router-headers"),_appcallserver=require("../../app-call-server"),_appfindsourcemapurl=require("../../app-find-source-map-url"),_routerreducertypes=require("./router-reducer-types"),_flightdatahelpers=require("../../flight-data-helpers"),_appbuildid=require("../../app-build-id"),_setcachebustingsearchparam=require("./set-cache-busting-search-param"),{createFromReadableStream:createFromReadableStream}=process.env.NEXT_RUNTIME?require("react-server-dom-webpack/client.edge"):require("react-server-dom-webpack/client");function urlToUrlWithoutFlightMarker(e){const r=new URL(e,location.origin);if(r.searchParams.delete(_approuterheaders.NEXT_RSC_UNION_QUERY),"production"===process.env.NODE_ENV&&"export"===process.env.__NEXT_CONFIG_OUTPUT&&r.pathname.endsWith(".txt")){const{pathname:e}=r,t=e.endsWith("/index.txt")?10:4;r.pathname=e.slice(0,-t)}return r}function doMpaNavigation(e){return{flightData:urlToUrlWithoutFlightMarker(e).toString(),canonicalUrl:void 0,couldBeIntercepted:!1,prerendered:!1,postponed:!1,staleTime:-1}}let abortController=new AbortController;async function fetchServerResponse(e,r){const{flightRouterState:t,nextUrl:a,prefetchKind:o}=r,n={[_approuterheaders.RSC_HEADER]:"1",[_approuterheaders.NEXT_ROUTER_STATE_TREE_HEADER]:encodeURIComponent(JSON.stringify(t))};o===_routerreducertypes.PrefetchKind.AUTO&&(n[_approuterheaders.NEXT_ROUTER_PREFETCH_HEADER]="1"),"development"===process.env.NODE_ENV&&r.isHmrRefresh&&(n[_approuterheaders.NEXT_HMR_REFRESH_HEADER]="1"),a&&(n[_approuterheaders.NEXT_URL]=a);try{var i;const r=o?o===_routerreducertypes.PrefetchKind.TEMPORARY?"high":"low":"auto",t=await createFetch(e,n,r,abortController.signal),a=urlToUrlWithoutFlightMarker(t.url),s=t.redirected?a:void 0,p=t.headers.get("content-type")||"",c=!!(null==(i=t.headers.get("vary"))?void 0:i.includes(_approuterheaders.NEXT_URL)),l=!!t.headers.get(_approuterheaders.NEXT_DID_POSTPONE_HEADER),d=t.headers.get(_approuterheaders.NEXT_ROUTER_STALE_TIME_HEADER),u=null!==d?parseInt(d,10):-1;let h=p.startsWith(_approuterheaders.RSC_CONTENT_TYPE_HEADER);if("production"===process.env.NODE_ENV&&"export"===process.env.__NEXT_CONFIG_OUTPUT&&(h||(h=p.startsWith("text/plain"))),!h||!t.ok||!t.body)return e.hash&&(a.hash=e.hash),doMpaNavigation(a.toString());"production"===process.env.NODE_ENV||process.env.TURBOPACK||await require("../react-dev-overlay/app/hot-reloader-client").waitForWebpackRuntimeHotUpdate();const _=l?createUnclosingPrefetchStream(t.body):t.body,E=await createFromNextReadableStream(_);return(0,_appbuildid.getAppBuildId)()!==E.b?doMpaNavigation(t.url):{flightData:(0,_flightdatahelpers.normalizeFlightData)(E.f),canonicalUrl:s,couldBeIntercepted:c,prerendered:E.S,postponed:l,staleTime:u}}catch(r){return abortController.signal.aborted||console.error("Failed to fetch RSC payload for "+e+". Falling back to browser navigation.",r),{flightData:e.toString(),canonicalUrl:void 0,couldBeIntercepted:!1,prerendered:!1,postponed:!1,staleTime:-1}}}function createFetch(e,r,t,a){const o=new URL(e);return"production"===process.env.NODE_ENV&&"export"===process.env.__NEXT_CONFIG_OUTPUT&&(o.pathname.endsWith("/")?o.pathname+="index.txt":o.pathname+=".txt"),(0,_setcachebustingsearchparam.setCacheBustingSearchParam)(o,r),process.env.__NEXT_TEST_MODE&&null!==t&&(r["Next-Test-Fetch-Priority"]=t),process.env.NEXT_DEPLOYMENT_ID&&(r["x-deployment-id"]=process.env.NEXT_DEPLOYMENT_ID),fetch(o,{credentials:"same-origin",headers:r,priority:t||void 0,signal:a})}function createFromNextReadableStream(e){return createFromReadableStream(e,{callServer:_appcallserver.callServer,findSourceMapURL:_appfindsourcemapurl.findSourceMapURL})}function createUnclosingPrefetchStream(e){const r=e.getReader();return new ReadableStream({async pull(e){for(;;){const{done:t,value:a}=await r.read();if(t)return;e.enqueue(a)}}})}"undefined"!=typeof window&&(window.addEventListener("pagehide",(()=>{abortController.abort()})),window.addEventListener("pageshow",(()=>{abortController=new AbortController}))),("function"==typeof exports.default||"object"==typeof exports.default&&null!==exports.default)&&void 0===exports.default.__esModule&&(Object.defineProperty(exports.default,"__esModule",{value:!0}),Object.assign(exports.default,exports),module.exports=exports.default);