"use strict";function _export(e,t){for(var a in t)Object.defineProperty(e,a,{enumerable:!0,get:t[a]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{handleExternalUrl:function(){return handleExternalUrl},navigateReducer:function(){return navigateReducer}});const _fetchserverresponse=require("../fetch-server-response"),_createhreffromurl=require("../create-href-from-url"),_invalidatecachebelowflightsegmentpath=require("../invalidate-cache-below-flight-segmentpath"),_applyrouterstatepatchtotree=require("../apply-router-state-patch-to-tree"),_shouldhardnavigate=require("../should-hard-navigate"),_isnavigatingtonewrootlayout=require("../is-navigating-to-new-root-layout"),_routerreducertypes=require("../router-reducer-types"),_handlemutable=require("../handle-mutable"),_applyflightdata=require("../apply-flight-data"),_prefetchreducer=require("./prefetch-reducer"),_approuter=require("../../app-router"),_segment=require("../../../../shared/lib/segment"),_pprnavigations=require("../ppr-navigations"),_prefetchcacheutils=require("../prefetch-cache-utils"),_clearcachenodedataforsegmentpath=require("../clear-cache-node-data-for-segment-path"),_aliasedprefetchnavigations=require("../aliased-prefetch-navigations"),_navigation=require("../../segment-cache/navigation");function handleExternalUrl(e,t,a,r){return t.mpaNavigation=!0,t.canonicalUrl=a,t.pendingPush=r,t.scrollableSegments=void 0,(0,_handlemutable.handleMutable)(e,t)}function generateSegmentsFromPatch(e){const t=[],[a,r]=e;if(0===Object.keys(r).length)return[[a]];for(const[e,n]of Object.entries(r))for(const r of generateSegmentsFromPatch(n))""===a?t.push([e,...r]):t.push([a,e,...r]);return t}function triggerLazyFetchForLeafSegments(e,t,a,r){let n=!1;e.rsc=t.rsc,e.prefetchRsc=t.prefetchRsc,e.loading=t.loading,e.parallelRoutes=new Map(t.parallelRoutes);const l=generateSegmentsFromPatch(r).map((e=>[...a,...e]));for(const a of l)(0,_clearcachenodedataforsegmentpath.clearCacheNodeDataForSegmentPath)(e,t,a),n=!0;return n}function handleNavigationResult(e,t,a,r){switch(r.tag){case _navigation.NavigationResultTag.MPA:{const n=r.data;return handleExternalUrl(e,t,n,a)}case _navigation.NavigationResultTag.NoOp:return(0,_handlemutable.handleMutable)(e,t);case _navigation.NavigationResultTag.Success:return t.cache=r.data.cacheNode,t.patchedTree=r.data.flightRouterState,t.canonicalUrl=r.data.canonicalUrl,t.scrollableSegments=r.data.scrollableSegments,t.shouldScroll=r.data.shouldScroll,(0,_handlemutable.handleMutable)(e,t);case _navigation.NavigationResultTag.Async:return r.data.then((r=>handleNavigationResult(e,t,a,r)),(()=>e));default:return e}}function navigateReducer(e,t){const{url:a,isExternalUrl:r,navigateType:n,shouldScroll:l,allowAliasing:o}=t,c={},{hash:s}=a,i=(0,_createhreffromurl.createHrefFromUrl)(a),u="push"===n;if((0,_prefetchcacheutils.prunePrefetchCache)(e.prefetchCache),c.preserveCustomHistoryState=!1,c.pendingPush=u,r)return handleExternalUrl(e,c,a.toString(),u);if(document.getElementById("__next-page-redirect"))return handleExternalUrl(e,c,i,u);if(process.env.__NEXT_CLIENT_SEGMENT_CACHE){const t=(0,_navigation.navigate)(a,e.cache,e.tree,e.nextUrl,l);return handleNavigationResult(e,c,u,t)}const h=(0,_prefetchcacheutils.getOrCreatePrefetchCacheEntry)({url:a,nextUrl:e.nextUrl,tree:e.tree,prefetchCache:e.prefetchCache,allowAliasing:o}),{treeAtTimeOfPrefetch:d,data:p}=h;return _prefetchreducer.prefetchQueue.bump(p),p.then((r=>{let{flightData:n,canonicalUrl:o,postponed:p}=r,g=!1;if(h.lastUsedTime||(h.lastUsedTime=Date.now(),g=!0),"string"==typeof n)return handleExternalUrl(e,c,n,u);const f=o?(0,_createhreffromurl.createHrefFromUrl)(o):i;if(!!s&&e.canonicalUrl.split("#",1)[0]===f.split("#",1)[0])return c.onlyHashChange=!0,c.canonicalUrl=f,c.shouldScroll=l,c.hashFragment=s,c.scrollableSegments=[],(0,_handlemutable.handleMutable)(e,c);if(h.aliased){const r=(0,_aliasedprefetchnavigations.handleAliasedPrefetchEntry)(e,n,a,c);return!1===r?navigateReducer(e,{...t,allowAliasing:!1}):r}let _=e.tree,m=e.cache,v=[];for(const t of n){const{pathToSegment:r,seedData:n,head:l,isHeadPartial:o,isRootRender:s}=t;let f=t.tree;const y=["",...r];let b=(0,_applyrouterstatepatchtotree.applyRouterStatePatchToTree)(y,_,f,i);if(null===b&&(b=(0,_applyrouterstatepatchtotree.applyRouterStatePatchToTree)(y,d,f,i)),null!==b){if(n&&s&&p){const t=(0,_pprnavigations.startPPRNavigation)(m,_,f,n,l,o,v);if(null!==t){if(null===t.route)return handleExternalUrl(e,c,i,u);b=t.route;const r=t.node;null!==r&&(c.cache=r);const n=t.dynamicRequestTree;if(null!==n){const r=(0,_fetchserverresponse.fetchServerResponse)(a,{flightRouterState:n,nextUrl:e.nextUrl});(0,_pprnavigations.listenForDynamicRequest)(t,r)}}else b=f}else{if((0,_isnavigatingtonewrootlayout.isNavigatingToNewRootLayout)(_,b))return handleExternalUrl(e,c,i,u);const a=(0,_approuter.createEmptyCacheNode)();let n=!1;h.status!==_routerreducertypes.PrefetchCacheEntryStatus.stale||g?n=(0,_applyflightdata.applyFlightData)(m,a,t,h):(n=triggerLazyFetchForLeafSegments(a,m,r,f),h.lastUsedTime=Date.now());(0,_shouldhardnavigate.shouldHardNavigate)(y,_)?(a.rsc=m.rsc,a.prefetchRsc=m.prefetchRsc,(0,_invalidatecachebelowflightsegmentpath.invalidateCacheBelowFlightSegmentPath)(a,m,r),c.cache=a):n&&(c.cache=a,m=a);for(const e of generateSegmentsFromPatch(f)){const t=[...r,...e];t[t.length-1]!==_segment.DEFAULT_SEGMENT_KEY&&v.push(t)}}_=b}}return c.patchedTree=_,c.canonicalUrl=f,c.scrollableSegments=v,c.hashFragment=s,c.shouldScroll=l,(0,_handlemutable.handleMutable)(e,c)}),(()=>e))}("function"==typeof exports.default||"object"==typeof exports.default&&null!==exports.default)&&void 0===exports.default.__esModule&&(Object.defineProperty(exports.default,"__esModule",{value:!0}),Object.assign(exports.default,exports),module.exports=exports.default);