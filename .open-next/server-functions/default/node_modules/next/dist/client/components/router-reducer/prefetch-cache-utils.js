"use strict";function _export(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{STATIC_STALETIME_MS:function(){return STATIC_STALETIME_MS},createSeededPrefetchCacheEntry:function(){return createSeededPrefetchCacheEntry},getOrCreatePrefetchCacheEntry:function(){return getOrCreatePrefetchCacheEntry},prunePrefetchCache:function(){return prunePrefetchCache}});const _fetchserverresponse=require("./fetch-server-response"),_routerreducertypes=require("./router-reducer-types"),_prefetchreducer=require("./reducers/prefetch-reducer"),INTERCEPTION_CACHE_KEY_MARKER="%";function createPrefetchCacheKeyImpl(e,t,r){let c=e.pathname;return t&&(c+=e.search),r?""+r+INTERCEPTION_CACHE_KEY_MARKER+c:c}function createPrefetchCacheKey(e,t,r){return createPrefetchCacheKeyImpl(e,t===_routerreducertypes.PrefetchKind.FULL,r)}function getExistingCacheEntry(e,t,r,c,n){void 0===t&&(t=_routerreducertypes.PrefetchKind.TEMPORARY);for(const u of[r,null]){const r=createPrefetchCacheKeyImpl(e,!0,u),a=createPrefetchCacheKeyImpl(e,!1,u),s=e.search?r:a,h=c.get(s);if(h&&n){return h.url.pathname===e.pathname&&h.url.search!==e.search?{...h,aliased:!0}:h}const f=c.get(a);if("development"!==process.env.NODE_ENV&&n&&e.search&&t!==_routerreducertypes.PrefetchKind.FULL&&f&&!f.key.includes(INTERCEPTION_CACHE_KEY_MARKER))return{...f,aliased:!0}}if("development"!==process.env.NODE_ENV&&t!==_routerreducertypes.PrefetchKind.FULL&&n)for(const t of c.values())if(t.url.pathname===e.pathname&&!t.key.includes(INTERCEPTION_CACHE_KEY_MARKER))return{...t,aliased:!0}}function getOrCreatePrefetchCacheEntry(e){let{url:t,nextUrl:r,tree:c,prefetchCache:n,kind:u,allowAliasing:a=!0}=e;const s=getExistingCacheEntry(t,u,r,n,a);if(s){s.status=getPrefetchEntryCacheStatus(s);return s.kind!==_routerreducertypes.PrefetchKind.FULL&&u===_routerreducertypes.PrefetchKind.FULL&&s.data.then((e=>{if(!(Array.isArray(e.flightData)&&e.flightData.some((e=>e.isRootRender&&null!==e.seedData))))return createLazyPrefetchEntry({tree:c,url:t,nextUrl:r,prefetchCache:n,kind:null!=u?u:_routerreducertypes.PrefetchKind.TEMPORARY})})),u&&s.kind===_routerreducertypes.PrefetchKind.TEMPORARY&&(s.kind=u),s}return createLazyPrefetchEntry({tree:c,url:t,nextUrl:r,prefetchCache:n,kind:u||_routerreducertypes.PrefetchKind.TEMPORARY})}function prefixExistingPrefetchCacheEntry(e){let{url:t,nextUrl:r,prefetchCache:c,existingCacheKey:n}=e;const u=c.get(n);if(!u)return;const a=createPrefetchCacheKey(t,u.kind,r);return c.set(a,{...u,key:a}),c.delete(n),a}function createSeededPrefetchCacheEntry(e){let{nextUrl:t,tree:r,prefetchCache:c,url:n,data:u,kind:a}=e;const s=u.couldBeIntercepted?createPrefetchCacheKey(n,a,t):createPrefetchCacheKey(n,a),h={treeAtTimeOfPrefetch:r,data:Promise.resolve(u),kind:a,prefetchTime:Date.now(),lastUsedTime:Date.now(),staleTime:-1,key:s,status:_routerreducertypes.PrefetchCacheEntryStatus.fresh,url:n};return c.set(s,h),h}function createLazyPrefetchEntry(e){let{url:t,kind:r,tree:c,nextUrl:n,prefetchCache:u}=e;const a=createPrefetchCacheKey(t,r),s=_prefetchreducer.prefetchQueue.enqueue((()=>(0,_fetchserverresponse.fetchServerResponse)(t,{flightRouterState:c,nextUrl:n,prefetchKind:r}).then((e=>{let r;if(e.couldBeIntercepted&&(r=prefixExistingPrefetchCacheEntry({url:t,existingCacheKey:a,nextUrl:n,prefetchCache:u})),e.prerendered){const t=u.get(null!=r?r:a);t&&(t.kind=_routerreducertypes.PrefetchKind.FULL,-1!==e.staleTime&&(t.staleTime=e.staleTime))}return e})))),h={treeAtTimeOfPrefetch:c,data:s,kind:r,prefetchTime:Date.now(),lastUsedTime:null,staleTime:-1,key:a,status:_routerreducertypes.PrefetchCacheEntryStatus.fresh,url:t};return u.set(a,h),h}function prunePrefetchCache(e){for(const[t,r]of e)getPrefetchEntryCacheStatus(r)===_routerreducertypes.PrefetchCacheEntryStatus.expired&&e.delete(t)}const DYNAMIC_STALETIME_MS=1e3*Number(process.env.__NEXT_CLIENT_ROUTER_DYNAMIC_STALETIME),STATIC_STALETIME_MS=1e3*Number(process.env.__NEXT_CLIENT_ROUTER_STATIC_STALETIME);function getPrefetchEntryCacheStatus(e){let{kind:t,prefetchTime:r,lastUsedTime:c,staleTime:n}=e;return-1!==n?Date.now()<r+n?_routerreducertypes.PrefetchCacheEntryStatus.fresh:_routerreducertypes.PrefetchCacheEntryStatus.stale:Date.now()<(null!=c?c:r)+DYNAMIC_STALETIME_MS?c?_routerreducertypes.PrefetchCacheEntryStatus.reusable:_routerreducertypes.PrefetchCacheEntryStatus.fresh:t===_routerreducertypes.PrefetchKind.AUTO&&Date.now()<r+STATIC_STALETIME_MS?_routerreducertypes.PrefetchCacheEntryStatus.stale:t===_routerreducertypes.PrefetchKind.FULL&&Date.now()<r+STATIC_STALETIME_MS?_routerreducertypes.PrefetchCacheEntryStatus.reusable:_routerreducertypes.PrefetchCacheEntryStatus.expired}("function"==typeof exports.default||"object"==typeof exports.default&&null!==exports.default)&&void 0===exports.default.__esModule&&(Object.defineProperty(exports.default,"__esModule",{value:!0}),Object.assign(exports.default,exports),module.exports=exports.default);