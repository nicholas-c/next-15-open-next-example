"use strict";function _export(e,r){for(var t in r)Object.defineProperty(e,t,{enumerable:!0,get:r[t]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{createOriginalStackFrame:function(){return createOriginalStackFrame},getIgnoredSources:function(){return getIgnoredSources},getOverlayMiddleware:function(){return getOverlayMiddleware},getServerError:function(){return _nodestackframes.getServerError},getSourceMapFromFile:function(){return _getsourcemapfromfile.getSourceMapFromFile},getSourceMapMiddleware:function(){return getSourceMapMiddleware},parseStack:function(){return _parsestack.parseStack}});const _interop_require_default=require("@swc/helpers/_/_interop_require_default"),_fs=require("fs"),_module=require("module"),_path=_interop_require_default._(require("path")),_url=require("url"),_sourcemap08=require("next/dist/compiled/source-map08"),_getsourcemapfromfile=require("../utils/get-source-map-from-file"),_launcheditor=require("../utils/launch-editor"),_shared=require("./shared"),_middlewareresponse=require("./middleware-response"),_nodestackframes=require("../utils/node-stack-frames"),_parsestack=require("../utils/parse-stack"),_webpackmodulepath=require("../utils/webpack-module-path"),_util=require("util");function shouldIgnoreSource(e){return e.includes("node_modules")||e.includes("next/dist")||e.startsWith("node:")}function getModuleById(e,r){const{chunkGraph:t,modules:o}=r;return[...o].find((r=>t.getModuleId(r)===e))}function findModuleNotFoundFromError(e){var r;return null==e||null==(r=e.match(/'([^']+)' module/))?void 0:r[1]}function getSourcePath(e){return e.startsWith("file://")?(0,_url.fileURLToPath)(e):e.replace(/^(webpack:\/\/\/|webpack:\/\/|webpack:\/\/_N_E\/)/,"")}async function findOriginalSourcePositionAndContent(e,r){let t;try{t=await new _sourcemap08.SourceMapConsumer(e)}catch(r){throw Object.defineProperty(new Error(e.file+": Invalid source map. Only conformant source maps can be used to find the original code.",{cause:r}),"__NEXT_ERROR_CODE",{value:"E635",enumerable:!1,configurable:!0})}try{var o,n;const e=t.originalPositionFor({line:null!=(o=r.lineNumber)?o:1,column:(null!=(n=r.column)?n:1)-1});if(!e.source)return null;var a;return{sourcePosition:e,sourceContent:null!=(a=t.sourceContentFor(e.source,!0))?a:null}}finally{t.destroy()}}function getIgnoredSources(e){var r;const t=new Set(null!=(r=e.ignoreList)?r:[]);var o;const n=null!=(o=null==e?void 0:e.sources)?o:[];for(let e=0;e<n.length;e++){const r=n[e];shouldIgnoreSource((0,_webpackmodulepath.formatFrameSourceFile)(r))&&t.add(e)}return e.sources.map(((r,o)=>{var n,a;return{url:r,ignored:t.has(e.sources.indexOf(r)),content:null!=(a=null==(n=e.sourcesContent)?void 0:n[o])?a:null}}))}function isIgnoredSource(e,r){if(null==r.source)return!0;for(const t of e.ignoredSources)if(t.ignored&&t.url===r.source)return!0;return!1}function findOriginalSourcePositionAndContentFromCompilation(e,r,t){var o,n;const a=getModuleById(e,t);var i;return null!=(i=null==a||null==(n=a.buildInfo)||null==(o=n.importLocByPath)?void 0:o.get(r))?i:null}async function createOriginalStackFrame(e){let{source:r,rootDirectory:t,frame:o,errorMessage:n}=e;var a,i;const l=findModuleNotFoundFromError(n),u=await(()=>{if(l){if("file"===r.type)return;return findOriginalSourcePositionAndContentFromCompilation(r.moduleId,l,r.compilation)}return findOriginalSourcePositionAndContent(r.sourceMap,o)})();if(!u)return null;const{sourcePosition:s,sourceContent:c}=u;if(!s.source)return null;const d=isIgnoredSource(r,s)||shouldIgnoreSource(r.moduleURL),m=getSourcePath((s.source.includes("|")?r.moduleURL:s.source)||r.moduleURL),p=_path.default.resolve(t,m);var f;const g={file:_path.default.relative(t,p),lineNumber:s.line,column:(null!=(f=s.column)?f:0)+1,methodName:null==(i=o.methodName)||null==(a=i.replace("__WEBPACK_DEFAULT_EXPORT__","default"))?void 0:a.replace("__webpack_exports__.",""),arguments:[],ignored:d};return{originalStackFrame:g,originalCodeFrame:(0,_shared.getOriginalCodeFrame)(g,c)}}async function getSourceMapFromCompilation(e,r){try{const o=getModuleById(e,r);if(!o)return;const n=r.codeGenerationResults.get(o),a=null==n?void 0:n.sources.get("javascript");var t;return null!=(t=null==a?void 0:a.map())?t:void 0}catch(r){return void console.error('Failed to lookup module by ID ("'+e+'"):',r)}}async function getSource(e,r){const{getCompilations:t}=r;let o;e=e.replace(/(.*)\/(?=file:\/\/)/,"");try{o=(0,_module.findSourceMap)(e)}catch(r){throw Object.defineProperty(new Error(e+": Invalid source map. Only conformant source maps can be used to find the original code.",{cause:r}),"__NEXT_ERROR_CODE",{value:"E635",enumerable:!1,configurable:!0})}if(void 0!==o){const r=o.payload;return{type:"file",sourceMap:r,ignoredSources:getIgnoredSources(r),moduleURL:e}}if(_path.default.isAbsolute(e)&&(e=(0,_url.pathToFileURL)(e).href),e.startsWith("file:")){const r=await(0,_getsourcemapfromfile.getSourceMapFromFile)(e);return r?{type:"file",sourceMap:r,ignoredSources:getIgnoredSources(r),moduleURL:e}:void 0}const n=e.replace(/^(rsc:\/\/React\/[^/]+\/)?(webpack-internal:\/\/\/|webpack:\/\/(_N_E\/)?)/,"").replace(/\?\d+$/,""),a=n.replace(/^(\(.*\)\/?)/,"");for(const e of t()){const r=await getSourceMapFromCompilation(n,e);if(r){return{type:"bundle",sourceMap:r,compilation:e,moduleId:n,moduleURL:a,ignoredSources:getIgnoredSources(r)}}}}function getOriginalStackFrames(e){let{isServer:r,isEdgeServer:t,isAppDirectory:o,frames:n,clientStats:a,serverStats:i,edgeServerStats:l,rootDirectory:u}=e;return Promise.all(n.map((e=>getOriginalStackFrame({isServer:r,isEdgeServer:t,isAppDirectory:o,frame:e,clientStats:a,serverStats:i,edgeServerStats:l,rootDirectory:u}).then((e=>({status:"fulfilled",value:e})),(e=>({status:"rejected",reason:(0,_util.inspect)(e,{colors:!1})}))))))}async function getOriginalStackFrame(e){let{isServer:r,isEdgeServer:t,isAppDirectory:o,frame:n,clientStats:a,serverStats:i,edgeServerStats:l,rootDirectory:u}=e;var s;const c=null!=(s=n.file)?s:"",d=await getSource(c,{getCompilations:()=>{const e=[];if(!t&&!r||o){var n;const r=null==(n=a())?void 0:n.compilation;r&&e.push(r)}if(r||o){var u;const r=null==(u=i())?void 0:u.compilation;r&&e.push(r)}if(t||o){var s;const r=null==(s=l())?void 0:s.compilation;r&&e.push(r)}return e}});var m;const p={file:n.file,lineNumber:n.lineNumber,column:null!=(m=n.column)?m:1,methodName:n.methodName,ignored:shouldIgnoreSource(c),arguments:[]};if(!d)return{originalStackFrame:p,originalCodeFrame:null};const f=await createOriginalStackFrame({frame:n,source:d,rootDirectory:u});return f||{originalStackFrame:p,originalCodeFrame:null}}function getOverlayMiddleware(e){const{rootDirectory:r,clientStats:t,serverStats:o,edgeServerStats:n}=e;return async function(e,a,i){const{pathname:l,searchParams:u}=new URL("http://n"+e.url);if("/__nextjs_original-stack-frames"===l){if("POST"!==e.method)return _middlewareresponse.middlewareResponse.badRequest(a);const i=await new Promise(((r,t)=>{let o="";e.on("data",(e=>{o+=e})),e.on("end",(()=>r(o))),e.on("error",t)}));try{const{frames:e,isServer:l,isEdgeServer:u,isAppDirectory:s}=JSON.parse(i);return _middlewareresponse.middlewareResponse.json(a,await getOriginalStackFrames({isServer:l,isEdgeServer:u,isAppDirectory:s,frames:e.map((e=>{var r,t;return{...e,lineNumber:null!=(r=e.lineNumber)?r:0,column:null!=(t=e.column)?t:0}})),clientStats:t,serverStats:o,edgeServerStats:n,rootDirectory:r}))}catch(e){return _middlewareresponse.middlewareResponse.badRequest(a)}}else if("/__nextjs_launch-editor"===l){var s,c;const e={file:u.get("file"),methodName:u.get("methodName"),lineNumber:parseInt(null!=(s=u.get("lineNumber"))?s:"0",10)||0,column:parseInt(null!=(c=u.get("column"))?c:"0",10)||0,arguments:u.getAll("arguments").filter(Boolean)};if(!e.file)return _middlewareresponse.middlewareResponse.badRequest(a);const t=_path.default.resolve(r,e.file.replace(/^\([^)]+\)\//,""));if(!await _fs.promises.access(t,_fs.constants.F_OK).then((()=>!0),(()=>!1)))return _middlewareresponse.middlewareResponse.notFound(a);try{var d;(0,_launcheditor.launchEditor)(t,e.lineNumber,null!=(d=e.column)?d:1)}catch(e){return console.log("Failed to launch editor:",e),_middlewareresponse.middlewareResponse.internalServerError(a)}return _middlewareresponse.middlewareResponse.noContent(a)}return i()}}function getSourceMapMiddleware(e){const{clientStats:r,serverStats:t,edgeServerStats:o}=e;return async function(e,n,a){const{pathname:i,searchParams:l}=new URL("http://n"+e.url);if("/__nextjs_source-map"!==i)return a();const u=l.get("filename");if(!u)return _middlewareresponse.middlewareResponse.badRequest(n);let s;try{s=await getSource(u,{getCompilations:()=>{const e=[];for(const n of[r(),t(),o()])(null==n?void 0:n.compilation)&&e.push(n.compilation);return e}})}catch(e){return _middlewareresponse.middlewareResponse.internalServerError(n,e)}return s?_middlewareresponse.middlewareResponse.json(n,s.sourceMap):_middlewareresponse.middlewareResponse.noContent(n)}}("function"==typeof exports.default||"object"==typeof exports.default&&null!==exports.default)&&void 0===exports.default.__esModule&&(Object.defineProperty(exports.default,"__esModule",{value:!0}),Object.assign(exports.default,exports),module.exports=exports.default);