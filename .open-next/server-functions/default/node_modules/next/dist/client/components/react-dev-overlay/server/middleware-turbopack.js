"use strict";function _export(e,r){for(var n in r)Object.defineProperty(e,n,{enumerable:!0,get:r[n]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{batchedTraceSource:function(){return batchedTraceSource},getOverlayMiddleware:function(){return getOverlayMiddleware},getSourceMapMiddleware:function(){return getSourceMapMiddleware}});const _interop_require_default=require("@swc/helpers/_/_interop_require_default"),_interop_require_wildcard=require("@swc/helpers/_/_interop_require_wildcard"),_shared=require("./shared"),_middlewareresponse=require("./middleware-response"),_promises=_interop_require_wildcard._(require("fs/promises")),_path=_interop_require_default._(require("path")),_url=_interop_require_default._(require("url")),_launcheditor=require("../utils/launch-editor"),_sourcemap08=require("next/dist/compiled/source-map08"),_getsourcemapfromfile=require("../utils/get-source-map-from-file"),_nodemodule=require("node:module"),_nodeurl=require("node:url"),_nodeutil=require("node:util");function shouldIgnorePath(e){return e.includes("node_modules")||e.includes("next/dist")||e.startsWith("node:")}const currentSourcesByFile=new Map;async function batchedTraceSource(e,r){const n=r.file?decodeURIComponent(r.file):void 0;if(!n)return;var o,t,l;if(n.startsWith("node:"))return{frame:{file:n,lineNumber:null!=(o=r.line)?o:0,column:null!=(t=r.column)?t:0,methodName:null!=(l=r.methodName)?l:"<unknown>",ignored:!0,arguments:[]},source:null};const a=(0,_nodeurl.pathToFileURL)(process.cwd()).href,i=await e.traceSource(r,a);var u,s,c;if(!i)return{frame:{file:n,lineNumber:null!=(u=r.line)?u:0,column:null!=(s=r.column)?s:0,methodName:null!=(c=r.methodName)?c:"<unknown>",ignored:shouldIgnorePath(n),arguments:[]},source:null};let d=null;const m=i.originalFile,f=shouldIgnorePath(null!=m?m:i.file)||!!i.isInternal;if(m&&!f){let r=currentSourcesByFile.get(m);r||(r=e.getSourceForAsset(m),currentSourcesByFile.set(m,r),setTimeout((()=>{currentSourcesByFile.delete(m)}),100)),d=await r}var p,_,w;return{frame:{file:i.file,lineNumber:null!=(p=i.line)?p:0,column:null!=(_=i.column)?_:0,methodName:null!=(w=r.methodName)?w:"<unknown>",ignored:f,arguments:[]},source:d}}function parseFile(e){if(e)return e.replace(/^rsc:\/\/React\/[^/]+\//,"").replace(/\?\d+$/,"")}function createStackFrames(e){const{frames:r,isServer:n}=e;return r.map((e=>{const r=parseFile(e.file);var o,t,l;if(r)return{file:r,methodName:null!=(o=e.methodName)?o:"<unknown>",line:null!=(t=e.lineNumber)?t:0,column:null!=(l=e.column)?l:0,isServer:n}})).filter((e=>void 0!==e))}function createStackFrame(e){const r=parseFile(e.get("file"));var n,o,t;if(r)return{file:r,methodName:null!=(n=e.get("methodName"))?n:"<unknown>",line:parseInt(null!=(o=e.get("lineNumber"))?o:"0",10)||0,column:parseInt(null!=(t=e.get("column"))?t:"0",10)||0,isServer:"true"===e.get("isServer")}}function findApplicableSourceMapPayload(e,r){if("sections"in r){var n;const t=null!=(n=e.line)?n:0;var o;const l=null!=(o=e.column)?o:0;let a=r.sections[0];for(let e=0;e<r.sections.length&&r.sections[e].offset.line<=t&&r.sections[e].offset.column<=l;e++)a=r.sections[e];return void 0===a?void 0:a.map}return r}async function nativeTraceSource(e){const r=decodeURIComponent(e.file);let n;try{var o;n=null==(o=(0,_nodemodule.findSourceMap)(r))?void 0:o.payload}catch(e){throw Object.defineProperty(new Error(r+": Invalid source map. Only conformant source maps can be used to find the original code.",{cause:e}),"__NEXT_ERROR_CODE",{value:"E635",enumerable:!1,configurable:!0})}if(void 0!==n){let o,p;try{o=await new _sourcemap08.SourceMapConsumer(n)}catch(e){throw Object.defineProperty(new Error(r+": Invalid source map. Only conformant source maps can be used to find the original code.",{cause:e}),"__NEXT_ERROR_CODE",{value:"E635",enumerable:!1,configurable:!0})}try{var t,l;const r=o.originalPositionFor({line:null!=(t=e.line)?t:1,column:(null!=(l=e.column)?l:1)-1});if(null===r.source)p=null;else{var a;p={originalPosition:r,sourceContent:null!=(a=o.sourceContentFor(r.source,!0))?a:null}}}finally{o.destroy()}if(null!==p){var i,u,s;const{originalPosition:r,sourceContent:o}=p,t=findApplicableSourceMapPayload(e,n);let l=!1;if(void 0===t)console.error("No applicable source map found in sections for frame",e);else{var c;const n=t.sources.indexOf(r.source);var d;l=null!=(d=null==(c=t.ignoreList)?void 0:c.includes(n))?d:shouldIgnorePath(e.file)}var m,f;return{frame:{methodName:(null==(u=e.methodName)||null==(i=u.replace("__WEBPACK_DEFAULT_EXPORT__","default"))?void 0:i.replace("__webpack_exports__.",""))||"<unknown>",column:(null!=(m=r.column)?m:0)+1,file:(null==(s=r.source)?void 0:s.startsWith("file://"))?relativeToCwd(r.source):r.source,lineNumber:null!=(f=r.line)?f:0,arguments:[],ignored:l},source:o}}}}function relativeToCwd(e){return _path.default.relative(process.cwd(),_url.default.fileURLToPath(e))}async function createOriginalStackFrame(e,r){var n;const o=null!=(n=await nativeTraceSource(r))?n:await batchedTraceSource(e,r);return o?{originalStackFrame:o.frame,originalCodeFrame:(0,_shared.getOriginalCodeFrame)(o.frame,o.source)}:null}function getOverlayMiddleware(e){return async function(r,n,o){const{pathname:t,searchParams:l}=new URL(r.url,"http://n");if("/__nextjs_original-stack-frames"===t){if("POST"!==r.method)return _middlewareresponse.middlewareResponse.badRequest(n);const o=await new Promise(((e,n)=>{let o="";r.on("data",(e=>{o+=e})),r.on("end",(()=>e(o))),r.on("error",n)})),t=createStackFrames(JSON.parse(o)),l=await Promise.all(t.map((async r=>{try{const n=await createOriginalStackFrame(e,r);return null===n?{status:"rejected",reason:"Failed to create original stack frame"}:{status:"fulfilled",value:n}}catch(e){return{status:"rejected",reason:(0,_nodeutil.inspect)(e,{colors:!1})}}})));return _middlewareresponse.middlewareResponse.json(n,l)}if("/__nextjs_launch-editor"===t){const e=createStackFrame(l);if(!e)return _middlewareresponse.middlewareResponse.badRequest(n);if(!await _promises.default.access(e.file,_promises.constants.F_OK).then((()=>!0),(()=>!1)))return _middlewareresponse.middlewareResponse.notFound(n);try{var a,i;(0,_launcheditor.launchEditor)(e.file,null!=(a=e.line)?a:1,null!=(i=e.column)?i:1)}catch(e){return console.log("Failed to launch editor:",e),_middlewareresponse.middlewareResponse.internalServerError(n)}return _middlewareresponse.middlewareResponse.noContent(n)}return o()}}function getSourceMapMiddleware(e){return async function(r,n,o){const{pathname:t,searchParams:l}=new URL(r.url,"http://n");if("/__nextjs_source-map"!==t)return o();let a=l.get("filename");if(!a)return _middlewareresponse.middlewareResponse.badRequest(n);if(a.startsWith("webpack://")||a.startsWith("webpack-internal:///")){const e=(0,_nodemodule.findSourceMap)(a);return e?_middlewareresponse.middlewareResponse.json(n,e.payload):_middlewareresponse.middlewareResponse.noContent(n)}try{a=decodeURI(a),_path.default.isAbsolute(a)&&(a=_url.default.pathToFileURL(a).href);const r=await e.getSourceMap(a);if(r)return _middlewareresponse.middlewareResponse.jsonString(n,r);if(a.startsWith("file:")){const e=await(0,_getsourcemapfromfile.getSourceMapFromFile)(a);if(e)return _middlewareresponse.middlewareResponse.json(n,e)}}catch(e){console.error("Failed to get source map:",e)}_middlewareresponse.middlewareResponse.noContent(n)}}("function"==typeof exports.default||"object"==typeof exports.default&&null!==exports.default)&&void 0===exports.default.__esModule&&(Object.defineProperty(exports.default,"__esModule",{value:!0}),Object.assign(exports.default,exports),module.exports=exports.default);