"use strict";function _export(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{createRouteLoader:function(){return createRouteLoader},getClientBuildManifest:function(){return getClientBuildManifest},isAssetError:function(){return isAssetError},markAssetError:function(){return markAssetError}});const _interop_require_default=require("@swc/helpers/_/_interop_require_default"),_getassetpathfromroute=_interop_require_default._(require("../shared/lib/router/utils/get-asset-path-from-route")),_trustedtypes=require("./trusted-types"),_requestidlecallback=require("./request-idle-callback"),_deploymentid=require("../build/deployment-id"),_encodeuripath=require("../shared/lib/encode-uri-path"),MS_MAX_IDLE_DELAY=3800;function withFuture(e,t,r){let n,o=t.get(e);if(o)return"future"in o?o.future:Promise.resolve(o);const s=new Promise((e=>{n=e}));return t.set(e,{resolve:n,future:s}),r?r().then((e=>(n(e),e))).catch((r=>{throw t.delete(e),r})):s}const ASSET_LOAD_ERROR=Symbol("ASSET_LOAD_ERROR");function markAssetError(e){return Object.defineProperty(e,ASSET_LOAD_ERROR,{})}function isAssetError(e){return e&&ASSET_LOAD_ERROR in e}function hasPrefetch(e){try{return e=document.createElement("link"),!!window.MSInputMethodContext&&!!document.documentMode||e.relList.supports("prefetch")}catch(e){return!1}}const canPrefetch=hasPrefetch(),getAssetQueryString=()=>(0,_deploymentid.getDeploymentIdQueryOrEmptyString)();function prefetchViaDom(e,t,r){return new Promise(((n,o)=>{const s='\n      link[rel="prefetch"][href^="'+e+'"],\n      link[rel="preload"][href^="'+e+'"],\n      script[src^="'+e+'"]';if(document.querySelector(s))return n();r=document.createElement("link"),t&&(r.as=t),r.rel="prefetch",r.crossOrigin=process.env.__NEXT_CROSS_ORIGIN,r.onload=n,r.onerror=()=>o(markAssetError(Object.defineProperty(new Error("Failed to prefetch: "+e),"__NEXT_ERROR_CODE",{value:"E268",enumerable:!1,configurable:!0}))),r.href=e,document.head.appendChild(r)}))}function appendScript(e,t){return new Promise(((r,n)=>{(t=document.createElement("script")).onload=r,t.onerror=()=>n(markAssetError(Object.defineProperty(new Error("Failed to load script: "+e),"__NEXT_ERROR_CODE",{value:"E74",enumerable:!1,configurable:!0}))),t.crossOrigin=process.env.__NEXT_CROSS_ORIGIN,t.src=e,document.body.appendChild(t)}))}let devBuildPromise;function resolvePromiseWithTimeout(e,t,r){return new Promise(((n,o)=>{let s=!1;e.then((e=>{s=!0,n(e)})).catch(o),"development"===process.env.NODE_ENV&&(devBuildPromise||Promise.resolve()).then((()=>{(0,_requestidlecallback.requestIdleCallback)((()=>setTimeout((()=>{s||o(r)}),t)))})),"development"!==process.env.NODE_ENV&&(0,_requestidlecallback.requestIdleCallback)((()=>setTimeout((()=>{s||o(r)}),t)))}))}function getClientBuildManifest(){if(self.__BUILD_MANIFEST)return Promise.resolve(self.__BUILD_MANIFEST);return resolvePromiseWithTimeout(new Promise((e=>{const t=self.__BUILD_MANIFEST_CB;self.__BUILD_MANIFEST_CB=()=>{e(self.__BUILD_MANIFEST),t&&t()}})),MS_MAX_IDLE_DELAY,markAssetError(Object.defineProperty(new Error("Failed to load client build manifest"),"__NEXT_ERROR_CODE",{value:"E273",enumerable:!1,configurable:!0})))}function getFilesForRoute(e,t){if("development"===process.env.NODE_ENV){const r=e+"/_next/static/chunks/pages"+(0,_encodeuripath.encodeURIPath)((0,_getassetpathfromroute.default)(t,".js"))+getAssetQueryString();return Promise.resolve({scripts:[(0,_trustedtypes.__unsafeCreateTrustedScriptURL)(r)],css:[]})}return getClientBuildManifest().then((r=>{if(!(t in r))throw markAssetError(Object.defineProperty(new Error("Failed to lookup route: "+t),"__NEXT_ERROR_CODE",{value:"E446",enumerable:!1,configurable:!0}));const n=r[t].map((t=>e+"/_next/"+(0,_encodeuripath.encodeURIPath)(t)));return{scripts:n.filter((e=>e.endsWith(".js"))).map((e=>(0,_trustedtypes.__unsafeCreateTrustedScriptURL)(e)+getAssetQueryString())),css:n.filter((e=>e.endsWith(".css"))).map((e=>e+getAssetQueryString()))}}))}function createRouteLoader(e){const t=new Map,r=new Map,n=new Map,o=new Map;function s(e){if("development"!==process.env.NODE_ENV){let t=r.get(e.toString());return t||(document.querySelector('script[src^="'+e+'"]')?Promise.resolve():(r.set(e.toString(),t=appendScript(e)),t))}return appendScript(e)}function i(e){let t=n.get(e);return t||(n.set(e,t=fetch(e,{credentials:"same-origin"}).then((t=>{if(!t.ok)throw Object.defineProperty(new Error("Failed to load stylesheet: "+e),"__NEXT_ERROR_CODE",{value:"E189",enumerable:!1,configurable:!0});return t.text().then((t=>({href:e,content:t})))})).catch((e=>{throw markAssetError(e)}))),t)}return{whenEntrypoint:e=>withFuture(e,t),onEntrypoint(e,r){(r?Promise.resolve().then((()=>r())).then((e=>({component:e&&e.default||e,exports:e})),(e=>({error:e}))):Promise.resolve(void 0)).then((r=>{const n=t.get(e);n&&"resolve"in n?r&&(t.set(e,r),n.resolve(r)):(r?t.set(e,r):t.delete(e),o.delete(e))}))},loadRoute(r,n){return withFuture(r,o,(()=>{let o;return"development"===process.env.NODE_ENV&&(devBuildPromise=new Promise((e=>{o=e}))),resolvePromiseWithTimeout(getFilesForRoute(e,r).then((e=>{let{scripts:n,css:o}=e;return Promise.all([t.has(r)?[]:Promise.all(n.map(s)),Promise.all(o.map(i))])})).then((e=>this.whenEntrypoint(r).then((t=>({entrypoint:t,styles:e[1]}))))),MS_MAX_IDLE_DELAY,markAssetError(Object.defineProperty(new Error("Route did not complete loading: "+r),"__NEXT_ERROR_CODE",{value:"E12",enumerable:!1,configurable:!0}))).then((e=>{let{entrypoint:t,styles:r}=e;const n=Object.assign({styles:r},t);return"error"in t?t:n})).catch((e=>{if(n)throw e;return{error:e}})).finally((()=>null==o?void 0:o()))}))},prefetch(t){let r;return(r=navigator.connection)&&(r.saveData||/2g/.test(r.effectiveType))?Promise.resolve():getFilesForRoute(e,t).then((e=>Promise.all(canPrefetch?e.scripts.map((e=>prefetchViaDom(e.toString(),"script"))):[]))).then((()=>{(0,_requestidlecallback.requestIdleCallback)((()=>this.loadRoute(t,!0).catch((()=>{}))))})).catch((()=>{}))}}}("function"==typeof exports.default||"object"==typeof exports.default&&null!==exports.default)&&void 0===exports.default.__esModule&&(Object.defineProperty(exports.default,"__esModule",{value:!0}),Object.assign(exports.default,exports),module.exports=exports.default);