"use strict";function _export(e,r){for(var t in r)Object.defineProperty(e,t,{enumerable:!0,get:r[t]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{getUtils:function(){return getUtils},interpolateDynamicPath:function(){return interpolateDynamicPath},normalizeDynamicRouteParams:function(){return normalizeDynamicRouteParams},normalizeVercelUrl:function(){return normalizeVercelUrl}});const _url=require("url"),_normalizelocalepath=require("../shared/lib/i18n/normalize-locale-path"),_pathmatch=require("../shared/lib/router/utils/path-match"),_routeregex=require("../shared/lib/router/utils/route-regex"),_routematcher=require("../shared/lib/router/utils/route-matcher"),_preparedestination=require("../shared/lib/router/utils/prepare-destination"),_removetrailingslash=require("../shared/lib/router/utils/remove-trailing-slash"),_apppaths=require("../shared/lib/router/utils/app-paths"),_constants=require("../lib/constants"),_utils=require("./web/utils");function normalizeVercelUrl(e,r,t){const a=(0,_url.parse)(e.url,!0);delete a.search;for(const e of Object.keys(a.query)){const n=e!==_constants.NEXT_QUERY_PARAM_PREFIX&&e.startsWith(_constants.NEXT_QUERY_PARAM_PREFIX),o=e!==_constants.NEXT_INTERCEPTION_MARKER_PREFIX&&e.startsWith(_constants.NEXT_INTERCEPTION_MARKER_PREFIX);(n||o||r.includes(e)||t&&Object.keys(t.groups).includes(e))&&delete a.query[e]}e.url=(0,_url.format)(a)}function interpolateDynamicPath(e,r,t){if(!t)return e;for(const a of Object.keys(t.groups)){const{optional:n,repeat:o}=t.groups[a];let s,i=`[${o?"...":""}${a}]`;n&&(i=`[${i}]`);const l=r[a];s=Array.isArray(l)?l.map((e=>e&&encodeURIComponent(e))).join("/"):l?encodeURIComponent(l):"",e=e.replaceAll(i,s)}return e}function normalizeDynamicRouteParams(e,r,t,a){let n=!0,o={};for(const n of Object.keys(r.groups)){let s=e[n];"string"==typeof s?s=(0,_apppaths.normalizeRscURL)(s):Array.isArray(s)&&(s=s.map(_apppaths.normalizeRscURL));const i=t[n],l=r.groups[n].optional;if((Array.isArray(i)?i.some((e=>Array.isArray(s)?s.some((r=>r.includes(e))):null==s?void 0:s.includes(e))):null==s?void 0:s.includes(i))||void 0===s&&(!l||!a))return{params:{},hasValidParams:!1};!l||s&&(!Array.isArray(s)||1!==s.length||"index"!==s[0]&&s[0]!==`[[...${n}]]`)||(s=void 0,delete e[n]),s&&"string"==typeof s&&r.groups[n].repeat&&(s=s.split("/")),s&&(o[n]=s)}return{params:o,hasValidParams:n}}function getUtils({page:e,i18n:r,basePath:t,rewrites:a,pageIsDynamic:n,trailingSlash:o,caseSensitive:s}){let i,l,u;function c(i,u){const c={};let m=u.pathname;const p=()=>{const r=(0,_removetrailingslash.removeTrailingSlash)(m||"");return r===(0,_removetrailingslash.removeTrailingSlash)(e)||(null==l?void 0:l(r))},h=a=>{const p=(0,_pathmatch.getPathMatch)(a.source+(o?"(/)?":""),{removeUnnamedParams:!0,strict:!0,sensitive:!!s});if(!u.pathname)return!1;let h=p(u.pathname);if((a.has||a.missing)&&h){const e=(0,_preparedestination.matchHas)(i,u.query,a.has,a.missing);e?Object.assign(h,e):h=!1}if(h){const{parsedDestination:o,destQuery:s}=(0,_preparedestination.prepareDestination)({appendParamsToQuery:!0,destination:a.destination,params:h,query:u.query});if(o.protocol)return!0;if(Object.assign(c,s,h),Object.assign(u.query,o.query),delete o.query,Object.assign(u,o),m=u.pathname,!m)return!1;if(t&&(m=m.replace(new RegExp(`^${t}`),"")||"/"),r){const e=(0,_normalizelocalepath.normalizeLocalePath)(m,r.locales);m=e.pathname,u.query.nextInternalLocale=e.detectedLocale||h.nextInternalLocale}if(m===e)return!0;if(n&&l){const e=l(m);if(e)return u.query={...u.query,...e},!0}}return!1};for(const e of a.beforeFiles||[])h(e);if(m!==e){let e=!1;for(const r of a.afterFiles||[])if(e=h(r),e)break;if(!e&&!p())for(const r of a.fallback||[])if(e=h(r),e)break}return c}function m(e){if(!i)return null;const{groups:r,routeKeys:t}=i,a=(0,_routematcher.getRouteMatcher)({re:{exec:e=>{const a=Object.fromEntries(new URLSearchParams(e));for(const[e,r]of Object.entries(a)){const t=(0,_utils.normalizeNextQueryParam)(e);t&&(a[t]=r,delete a[e])}const n={};for(const e of Object.keys(t)){const o=t[e];if(!o)continue;const s=r[o],i=a[e];if(!s.optional&&!i)return null;n[s.pos]=i}return n}},groups:r})(e);return a||null}return n&&(i=(0,_routeregex.getNamedRouteRegex)(e,{prefixRouteKeys:!1}),l=(0,_routematcher.getRouteMatcher)(i),u=l(e)),{handleRewrites:c,defaultRouteRegex:i,dynamicRouteMatcher:l,defaultRouteMatches:u,getParamsFromRouteMatches:m,normalizeDynamicRouteParams:(e,r)=>i&&u?normalizeDynamicRouteParams(e,i,u,r):{params:{},hasValidParams:!1},normalizeVercelUrl:(e,r)=>normalizeVercelUrl(e,r,i),interpolateDynamicPath:(e,r)=>interpolateDynamicPath(e,r,i)}}