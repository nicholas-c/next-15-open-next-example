"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"createTSPlugin",{enumerable:!0,get:function(){return createTSPlugin}});const _utils=require("./utils"),_constant=require("./constant"),_config=_interop_require_default(require("./rules/config")),_server=_interop_require_default(require("./rules/server")),_entry=_interop_require_default(require("./rules/entry")),_clientboundary=_interop_require_default(require("./rules/client-boundary")),_serverboundary=_interop_require_default(require("./rules/server-boundary")),_metadata=_interop_require_default(require("./rules/metadata")),_error=_interop_require_default(require("./rules/error"));function _interop_require_default(t){return t&&t.__esModule?t:{default:t}}const createTSPlugin=({typescript:t})=>{function e(e){(0,_utils.init)({ts:t,info:e});const i=Object.create(null);for(let t of Object.keys(e.languageService)){const n=e.languageService[t];i[t]=(...t)=>n.apply(e.languageService,t)}return(e.config??{enabled:!0}).enabled?(i.getCompletionsAtPosition=(i,n,r)=>{let o=e.languageService.getCompletionsAtPosition(i,n,r)||{isGlobalCompletion:!1,isMemberCompletion:!1,isNewIdentifierLocation:!1,entries:[]};if(!(0,_utils.isAppEntryFile)(i))return o;(0,_utils.getEntryInfo)(i).client||(o.entries=_server.default.filterCompletionsAtPosition(o.entries),o=_metadata.default.filterCompletionsAtPosition(i,n,r,o)),_config.default.addCompletionsAtPosition(i,n,o);const a=(0,_utils.getSource)(i);return a?(t.forEachChild(a,(t=>{(0,_utils.isPositionInsideNode)(n,t)&&(0,_utils.isDefaultFunctionExport)(t)&&o.entries.push(..._entry.default.getCompletionsAtPosition(i,t,n))})),o):o},i.getCompletionEntryDetails=(t,i,n,r,o,a,s)=>{const u=_config.default.getCompletionEntryDetails(n,s);if(u)return u;const l=_metadata.default.getCompletionEntryDetails(t,i,n,r,o,a,s);return l||e.languageService.getCompletionEntryDetails(t,i,n,r,o,a,s)},i.getQuickInfoAtPosition=(t,i)=>{const n=e.languageService.getQuickInfoAtPosition(t,i);if(!(0,_utils.isAppEntryFile)(t))return n;if(!(0,_utils.getEntryInfo)(t).client){const n=e.languageService.getDefinitionAtPosition(t,i);if(n&&_server.default.hasDisallowedReactAPIDefinition(n))return;const r=_metadata.default.getQuickInfoAtPosition(t,i);if(r)return r}const r=_config.default.getQuickInfoAtPosition(t,i);return r||n},i.getSemanticDiagnostics=i=>{const n=e.languageService.getSemanticDiagnostics(i),r=(0,_utils.getSource)(i);if(!r)return n;let o=!1,a=!1;const s=(0,_utils.isAppEntryFile)(i);try{const t=(0,_utils.getEntryInfo)(i,!0);o=t.client,a=t.server}catch(e){n.push({file:r,category:t.DiagnosticCategory.Error,code:_constant.NEXT_TS_ERRORS.MISPLACED_ENTRY_DIRECTIVE,...e}),o=!1,a=!1}if((0,_utils.isInsideApp)(i)){const t=_error.default.getSemanticDiagnostics(r,o);n.push(...t)}return t.forEachChild(r,(e=>{var u,l;if(t.isImportDeclaration(e)){if(s&&(!o||a)){const t=_server.default.getSemanticDiagnosticsForImportDeclaration(r,e);n.push(...t)}}else if(t.isVariableStatement(e)&&(null==(u=e.modifiers)?void 0:u.some((e=>e.kind===t.SyntaxKind.ExportKeyword)))){if(s){const t=_config.default.getSemanticDiagnosticsForExportVariableStatement(r,e),a=o?_metadata.default.getSemanticDiagnosticsForExportVariableStatementInClientEntry(i,e):_metadata.default.getSemanticDiagnosticsForExportVariableStatement(i,e);n.push(...t,...a)}o&&n.push(..._clientboundary.default.getSemanticDiagnosticsForExportVariableStatement(r,e)),a&&n.push(..._serverboundary.default.getSemanticDiagnosticsForExportVariableStatement(r,e))}else if((0,_utils.isDefaultFunctionExport)(e)){if(s){const t=_entry.default.getSemanticDiagnostics(i,r,e);n.push(...t)}o&&n.push(..._clientboundary.default.getSemanticDiagnosticsForFunctionExport(r,e)),a&&n.push(..._serverboundary.default.getSemanticDiagnosticsForFunctionExport(r,e))}else if(t.isFunctionDeclaration(e)&&(null==(l=e.modifiers)?void 0:l.some((e=>e.kind===t.SyntaxKind.ExportKeyword)))){if(s){const t=o?_metadata.default.getSemanticDiagnosticsForExportVariableStatementInClientEntry(i,e):_metadata.default.getSemanticDiagnosticsForExportVariableStatement(i,e);n.push(...t)}o&&n.push(..._clientboundary.default.getSemanticDiagnosticsForFunctionExport(r,e)),a&&n.push(..._serverboundary.default.getSemanticDiagnosticsForFunctionExport(r,e))}else if(t.isExportDeclaration(e)){if(s){const t=o?_metadata.default.getSemanticDiagnosticsForExportDeclarationInClientEntry(i,e):_metadata.default.getSemanticDiagnosticsForExportDeclaration(i,e);n.push(...t)}a&&n.push(..._serverboundary.default.getSemanticDiagnosticsForExportDeclaration(r,e))}})),n},i.getDefinitionAndBoundSpan=(t,i)=>{const n=(0,_utils.getEntryInfo)(t);if((0,_utils.isAppEntryFile)(t)&&!n.client){const e=_metadata.default.getDefinitionAndBoundSpan(t,i);if(e)return e}return e.languageService.getDefinitionAndBoundSpan(t,i)},i):i}return{create:e}};