"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return _default}});const _constant=require("../constant"),_utils=require("../utils"),TYPE_ANNOTATION=": Metadata | null",TYPE_ANNOTATION_ASYNC=": Promise<Metadata | null>",TYPE_IMPORT="\n\nimport type { Metadata } from 'next'";function getMetadataExport(e,t){const i=(0,_utils.getSource)(e);let a;if(i){const e=(0,_utils.getTs)();e.forEachChild(i,(function(i){var n;if(!a&&((0,_utils.isPositionInsideNode)(t,i)&&e.isVariableStatement(i)&&(null==(n=i.modifiers)?void 0:n.some((t=>t.kind===e.SyntaxKind.ExportKeyword)))&&e.isVariableDeclarationList(i.declarationList)))for(const e of i.declarationList.declarations)if((0,_utils.isPositionInsideNode)(t,e)&&"metadata"===e.name.getText())return void(a=e)}))}return a}let cachedProxiedLanguageService,cachedProxiedLanguageServiceHost;function getProxiedLanguageService(){if(cachedProxiedLanguageService)return{languageService:cachedProxiedLanguageService,languageServiceHost:cachedProxiedLanguageServiceHost};const e=(0,_utils.getInfo)().languageServiceHost,t=(0,_utils.getTs)();class i{getScriptFileNames(){const t=new Set;for(var i in this.files)this.files.hasOwnProperty(i)&&t.add(i);const a=e.getScriptFileNames();for(const e of a)t.add(e);return[...t]}addFile(e,i){const a=t.ScriptSnapshot.fromString(i);a.getChangeRange=e=>{};this.files[e]?(this.files[e].ver++,this.files[e].file=a):this.files[e]={ver:1,file:a}}readFile(t){const i=this.files[t];return i?i.file.getText(0,i.file.getLength()):e.readFile(t)}fileExists(t){return void 0!==this.files[t]||e.fileExists(t)}constructor(){this.files={},this.log=()=>{},this.trace=()=>{},this.error=()=>{},this.getCompilationSettings=()=>e.getCompilationSettings(),this.getScriptIsOpen=()=>!0,this.getCurrentDirectory=()=>e.getCurrentDirectory(),this.getDefaultLibFileName=t=>e.getDefaultLibFileName(t),this.getScriptVersion=t=>{const i=this.files[t];return i?i.ver.toString():e.getScriptVersion(t)},this.getScriptSnapshot=t=>{const i=this.files[t];return i?i.file:e.getScriptSnapshot(t)}}}return cachedProxiedLanguageServiceHost=new i,cachedProxiedLanguageService=t.createLanguageService(cachedProxiedLanguageServiceHost,t.createDocumentRegistry()),{languageService:cachedProxiedLanguageService,languageServiceHost:cachedProxiedLanguageServiceHost}}function updateVirtualFileWithType(e,t,i){const a=(0,_utils.getSource)(e);if(!a)return;const n=a.getFullText();let r,o;const s=(0,_utils.getTs)();if(s.isFunctionDeclaration(t)){if(!i)return;var c;r=t.body.getFullStart();o=(null==(c=t.modifiers)?void 0:c.some((e=>e.kind===s.SyntaxKind.AsyncKeyword)))?TYPE_ANNOTATION_ASYNC:TYPE_ANNOTATION}else r=t.name.getFullStart()+t.name.getFullWidth(),o=TYPE_ANNOTATION;const l=n.slice(0,r)+o+n.slice(r)+TYPE_IMPORT,{languageServiceHost:g}=getProxiedLanguageService();return g.addFile(e,l),[r,o.length]}function isTyped(e){return void 0!==e.type}function proxyDiagnostics(e,t,i){const{languageService:a}=getProxiedLanguageService(),n=a.getSemanticDiagnostics(e),r=(0,_utils.getSource)(e);return n.filter((e=>void 0!==e.start&&void 0!==e.length&&(!(e.start<i.getFullStart())&&!(e.start+e.length>=i.getFullStart()+i.getFullWidth()+t[1])))).map((e=>({file:r,category:e.category,code:e.code,messageText:e.messageText,start:e.start<t[0]?e.start:e.start-t[1],length:e.length})))}const metadata={filterCompletionsAtPosition(e,t,i,a){const n=getMetadataExport(e,t);if(!n)return a;if(isTyped(n))return a;const r=(0,_utils.getTs)(),o=updateVirtualFileWithType(e,n);if(void 0===o)return a;const{languageService:s}=getProxiedLanguageService(),c=t<=o[0]?t:t+o[1],l=s.getCompletionsAtPosition(e,c,void 0);return l?(l.isIncomplete=!0,l.entries=l.entries.filter((e=>[r.ScriptElementKind.memberVariableElement,r.ScriptElementKind.typeElement,r.ScriptElementKind.string].includes(e.kind))).map((e=>{const t=e.kind===r.ScriptElementKind.memberVariableElement&&/^[a-zA-Z0-9_]+$/.test(e.name)?e.name+": ":e.name;return{name:e.name,insertText:t,kind:e.kind,kindModifiers:e.kindModifiers,sortText:"!"+e.name,labelDetails:{description:"Next.js metadata"},data:e.data}})),l):a},getSemanticDiagnosticsForExportVariableStatementInClientEntry(e,t){const i=(0,_utils.getSource)(e),a=(0,_utils.getTs)();var n;if(a.isFunctionDeclaration(t)){if("generateMetadata"===(null==(n=t.name)?void 0:n.getText()))return[{file:i,category:a.DiagnosticCategory.Error,code:_constant.NEXT_TS_ERRORS.INVALID_METADATA_EXPORT,messageText:"The Next.js 'generateMetadata' API is not allowed in a client component.",start:t.name.getStart(),length:t.name.getWidth()}]}else for(const e of t.declarationList.declarations){if("metadata"===e.name.getText())return[{file:i,category:a.DiagnosticCategory.Error,code:_constant.NEXT_TS_ERRORS.INVALID_METADATA_EXPORT,messageText:"The Next.js 'metadata' API is not allowed in a client component.",start:e.name.getStart(),length:e.name.getWidth()}]}return[]},getSemanticDiagnosticsForExportVariableStatement(e,t){var i;if((0,_utils.getTs)().isFunctionDeclaration(t)){if("generateMetadata"===(null==(i=t.name)?void 0:i.getText())){if(isTyped(t))return[];const i=updateVirtualFileWithType(e,t,!0);return i?proxyDiagnostics(e,i,t):[]}}else for(const i of t.declarationList.declarations)if("metadata"===i.name.getText()){if(isTyped(i))break;const t=updateVirtualFileWithType(e,i);if(!t)break;return proxyDiagnostics(e,t,i)}return[]},getSemanticDiagnosticsForExportDeclarationInClientEntry(e,t){const i=(0,_utils.getTs)(),a=(0,_utils.getSource)(e),n=[],r=t.exportClause;if(r&&i.isNamedExports(r))for(const e of r.elements)["generateMetadata","metadata"].includes(e.name.getText())&&n.push({file:a,category:i.DiagnosticCategory.Error,code:_constant.NEXT_TS_ERRORS.INVALID_METADATA_EXPORT,messageText:`The Next.js '${e.name.getText()}' API is not allowed in a client component.`,start:e.name.getStart(),length:e.name.getWidth()});return n},getSemanticDiagnosticsForExportDeclaration(e,t){const i=(0,_utils.getTs)(),a=t.exportClause;if(a&&i.isNamedExports(a))for(const t of a.elements)if("metadata"===t.name.getText()){const a=(0,_utils.getTypeChecker)();if(a){const n=a.getSymbolAtLocation(t.name);if(n){const r=a.getAliasedSymbol(n);if(r&&r.declarations){const a=r.declarations[0];if(a&&i.isVariableDeclaration(a)){if(isTyped(a))break;const n=a.getSourceFile().fileName,r=n===e,o=updateVirtualFileWithType(n,a);if(!o)break;const s=proxyDiagnostics(n,o,a);if(s.length)return r?s:[{file:(0,_utils.getSource)(e),category:i.DiagnosticCategory.Error,code:_constant.NEXT_TS_ERRORS.INVALID_METADATA_EXPORT,messageText:"The 'metadata' export value is not typed correctly, please make sure it is typed as 'Metadata':\nhttps://nextjs.org/docs/app/building-your-application/optimizing/metadata#static-metadata",start:t.name.getStart(),length:t.name.getWidth()}]}}}}}return[]},getCompletionEntryDetails(e,t,i,a,n,r,o){const s=getMetadataExport(e,t);if(!s)return;if(isTyped(s))return;const c=updateVirtualFileWithType(e,s);if(void 0===c)return;const{languageService:l}=getProxiedLanguageService(),g=t<=c[0]?t:t+c[1];return l.getCompletionEntryDetails(e,g,i,a,n,r,o)},getQuickInfoAtPosition(e,t){const i=getMetadataExport(e,t);if(!i)return;if(isTyped(i))return;const a=updateVirtualFileWithType(e,i);if(void 0===a)return;const{languageService:n}=getProxiedLanguageService(),r=t<=a[0]?t:t+a[1];return n.getQuickInfoAtPosition(e,r)},getDefinitionAndBoundSpan(e,t){const i=getMetadataExport(e,t);if(!i)return;if(isTyped(i))return;if(!(0,_utils.isPositionInsideNode)(t,i))return;const a=updateVirtualFileWithType(e,i);if(void 0===a)return;const{languageService:n}=getProxiedLanguageService(),r=t<=a[0]?t:t+a[1],o=n.getDefinitionAndBoundSpan(e,r);return o&&o.textSpan.start>a[0]&&(o.textSpan.start-=a[1]),o}},_default=metadata;