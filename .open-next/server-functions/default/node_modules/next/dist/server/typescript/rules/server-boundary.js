"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return _default}});const _constant=require("../constant"),_utils=require("../utils");function isPromiseType(t,e){const n=t;return!!n.target&&!!/^Promise(<.+>)?$/.test(e.typeToString(n.target))}function isFunctionReturningPromise(t,e,n){const r=e.getTypeAtLocation(t),s=e.getSignaturesOfType(r,n.SignatureKind.Call);let i=!0;if(s.length)for(const t of s){const n=t.getReturnType();if(n.isUnion()){for(const t of n.types)if(!isPromiseType(t,e)){i=!1;break}}else i=isPromiseType(n,e)}else i=!1;return i}const serverBoundary={getSemanticDiagnosticsForExportDeclaration(t,e){const n=(0,_utils.getTs)(),r=(0,_utils.getTypeChecker)();if(!r)return[];const s=[],i=e.exportClause;if(!e.isTypeOnly&&i&&n.isNamedExports(i))for(const e of i.elements)e.isTypeOnly||isFunctionReturningPromise(e,r,n)||s.push({file:t,category:n.DiagnosticCategory.Error,code:_constant.NEXT_TS_ERRORS.INVALID_SERVER_ENTRY_RETURN,messageText:'The "use server" file can only export async functions.',start:e.getStart(),length:e.getWidth()});return s},getSemanticDiagnosticsForExportVariableStatement(t,e){const n=(0,_utils.getTs)(),r=[];if(n.isVariableDeclarationList(e.declarationList))for(const s of e.declarationList.declarations){const e=s.initializer;e&&(n.isArrowFunction(e)||n.isFunctionDeclaration(e)||n.isFunctionExpression(e)||n.isCallExpression(e)||n.isIdentifier(e))?r.push(...serverBoundary.getSemanticDiagnosticsForFunctionExport(t,e)):r.push({file:t,category:n.DiagnosticCategory.Error,code:_constant.NEXT_TS_ERRORS.INVALID_SERVER_ENTRY_RETURN,messageText:'The "use server" file can only export async functions.',start:s.getStart(),length:s.getWidth()})}return r},getSemanticDiagnosticsForFunctionExport(t,e){const n=(0,_utils.getTs)(),r=(0,_utils.getTypeChecker)();if(!r)return[];const s=[];return isFunctionReturningPromise(e,r,n)||s.push({file:t,category:n.DiagnosticCategory.Error,code:_constant.NEXT_TS_ERRORS.INVALID_SERVER_ENTRY_RETURN,messageText:'The "use server" file can only export async functions. Add "async" to the function declaration or return a Promise.',start:e.getStart(),length:e.getWidth()}),s}},_default=serverBoundary;