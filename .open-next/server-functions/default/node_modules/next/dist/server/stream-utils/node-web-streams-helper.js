"use strict";function _export(e,r){for(var t in r)Object.defineProperty(e,t,{enumerable:!0,get:r[t]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{chainStreams:function(){return chainStreams},continueDynamicHTMLResume:function(){return continueDynamicHTMLResume},continueDynamicPrerender:function(){return continueDynamicPrerender},continueFizzStream:function(){return continueFizzStream},continueStaticPrerender:function(){return continueStaticPrerender},createBufferedTransformStream:function(){return createBufferedTransformStream},createDocumentClosingStream:function(){return createDocumentClosingStream},createRootLayoutValidatorStream:function(){return createRootLayoutValidatorStream},renderToInitialFizzStream:function(){return renderToInitialFizzStream},streamFromBuffer:function(){return streamFromBuffer},streamFromString:function(){return streamFromString},streamToBuffer:function(){return streamToBuffer},streamToString:function(){return streamToString}});const _tracer=require("../lib/trace/tracer"),_constants=require("../lib/trace/constants"),_detachedpromise=require("../../lib/detached-promise"),_scheduler=require("../../lib/scheduler"),_encodedTags=require("./encodedTags"),_uint8arrayhelpers=require("./uint8array-helpers");function voidCatch(){}const encoder=new TextEncoder;function chainStreams(...e){if(0===e.length)throw Object.defineProperty(new Error("Invariant: chainStreams requires at least one stream"),"__NEXT_ERROR_CODE",{value:"E437",enumerable:!1,configurable:!0});if(1===e.length)return e[0];const{readable:r,writable:t}=new TransformStream;let n=e[0].pipeTo(t,{preventClose:!0}),a=1;for(;a<e.length-1;a++){const r=e[a];n=n.then((()=>r.pipeTo(t,{preventClose:!0})))}const o=e[a];return n=n.then((()=>o.pipeTo(t))),n.catch(voidCatch),r}function streamFromString(e){return new ReadableStream({start(r){r.enqueue(encoder.encode(e)),r.close()}})}function streamFromBuffer(e){return new ReadableStream({start(r){r.enqueue(e),r.close()}})}async function streamToBuffer(e){const r=e.getReader(),t=[];for(;;){const{done:e,value:n}=await r.read();if(e)break;t.push(n)}return Buffer.concat(t)}async function streamToString(e,r){const t=new TextDecoder("utf-8",{fatal:!0});let n="";for await(const a of e){if(null==r?void 0:r.aborted)return n;n+=t.decode(a,{stream:!0})}return n+=t.decode(),n}function createBufferedTransformStream(){let e,r=[],t=0;const n=n=>{if(e)return;const a=new _detachedpromise.DetachedPromise;e=a,(0,_scheduler.scheduleImmediate)((()=>{try{const e=new Uint8Array(t);let a=0;for(let t=0;t<r.length;t++){const n=r[t];e.set(n,a),a+=n.byteLength}r.length=0,t=0,n.enqueue(e)}catch{}finally{e=void 0,a.resolve()}}))};return new TransformStream({transform(e,a){r.push(e),t+=e.byteLength,n(a)},flush(){if(e)return e.promise}})}function renderToInitialFizzStream({ReactDOMServer:e,element:r,streamOptions:t}){return(0,_tracer.getTracer)().trace(_constants.AppRenderSpan.renderToReadableStream,(async()=>e.renderToReadableStream(r,t)))}function createHeadInsertionTransformStream(e){let r=!1,t=!1;return new TransformStream({async transform(n,a){t=!0;const o=await e();if(r){if(o){const e=encoder.encode(o);a.enqueue(e)}a.enqueue(n)}else{const e=(0,_uint8arrayhelpers.indexOfUint8Array)(n,_encodedTags.ENCODED_TAGS.CLOSED.HEAD);if(-1!==e){if(o){const r=encoder.encode(o),t=new Uint8Array(n.length+r.length);t.set(n.slice(0,e)),t.set(r,e),t.set(n.slice(e),e+r.length),a.enqueue(t)}else a.enqueue(n);r=!0}else o&&a.enqueue(encoder.encode(o)),a.enqueue(n),r=!0}},async flush(r){if(t){const t=await e();t&&r.enqueue(encoder.encode(t))}}})}function createDeferredSuffixStream(e){let r,t=!1;const n=t=>{const n=new _detachedpromise.DetachedPromise;r=n,(0,_scheduler.scheduleImmediate)((()=>{try{t.enqueue(encoder.encode(e))}catch{}finally{r=void 0,n.resolve()}}))};return new TransformStream({transform(e,r){r.enqueue(e),t||(t=!0,n(r))},flush(n){if(r)return r.promise;t||n.enqueue(encoder.encode(e))}})}function createMergedTransformStream(e){let r=null,t=!1;async function n(n){if(r)return;const a=e.getReader();await(0,_scheduler.atLeastOneTask)();try{for(;;){const{done:e,value:r}=await a.read();if(e)return void(t=!0);n.enqueue(r)}}catch(e){n.error(e)}}return new TransformStream({transform(e,t){t.enqueue(e),r||(r=n(t))},flush(e){if(!t)return r||n(e)}})}const CLOSE_TAG="</body></html>";function createMoveSuffixStream(){let e=!1;return new TransformStream({transform(r,t){if(e)return t.enqueue(r);const n=(0,_uint8arrayhelpers.indexOfUint8Array)(r,_encodedTags.ENCODED_TAGS.CLOSED.BODY_AND_HTML);if(n>-1){if(e=!0,r.length===_encodedTags.ENCODED_TAGS.CLOSED.BODY_AND_HTML.length)return;const a=r.slice(0,n);if(t.enqueue(a),r.length>_encodedTags.ENCODED_TAGS.CLOSED.BODY_AND_HTML.length+n){const e=r.slice(n+_encodedTags.ENCODED_TAGS.CLOSED.BODY_AND_HTML.length);t.enqueue(e)}}else t.enqueue(r)},flush(e){e.enqueue(_encodedTags.ENCODED_TAGS.CLOSED.BODY_AND_HTML)}})}function createStripDocumentClosingTagsTransform(){return new TransformStream({transform(e,r){(0,_uint8arrayhelpers.isEquivalentUint8Arrays)(e,_encodedTags.ENCODED_TAGS.CLOSED.BODY_AND_HTML)||(0,_uint8arrayhelpers.isEquivalentUint8Arrays)(e,_encodedTags.ENCODED_TAGS.CLOSED.BODY)||(0,_uint8arrayhelpers.isEquivalentUint8Arrays)(e,_encodedTags.ENCODED_TAGS.CLOSED.HTML)||(e=(0,_uint8arrayhelpers.removeFromUint8Array)(e,_encodedTags.ENCODED_TAGS.CLOSED.BODY),e=(0,_uint8arrayhelpers.removeFromUint8Array)(e,_encodedTags.ENCODED_TAGS.CLOSED.HTML),r.enqueue(e))}})}function createRootLayoutValidatorStream(){let e=!1,r=!1;return new TransformStream({async transform(t,n){!e&&(0,_uint8arrayhelpers.indexOfUint8Array)(t,_encodedTags.ENCODED_TAGS.OPENING.HTML)>-1&&(e=!0),!r&&(0,_uint8arrayhelpers.indexOfUint8Array)(t,_encodedTags.ENCODED_TAGS.OPENING.BODY)>-1&&(r=!0),n.enqueue(t)},flush(t){const n=[];e||n.push("html"),r||n.push("body"),n.length&&t.enqueue(encoder.encode(`<script>self.__next_root_layout_missing_tags=${JSON.stringify(n)}<\/script>`))}})}function chainTransformers(e,r){let t=e;for(const e of r)e&&(t=t.pipeThrough(e));return t}async function continueFizzStream(e,{suffix:r,inlinedDataStream:t,isStaticGeneration:n,getServerInsertedHTML:a,getServerInsertedMetadata:o,validateRootLayout:i}){const u=r?r.split(CLOSE_TAG,1)[0]:null;return n&&"allReady"in e&&await e.allReady,chainTransformers(e,[createBufferedTransformStream(),createHeadInsertionTransformStream(o),null!=u&&u.length>0?createDeferredSuffixStream(u):null,t?createMergedTransformStream(t):null,i?createRootLayoutValidatorStream():null,createMoveSuffixStream(),createHeadInsertionTransformStream(a)])}async function continueDynamicPrerender(e,{getServerInsertedHTML:r,getServerInsertedMetadata:t}){return e.pipeThrough(createBufferedTransformStream()).pipeThrough(createStripDocumentClosingTagsTransform()).pipeThrough(createHeadInsertionTransformStream(r)).pipeThrough(createHeadInsertionTransformStream(t))}async function continueStaticPrerender(e,{inlinedDataStream:r,getServerInsertedHTML:t,getServerInsertedMetadata:n}){return e.pipeThrough(createBufferedTransformStream()).pipeThrough(createHeadInsertionTransformStream(t)).pipeThrough(createHeadInsertionTransformStream(n)).pipeThrough(createMergedTransformStream(r)).pipeThrough(createMoveSuffixStream())}async function continueDynamicHTMLResume(e,{inlinedDataStream:r,getServerInsertedHTML:t,getServerInsertedMetadata:n}){return e.pipeThrough(createBufferedTransformStream()).pipeThrough(createHeadInsertionTransformStream(t)).pipeThrough(createHeadInsertionTransformStream(n)).pipeThrough(createMergedTransformStream(r)).pipeThrough(createMoveSuffixStream())}function createDocumentClosingStream(){return streamFromString(CLOSE_TAG)}