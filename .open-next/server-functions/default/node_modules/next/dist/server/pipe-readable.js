"use strict";function _export(e,r){for(var t in r)Object.defineProperty(e,t,{enumerable:!0,get:r[t]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{isAbortError:function(){return isAbortError},pipeToNodeResponse:function(){return pipeToNodeResponse}});const _nextrequest=require("./web/spec-extension/adapters/next-request"),_detachedpromise=require("../lib/detached-promise"),_tracer=require("./lib/trace/tracer"),_constants=require("./lib/trace/constants"),_clientcomponentrendererlogger=require("./client-component-renderer-logger");function isAbortError(e){return"AbortError"===(null==e?void 0:e.name)||(null==e?void 0:e.name)===_nextrequest.ResponseAbortedName}function createWriterFromResponse(e,r){let t=!1,n=new _detachedpromise.DetachedPromise;function o(){n.resolve()}e.on("drain",o),e.once("close",(()=>{e.off("drain",o),n.resolve()}));const s=new _detachedpromise.DetachedPromise;return e.once("finish",(()=>{s.resolve()})),new WritableStream({write:async r=>{if(!t){if(t=!0,"performance"in globalThis&&process.env.NEXT_OTEL_PERFORMANCE_PREFIX){const e=(0,_clientcomponentrendererlogger.getClientComponentLoaderMetrics)();e&&performance.measure(`${process.env.NEXT_OTEL_PERFORMANCE_PREFIX}:next-client-component-loading`,{start:e.clientComponentLoadStart,end:e.clientComponentLoadStart+e.clientComponentLoadTimes})}e.flushHeaders(),(0,_tracer.getTracer)().trace(_constants.NextNodeServerSpan.startResponse,{spanName:"start response"},(()=>{}))}try{const t=e.write(r);"flush"in e&&"function"==typeof e.flush&&e.flush(),t||(await n.promise,n=new _detachedpromise.DetachedPromise)}catch(r){throw e.end(),Object.defineProperty(new Error("failed to write chunk to response",{cause:r}),"__NEXT_ERROR_CODE",{value:"E321",enumerable:!1,configurable:!0})}},abort:r=>{e.writableFinished||e.destroy(r)},close:async()=>{if(r&&await r,!e.writableFinished)return e.end(),s.promise}})}async function pipeToNodeResponse(e,r,t){try{const{errored:n,destroyed:o}=r;if(n||o)return;const s=(0,_nextrequest.createAbortController)(r),i=createWriterFromResponse(r,t);await e.pipeTo(i,{signal:s.signal})}catch(e){if(isAbortError(e))return;throw Object.defineProperty(new Error("failed to pipe response",{cause:e}),"__NEXT_ERROR_CODE",{value:"E180",enumerable:!1,configurable:!0})}}