"use strict";function _export(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{propagateServerField:function(){return propagateServerField},setupDevBundler:function(){return setupDevBundler}});const _getpagestaticinfo=require("../../../build/analysis/get-page-static-info"),_swc=require("../../../build/swc"),_fs=_interop_require_default(require("fs")),_promises=require("fs/promises"),_url=_interop_require_default(require("url")),_path=_interop_require_default(require("path")),_querystring=_interop_require_default(require("querystring")),_watchpack=_interop_require_default(require("next/dist/compiled/watchpack")),_env=require("@next/env"),_findup=_interop_require_default(require("next/dist/compiled/find-up")),_filesystem=require("./filesystem"),_log=_interop_require_wildcard(require("../../../build/output/log")),_hotreloaderwebpack=_interop_require_default(require("../../dev/hot-reloader-webpack")),_shared=require("../../../trace/shared"),_loadjsconfig=_interop_require_default(require("../../../build/load-jsconfig")),_findpagefile=require("../find-page-file"),_events=require("../../../telemetry/events"),_defineenvplugin=require("../../../build/webpack/plugins/define-env-plugin"),_utils=require("../../../shared/lib/router/utils"),_entries=require("../../../build/entries"),_verifytypescriptsetup=require("../../../lib/verify-typescript-setup"),_verifypartytownsetup=require("../../../lib/verify-partytown-setup"),_routeregex=require("../../../shared/lib/router/utils/route-regex"),_apppaths=require("../../../shared/lib/router/utils/app-paths"),_builddataroute=require("./build-data-route"),_routematcher=require("../../../shared/lib/router/utils/route-matcher"),_normalizepathsep=require("../../../shared/lib/page-path/normalize-path-sep"),_createclientrouterfilter=require("../../../lib/create-client-router-filter"),_absolutepathtopage=require("../../../shared/lib/page-path/absolute-path-to-page"),_generateinterceptionroutesrewrites=require("../../../lib/generate-interception-routes-rewrites"),_constants=require("../../../shared/lib/constants"),_middlewareroutematcher=require("../../../shared/lib/router/utils/middleware-route-matcher"),_utils1=require("../../../build/utils"),_shared1=require("../../../build/webpack/plugins/next-types-plugin/shared"),_hotreloadertypes=require("../../dev/hot-reloader-types"),_pagetypes=require("../../../lib/page-types"),_hotreloaderturbopack=require("../../dev/hot-reloader-turbopack"),_encryptionutilsserver=require("../../app-render/encryption-utils-server"),_ismetadataroute=require("../../../lib/metadata/is-metadata-route"),_getmetadataroute=require("../../../lib/metadata/get-metadata-route"),_createenvdefinitions=require("../experimental/create-env-definitions"),_jsconfigpathsplugin=require("../../../build/webpack/plugins/jsconfig-paths-plugin"),_store=require("../../../build/output/store"),_utils2=require("../../../shared/lib/turbopack/utils");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(_getRequireWildcardCache=function(e){return e?r:t})(e)}function _interop_require_wildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=_getRequireWildcardCache(t);if(r&&r.has(e))return r.get(e);var i={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in e)if("default"!==n&&Object.prototype.hasOwnProperty.call(e,n)){var s=a?Object.getOwnPropertyDescriptor(e,n):null;s&&(s.get||s.set)?Object.defineProperty(i,n,s):i[n]=e[n]}return i.default=e,r&&r.set(e,i),i}async function verifyTypeScript(e){let t=!1;return(await(0,_verifytypescriptsetup.verifyTypeScriptSetup)({dir:e.dir,distDir:e.nextConfig.distDir,intentDirs:[e.pagesDir,e.appDir].filter(Boolean),typeCheckPreflight:!1,tsconfigPath:e.nextConfig.typescript.tsconfigPath,disableStaticImages:e.nextConfig.images.disableStaticImages,hasAppDir:!!e.appDir,hasPagesDir:!!e.pagesDir})).version&&(t=!0),t}async function propagateServerField(e,t,r){var i,a;await(null==(a=e.renderServer)||null==(i=a.instance)?void 0:i.propagateServerField(e.dir,t,r))}async function startWatcher(e){const{nextConfig:t,appDir:r,pagesDir:i,dir:a,resetFetch:n}=e,{useFileSystemPublicRoutes:s}=t,o=await verifyTypeScript(e),l=_path.default.join(e.dir,e.nextConfig.distDir);if(o){const e=_path.default.join(l,"types");_fs.default.existsSync(e)||await(0,_promises.mkdir)(e,{recursive:!0})}(0,_shared.setGlobal)("distDir",l),(0,_shared.setGlobal)("phase",_constants.PHASE_DEVELOPMENT_SERVER);const u=(0,_findpagefile.createValidFileMatcher)(t.pageExtensions,r),p={};_store.store.setState({logging:!1!==t.logging});const d=e.turbo?await(0,_hotreloaderturbopack.createHotReloaderTurbopack)(e,p,l,n):new _hotreloaderwebpack.default(e.dir,{appDir:r,pagesDir:i,distDir:l,config:e.nextConfig,buildId:"development",encryptionKey:await(0,_encryptionutilsserver.generateEncryptionKeyBase64)({isBuild:!1,distDir:l}),telemetry:e.telemetry,rewrites:e.fsChecker.rewrites,previewProps:e.fsChecker.prerenderManifest.preview,resetFetch:n});await d.start(),e.nextConfig.experimental.nextScriptWorkers&&await(0,_verifypartytownsetup.verifyPartytownSetup)(e.dir,_path.default.join(l,_constants.CLIENT_STATIC_FILES_PATH)),e.fsChecker.ensureCallback((async function(e){"appFile"!==e.type&&"pageFile"!==e.type||await d.ensurePage({clientOnly:!1,page:e.itemPath,isApp:"appFile"===e.type,definition:void 0})}));let c=!1,f=[];await new Promise((async(n,_)=>{i&&_fs.default.readdir(i,((e,t)=>{(null==t?void 0:t.length)||c||(n(),c=!0)}));const g=[...i?[i]:[],...r?[r]:[]],h=i||r,v=[...(0,_utils1.getPossibleMiddlewareFilenames)(_path.default.join(h,".."),t.pageExtensions),...(0,_utils1.getPossibleInstrumentationHookFilenames)(_path.default.join(h,".."),t.pageExtensions)];let m=[];const w=[".env.development.local",".env.local",".env.development",".env"].map((e=>_path.default.join(a,e)));v.push(...w);const y=[_path.default.join(a,"tsconfig.json"),_path.default.join(a,"jsconfig.json")];v.push(...y);const b=new _watchpack.default({ignored:e=>!v.some((t=>t.startsWith(e)))&&!g.some((t=>e.startsWith(t)||t.startsWith(e)))}),E=new Map;let x,P=o,S=new Set;b.on("aggregated",(async()=>{var h,C;let R;const F=[],q=b.getTimeInfoEntries(),k={},D=new Set,T=new Set,I=new Map,M=new Map;let O=!1,j=!1,A=0,N=!1;const{appFiles:W,pageFiles:H}=e.fsChecker;W.clear(),H.clear(),_shared1.devPageFiles.clear();const B=[...q.keys()].sort((0,_entries.sortByPageExts)(t.pageExtensions));for(const n of B){if(!v.includes(n)&&!g.some((e=>n.startsWith(e))))continue;const o=q.get(n),l=E.get(n),d=void 0===l||l&&l!==(null==o?void 0:o.timestamp);if(E.set(n,null==o?void 0:o.timestamp),w.includes(n)){d&&(O=!0);continue}if(y.includes(n)){n.endsWith("tsconfig.json")&&(P=!0),d&&(j=!0);continue}if(void 0===(null==o?void 0:o.accuracy)||!u.isPageFile(n))continue;const c=Boolean(r&&(0,_normalizepathsep.normalizePathSep)(n).startsWith((0,_normalizepathsep.normalizePathSep)(r)+"/")),f=Boolean(i&&(0,_normalizepathsep.normalizePathSep)(n).startsWith((0,_normalizepathsep.normalizePathSep)(i)+"/")),_=(0,_absolutepathtopage.absolutePathToPage)(n,{dir:a,extensions:t.pageExtensions,keepIndex:!1,pagesType:_pagetypes.PAGE_TYPES.ROOT});if((0,_utils1.isMiddlewareFile)(_)){var z;const i=await(0,_entries.getStaticInfoIncludingLayouts)({pageFilePath:n,config:t,appDir:r,page:_,isDev:!0,isInsideAppDir:c,pageExtensions:t.pageExtensions});if("export"===t.output){_log.error('Middleware cannot be used with "output: export". See more info here: https://nextjs.org/docs/advanced-features/static-html-export');continue}p.actualMiddlewareFile=_,await propagateServerField(e,"actualMiddlewareFile",p.actualMiddlewareFile),R=(null==(z=i.middleware)?void 0:z.matchers)||[{regexp:".*",originalSource:"/:path*"}];continue}if((0,_utils1.isInstrumentationHookFile)(_)){p.actualInstrumentationHookFile=_,await propagateServerField(e,"actualInstrumentationHookFile",p.actualInstrumentationHookFile);continue}if((n.endsWith(".ts")||n.endsWith(".tsx"))&&(P=!0),!c&&!f)continue;_shared1.devPageFiles.add(n);let h=(0,_absolutepathtopage.absolutePathToPage)(n,{dir:c?r:i,extensions:t.pageExtensions,keepIndex:c,pagesType:c?_pagetypes.PAGE_TYPES.APP:_pagetypes.PAGE_TYPES.PAGES});if(c&&r&&(0,_ismetadataroute.isMetadataRouteFile)(n.replace(r,""),t.pageExtensions,!0)){const e=await(0,_getpagestaticinfo.getPageStaticInfo)({pageFilePath:n,nextConfig:{},page:h,isDev:!0,pageType:_pagetypes.PAGE_TYPES.APP});h=(0,_getmetadataroute.normalizeMetadataPageToRoute)(h,!(!e.generateSitemaps&&!e.generateImageMetadata))}if(c||!h.startsWith("/api/")||"export"!==t.output){if(c){const e=u.isRootNotFound(n);if(N=!0,e)continue;if(!e&&!u.isAppRouterPage(n))continue;if((0,_normalizepathsep.normalizePathSep)(h).includes("/_"))continue;const t=h;if(h=(0,_apppaths.normalizeAppPath)(h).replace(/%5F/g,"_"),k[h]||(k[h]=[]),k[h].push(t),s&&W.add(h),F.includes(h))continue}else s&&(H.add(h),e.fsChecker.nextDataRoutes.add(h));(c?I:M).set(h,n),r&&D.has(h)?T.add(h):D.add(h),/[\\\\/]_middleware$/.test(h)?m.push(h):F.push(h)}else _log.error('API Routes cannot be used with "output: export". See more info here: https://nextjs.org/docs/advanced-features/static-html-export')}const L=T.size;if(A=L-S.size,0!==A)if(L>0){let e=`Conflicting app and page file${1===L?" was":"s were"} found, please remove the conflicting files to continue:\n`;for(const t of T){const r=_path.default.relative(a,I.get(t));e+=`  "${_path.default.relative(a,M.get(t))}" - "${r}"\n`}d.setHmrServerError(Object.defineProperty(new Error(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0}))}else 0===L&&(d.clearHmrServerError(),await propagateServerField(e,"reloadMatchers",void 0));let $;if(S=T,t.experimental.clientRouterFilter&&($=(0,_createclientrouterfilter.createClientRouterFilter)(Object.keys(k),t.experimental.clientRouterFilterRedirects?(t._originalRedirects||[]).filter((e=>!e.internal)):[],t.experimental.clientRouterFilterAllowedRate),x&&JSON.stringify(x)===JSON.stringify($)||(O=!0,x=$)),!o&&P&&await verifyTypeScript(e).then((()=>{j=!0})).catch((()=>{})),O||j){var V;if(O){var G;const{loadedEnvFiles:r}=(0,_env.loadEnvConfig)(a,"development"===process.env.NODE_ENV,_log,!0,(e=>{_log.info(`Reload env: ${e}`)}));o&&(null==(G=t.experimental)?void 0:G.typedEnv)&&(0,_createenvdefinitions.createEnvDefinitions)({distDir:l,loadedEnvFiles:[...r,{path:t.configFileName,env:t.env,contents:""}]}),await propagateServerField(e,"loadEnvConfig",[{dev:!0,forceReload:!0,silent:!0}])}let r;if(j)try{r=await(0,_loadjsconfig.default)(a,t)}catch(e){}if(d.turbopackProject){const r=e.fsChecker.rewrites.afterFiles.length>0||e.fsChecker.rewrites.beforeFiles.length>0||e.fsChecker.rewrites.fallback.length>0;await d.turbopackProject.update({defineEnv:(0,_swc.createDefineEnv)({isTurbopack:!0,clientRouterFilters:$,config:t,dev:!0,distDir:l,fetchCacheKeyPrefix:e.nextConfig.experimental.fetchCacheKeyPrefix,hasRewrites:r,middlewareMatchers:void 0})})}null==(V=d.activeWebpackConfigs)||V.forEach(((i,a)=>{const n=0===a,s=1===a,o=2===a,u=e.fsChecker.rewrites.afterFiles.length>0||e.fsChecker.rewrites.beforeFiles.length>0||e.fsChecker.rewrites.fallback.length>0;var p,d,c;j&&(null==(d=i.resolve)||null==(p=d.plugins)||p.forEach((e=>{if(e instanceof _jsconfigpathsplugin.JsConfigPathsPlugin&&r){var t,a,n;const{resolvedBaseUrl:p,jsConfig:d}=r,c=e.resolvedBaseUrl,f=null==(a=i.resolve)||null==(t=a.modules)?void 0:t.findIndex((e=>e===(null==c?void 0:c.baseUrl)));if(p&&p.baseUrl!==(null==c?void 0:c.baseUrl)){var s,o,l,u;if(f&&f>-1)null==(o=i.resolve)||null==(s=o.modules)||s.splice(f,1);if(!p.isImplicit)null==(u=i.resolve)||null==(l=u.modules)||l.push(p.baseUrl)}(null==d||null==(n=d.compilerOptions)?void 0:n.paths)&&p&&(Object.keys(e.paths).forEach((t=>{delete e.paths[t]})),Object.assign(e.paths,d.compilerOptions.paths),e.resolvedBaseUrl=p)}})));O&&(null==(c=i.plugins)||c.forEach((r=>{if(r&&"object"==typeof r.definitions&&r.definitions.__NEXT_DEFINE_ENV){const i=(0,_defineenvplugin.getDefineEnv)({isTurbopack:!1,clientRouterFilters:$,config:t,dev:!0,distDir:l,fetchCacheKeyPrefix:e.nextConfig.experimental.fetchCacheKeyPrefix,hasRewrites:u,isClient:n,isEdgeServer:o,isNodeOrEdgeCompilation:s||o,isNodeServer:s,middlewareMatchers:void 0});Object.keys(r.definitions).forEach((e=>{e in i||delete r.definitions[e]})),Object.assign(r.definitions,i)}})))})),await d.invalidate({reloadAfterInvalidation:O})}m.length>0&&(_log.error(Object.defineProperty(new _utils1.NestedMiddlewareError(m,a,i||r),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0}).message),m=[]),p.appPathRoutes=Object.fromEntries(Object.entries(k).map((([e,t])=>[e,t.sort()]))),await propagateServerField(e,"appPathRoutes",p.appPathRoutes),p.middleware=R?{match:null,page:"/",matchers:R}:void 0,await propagateServerField(e,"middleware",p.middleware),p.hasAppNotFound=N,e.fsChecker.middlewareMatcher=(null==(h=p.middleware)?void 0:h.matchers)?(0,_middlewareroutematcher.getMiddlewareRouteMatcher)(null==(C=p.middleware)?void 0:C.matchers):void 0;const U=(0,_generateinterceptionroutesrewrites.generateInterceptionRoutesRewrites)(Object.keys(k),e.nextConfig.basePath).map((t=>(0,_filesystem.buildCustomRoute)("before_files_rewrite",t,e.nextConfig.basePath,e.nextConfig.experimental.caseSensitiveRoutes)));e.fsChecker.rewrites.beforeFiles.push(...U);const K="function"==typeof t.exportPathMap&&await(null==t.exportPathMap?void 0:t.exportPathMap.call(t,{},{dev:!0,dir:e.dir,outDir:null,distDir:l,buildId:"development"}))||{},J=Object.entries(K||{});J.length>0&&(e.fsChecker.exportPathMapRoutes=J.map((([t,r])=>(0,_filesystem.buildCustomRoute)("before_files_rewrite",{source:t,destination:`${r.page}${r.query?"?":""}${_querystring.default.stringify(r.query)}`},e.nextConfig.basePath,e.nextConfig.experimental.caseSensitiveRoutes))));try{const t=(0,_utils.getSortedRoutes)(F);e.fsChecker.dynamicRoutes=t.map((e=>{const t=(0,_routeregex.getRouteRegex)(e);return{regex:t.re.toString(),match:(0,_routematcher.getRouteMatcher)(t),page:e}}));const r=[];for(const i of t){const t=(0,_builddataroute.buildDataRoute)(i,"development"),a=(0,_routeregex.getRouteRegex)(t.page);r.push({...t,regex:a.re.toString(),match:(0,_routematcher.getRouteMatcher)({re:e.nextConfig.i18n?new RegExp(t.dataRouteRegex.replace("/development/","/development/(?<nextLocale>[^/]+?)/")):new RegExp(t.dataRouteRegex),groups:a.groups})})}if(e.fsChecker.dynamicRoutes.unshift(...r),!(null==f?void 0:f.every(((e,r)=>e===t[r])))){const e=t.filter((e=>!f.includes(e))),r=f.filter((e=>!t.includes(e)));d.send({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.DEV_PAGES_MANIFEST_UPDATE,data:[{devPagesManifest:!0}]}),e.forEach((e=>{d.send({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.ADDED_PAGE,data:[e]})})),r.forEach((e=>{d.send({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.REMOVED_PAGE,data:[e]})}))}f=t,c||(n(),c=!0)}catch(e){c?_log.warn("Failed to reload dynamic routes:",e):(_(e),c=!0)}finally{await propagateServerField(e,"reloadMatchers",void 0)}})),b.watch({directories:[a],startTime:0})}));const _=`/_next/${_constants.CLIENT_STATIC_FILES_PATH}/development/${_constants.DEV_CLIENT_PAGES_MANIFEST}`;e.fsChecker.devVirtualFsItems.add(_);const g=`/_next/${_constants.CLIENT_STATIC_FILES_PATH}/development/${_constants.DEV_CLIENT_MIDDLEWARE_MANIFEST}`;e.fsChecker.devVirtualFsItems.add(g);const h=`/_next/${_constants.CLIENT_STATIC_FILES_PATH}/development/${_constants.TURBOPACK_CLIENT_MIDDLEWARE_MANIFEST}`;async function v(t,r){var i,a,n;const s=_url.default.parse(t.url||"/");return(null==(i=s.pathname)?void 0:i.includes(_))?(r.statusCode=200,r.setHeader("Content-Type","application/json; charset=utf-8"),r.end(JSON.stringify({pages:f.filter((t=>!e.fsChecker.appFiles.has(t)))})),{finished:!0}):(null==(a=s.pathname)?void 0:a.includes(g))||(null==(n=s.pathname)?void 0:n.includes(h))?(r.statusCode=200,r.setHeader("Content-Type","application/json; charset=utf-8"),r.end(JSON.stringify((null==(o=p.middleware)?void 0:o.matchers)||[])),{finished:!0}):{finished:!1};var o}function m(e,t){e instanceof _utils2.ModuleBuildError?_log.error(e.message):e instanceof _utils2.TurbopackInternalError||("warning"===t?_log.warn(e):"app-dir"===t?_log.error(e):t?_log.error(`${t}:`,e):_log.error(e))}return e.fsChecker.devVirtualFsItems.add(h),{serverFields:p,hotReloader:d,requestHandler:v,logErrorWithOriginalStack:m,async ensureMiddleware(e){if(p.actualMiddlewareFile)return d.ensurePage({page:p.actualMiddlewareFile,clientOnly:!1,definition:void 0,url:e})}}}async function setupDevBundler(e){const t=_path.default.relative(e.dir,e.pagesDir||e.appDir||"").startsWith("src"),r=await startWatcher(e);return e.telemetry.record((0,_events.eventCliSession)(_path.default.join(e.dir,e.nextConfig.distDir),e.nextConfig,{webpackVersion:5,isSrcDir:t,turboFlag:!!e.turbo,cliCommand:"dev",appDir:!!e.appDir,pagesDir:!!e.pagesDir,isCustomServer:!!e.isCustomServer,hasNowJson:!!await(0,_findup.default)("now.json",{cwd:e.dir})})),r}