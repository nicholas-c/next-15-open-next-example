"use strict";function _export(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{buildCustomRoute:function(){return buildCustomRoute},setupFsCheck:function(){return setupFsCheck}});const _path=_interop_require_default(require("path")),_promises=_interop_require_default(require("fs/promises")),_log=_interop_require_wildcard(require("../../../build/output/log")),_debug=_interop_require_default(require("next/dist/compiled/debug")),_lrucache=require("../lru-cache"),_loadcustomroutes=_interop_require_default(require("../../../lib/load-custom-routes")),_redirectstatus=require("../../../lib/redirect-status"),_fileexists=require("../../../lib/file-exists"),_recursivereaddir=require("../../../lib/recursive-readdir"),_utils=require("../../../shared/lib/router/utils"),_escaperegexp=require("../../../shared/lib/escape-regexp"),_pathmatch=require("../../../shared/lib/router/utils/path-match"),_routeregex=require("../../../shared/lib/router/utils/route-regex"),_routematcher=require("../../../shared/lib/router/utils/route-matcher"),_pathhasprefix=require("../../../shared/lib/router/utils/path-has-prefix"),_normalizelocalepath=require("../../../shared/lib/i18n/normalize-locale-path"),_removepathprefix=require("../../../shared/lib/router/utils/remove-path-prefix"),_middlewareroutematcher=require("../../../shared/lib/router/utils/middleware-route-matcher"),_constants=require("../../../shared/lib/constants"),_normalizepathsep=require("../../../shared/lib/page-path/normalize-path-sep"),_getmetadataroute=require("../../../lib/metadata/get-metadata-route"),_rsc=require("../../normalizers/request/rsc"),_prefetchrsc=require("../../normalizers/request/prefetch-rsc"),_encodeuripath=require("../../../shared/lib/encode-uri-path");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(_getRequireWildcardCache=function(e){return e?r:t})(e)}function _interop_require_wildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=_getRequireWildcardCache(t);if(r&&r.has(e))return r.get(e);var a={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(a,o,s):a[o]=e[o]}return a.default=e,r&&r.set(e,a),a}const debug=(0,_debug.default)("next:router-server:filesystem"),buildCustomRoute=(e,t,r,a)=>{const i=["/_next"].map((e=>r?`${r}${e}`:e)),o=(0,_pathmatch.getPathMatch)(t.source,{strict:!0,removeUnnamedParams:!0,regexModifier:t.internal?void 0:t=>(0,_redirectstatus.modifyRouteRegex)(t,"redirect"===e?i:void 0),sensitive:a});return{...t,..."rewrite"===e?{check:!0}:{},match:o}};async function setupFsCheck(e){const t=e.dev?void 0:new _lrucache.LRUCache(1048576,(function(e){return e?(e.fsPath||"").length+e.itemPath.length+e.type.length:0})),r=new Set,a=new Set,i=new Set,o=new Set,s=new Set,n=new Set;let l=[],c=()=>!1;const u=_path.default.join(e.dir,e.config.distDir),d=_path.default.join(e.dir,"public"),p=_path.default.join(u,"static"),h=_path.default.join(e.dir,"static");let f,_={redirects:[],rewrites:{beforeFiles:[],afterFiles:[],fallback:[]},headers:[]},m="development";if(e.dev)_=await(0,_loadcustomroutes.default)(e.config),f={version:4,routes:{},dynamicRoutes:{},notFoundRoutes:[],preview:{previewModeId:require("crypto").randomBytes(16).toString("hex"),previewModeSigningKey:require("crypto").randomBytes(32).toString("hex"),previewModeEncryptionKey:require("crypto").randomBytes(32).toString("hex")}};else{var g,b;const t=_path.default.join(e.dir,e.config.distDir,_constants.BUILD_ID_FILE);try{m=await _promises.default.readFile(t,"utf8")}catch(t){if("ENOENT"!==t.code)throw t;throw Object.defineProperty(new Error(`Could not find a production build in the '${e.config.distDir}' directory. Try building your app with 'next build' before starting the production server. https://nextjs.org/docs/messages/production-start-no-build-id`),"__NEXT_ERROR_CODE",{value:"E427",enumerable:!1,configurable:!0})}try{for(const e of await(0,_recursivereaddir.recursiveReadDir)(d))a.add((0,_encodeuripath.encodeURIPath)((0,_normalizepathsep.normalizePathSep)(e)))}catch(e){if("ENOENT"!==e.code)throw e}try{for(const e of await(0,_recursivereaddir.recursiveReadDir)(h))o.add((0,_encodeuripath.encodeURIPath)((0,_normalizepathsep.normalizePathSep)(e)));_log.warn("The static directory has been deprecated in favor of the public directory. https://nextjs.org/docs/messages/static-dir-deprecated")}catch(e){if("ENOENT"!==e.code)throw e}try{for(const e of await(0,_recursivereaddir.recursiveReadDir)(p))i.add(_path.default.posix.join("/_next/static",(0,_encodeuripath.encodeURIPath)((0,_normalizepathsep.normalizePathSep)(e))))}catch(t){if("standalone"!==e.config.output)throw t}const w=_path.default.join(u,_constants.ROUTES_MANIFEST),v=_path.default.join(u,_constants.PRERENDER_MANIFEST),F=_path.default.join(u,"server",_constants.MIDDLEWARE_MANIFEST),y=_path.default.join(u,"server",_constants.FUNCTIONS_CONFIG_MANIFEST),S=_path.default.join(u,"server",_constants.PAGES_MANIFEST),P=_path.default.join(u,_constants.APP_PATH_ROUTES_MANIFEST),q=JSON.parse(await _promises.default.readFile(w,"utf8"));f=JSON.parse(await _promises.default.readFile(v,"utf8"));const E=JSON.parse(await _promises.default.readFile(F,"utf8").catch((()=>"{}"))),M=JSON.parse(await _promises.default.readFile(y,"utf8").catch((()=>"{}"))),C=JSON.parse(await _promises.default.readFile(S,"utf8")),I=JSON.parse(await _promises.default.readFile(P,"utf8").catch((()=>"{}")));for(const t of Object.keys(C))e.config.i18n?n.add((0,_normalizelocalepath.normalizeLocalePath)(t,e.config.i18n.locales).pathname):n.add(t);for(const e of Object.keys(I))s.add(I[e]);const j=(0,_escaperegexp.escapeStringRegexp)(m);for(const t of q.dataRoutes){if((0,_utils.isDynamicRoute)(t.page)){const r=(0,_routeregex.getRouteRegex)(t.page);l.push({...t,regex:r.re.toString(),match:(0,_routematcher.getRouteMatcher)({re:e.config.i18n?new RegExp(t.dataRouteRegex.replace(`/${j}/`,`/${j}/(?<nextLocale>[^/]+?)/`)):new RegExp(t.dataRouteRegex),groups:r.groups})})}r.add(t.page)}for(const e of q.dynamicRoutes)l.push({...e,match:(0,_routematcher.getRouteMatcher)((0,_routeregex.getRouteRegex)(e.page))});var R,x;if(null==(b=E.middleware)||null==(g=b["/"])?void 0:g.matchers)c=(0,_middlewareroutematcher.getMiddlewareRouteMatcher)(null==(x=E.middleware)||null==(R=x["/"])?void 0:R.matchers);else(null==M?void 0:M.functions["/_middleware"])&&(c=(0,_middlewareroutematcher.getMiddlewareRouteMatcher)(M.functions["/_middleware"].matchers??[{regexp:".*",originalSource:"/:path*"}]));_={redirects:q.redirects,rewrites:q.rewrites?Array.isArray(q.rewrites)?{beforeFiles:[],afterFiles:q.rewrites,fallback:[]}:q.rewrites:{beforeFiles:[],afterFiles:[],fallback:[]},headers:q.headers}}const w=_.headers.map((t=>buildCustomRoute("header",t,e.config.basePath,e.config.experimental.caseSensitiveRoutes))),v=_.redirects.map((t=>buildCustomRoute("redirect",t,e.config.basePath,e.config.experimental.caseSensitiveRoutes))),F={beforeFiles:_.rewrites.beforeFiles.map((e=>buildCustomRoute("before_files_rewrite",e))),afterFiles:_.rewrites.afterFiles.map((t=>buildCustomRoute("rewrite",t,e.config.basePath,e.config.experimental.caseSensitiveRoutes))),fallback:_.rewrites.fallback.map((t=>buildCustomRoute("rewrite",t,e.config.basePath,e.config.experimental.caseSensitiveRoutes)))},{i18n:y}=e.config,S=(e,t)=>{let r;if(y){const a=(0,_normalizelocalepath.normalizeLocalePath)(e,t||y.locales);e=a.pathname,r=a.detectedLocale}return{locale:r,pathname:e}};let P;debug("nextDataRoutes",r),debug("dynamicRoutes",l),debug("pageFiles",n),debug("appFiles",s);const q={rsc:new _rsc.RSCPathnameNormalizer,prefetchRSC:e.config.experimental.ppr?new _prefetchrsc.PrefetchRSCPathnameNormalizer:void 0};return{headers:w,rewrites:F,redirects:v,buildId:m,handleLocale:S,appFiles:s,pageFiles:n,dynamicRoutes:l,nextDataRoutes:r,exportPathMapRoutes:void 0,devVirtualFsItems:new Set,prerenderManifest:f,middlewareMatcher:c,ensureCallback(e){P=e},async getItem(l){const c=l,u=null==t?void 0:t.get(c);if(u)return u;const{basePath:f}=e.config,_=(0,_pathhasprefix.pathHasPrefix)(l,f);if(f&&!_)return null;var g;(f&&_&&(l=(0,_removepathprefix.removePathPrefix)(l,f)||"/"),e.minimalMode)&&((null==(g=q.prefetchRSC)?void 0:g.match(l))?l=q.prefetchRSC.normalize(l,!0):q.rsc.match(l)&&(l=q.rsc.normalize(l,!0)));"/"!==l&&l.endsWith("/")&&(l=l.substring(0,l.length-1));let b=l;try{b=decodeURIComponent(l)}catch{}if("/_next/image"===l)return{itemPath:l,type:"nextImage"};const R=[[this.devVirtualFsItems,"devVirtualFsItem"],[i,"nextStaticFolder"],[o,"legacyStaticFolder"],[a,"publicFolder"],[s,"appFile"],[n,"pageFile"]];for(let[a,i]of R){let o,s=l,n=b;if(y){var x;const e=S(l,"pageFile"===i||"appFile"===i?void 0:[null==y?void 0:y.defaultLocale,...(null==(x=y.domains)?void 0:x.map((e=>e.defaultLocale)))||[]]);if(e.pathname!==s){s=e.pathname,o=e.locale;try{n=decodeURIComponent(s)}catch{}}}if("legacyStaticFolder"===i){if(!(0,_pathhasprefix.pathHasPrefix)(s,"/static"))continue;s=s.substring("/static".length);try{n=decodeURIComponent(s)}catch{}}if("nextStaticFolder"===i&&!(0,_pathhasprefix.pathHasPrefix)(s,"/_next/static"))continue;const u=`/_next/data/${m}/`;if("pageFile"===i&&s.startsWith(u)&&s.endsWith(".json")){a=r,s=s.substring(u.length-1),s=s.substring(0,s.length-".json".length);const e=S(s);s="/index"===e.pathname?"/":e.pathname,o=e.locale;try{n=decodeURIComponent(s)}catch{}}let f=a.has(s);if(!f&&!e.dev)if(f=a.has(n),f)s=n;else try{const e=(0,_encodeuripath.encodeURIPath)(s);f=a.has(e)}catch{}if(f||e.dev){let r,a;switch(i){case"nextStaticFolder":a=p,s=s.substring("/_next/static".length);break;case"legacyStaticFolder":a=h;break;case"publicFolder":a=d}if(a&&s&&(r=_path.default.posix.join(a,s)),!f&&e.dev){if(["nextStaticFolder","publicFolder","legacyStaticFolder"].includes(i)&&a){let e=r&&await(0,_fileexists.fileExists)(r,_fileexists.FileType.File);if(!e){try{const t=decodeURIComponent(s);r=_path.default.posix.join(a,t),e=await(0,_fileexists.fileExists)(r,_fileexists.FileType.File)}catch{}if(!e)continue}}else{if("pageFile"!==i&&"appFile"!==i)continue;{var w;const e="appFile"===i;if(P&&"ENSURE_FAILED"===await(null==(w=P({type:i,itemPath:e?(0,_getmetadataroute.normalizeMetadataRoute)(s):s}))?void 0:w.catch((()=>"ENSURE_FAILED"))))continue}}}if("appFile"===i&&o&&o!==(null==y?void 0:y.defaultLocale))continue;const n={type:i,fsPath:r,locale:o,itemsRoot:a,itemPath:s};return null==t||t.set(c,n),n}}return null==t||t.set(c,null),null},getDynamicRoutes(){return this.dynamicRoutes},getMiddlewareMatchers(){return this.middlewareMatcher}}}