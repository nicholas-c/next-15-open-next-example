"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"getResolveRoutes",{enumerable:!0,get:function(){return getResolveRoutes}});const _url=_interop_require_default(require("url")),_nodepath=_interop_require_default(require("node:path")),_debug=_interop_require_default(require("next/dist/compiled/debug")),_bodystreams=require("../../body-streams"),_utils=require("../server-ipc/utils"),_serverrouteutils=require("../../server-route-utils"),_formathostname=require("../format-hostname"),_utils1=require("../../web/utils"),_pipereadable=require("../../pipe-readable"),_gethostname=require("../../../shared/lib/get-hostname"),_redirectstatus=require("../../../lib/redirect-status"),_utils2=require("../../../shared/lib/utils"),_relativizeurl=require("../../../shared/lib/router/utils/relativize-url"),_addpathprefix=require("../../../shared/lib/router/utils/add-path-prefix"),_pathhasprefix=require("../../../shared/lib/router/utils/path-has-prefix"),_detectdomainlocale=require("../../../shared/lib/i18n/detect-domain-locale"),_normalizelocalepath=require("../../../shared/lib/i18n/normalize-locale-path"),_removepathprefix=require("../../../shared/lib/router/utils/remove-path-prefix"),_nextdata=require("../../normalizers/request/next-data"),_basepath=require("../../normalizers/request/base-path"),_requestmeta=require("../../request-meta"),_preparedestination=require("../../../shared/lib/router/utils/prepare-destination"),_approuterheaders=require("../../../client/components/app-router-headers"),_computechangedpath=require("../../../client/components/router-reducer/compute-changed-path"),_generateinterceptionroutesrewrites=require("../../../lib/generate-interception-routes-rewrites"),_parseandvalidateflightrouterstate=require("../../app-render/parse-and-validate-flight-router-state");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}const debug=(0,_debug.default)("next:router-server:resolve-routes");function getResolveRoutes(e,t,a,r,i,s){const n=[{match:()=>({}),name:"middleware_next_data"},...a.minimalMode?[]:e.headers,...a.minimalMode?[]:e.redirects,{match:()=>({}),name:"middleware"},...a.minimalMode?[]:e.rewrites.beforeFiles,{match:()=>({}),name:"before_files_end"},{match:()=>({}),name:"check_fs"},...a.minimalMode?[]:e.rewrites.afterFiles,{check:!0,match:()=>({}),name:"after files check: true"},...a.minimalMode?[]:e.rewrites.fallback];async function d({req:d,res:o,isUpgradeReq:l,invokedOutputs:u}){var h,p;let c=!1,m={},f=null,_=_url.default.parse(d.url||"",!0),q=!1;const b=(d.url||"").split("?",1)[0];if(null==b?void 0:b.match(/(\\|\/\/)/))return _=_url.default.parse((0,_utils2.normalizeRepeatedSlashes)(d.url),!0),{parsedUrl:_,resHeaders:m,finished:!0,statusCode:308};const x=(null==d||null==(h=d.socket)?void 0:h.encrypted)||(null==(p=d.headers["x-forwarded-proto"])?void 0:p.includes("https"))?"https":"http",P=t.experimental.trustHostHeader?`https://${d.headers.host||"localhost"}${d.url}`:a.port?`${x}://${(0,_formathostname.formatHostname)(a.hostname||"localhost")}:${a.port}${d.url}`:d.url||"";(0,_requestmeta.addRequestMeta)(d,"initURL",P),(0,_requestmeta.addRequestMeta)(d,"initQuery",{..._.query}),(0,_requestmeta.addRequestMeta)(d,"initProtocol",x),l||(0,_requestmeta.addRequestMeta)(d,"clonableBody",(0,_bodystreams.getCloneableBody)(d));const v=e=>!t.trailingSlash||t.skipMiddlewareUrlNormalize||e.endsWith("/")?e:`${e}/`;let w,R,g;if(t.i18n){var y;const e=null==(y=_.pathname)?void 0:y.endsWith("/"),a=(0,_pathhasprefix.pathHasPrefix)(_.pathname||"",t.basePath);g=(0,_normalizelocalepath.normalizeLocalePath)((0,_removepathprefix.removePathPrefix)(_.pathname||"/",t.basePath),t.i18n.locales),w=(0,_detectdomainlocale.detectDomainLocale)(t.i18n.domains,(0,_gethostname.getHostname)(_,d.headers)),R=(null==w?void 0:w.defaultLocale)||t.i18n.defaultLocale,(0,_requestmeta.addRequestMeta)(d,"defaultLocale",R),(0,_requestmeta.addRequestMeta)(d,"locale",g.detectedLocale||R),g.detectedLocale||g.pathname.startsWith("/_next/")||(_.pathname=(0,_addpathprefix.addPathPrefix)("/"===g.pathname?`/${R}`:(0,_addpathprefix.addPathPrefix)(g.pathname||"",`/${R}`),a?t.basePath:""),e&&(_.pathname=v(_.pathname)))}const M=e=>{if(t.i18n&&e===b&&(null==g?void 0:g.detectedLocale)&&(0,_pathhasprefix.pathHasPrefix)(g.pathname,"/api"))return!0};async function H(){const a=_.pathname||"";if(M(a))return;if(!(null==u?void 0:u.has(a))){const r=await e.getItem(a);if(r&&(t.useFileSystemPublicRoutes||q||"appFile"!==r.type&&"pageFile"!==r.type))return r}const r=e.getDynamicRoutes();let i=_.pathname;if(t.basePath){if(!(0,_pathhasprefix.pathHasPrefix)(i||"",t.basePath))return;i=(null==i?void 0:i.substring(t.basePath.length))||"/"}const s=e.handleLocale(i||"");for(const a of r){if(null==u?void 0:u.has(a.page))continue;if(a.match(s.pathname)){const r=await e.getItem((0,_addpathprefix.addPathPrefix)(a.page,t.basePath||""));if("appFile"===(null==r?void 0:r.type)&&(null==g?void 0:g.detectedLocale))continue;if(r&&(null==i?void 0:i.startsWith("/_next/data"))&&(0,_requestmeta.addRequestMeta)(d,"isNextDataReq",!0),t.useFileSystemPublicRoutes||q)return r}}}const L={basePath:t.basePath&&"/"!==t.basePath?new _basepath.BasePathPathnameNormalizer(t.basePath):void 0,data:new _nextdata.NextDataPathnameNormalizer(e.buildId)};async function z(n){let l=_.pathname||"/";if(t.i18n&&n.internal){const e=l.endsWith("/");t.basePath&&(l=(0,_removepathprefix.removePathPrefix)(l,t.basePath));const a=l!==_.pathname,r=(0,_normalizelocalepath.normalizeLocalePath)(l,t.i18n.locales),i=r.detectedLocale===R;i?l="/"===r.pathname&&a?t.basePath:(0,_addpathprefix.addPathPrefix)(r.pathname,a?t.basePath:""):a&&(l="/"===l?t.basePath:(0,_addpathprefix.addPathPrefix)(l,t.basePath)),(i||a)&&e&&(l=v(l))}let h=n.match(l);if((n.has||n.missing)&&h){const e=(0,_preparedestination.matchHas)(d,_.query,n.has,n.missing);e?Object.assign(h,e):h=!1}if(h){if(e.exportPathMapRoutes&&"before_files_end"===n.name)for(const t of e.exportPathMapRoutes){const e=await z(t);if(e)return e}var p;if("middleware_next_data"===n.name&&_.pathname)if(null==(p=e.getMiddlewareMatchers())?void 0:p.length){var c;let e=_.pathname;const a=null==(c=L.basePath)?void 0:c.match(_.pathname);a&&L.basePath&&(e=L.basePath.normalize(e,!0));let r=!1;if(L.data.match(e)&&(r=!0,(0,_requestmeta.addRequestMeta)(d,"isNextDataReq",!0),e=L.data.normalize(e,!0)),t.i18n){const a=(0,_normalizelocalepath.normalizeLocalePath)(e,t.i18n.locales);a.detectedLocale&&(0,_requestmeta.addRequestMeta)(d,"locale",a.detectedLocale)}r&&(a&&(e=_nodepath.default.posix.join(t.basePath,e)),e=v(e),_.pathname=e)}if("check_fs"===n.name){const a=_.pathname||"";if((null==u?void 0:u.has(a))||M(a))return;const r=await e.getItem(a);if(r&&!(t.i18n&&(null==g?void 0:g.detectedLocale)&&(0,_pathhasprefix.pathHasPrefix)(a,"/api"))&&(t.useFileSystemPublicRoutes||q||"appFile"!==r.type&&"pageFile"!==r.type))return f=r,r.locale&&(0,_requestmeta.addRequestMeta)(d,"locale",r.locale),{parsedUrl:_,resHeaders:m,finished:!0,matchedOutput:f}}if(!a.minimalMode&&"middleware"===n.name){const a=e.getMiddlewareMatchers();if(null==a?void 0:a(_.pathname,d,_.query)){s&&await s(d.url);const e=await(null==r?void 0:r.initialize(i));if(!e)throw Object.defineProperty(new Error('Failed to initialize render server "middleware"'),"__NEXT_ERROR_CODE",{value:"E222",enumerable:!1,configurable:!0});let a,n;(0,_requestmeta.addRequestMeta)(d,"invokePath",""),(0,_requestmeta.addRequestMeta)(d,"invokeOutput",""),(0,_requestmeta.addRequestMeta)(d,"invokeQuery",{}),(0,_requestmeta.addRequestMeta)(d,"middlewareInvoke",!0),debug("invoking middleware",d.url,d.headers);try{try{await e.requestHandler(d,o,_)}catch(e){if(!("result"in e)||!("response"in e.result))throw e;a=e.result.response,o.statusCode=a.status,a.body?n=a.body:a.status&&(n=new ReadableStream({start(e){e.enqueue(""),e.close()}}))}}catch(e){if((0,_pipereadable.isAbortError)(e))return{parsedUrl:_,resHeaders:m,finished:!0};throw e}if(o.closed||o.finished||!a)return{parsedUrl:_,resHeaders:m,finished:!0};const l=(0,_utils1.toNodeOutgoingHttpHeaders)(a.headers);if(debug("middleware res",a.status,l),l["x-middleware-override-headers"]){const e=new Set;let t=l["x-middleware-override-headers"];"string"==typeof t&&(t=t.split(","));for(const a of t)e.add(a.trim());delete l["x-middleware-override-headers"];for(const t of Object.keys(d.headers))e.has(t)||delete d.headers[t];for(const t of e.keys()){const e="x-middleware-request-"+t,a=l[e];d.headers[t]!==a&&(d.headers[t]=null===a?void 0:a),delete l[e]}}l["x-middleware-rewrite"]||l["x-middleware-next"]||l.location||(l["x-middleware-refresh"]="1"),delete l["x-middleware-next"];for(const[e,t]of Object.entries({...(0,_utils.filterReqHeaders)(l,_utils.ipcForbiddenHeaders)}))["content-length","x-middleware-rewrite","x-middleware-redirect","x-middleware-refresh"].includes(e)||("x-middleware-set-cookie"!==e?t&&(m[e]=t,d.headers[e]=t):d.headers[e]=t);if(l["x-middleware-rewrite"]){const e=l["x-middleware-rewrite"],a=(0,_relativizeurl.getRelativeURL)(e,P);if(m["x-middleware-rewrite"]=a,_=_url.default.parse(a,!0),_.protocol)return{parsedUrl:_,resHeaders:m,finished:!0};if(t.i18n){const e=(0,_normalizelocalepath.normalizeLocalePath)(_.pathname||"",t.i18n.locales);e.detectedLocale&&(0,_requestmeta.addRequestMeta)(d,"locale",e.detectedLocale)}}if(l.location){const e=l.location,t=(0,_relativizeurl.getRelativeURL)(e,P);return m.location=t,_=_url.default.parse(t,!0),{parsedUrl:_,resHeaders:m,finished:!0,statusCode:a.status}}if(l["x-middleware-refresh"])return{parsedUrl:_,resHeaders:m,finished:!0,bodyStream:n,statusCode:a.status}}}if(("statusCode"in n||"permanent"in n)&&n.destination){const{parsedDestination:e}=(0,_preparedestination.prepareDestination)({appendParamsToQuery:!1,destination:n.destination,params:h,query:_.query}),{query:t}=e;return delete e.query,e.search=(0,_serverrouteutils.stringifyQuery)(d,t),e.pathname=(0,_utils2.normalizeRepeatedSlashes)(e.pathname),{finished:!0,parsedUrl:e,statusCode:(0,_redirectstatus.getRedirectStatus)(n)}}if(n.headers){const e=Object.keys(h).length>0;for(const t of n.headers){let{key:a,value:r}=t;if(e&&(a=(0,_preparedestination.compileNonPath)(a,h),r=(0,_preparedestination.compileNonPath)(r,h)),"set-cookie"===a.toLowerCase()){if(!Array.isArray(m[a])){const e=m[a];m[a]="string"==typeof e?[e]:[]}m[a].push(r)}else m[a]=r}}if(n.destination){let e=h;try{if((0,_generateinterceptionroutesrewrites.isInterceptionRouteRewrite)(n)){const t=d.headers[_approuterheaders.NEXT_ROUTER_STATE_TREE_HEADER.toLowerCase()];t&&(e={...(0,_computechangedpath.getSelectedParams)((0,_parseandvalidateflightrouterstate.parseAndValidateFlightRouterState)(t)),...h})}}catch(e){}const{search:a,pathname:r}=(0,_preparedestination.parseDestination)({destination:n.destination,params:e,query:_.query}),{parsedDestination:i}=(0,_preparedestination.prepareDestination)({appendParamsToQuery:!0,destination:n.destination,params:e,query:_.query});if(i.protocol)return{parsedUrl:i,finished:!0};if("1"===d.headers[_approuterheaders.RSC_HEADER.toLowerCase()]&&(_.pathname!==r&&o.setHeader(_approuterheaders.NEXT_REWRITTEN_PATH_HEADER,r),a&&o.setHeader(_approuterheaders.NEXT_REWRITTEN_QUERY_HEADER,a.slice(1))),t.i18n){const e=(0,_normalizelocalepath.normalizeLocalePath)((0,_removepathprefix.removePathPrefix)(i.pathname,t.basePath),t.i18n.locales);e.detectedLocale&&(0,_requestmeta.addRequestMeta)(d,"locale",e.detectedLocale)}q=!0,_.pathname=i.pathname,Object.assign(_.query,i.query)}if(n.check){const e=await H();if(e)return{parsedUrl:_,resHeaders:m,finished:!0,matchedOutput:e}}}}for(const e of n){const t=await z(e);if(t)return t}return{finished:c,parsedUrl:_,resHeaders:m,matchedOutput:f}}return d}