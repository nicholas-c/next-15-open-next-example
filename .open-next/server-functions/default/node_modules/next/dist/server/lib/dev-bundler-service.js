"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"DevBundlerService",{enumerable:!0,get:function(){return DevBundlerService}});const _lrucache=require("./lru-cache"),_mockrequest=require("./mock-request"),_hotreloadertypes=require("../dev/hot-reloader-types");class DevBundlerService{constructor(e,r){this.bundler=e,this.handler=r,this.ensurePage=async e=>await this.bundler.hotReloader.ensurePage(e),this.logErrorWithOriginalStack=this.bundler.logErrorWithOriginalStack.bind(this.bundler),this.appIsrManifestInner=new _lrucache.LRUCache(8e3,(function(){return 16}))}async getFallbackErrorComponents(e){await this.bundler.hotReloader.buildFallbackError(),await this.bundler.hotReloader.ensurePage({page:"/_error",clientOnly:!1,definition:void 0,url:e})}async getCompilationError(e){const r=await this.bundler.hotReloader.getCompilationErrors(e);if(r)return r[0]}async revalidate({urlPath:e,revalidateHeaders:r,opts:t}){const s=(0,_mockrequest.createRequestResponseMocks)({url:e,headers:r});if(await this.handler(s.req,s.res),await s.res.hasStreamed,"REVALIDATED"!==s.res.getHeader("x-nextjs-cache")&&200!==s.res.statusCode&&(404!==s.res.statusCode||!t.unstable_onlyGenerated))throw Object.defineProperty(new Error(`Invalid response ${s.res.statusCode}`),"__NEXT_ERROR_CODE",{value:"E175",enumerable:!1,configurable:!0});return{}}get appIsrManifest(){const e={};for(const r of this.appIsrManifestInner.keys())e[r]=this.appIsrManifestInner.get(r);return e}setIsrStatus(e,r){var t,s;null===r?this.appIsrManifestInner.remove(e):this.appIsrManifestInner.set(e,r),null==(s=this.bundler)||null==(t=s.hotReloader)||t.send({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.ISR_MANIFEST,data:this.appIsrManifest})}close(){this.bundler.hotReloader.close()}}