"use strict";function _export(e,t){for(var n in t)Object.defineProperty(e,n,{enumerable:!0,get:t[n]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{NEXT_PATCH_SYMBOL:function(){return NEXT_PATCH_SYMBOL},createPatchedFetcher:function(){return createPatchedFetcher},patchFetch:function(){return patchFetch},validateRevalidate:function(){return validateRevalidate},validateTags:function(){return validateTags}});const _constants=require("./trace/constants"),_tracer=require("./trace/tracer"),_constants1=require("../../lib/constants"),_dynamicrendering=require("../app-render/dynamic-rendering"),_dynamicrenderingutils=require("../dynamic-rendering-utils"),_dedupefetch=require("./dedupe-fetch"),_responsecache=require("../response-cache"),_scheduler=require("../../lib/scheduler"),_cloneresponse=require("./clone-response"),isEdgeRuntime="edge"===process.env.NEXT_RUNTIME,NEXT_PATCH_SYMBOL=Symbol.for("next-patch");function isFetchPatched(){return!0===globalThis[NEXT_PATCH_SYMBOL]}function validateRevalidate(e,t){try{let n;if(!1===e)n=_constants1.INFINITE_CACHE;else if("number"==typeof e&&!isNaN(e)&&e>-1)n=e;else if(void 0!==e)throw Object.defineProperty(new Error(`Invalid revalidate value "${e}" on "${t}", must be a non-negative number or false`),"__NEXT_ERROR_CODE",{value:"E179",enumerable:!1,configurable:!0});return n}catch(e){if(e instanceof Error&&e.message.includes("Invalid revalidate"))throw e;return}}function validateTags(e,t){const n=[],r=[];for(let a=0;a<e.length;a++){const c=e[a];if("string"!=typeof c?r.push({tag:c,reason:"invalid type, must be a string"}):c.length>_constants1.NEXT_CACHE_TAG_MAX_LENGTH?r.push({tag:c,reason:`exceeded max length of ${_constants1.NEXT_CACHE_TAG_MAX_LENGTH}`}):n.push(c),n.length>_constants1.NEXT_CACHE_TAG_MAX_ITEMS){console.warn(`Warning: exceeded max tag count for ${t}, dropped tags:`,e.slice(a).join(", "));break}}if(r.length>0){console.warn(`Warning: invalid tags passed to ${t}: `);for(const{tag:e,reason:t}of r)console.log(`tag: "${e}" ${t}`)}return n}function trackFetchMetric(e,t){var n;if(!e)return;if(null==(n=e.requestEndedState)?void 0:n.ended)return;const r=(!!process.env.NEXT_DEBUG_BUILD||"1"===process.env.NEXT_SSG_FETCH_METRICS)&&e.isStaticGeneration,a="development"===process.env.NODE_ENV;(r||a)&&(e.fetchMetrics??=[],e.fetchMetrics.push({...t,end:performance.timeOrigin+performance.now(),idx:e.nextFetchId||0}))}function createPatchedFetcher(e,{workAsyncStorage:t,workUnitAsyncStorage:n}){const r=async(r,a)=>{var c,o;let s;try{s=new URL(r instanceof Request?r.url:r),s.username="",s.password=""}catch{s=void 0}const i=(null==s?void 0:s.href)??"",d=(null==a||null==(c=a.method)?void 0:c.toUpperCase())||"GET",l=!0===(null==a||null==(o=a.next)?void 0:o.internal),u="1"===process.env.NEXT_OTEL_FETCH_DISABLED,h=l?void 0:performance.timeOrigin+performance.now(),f=t.getStore(),p=n.getStore();let v=p&&"prerender"===p.type?p.cacheSignal:null;v&&v.beginRead();const g=(0,_tracer.getTracer)().trace(l?_constants.NextNodeServerSpan.internalFetch:_constants.AppRenderSpan.fetch,{hideSpan:u,kind:_tracer.SpanKind.CLIENT,spanName:["fetch",d,i].filter(Boolean).join(" "),attributes:{"http.url":i,"http.method":d,"net.peer.name":null==s?void 0:s.hostname,"net.peer.port":(null==s?void 0:s.port)||void 0}},(async()=>{var t;if(l)return e(r,a);if(!f)return e(r,a);if(f.isDraftMode)return e(r,a);const n=r&&"object"==typeof r&&"string"==typeof r.method,c=e=>(null==a?void 0:a[e])||(n?r[e]:null);let o;const s=e=>{var t,c,o;return void 0!==(null==a||null==(t=a.next)?void 0:t[e])?null==a||null==(c=a.next)?void 0:c[e]:n?null==(o=r.next)?void 0:o[e]:void 0};let d=s("revalidate");const u=validateTags(s("tags")||[],`fetch ${r.toString()}`),g=!p||"cache"!==p.type&&"prerender"!==p.type&&"prerender-ppr"!==p.type&&"prerender-legacy"!==p.type?void 0:p;if(g&&Array.isArray(u)){const e=g.tags??(g.tags=[]);for(const t of u)e.includes(t)||e.push(t)}const _=p&&"unstable-cache"!==p.type?p.implicitTags:[],y=p&&"unstable-cache"===p.type?"force-no-store":f.fetchCache,m=!!f.isUnstableNoStore;let E,C=c("cache"),T="";if("string"==typeof C&&void 0!==d){("force-cache"===C&&0===d||"no-store"===C&&(d>0||!1===d))&&(E=`Specified "cache: ${C}" and "revalidate: ${d}", only one should be specified.`,C=void 0,d=void 0)}const b="no-cache"===C||"no-store"===C||"force-no-store"===y||"only-no-store"===y,R=!y&&!C&&!d&&f.forceDynamic;"force-cache"===C&&void 0===d?d=!1:"cache"!==(null==p?void 0:p.type)&&(b||R)&&(d=0),"no-cache"!==C&&"no-store"!==C||(T=`cache: ${C}`),o=validateRevalidate(d,f.route);const S=c("headers"),w="function"==typeof(null==S?void 0:S.get)?S:new Headers(S||{}),x=w.get("authorization")||w.get("cookie"),N=!["get","head"].includes((null==(t=c("method"))?void 0:t.toLowerCase())||"get"),H=null==y&&(null==C||"default"===C)&&null==d,I=H&&!f.isPrerendering||(x||N)&&g&&0===g.revalidate;if(H&&void 0!==p&&"prerender"===p.type)return v&&(v.endRead(),v=null),(0,_dynamicrenderingutils.makeHangingPromise)(p.renderSignal,"fetch()");switch(y){case"force-no-store":T="fetchCache = force-no-store";break;case"only-no-store":if("force-cache"===C||void 0!==o&&o>0)throw Object.defineProperty(new Error(`cache: 'force-cache' used on fetch for ${i} with 'export const fetchCache = 'only-no-store'`),"__NEXT_ERROR_CODE",{value:"E448",enumerable:!1,configurable:!0});T="fetchCache = only-no-store";break;case"only-cache":if("no-store"===C)throw Object.defineProperty(new Error(`cache: 'no-store' used on fetch for ${i} with 'export const fetchCache = 'only-cache'`),"__NEXT_ERROR_CODE",{value:"E521",enumerable:!1,configurable:!0});break;case"force-cache":void 0!==d&&0!==d||(T="fetchCache = force-cache",o=_constants1.INFINITE_CACHE)}if(void 0===o?"default-cache"!==y||m?"default-no-store"===y?(o=0,T="fetchCache = default-no-store"):m?(o=0,T="noStore call"):I?(o=0,T="auto no cache"):(T="auto cache",o=g?g.revalidate:_constants1.INFINITE_CACHE):(o=_constants1.INFINITE_CACHE,T="fetchCache = default-cache"):T||(T=`revalidate: ${o}`),(!f.forceStatic||0!==o)&&!I&&g&&o<g.revalidate){if(0===o){if(p&&"prerender"===p.type)return v&&(v.endRead(),v=null),(0,_dynamicrenderingutils.makeHangingPromise)(p.renderSignal,"fetch()");(0,_dynamicrendering.markCurrentScopeAsDynamic)(f,p,`revalidate: 0 fetch ${r} ${f.route}`)}g&&d===o&&(g.revalidate=o)}const F="number"==typeof o&&o>0;let A;const{incrementalCache:k}=f,O="request"===(null==p?void 0:p.type)||"cache"===(null==p?void 0:p.type)?p:void 0;if(k&&(F||(null==O?void 0:O.serverComponentsHmrCache)))try{A=await k.generateCacheKey(i,n?r:a)}catch(e){console.error("Failed to generate cache key for",r)}const P=f.nextFetchId??1;f.nextFetchId=P+1;let $=()=>Promise.resolve();const B=async(t,c)=>{const s=["cache","credentials","headers","integrity","keepalive","method","mode","redirect","referrer","referrerPolicy","window","duplex",...t?[]:["signal"]];if(n){const e=r,t={body:e._ogBody||e.body};for(const n of s)t[n]=e[n];r=new Request(e.url,t)}else if(a){const{_ogBody:e,body:n,signal:r,...c}=a;a={...c,body:e||n,signal:t?void 0:r}}const d={...a,next:{...null==a?void 0:a.next,fetchType:"origin",fetchIdx:P}};return e(r,d).then((async e=>{if(!t&&h&&trackFetchMetric(f,{start:h,url:i,cacheReason:c||T,cacheStatus:0===o||c?"skip":"miss",cacheWarning:E,status:e.status,method:d.method||"GET"}),200===e.status&&k&&A&&(F||(null==O?void 0:O.serverComponentsHmrCache))){const t=o>=_constants1.INFINITE_CACHE?_constants1.CACHE_ONE_YEAR:o,n=!(o>=_constants1.INFINITE_CACHE)&&o;if(p&&"prerender"===p.type){const r=await e.arrayBuffer(),a={headers:Object.fromEntries(e.headers.entries()),body:Buffer.from(r).toString("base64"),status:e.status,url:e.url};return await k.set(A,{kind:_responsecache.CachedRouteKind.FETCH,data:a,revalidate:t},{fetchCache:!0,revalidate:n,fetchUrl:i,fetchIdx:P,tags:u}),await $(),new Response(r,{headers:e.headers,status:e.status,statusText:e.statusText})}{const[a,c]=(0,_cloneresponse.cloneResponse)(e);return a.arrayBuffer().then((async e=>{var r;const c=Buffer.from(e),o={headers:Object.fromEntries(a.headers.entries()),body:c.toString("base64"),status:a.status,url:a.url};null==O||null==(r=O.serverComponentsHmrCache)||r.set(A,o),F&&await k.set(A,{kind:_responsecache.CachedRouteKind.FETCH,data:o,revalidate:t},{fetchCache:!0,revalidate:n,fetchUrl:i,fetchIdx:P,tags:u})})).catch((e=>console.warn("Failed to set fetch cache",r,e))).finally($),c}}return await $(),e})).catch((e=>{throw $(),e}))};let M,X=!1,D=!1;if(A&&k){let e;if((null==O?void 0:O.isHmrRefresh)&&O.serverComponentsHmrCache&&(e=O.serverComponentsHmrCache.get(A),D=!0),F&&!e){$=await k.lock(A);const t=f.isOnDemandRevalidate?null:await k.get(A,{kind:_responsecache.IncrementalCacheKind.FETCH,revalidate:o,fetchUrl:i,fetchIdx:P,tags:u,softTags:_,isFallback:!1});if(H&&p&&"prerender"===p.type&&await(0,_scheduler.waitAtLeastOneReactRenderTask)(),t?await $():M="cache-control: no-cache (hard refresh)",(null==t?void 0:t.value)&&t.value.kind===_responsecache.CachedRouteKind.FETCH)if(f.isRevalidate&&t.isStale)X=!0;else{if(t.isStale&&(f.pendingRevalidates??={},!f.pendingRevalidates[A])){const e=B(!0).then((async e=>({body:await e.arrayBuffer(),headers:e.headers,status:e.status,statusText:e.statusText}))).finally((()=>{f.pendingRevalidates??={},delete f.pendingRevalidates[A||""]}));e.catch(console.error),f.pendingRevalidates[A]=e}e=t.value.data}}if(e){h&&trackFetchMetric(f,{start:h,url:i,cacheReason:T,cacheStatus:D?"hmr":"hit",cacheWarning:E,status:e.status||200,method:(null==a?void 0:a.method)||"GET"});const t=new Response(Buffer.from(e.body,"base64"),{headers:e.headers,status:e.status});return Object.defineProperty(t,"url",{value:e.url}),t}}if(f.isStaticGeneration&&a&&"object"==typeof a){const{cache:e}=a;if(isEdgeRuntime&&delete a.cache,"no-store"===e){if(p&&"prerender"===p.type)return v&&(v.endRead(),v=null),(0,_dynamicrenderingutils.makeHangingPromise)(p.renderSignal,"fetch()");(0,_dynamicrendering.markCurrentScopeAsDynamic)(f,p,`no-store fetch ${r} ${f.route}`)}const t="next"in a,{next:n={}}=a;if("number"==typeof n.revalidate&&g&&n.revalidate<g.revalidate){if(0===n.revalidate){if(p&&"prerender"===p.type)return(0,_dynamicrenderingutils.makeHangingPromise)(p.renderSignal,"fetch()");(0,_dynamicrendering.markCurrentScopeAsDynamic)(f,p,`revalidate: 0 fetch ${r} ${f.route}`)}f.forceStatic&&0===n.revalidate||(g.revalidate=n.revalidate)}t&&delete a.next}if(A&&X){const e=A;f.pendingRevalidates??={};let t=f.pendingRevalidates[e];if(t){const e=await t;return new Response(e.body,{headers:e.headers,status:e.status,statusText:e.statusText})}const n=B(!0,M).then(_cloneresponse.cloneResponse);return t=n.then((async e=>{const t=e[0];return{body:await t.arrayBuffer(),headers:t.headers,status:t.status,statusText:t.statusText}})).finally((()=>{var t;(null==(t=f.pendingRevalidates)?void 0:t[e])&&delete f.pendingRevalidates[e]})),t.catch((()=>{})),f.pendingRevalidates[e]=t,n.then((e=>e[1]))}return B(!1,M)}));if(v)try{return await g}finally{v&&v.endRead()}return g};return r.__nextPatched=!0,r.__nextGetStaticStore=()=>t,r._nextOriginalFetch=e,globalThis[NEXT_PATCH_SYMBOL]=!0,r}function patchFetch(e){if(isFetchPatched())return;const t=(0,_dedupefetch.createDedupeFetch)(globalThis.fetch);globalThis.fetch=createPatchedFetcher(t,e)}