"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"proxyRequest",{enumerable:!0,get:function(){return proxyRequest}});const _url=_interop_require_default(require("url")),_serverrouteutils=require("../../server-route-utils"),_stream=require("stream"),_detachedpromise=require("../../../lib/detached-promise");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}async function proxyRequest(e,r,o,t,s,n){const{query:u}=o;delete o.query,o.search=(0,_serverrouteutils.stringifyQuery)(e,u);const i=_url.default.format(o),l=new(require("next/dist/compiled/http-proxy"))({target:i,changeOrigin:!0,ignorePath:!0,ws:!0,proxyTimeout:null===n?void 0:n||3e4,headers:{"x-forwarded-host":e.headers.host||""}});let c=!1;l.on("proxyReq",(e=>{r.on("close",(()=>e.destroy()))})),l.on("proxyRes",(e=>{r.destroyed?e.destroy():r.on("close",(()=>e.destroy()))})),l.on("proxyRes",((e,r,o)=>{const t=s=>{e.removeListener("error",t),e.removeListener("close",t),o.removeListener("error",t),o.removeListener("close",t),r.destroy(s),e.destroy(s)};e.once("error",t),e.once("close",t),o.once("error",t),o.once("close",t)}));const d=new _detachedpromise.DetachedPromise;return l.on("error",(e=>{console.error(`Failed to proxy ${i}`,e),c||(c=!0,d.reject(e),r.destroyed||(r instanceof _stream.Duplex||(r.statusCode=500),r.end("Internal Server Error")))})),t||r instanceof _stream.Duplex?(l.on("proxyReqWs",(e=>{e.on("close",(()=>{c||(c=!0,d.resolve(!0))}))})),l.ws(e,r,t),d.resolve(!0)):(l.on("proxyReq",(e=>{e.on("close",(()=>{c||(c=!0,d.resolve(!0))}))})),l.web(e,r,{buffer:s})),d.promise.finally((()=>{l.close()}))}