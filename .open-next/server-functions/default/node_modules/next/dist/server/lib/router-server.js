"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"initialize",{enumerable:!0,get:function(){return initialize}}),require("../node-environment"),require("../require-hook");const _url=_interop_require_default(require("url")),_path=_interop_require_default(require("path")),_config=_interop_require_default(require("../config")),_servestatic=require("../serve-static"),_debug=_interop_require_default(require("next/dist/compiled/debug")),_log=_interop_require_wildcard(require("../../build/output/log")),_utils=require("../../shared/lib/utils"),_findpagesdir=require("../../lib/find-pages-dir"),_filesystem=require("./router-utils/filesystem"),_proxyrequest=require("./router-utils/proxy-request"),_pipereadable=require("../pipe-readable"),_resolveroutes=require("./router-utils/resolve-routes"),_requestmeta=require("../request-meta"),_pathhasprefix=require("../../shared/lib/router/utils/path-has-prefix"),_removepathprefix=require("../../shared/lib/router/utils/remove-path-prefix"),_compression=_interop_require_default(require("next/dist/compiled/compression")),_baseserver=require("../base-server"),_nextrequest=require("../web/spec-extension/adapters/next-request"),_ispostpone=require("./router-utils/is-postpone"),_parseurl=require("../../shared/lib/router/utils/parse-url"),_constants=require("../../shared/lib/constants"),_redirectstatuscode=require("../../client/components/redirect-status-code"),_devbundlerservice=require("./dev-bundler-service"),_trace=require("../../trace"),_ensureleadingslash=require("../../shared/lib/page-path/ensure-leading-slash"),_getnextpathnameinfo=require("../../shared/lib/router/utils/get-next-pathname-info"),_gethostname=require("../../shared/lib/get-hostname"),_detectdomainlocale=require("../../shared/lib/i18n/detect-domain-locale"),_mockrequest=require("./mock-request"),_hotreloadertypes=require("../dev/hot-reloader-types"),_normalizedassetprefix=require("../../shared/lib/normalized-asset-prefix"),_patchfetch=require("./patch-fetch"),_utils1=require("./server-ipc/utils");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(_getRequireWildcardCache=function(e){return e?t:r})(e)}function _interop_require_wildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var a={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var n=i?Object.getOwnPropertyDescriptor(e,s):null;n&&(n.get||n.set)?Object.defineProperty(a,s,n):a[s]=e[s]}return a.default=e,t&&t.set(e,a),a}const debug=(0,_debug.default)("next:router-server:main"),isNextFont=e=>e&&/\/media\/[^/]+\.(woff|woff2|eot|ttf|otf)$/.test(e),requestHandlers={};async function initialize(e){process.env.NODE_ENV||(process.env.NODE_ENV=e.dev?"development":"production");const r=await(0,_config.default)(e.dev?_constants.PHASE_DEVELOPMENT_SERVER:_constants.PHASE_PRODUCTION_SERVER,e.dir,{silent:!1});let t;!1!==(null==r?void 0:r.compress)&&(t=(0,_compression.default)());const a=await(0,_filesystem.setupFsCheck)({dev:e.dev,dir:e.dir,config:r,minimalMode:e.minimalMode}),i={};let s,n,o=globalThis.fetch;if(e.dev){const{Telemetry:t}=require("../../telemetry/storage"),u=new t({distDir:_path.default.join(e.dir,r.distDir)}),{pagesDir:l,appDir:d}=(0,_findpagesdir.findPagesDir)(e.dir),{setupDevBundler:c}=require("./router-utils/setup-dev-bundler"),p=()=>{globalThis.fetch=o,globalThis[_patchfetch.NEXT_PATCH_SYMBOL]=!1},h=e.startServerSpan?e.startServerSpan.traceChild("setup-dev-bundler"):(0,_trace.trace)("setup-dev-bundler");s=await h.traceAsyncFn((()=>c({renderServer:i,appDir:d,pagesDir:l,telemetry:u,fsChecker:a,dir:e.dir,nextConfig:r,isCustomServer:e.customServer,turbo:!!process.env.TURBOPACK,port:e.port,onDevServerCleanup:e.onDevServerCleanup,resetFetch:p}))),n=new _devbundlerservice.DevBundlerService(s,((r,t)=>requestHandlers[e.dir](r,t)))}i.instance=require("./render-server");const u=async(n,o)=>{if(process.env.NEXT_PRIVATE_TEST_HEADERS||(0,_utils1.filterInternalHeaders)(n.headers),!e.minimalMode&&r.i18n&&!1!==r.i18n.localeDetection){var u;let e=(n.url||"").split("?",1)[0]||"";r.basePath&&(e=(0,_removepathprefix.removePathPrefix)(e,r.basePath));const t=(0,_getnextpathnameinfo.getNextPathnameInfo)(e,{nextConfig:r}),a=(0,_detectdomainlocale.detectDomainLocale)(r.i18n.domains,(0,_gethostname.getHostname)({hostname:e},n.headers)),i=(null==a?void 0:a.defaultLocale)||r.i18n.defaultLocale,{getLocaleRedirect:s}=require("../../shared/lib/i18n/get-locale-redirect"),l=(0,_parseurl.parseUrl)(null==(u=n.url||"")?void 0:u.replace(/^\/+/,"/")),d=s({defaultLocale:i,domainLocale:a,headers:n.headers,nextConfig:r,pathLocale:t.locale,urlParsed:{...l,pathname:t.locale?`/${t.locale}${e}`:e}});if(d)return o.setHeader("Location",d),o.statusCode=_redirectstatuscode.RedirectStatusCode.TemporaryRedirect,void o.end(d)}t&&t(n,o,(()=>{})),n.on("error",(e=>{})),o.on("error",(e=>{}));const l=new Set;async function p(e,t,s,u){var l;if(r.i18n&&(0,_removepathprefix.removePathPrefix)(t,r.basePath).startsWith(`/${(0,_requestmeta.getRequestMeta)(n,"locale")}/api`)&&(t=a.handleLocale((0,_removepathprefix.removePathPrefix)(t,r.basePath)).pathname),n.headers["x-nextjs-data"]&&(null==(l=a.getMiddlewareMatchers())?void 0:l.length)&&"/404"===(0,_removepathprefix.removePathPrefix)(t,r.basePath))return o.setHeader("x-nextjs-matched-path",e.pathname||""),o.statusCode=404,o.setHeader("content-type","application/json"),o.end("{}"),null;if(!c)throw Object.defineProperty(new Error("Failed to initialize render server"),"__NEXT_ERROR_CODE",{value:"E90",enumerable:!1,configurable:!0});(0,_requestmeta.addRequestMeta)(n,"invokePath",t),(0,_requestmeta.addRequestMeta)(n,"invokeQuery",e.query),(0,_requestmeta.addRequestMeta)(n,"middlewareInvoke",!1);for(const e in u||{})(0,_requestmeta.addRequestMeta)(n,e,u[e]);debug("invokeRender",n.url,n.headers);try{var p;const e=await(null==i||null==(p=i.instance)?void 0:p.initialize(d));try{await(null==e?void 0:e.requestHandler(n,o))}catch(e){if(e instanceof _baseserver.NoFallbackError)return void await _(s+1);throw e}return}catch(e){if((0,_pipereadable.isAbortError)(e))return;throw e}}const _=async t=>{if(t>5)throw Object.defineProperty(new Error(`Attempted to handle request too many times ${n.url}`),"__NEXT_ERROR_CODE",{value:"E283",enumerable:!1,configurable:!0});if(s){const e=n.url||"/";r.basePath&&(0,_pathhasprefix.pathHasPrefix)(e,r.basePath)&&(n.url=(0,_removepathprefix.removePathPrefix)(e,r.basePath));const t=_url.default.parse(n.url||"/"),a=await s.hotReloader.run(n,o,t);if(a.finished)return a;n.url=e}const{finished:i,parsedUrl:u,statusCode:d,resHeaders:c,bodyStream:_,matchedOutput:f}=await h({req:n,res:o,isUpgradeReq:!1,signal:(0,_nextrequest.signalFromNodeResponse)(o),invokedOutputs:l});if(o.closed||o.finished)return;if(s&&"devVirtualFsItem"===(null==f?void 0:f.type)){const e=n.url||"/";if(r.basePath&&(0,_pathhasprefix.pathHasPrefix)(e,r.basePath)&&(n.url=(0,_removepathprefix.removePathPrefix)(e,r.basePath)),c)for(const e of Object.keys(c))o.setHeader(e,c[e]);if((await s.requestHandler(n,o)).finished)return;n.url=e}debug("requestHandler!",n.url,{matchedOutput:f,statusCode:d,resHeaders:c,bodyStream:!!_,parsedUrl:{pathname:u.pathname,query:u.query},finished:i});for(const e of Object.keys(c||{}))o.setHeader(e,c[e]);if(!_&&d&&d>300&&d<400){const e=_url.default.format(u);return o.statusCode=d,o.setHeader("location",e),d===_redirectstatuscode.RedirectStatusCode.PermanentRedirect&&o.setHeader("Refresh",`0;url=${e}`),o.end(e)}if(_)return o.statusCode=d||200,await(0,_pipereadable.pipeToNodeResponse)(_,o);var v;if(i&&u.protocol)return await(0,_proxyrequest.proxyRequest)(n,o,u,void 0,null==(v=(0,_requestmeta.getRequestMeta)(n,"clonableBody"))?void 0:v.cloneBodyStream(),r.experimental.proxyTimeout);if((null==f?void 0:f.fsPath)&&f.itemPath){if(e.dev&&(a.appFiles.has(f.itemPath)||a.pageFiles.has(f.itemPath))){o.statusCode=500;const e=`A conflicting public file and page file was found for path ${f.itemPath} https://nextjs.org/docs/messages/conflicting-public-file-page`;return await p(u,"/_error",t,{invokeStatus:500,invokeError:Object.defineProperty(new Error(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0})}),void _log.error(e)}if(o.getHeader("cache-control")||"nextStaticFolder"!==f.type||(e.dev&&!isNextFont(u.pathname)?o.setHeader("Cache-Control","no-store, must-revalidate"):o.setHeader("Cache-Control","public, max-age=31536000, immutable")),"GET"!==n.method&&"HEAD"!==n.method)return o.setHeader("Allow",["GET","HEAD"]),o.statusCode=405,await p(_url.default.parse("/405",!0),"/405",t,{invokeStatus:405});try{return await(0,_servestatic.serveStatic)(n,o,f.itemPath,{root:f.itemsRoot,etag:r.generateEtags})}catch(e){if(new Set([400,412,416]).has(e.statusCode)||(e.statusCode=400),"number"==typeof e.statusCode){const r=`/${e.statusCode}`,a=e.statusCode;return o.statusCode=e.statusCode,await p(_url.default.parse(r,!0),r,t,{invokeStatus:a})}throw e}}if(f)return l.add(f.itemPath),await p(u,u.pathname||"/",t,{invokeOutput:f.itemPath});if(o.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate"),e.dev&&!f&&"/favicon.ico"===u.pathname)return o.statusCode=404,o.end(""),null;const m=e.dev?null==s?void 0:s.serverFields.hasAppNotFound:await a.getItem(_constants.UNDERSCORE_NOT_FOUND_ROUTE);if(o.statusCode=404,m)return await p(u,_constants.UNDERSCORE_NOT_FOUND_ROUTE,t,{invokeStatus:404});await p(u,"/404",t,{invokeStatus:404})};try{await _(0)}catch(e){try{let r="/500",t="500";return e instanceof _utils.DecodeError?(r="/400",t="400"):console.error(e),o.statusCode=Number(t),await p(_url.default.parse(r,!0),r,0,{invokeStatus:o.statusCode})}catch(e){console.error(e)}o.statusCode=500,o.end("Internal Server Error")}};let l=u;if(r.experimental.testProxy){const{wrapRequestHandlerWorker:e,interceptTestApis:r}=require("next/dist/experimental/testmode/server");l=e(l),r(),o=globalThis.fetch}requestHandlers[e.dir]=l;const d={port:e.port,dir:e.dir,hostname:e.hostname,minimalMode:e.minimalMode,dev:!!e.dev,server:e.server,serverFields:{...(null==s?void 0:s.serverFields)||{},setIsrStatus:null==n?void 0:n.setIsrStatus.bind(n)},experimentalTestProxy:!!r.experimental.testProxy,experimentalHttpsServer:!!e.experimentalHttpsServer,bundlerService:n,startServerSpan:e.startServerSpan,quiet:e.quiet,onDevServerCleanup:e.onDevServerCleanup};d.serverFields.routerServerHandler=u;const c=await i.instance.initialize(d),p=async(e,r)=>{(0,_ispostpone.isPostpone)(r)||("unhandledRejection"===e?_log.error("unhandledRejection: ",r):"uncaughtException"===e&&_log.error("uncaughtException: ",r))};process.on("uncaughtException",p.bind(null,"uncaughtException")),process.on("unhandledRejection",p.bind(null,"unhandledRejection"));const h=(0,_resolveroutes.getResolveRoutes)(a,r,e,i.instance,d,null==s?void 0:s.ensureMiddleware);return{requestHandler:l,upgradeHandler:async(t,a,i)=>{try{if(t.on("error",(e=>{})),a.on("error",(e=>{})),e.dev&&s&&t.url){const{basePath:e,assetPrefix:o}=r;let u=e;o&&(u=(0,_normalizedassetprefix.normalizedAssetPrefix)(o),URL.canParse(u)&&(u=new URL(u).pathname.replace(/\/$/,"")));if(t.url.startsWith((0,_ensureleadingslash.ensureLeadingSlash)(`${u}/_next/webpack-hmr`)))return s.hotReloader.onHMR(t,a,i,(e=>{e.send(JSON.stringify({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.ISR_MANIFEST,data:(null==n?void 0:n.appIsrManifest)||{}}))}))}const o=new _mockrequest.MockedResponse({resWriter:()=>{throw Object.defineProperty(new Error("Invariant: did not expect response writer to be written to for upgrade request"),"__NEXT_ERROR_CODE",{value:"E522",enumerable:!1,configurable:!0})}}),{matchedOutput:u,parsedUrl:l}=await h({req:t,res:o,isUpgradeReq:!0,signal:(0,_nextrequest.signalFromNodeResponse)(a)});if(u)return a.end();if(l.protocol)return await(0,_proxyrequest.proxyRequest)(t,a,l,i)}catch(e){console.error("Error handling upgrade request",e),a.end()}},server:c.server,closeUpgraded(){var e;null==s||null==(e=s.hotReloader)||e.close()}}}