"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return FileSystemCache}});const _responsecache=require("../../response-cache"),_lrucache=require("../lru-cache"),_path=_interop_require_default(require("../../../shared/lib/isomorphic/path")),_constants=require("../../../lib/constants"),_tagsmanifestexternal=require("./tags-manifest.external"),_multifilewriter=require("../../../lib/multi-file-writer");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}let memoryCache;class FileSystemCache{constructor(e){this.fs=e.fs,this.flushToDisk=e.flushToDisk,this.serverDistDir=e.serverDistDir,this.revalidatedTags=e.revalidatedTags,this.debug=!!process.env.NEXT_PRIVATE_DEBUG_CACHE,e.maxMemoryCacheSize?memoryCache||(this.debug&&console.log("using memory store for fetch cache"),memoryCache=new _lrucache.LRUCache(e.maxMemoryCacheSize,(function({value:e}){var t;if(!e)return 25;if(e.kind===_responsecache.CachedRouteKind.REDIRECT)return JSON.stringify(e.props).length;if(e.kind===_responsecache.CachedRouteKind.IMAGE)throw Object.defineProperty(new Error("invariant image should not be incremental-cache"),"__NEXT_ERROR_CODE",{value:"E501",enumerable:!1,configurable:!0});return e.kind===_responsecache.CachedRouteKind.FETCH?JSON.stringify(e.data||"").length:e.kind===_responsecache.CachedRouteKind.APP_ROUTE?e.body.length:e.html.length+((null==(t=JSON.stringify(e.kind===_responsecache.CachedRouteKind.APP_PAGE?e.rscData:e.pageData))?void 0:t.length)||0)}))):this.debug&&console.log("not using memory store for fetch cache")}resetRequestCache(){}async revalidateTag(...e){let[t]=e;if(t="string"==typeof t?[t]:t,this.debug&&console.log("revalidateTag",t),0!==t.length)for(const e of t){const t=_tagsmanifestexternal.tagsManifest.items[e]||{};t.revalidatedAt=Date.now(),_tagsmanifestexternal.tagsManifest.items[e]=t}}async get(...e){var t,a,s;const[n,i]=e,{tags:r,softTags:c,kind:l,isRoutePPREnabled:o,isFallback:d}=i;let h=null==memoryCache?void 0:memoryCache.get(n);if(this.debug&&console.log("get",n,r,l,!!h),!h&&"edge"!==process.env.NEXT_RUNTIME){if(l===_responsecache.IncrementalCacheKind.APP_ROUTE)try{const e=this.getFilePath(`${n}.body`,_responsecache.IncrementalCacheKind.APP_ROUTE),t=await this.fs.readFile(e),{mtime:a}=await this.fs.stat(e),s=JSON.parse(await this.fs.readFile(e.replace(/\.body$/,_constants.NEXT_META_SUFFIX),"utf8"));return{lastModified:a.getTime(),value:{kind:_responsecache.CachedRouteKind.APP_ROUTE,body:t,headers:s.headers,status:s.status}}}catch{return null}try{const e=this.getFilePath(l===_responsecache.IncrementalCacheKind.FETCH?n:`${n}.html`,l),t=await this.fs.readFile(e,"utf8"),{mtime:a}=await this.fs.stat(e);if(l===_responsecache.IncrementalCacheKind.FETCH){var u;if(!this.flushToDisk)return null;const e=a.getTime(),s=JSON.parse(t);if(h={lastModified:e,value:s},(null==(u=h.value)?void 0:u.kind)===_responsecache.CachedRouteKind.FETCH){var _;const e=null==(_=h.value)?void 0:_.tags;(null==r?void 0:r.every((t=>null==e?void 0:e.includes(t))))||(this.debug&&console.log("tags vs storedTags mismatch",r,e),await this.set(n,h.value,{tags:r,isRoutePPREnabled:o}))}}else if(l===_responsecache.IncrementalCacheKind.APP_PAGE){let s,i,r;try{s=JSON.parse(await this.fs.readFile(e.replace(/\.html$/,_constants.NEXT_META_SUFFIX),"utf8"))}catch{}if(null==s?void 0:s.segmentPaths){const e=new Map;i=e;const t=n+_constants.RSC_SEGMENTS_DIR_SUFFIX;await Promise.all(s.segmentPaths.map((async a=>{const s=this.getFilePath(t+a+_constants.RSC_SEGMENT_SUFFIX,_responsecache.IncrementalCacheKind.APP_PAGE);try{e.set(a,await this.fs.readFile(s))}catch{}})))}d||(r=await this.fs.readFile(this.getFilePath(`${n}${o?_constants.RSC_PREFETCH_SUFFIX:_constants.RSC_SUFFIX}`,_responsecache.IncrementalCacheKind.APP_PAGE))),h={lastModified:a.getTime(),value:{kind:_responsecache.CachedRouteKind.APP_PAGE,html:t,rscData:r,postponed:null==s?void 0:s.postponed,headers:null==s?void 0:s.headers,status:null==s?void 0:s.status,segmentData:i}}}else{if(l!==_responsecache.IncrementalCacheKind.PAGES)throw Object.defineProperty(new Error(`Invariant: Unexpected route kind ${l} in file system cache.`),"__NEXT_ERROR_CODE",{value:"E445",enumerable:!1,configurable:!0});{let e,s={};d||(s=JSON.parse(await this.fs.readFile(this.getFilePath(`${n}${_constants.NEXT_DATA_SUFFIX}`,_responsecache.IncrementalCacheKind.PAGES),"utf8"))),h={lastModified:a.getTime(),value:{kind:_responsecache.CachedRouteKind.PAGES,html:t,pageData:s,headers:null==e?void 0:e.headers,status:null==e?void 0:e.status}}}}h&&(null==memoryCache||memoryCache.set(n,h))}catch{return null}}if((null==h||null==(t=h.value)?void 0:t.kind)===_responsecache.CachedRouteKind.APP_PAGE||(null==h||null==(a=h.value)?void 0:a.kind)===_responsecache.CachedRouteKind.PAGES){var f;let e;const t=null==(f=h.value.headers)?void 0:f[_constants.NEXT_CACHE_TAGS_HEADER];if("string"==typeof t&&(e=t.split(",")),null==e?void 0:e.length){if(e.some((e=>{var t;return(null==_tagsmanifestexternal.tagsManifest||null==(t=_tagsmanifestexternal.tagsManifest.items[e])?void 0:t.revalidatedAt)&&(null==_tagsmanifestexternal.tagsManifest?void 0:_tagsmanifestexternal.tagsManifest.items[e].revalidatedAt)>=((null==h?void 0:h.lastModified)||Date.now())})))return null}}else if((null==h||null==(s=h.value)?void 0:s.kind)===_responsecache.CachedRouteKind.FETCH){[...r||[],...c||[]].some((e=>{var t;return!!this.revalidatedTags.includes(e)||(null==_tagsmanifestexternal.tagsManifest||null==(t=_tagsmanifestexternal.tagsManifest.items[e])?void 0:t.revalidatedAt)&&(null==_tagsmanifestexternal.tagsManifest?void 0:_tagsmanifestexternal.tagsManifest.items[e].revalidatedAt)>=((null==h?void 0:h.lastModified)||Date.now())}))&&(h=void 0)}return h??null}async set(...e){const[t,a,s]=e,{isFallback:n}=s;if(null==memoryCache||memoryCache.set(t,{value:a,lastModified:Date.now()}),this.debug&&console.log("set",t),!this.flushToDisk||!a)return;const i=new _multifilewriter.MultiFileWriter(this.fs);if(a.kind===_responsecache.CachedRouteKind.APP_ROUTE){const e=this.getFilePath(`${t}.body`,_responsecache.IncrementalCacheKind.APP_ROUTE);i.append(e,a.body);const s={headers:a.headers,status:a.status,postponed:void 0,segmentPaths:void 0};i.append(e.replace(/\.body$/,_constants.NEXT_META_SUFFIX),JSON.stringify(s,null,2))}else if(a.kind===_responsecache.CachedRouteKind.PAGES||a.kind===_responsecache.CachedRouteKind.APP_PAGE){const e=a.kind===_responsecache.CachedRouteKind.APP_PAGE,r=this.getFilePath(`${t}.html`,e?_responsecache.IncrementalCacheKind.APP_PAGE:_responsecache.IncrementalCacheKind.PAGES);if(i.append(r,a.html),n||i.append(this.getFilePath(`${t}${e?s.isRoutePPREnabled?_constants.RSC_PREFETCH_SUFFIX:_constants.RSC_SUFFIX:_constants.NEXT_DATA_SUFFIX}`,e?_responsecache.IncrementalCacheKind.APP_PAGE:_responsecache.IncrementalCacheKind.PAGES),e?a.rscData:JSON.stringify(a.pageData)),(null==a?void 0:a.kind)===_responsecache.CachedRouteKind.APP_PAGE){let e;if(a.segmentData){e=[];const t=r.replace(/\.html$/,_constants.RSC_SEGMENTS_DIR_SUFFIX);for(const[s,n]of a.segmentData){e.push(s);const a=t+s+_constants.RSC_SEGMENT_SUFFIX;i.append(a,n)}}const t={headers:a.headers,status:a.status,postponed:a.postponed,segmentPaths:e};i.append(r.replace(/\.html$/,_constants.NEXT_META_SUFFIX),JSON.stringify(t))}}else if(a.kind===_responsecache.CachedRouteKind.FETCH){const e=this.getFilePath(t,_responsecache.IncrementalCacheKind.FETCH);i.append(e,JSON.stringify({...a,tags:s.tags}))}await i.wait()}getFilePath(e,t){switch(t){case _responsecache.IncrementalCacheKind.FETCH:return _path.default.join(this.serverDistDir,"..","cache","fetch-cache",e);case _responsecache.IncrementalCacheKind.PAGES:return _path.default.join(this.serverDistDir,"pages",e);case _responsecache.IncrementalCacheKind.IMAGE:case _responsecache.IncrementalCacheKind.APP_PAGE:case _responsecache.IncrementalCacheKind.APP_ROUTE:return _path.default.join(this.serverDistDir,"app",e);default:throw Object.defineProperty(new Error(`Unexpected file path kind: ${t}`),"__NEXT_ERROR_CODE",{value:"E479",enumerable:!1,configurable:!0})}}}