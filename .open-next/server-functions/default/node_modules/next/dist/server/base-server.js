"use strict";function _export(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{NoFallbackError:function(){return NoFallbackError},WrappedBuildError:function(){return WrappedBuildError},default:function(){return Server}});const _fallbackparams=require("./request/fallback-params"),_responsecache=require("./response-cache"),_utils=require("../shared/lib/utils"),_url=require("url"),_formathostname=require("./lib/format-hostname"),_redirectstatus=require("../lib/redirect-status"),_isedgeruntime=require("../lib/is-edge-runtime"),_constants=require("../shared/lib/constants"),_utils1=require("../shared/lib/router/utils"),_apiutils=require("./api-utils"),_runtimeconfigexternal=require("../shared/lib/runtime-config.external"),_revalidate=require("./lib/revalidate"),_utils2=require("./utils"),_isbot=require("../shared/lib/router/utils/is-bot"),_renderresult=_interop_require_default(require("./render-result")),_removetrailingslash=require("../shared/lib/router/utils/remove-trailing-slash"),_denormalizepagepath=require("../shared/lib/page-path/denormalize-page-path"),_log=_interop_require_wildcard(require("../build/output/log")),_serverutils=require("./server-utils"),_iserror=_interop_require_wildcard(require("../lib/is-error")),_requestmeta=require("./request-meta"),_removepathprefix=require("../shared/lib/router/utils/remove-path-prefix"),_apppaths=require("../shared/lib/router/utils/app-paths"),_gethostname=require("../shared/lib/get-hostname"),_parseurl=require("../shared/lib/router/utils/parse-url"),_getnextpathnameinfo=require("../shared/lib/router/utils/get-next-pathname-info"),_approuterheaders=require("../client/components/app-router-headers"),_localeroutenormalizer=require("./normalizers/locale-route-normalizer"),_defaultroutematchermanager=require("./route-matcher-managers/default-route-matcher-manager"),_apppageroutematcherprovider=require("./route-matcher-providers/app-page-route-matcher-provider"),_approuteroutematcherprovider=require("./route-matcher-providers/app-route-route-matcher-provider"),_pagesapiroutematcherprovider=require("./route-matcher-providers/pages-api-route-matcher-provider"),_pagesroutematcherprovider=require("./route-matcher-providers/pages-route-matcher-provider"),_servermanifestloader=require("./route-matcher-providers/helpers/manifest-loaders/server-manifest-loader"),_tracer=require("./lib/trace/tracer"),_constants1=require("./lib/trace/constants"),_i18nprovider=require("./lib/i18n-provider"),_sendresponse=require("./send-response"),_utils3=require("./web/utils"),_constants2=require("../lib/constants"),_normalizelocalepath=require("../shared/lib/i18n/normalize-locale-path"),_nextrequest=require("./web/spec-extension/adapters/next-request"),_matchnextdatapathname=require("./lib/match-next-data-pathname"),_getroutefromassetpath=_interop_require_default(require("../shared/lib/router/utils/get-route-from-asset-path")),_decodepathparams=require("./lib/router-utils/decode-path-params"),_rsc=require("./normalizers/request/rsc"),_stripflightheaders=require("./app-render/strip-flight-headers"),_checks=require("./route-modules/checks"),_prefetchrsc=require("./normalizers/request/prefetch-rsc"),_nextdata=require("./normalizers/request/next-data"),_serveractionrequestmeta=require("./lib/server-action-request-meta"),_interceptionroutes=require("./lib/interception-routes"),_toroute=require("./lib/to-route"),_helpers=require("./base-http/helpers"),_patchsetheader=require("./lib/patch-set-header"),_ppr=require("./lib/experimental/ppr"),_builtinrequestcontext=require("./after/builtin-request-context"),_encodedTags=require("./stream-utils/encodedTags"),_adapter=require("./web/adapter"),_utils4=require("./instrumentation/utils"),_routekind=require("./route-kind"),_fallback=require("../lib/fallback"),_utils5=require("./response-cache/utils"),_scheduler=require("../lib/scheduler"),_segmentprefixrsc=require("./normalizers/request/segment-prefix-rsc"),_streamingmetadata=require("./lib/streaming-metadata"),_handlers=require("./use-cache/handlers");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(_getRequireWildcardCache=function(e){return e?r:t})(e)}function _interop_require_wildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=_getRequireWildcardCache(t);if(r&&r.has(e))return r.get(e);var a={__proto__:null},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var i in e)if("default"!==i&&Object.prototype.hasOwnProperty.call(e,i)){var n=s?Object.getOwnPropertyDescriptor(e,i):null;n&&(n.get||n.set)?Object.defineProperty(a,i,n):a[i]=e[i]}return a.default=e,r&&r.set(e,a),a}class NoFallbackError extends Error{}class WrappedBuildError extends Error{constructor(e){super(),this.innerError=e}}class Server{getServerComponentsHmrCache(){return this.nextConfig.experimental.serverComponentsHmrCache?globalThis.__serverComponentsHmrCache:void 0}constructor(e){var t,r,a;this.handleRSCRequest=(e,t,r)=>{var a,s,i;if(!r.pathname)return!1;if(null==(a=this.normalizers.segmentPrefetchRSC)?void 0:a.match(r.pathname)){const t=this.normalizers.segmentPrefetchRSC.extract(r.pathname);if(!t)return!1;const{originalPathname:a,segmentPath:s}=t;r.pathname=a,e.headers[_approuterheaders.RSC_HEADER.toLowerCase()]="1",e.headers[_approuterheaders.NEXT_ROUTER_PREFETCH_HEADER.toLowerCase()]="1",e.headers[_approuterheaders.NEXT_ROUTER_SEGMENT_PREFETCH_HEADER.toLowerCase()]=s,(0,_requestmeta.addRequestMeta)(e,"isRSCRequest",!0),(0,_requestmeta.addRequestMeta)(e,"isPrefetchRSCRequest",!0),(0,_requestmeta.addRequestMeta)(e,"segmentPrefetchRSCRequest",s)}else if(null==(s=this.normalizers.prefetchRSC)?void 0:s.match(r.pathname))r.pathname=this.normalizers.prefetchRSC.normalize(r.pathname,!0),e.headers[_approuterheaders.RSC_HEADER.toLowerCase()]="1",e.headers[_approuterheaders.NEXT_ROUTER_PREFETCH_HEADER.toLowerCase()]="1",(0,_requestmeta.addRequestMeta)(e,"isRSCRequest",!0),(0,_requestmeta.addRequestMeta)(e,"isPrefetchRSCRequest",!0);else if(null==(i=this.normalizers.rsc)?void 0:i.match(r.pathname))r.pathname=this.normalizers.rsc.normalize(r.pathname,!0),e.headers[_approuterheaders.RSC_HEADER.toLowerCase()]="1",(0,_requestmeta.addRequestMeta)(e,"isRSCRequest",!0);else{if(e.headers["x-now-route-matches"])return(0,_stripflightheaders.stripFlightHeaders)(e.headers),!1;if("1"!==e.headers[_approuterheaders.RSC_HEADER.toLowerCase()])return!1;if((0,_requestmeta.addRequestMeta)(e,"isRSCRequest",!0),"1"===e.headers[_approuterheaders.NEXT_ROUTER_PREFETCH_HEADER.toLowerCase()]){(0,_requestmeta.addRequestMeta)(e,"isPrefetchRSCRequest",!0);const t=e.headers[_approuterheaders.NEXT_ROUTER_SEGMENT_PREFETCH_HEADER.toLowerCase()];"string"==typeof t&&(0,_requestmeta.addRequestMeta)(e,"segmentPrefetchRSCRequest",t)}}if(e.url){const t=(0,_url.parse)(e.url);t.pathname=r.pathname,e.url=(0,_url.format)(t)}return!1},this.handleNextDataRequest=async(e,t,r)=>{const a=await this.getMiddleware(),s=(0,_matchnextdatapathname.matchNextDataPathname)(r.pathname);if(!s||!s.path)return!1;if(s.path[0]!==this.buildId)return("edge"===process.env.NEXT_RUNTIME||!(0,_requestmeta.getRequestMeta)(e,"middlewareInvoke"))&&(await this.render404(e,t,r),!0);s.path.shift();const i=s.path[s.path.length-1];if("string"!=typeof i||!i.endsWith(".json"))return await this.render404(e,t,r),!0;let n=`/${s.path.join("/")}`;if(n=(0,_getroutefromassetpath.default)(n,".json"),a&&(this.nextConfig.trailingSlash&&!n.endsWith("/")&&(n+="/"),!this.nextConfig.trailingSlash&&n.length>1&&n.endsWith("/")&&(n=n.substring(0,n.length-1))),this.i18nProvider){var o;const s=null==e||null==(o=e.headers.host)?void 0:o.split(":",1)[0].toLowerCase(),i=this.i18nProvider.detectDomainLocale(s),l=(null==i?void 0:i.defaultLocale)??this.i18nProvider.config.defaultLocale,d=this.i18nProvider.analyze(n);if(d.detectedLocale&&(n=d.pathname),(0,_requestmeta.addRequestMeta)(e,"locale",d.detectedLocale),(0,_requestmeta.addRequestMeta)(e,"defaultLocale",l),d.detectedLocale||(0,_requestmeta.removeRequestMeta)(e,"localeInferredFromDefault"),!d.detectedLocale&&!a)return(0,_requestmeta.addRequestMeta)(e,"locale",l),await this.render404(e,t,r),!0}return r.pathname=n,(0,_requestmeta.addRequestMeta)(e,"isNextDataReq",!0),!1},this.handleNextImageRequest=()=>!1,this.handleCatchallRenderRequest=()=>!1,this.handleCatchallMiddlewareRequest=()=>!1,this.normalize=e=>{const t=[];this.normalizers.data&&t.push(this.normalizers.data),this.normalizers.segmentPrefetchRSC&&t.push(this.normalizers.segmentPrefetchRSC),this.normalizers.prefetchRSC&&t.push(this.normalizers.prefetchRSC),this.normalizers.rsc&&t.push(this.normalizers.rsc);for(const r of t)if(r.match(e))return r.normalize(e,!0);return e},this.normalizeAndAttachMetadata=async(e,t,r)=>{let a=await this.handleNextImageRequest(e,t,r);return!!a||!(!this.enabledDirectories.pages||(a=await this.handleNextDataRequest(e,t,r),!a))},this.prepared=!1,this.preparedPromise=null,this.customErrorNo404Warn=(0,_utils.execOnce)((()=>{_log.warn("You have added a custom /_error page without a custom /404 page. This prevents the 404 page from being auto statically optimized.\nSee here for info: https://nextjs.org/docs/messages/custom-error-no-custom-404")}));const{dir:s=".",quiet:i=!1,conf:n,dev:o=!1,minimalMode:l=!1,hostname:d,port:u,experimentalTestProxy:h}=e;this.experimentalTestProxy=h,this.serverOptions=e,this.dir="edge"===process.env.NEXT_RUNTIME?s:require("path").resolve(s),this.quiet=i,this.loadEnvConfig({dev:o}),this.nextConfig=n,this.hostname=d,this.hostname&&(this.fetchHostname=(0,_formathostname.formatHostname)(this.hostname)),this.port=u,this.distDir="edge"===process.env.NEXT_RUNTIME?this.nextConfig.distDir:require("path").join(this.dir,this.nextConfig.distDir),this.publicDir=this.getPublicDir(),this.hasStaticDir=!l&&this.getHasStaticDir(),this.i18nProvider=(null==(t=this.nextConfig.i18n)?void 0:t.locales)?new _i18nprovider.I18NProvider(this.nextConfig.i18n):void 0,this.localeNormalizer=this.i18nProvider?new _localeroutenormalizer.LocaleRouteNormalizer(this.i18nProvider):void 0;const{serverRuntimeConfig:c={},publicRuntimeConfig:p,assetPrefix:m,generateEtags:_}=this.nextConfig;this.buildId=this.getBuildId();this["minimalMode"]=l||!!process.env.NEXT_PRIVATE_MINIMAL_MODE,this.enabledDirectories=this.getEnabledDirectories(o),this.isAppPPREnabled=this.enabledDirectories.app&&(0,_ppr.checkIsAppPPREnabled)(this.nextConfig.experimental.ppr),this.isAppSegmentPrefetchEnabled=this.enabledDirectories.app&&!0===this.nextConfig.experimental.clientSegmentCache,this.normalizers={rsc:this.enabledDirectories.app&&this.minimalMode?new _rsc.RSCPathnameNormalizer:void 0,prefetchRSC:this.isAppPPREnabled&&this.minimalMode?new _prefetchrsc.PrefetchRSCPathnameNormalizer:void 0,segmentPrefetchRSC:this.isAppSegmentPrefetchEnabled&&this.minimalMode?new _segmentprefixrsc.SegmentPrefixRSCPathnameNormalizer:void 0,data:this.enabledDirectories.pages?new _nextdata.NextDataPathnameNormalizer(this.buildId):void 0},this.nextFontManifest=this.getNextFontManifest(),"edge"!==process.env.NEXT_RUNTIME&&(process.env.NEXT_DEPLOYMENT_ID=this.nextConfig.deploymentId||""),this.renderOpts={supportsDynamicResponse:!0,trailingSlash:this.nextConfig.trailingSlash,deploymentId:this.nextConfig.deploymentId,strictNextHead:this.nextConfig.experimental.strictNextHead??!0,poweredByHeader:this.nextConfig.poweredByHeader,canonicalBase:this.nextConfig.amp.canonicalBase||"",generateEtags:_,previewProps:this.getPrerenderManifest().preview,ampOptimizerConfig:null==(r=this.nextConfig.experimental.amp)?void 0:r.optimizer,basePath:this.nextConfig.basePath,images:this.nextConfig.images,optimizeCss:this.nextConfig.experimental.optimizeCss,nextConfigOutput:this.nextConfig.output,nextScriptWorkers:this.nextConfig.experimental.nextScriptWorkers,disableOptimizedLoading:this.nextConfig.experimental.disableOptimizedLoading,domainLocales:null==(a=this.nextConfig.i18n)?void 0:a.domains,distDir:this.distDir,serverComponents:this.enabledDirectories.app,cacheLifeProfiles:this.nextConfig.experimental.cacheLife,enableTainting:this.nextConfig.experimental.taint,crossOrigin:this.nextConfig.crossOrigin?this.nextConfig.crossOrigin:void 0,largePageDataBytes:this.nextConfig.experimental.largePageDataBytes,runtimeConfig:Object.keys(p).length>0?p:void 0,isExperimentalCompile:this.nextConfig.experimental.isExperimentalCompile,htmlLimitedBots:this.nextConfig.htmlLimitedBots,streamingMetadata:!this.nextConfig.experimental.dynamicIO,experimental:{expireTime:this.nextConfig.expireTime,clientTraceMetadata:this.nextConfig.experimental.clientTraceMetadata,dynamicIO:this.nextConfig.experimental.dynamicIO??!1,clientSegmentCache:this.nextConfig.experimental.clientSegmentCache??!1,inlineCss:this.nextConfig.experimental.inlineCss??!1,authInterrupts:!!this.nextConfig.experimental.authInterrupts},onInstrumentationRequestError:this.instrumentationOnRequestError.bind(this),reactMaxHeadersLength:this.nextConfig.reactMaxHeadersLength},(0,_runtimeconfigexternal.setConfig)({serverRuntimeConfig:c,publicRuntimeConfig:p}),this.pagesManifest=this.getPagesManifest(),this.appPathsManifest=this.getAppPathsManifest(),this.appPathRoutes=this.getAppPathRoutes(),this.interceptionRoutePatterns=this.getinterceptionRoutePatterns(),this.matchers=this.getRouteMatchers(),this.matchers.reload(),this.setAssetPrefix(m),this.responseCache=this.getResponseCache({dev:o})}reloadMatchers(){return this.matchers.reload()}getRouteMatchers(){const e=new _servermanifestloader.ServerManifestLoader((e=>{switch(e){case _constants.PAGES_MANIFEST:return this.getPagesManifest()??null;case _constants.APP_PATHS_MANIFEST:return this.getAppPathsManifest()??null;default:return null}})),t=new _defaultroutematchermanager.DefaultRouteMatcherManager;return t.push(new _pagesroutematcherprovider.PagesRouteMatcherProvider(this.distDir,e,this.i18nProvider)),t.push(new _pagesapiroutematcherprovider.PagesAPIRouteMatcherProvider(this.distDir,e,this.i18nProvider)),this.enabledDirectories.app&&(t.push(new _apppageroutematcherprovider.AppPageRouteMatcherProvider(this.distDir,e)),t.push(new _approuteroutematcherprovider.AppRouteRouteMatcherProvider(this.distDir,e))),t}async instrumentationOnRequestError(...e){const[t,r,a]=e;if(this.instrumentation)try{await(null==this.instrumentation.onRequestError?void 0:this.instrumentation.onRequestError.call(this.instrumentation,t,{path:r.url||"",method:r.method||"GET",headers:r instanceof _adapter.NextRequestHint?Object.fromEntries(r.headers.entries()):r.headers},a))}catch(e){console.error("Error in instrumentation.onRequestError:",e)}}logError(e){this.quiet||_log.error(e)}async handleRequest(e,t,r){await this.prepare();const a=e.method.toUpperCase(),s=(0,_tracer.getTracer)();return s.withPropagatedContext(e.headers,(()=>s.trace(_constants1.BaseServerSpan.handleRequest,{spanName:`${a} ${e.url}`,kind:_tracer.SpanKind.SERVER,attributes:{"http.method":a,"http.target":e.url}},(async i=>this.handleRequestImpl(e,t,r).finally((()=>{if(!i)return;const r=(0,_requestmeta.getRequestMeta)(e,"isRSCRequest")??!1;i.setAttributes({"http.status_code":t.statusCode,"next.rsc":r});const n=s.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==_constants1.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);const o=n.get("next.route");if(o){const e=r?`RSC ${a} ${o}`:`${a} ${o}`;i.setAttributes({"next.route":o,"http.route":o,"next.span_name":e}),i.updateName(e)}else i.updateName(r?`RSC ${a} ${e.url}`:`${a} ${e.url}`)}))))))}async handleRequestImpl(e,t,r){try{var a,s,i,n;await this.matchers.waitTillReady(),(0,_patchsetheader.patchSetHeaderWithCookieSupport)(e,(0,_helpers.isNodeNextResponse)(t)?t.originalResponse:t);const c=(e.url||"").split("?",1)[0];if(null==c?void 0:c.match(/(\\|\/\/)/)){const r=(0,_utils.normalizeRepeatedSlashes)(e.url);return void t.redirect(r,308).body(r).send()}if(!r||"object"!=typeof r){if(!e.url)throw Object.defineProperty(new Error("Invariant: url can not be undefined"),"__NEXT_ERROR_CODE",{value:"E123",enumerable:!1,configurable:!0});r=(0,_url.parse)(e.url,!0)}if(!r.pathname)throw Object.defineProperty(new Error("Invariant: pathname can't be empty"),"__NEXT_ERROR_CODE",{value:"E412",enumerable:!1,configurable:!0});"string"==typeof r.query&&(r.query=Object.fromEntries(new URLSearchParams(r.query)));const{originalRequest:p=null}=(0,_helpers.isNodeNextRequest)(e)?e:{},m=null==p?void 0:p.headers["x-forwarded-proto"],_=m?"https"===m:!!(null==p||null==(a=p.socket)?void 0:a.encrypted);e.headers["x-forwarded-host"]??=e.headers.host??this.hostname,e.headers["x-forwarded-port"]??=this.port?this.port.toString():_?"443":"80",e.headers["x-forwarded-proto"]??=_?"https":"http",e.headers["x-forwarded-for"]??=null==p||null==(s=p.socket)?void 0:s.remoteAddress,this.attachRequestMeta(e,r);let f=await this.handleRSCRequest(e,t,r);if(f)return;const R=null==(i=this.i18nProvider)?void 0:i.detectDomainLocale((0,_gethostname.getHostname)(r,e.headers)),g=(null==R?void 0:R.defaultLocale)||(null==(n=this.nextConfig.i18n)?void 0:n.defaultLocale);(0,_requestmeta.addRequestMeta)(e,"defaultLocale",g);const E=(0,_parseurl.parseUrl)(e.url.replace(/^\/+/,"/")),v=(0,_getnextpathnameinfo.getNextPathnameInfo)(E.pathname,{nextConfig:this.nextConfig,i18nProvider:this.i18nProvider});E.pathname=v.pathname,v.basePath&&(e.url=(0,_removepathprefix.removePathPrefix)(e.url,this.nextConfig.basePath));const q=this.minimalMode&&"string"==typeof e.headers[_constants2.MATCHED_PATH_HEADER];if(q)try{var o,l,d;this.enabledDirectories.app&&(e.url.match(/^\/index($|\?)/)&&(e.url=e.url.replace(/^\/index/,"/")),r.pathname="/index"===r.pathname?"/":r.pathname);let{pathname:a}=new URL(e.headers[_constants2.MATCHED_PATH_HEADER],"http://localhost"),{pathname:s}=new URL(e.url,"http://localhost");if(null==(o=this.normalizers.data)?void 0:o.match(s))(0,_requestmeta.addRequestMeta)(e,"isNextDataReq",!0);else if(this.isAppPPREnabled&&this.minimalMode&&"1"===e.headers[_constants2.NEXT_RESUME_HEADER]&&"POST"===e.method){const t=[];for await(const r of e.body)t.push(r);const r=Buffer.concat(t).toString("utf8");(0,_requestmeta.addRequestMeta)(e,"postponed",r)}a=this.normalize(a);const i=this.stripNextDataPath(s),n=null==(l=this.i18nProvider)?void 0:l.analyze(a,{defaultLocale:g});n&&((0,_requestmeta.addRequestMeta)(e,"locale",n.detectedLocale),n.inferredFromDefault?(0,_requestmeta.addRequestMeta)(e,"localeInferredFromDefault",!0):(0,_requestmeta.removeRequestMeta)(e,"localeInferredFromDefault")),a=(0,_denormalizepagepath.denormalizePagePath)(a);let h=a,c=(0,_utils1.isDynamicRoute)(h);if(!c){const e=await this.matchers.match(h,{i18n:n});e&&(h=e.definition.pathname,c=void 0!==e.params)}n&&(a=n.pathname);const p=(0,_serverutils.getUtils)({pageIsDynamic:c,page:h,i18n:this.nextConfig.i18n,basePath:this.nextConfig.basePath,rewrites:(null==(d=this.getRoutesManifest())?void 0:d.rewrites)||{beforeFiles:[],afterFiles:[],fallback:[]},caseSensitive:!!this.nextConfig.experimental.caseSensitiveRoutes});g&&!v.locale&&(r.pathname=`/${g}${r.pathname}`);const m=r.pathname,_=Object.keys(p.handleRewrites(e,r)),R=m!==r.pathname;R&&r.pathname&&(0,_requestmeta.addRequestMeta)(e,"rewroteURL",r.pathname);const q={...r.query};for(const[e,t]of Object.entries(r.query)){const a=(0,_utils3.normalizeNextQueryParam)(e);a&&(delete r.query[e],void 0!==t&&(q[a]=t))}if(c){let t={},r=p.normalizeDynamicRouteParams(q,!1);if(!r.hasValidParams&&!(0,_utils1.isDynamicRoute)(i)){let e=null==p.dynamicRouteMatcher?void 0:p.dynamicRouteMatcher.call(p,i);e&&(p.normalizeDynamicRouteParams(e,!1),Object.assign(r.params,e),r.hasValidParams=!0)}if("/index"!==a&&!r.hasValidParams&&!(0,_utils1.isDynamicRoute)(a)){let e=null==p.dynamicRouteMatcher?void 0:p.dynamicRouteMatcher.call(p,a);if(e){const a=p.normalizeDynamicRouteParams(e,!1);a.hasValidParams&&(Object.assign(t,e),r=a)}}r.hasValidParams&&(t=r.params);const s=e.headers["x-now-route-matches"];if("string"==typeof s&&s&&(0,_utils1.isDynamicRoute)(a)&&!r.hasValidParams){const e=p.getParamsFromRouteMatches(s);e&&(r=p.normalizeDynamicRouteParams(e,!0),r.hasValidParams&&(t=r.params))}if(r.hasValidParams||(r=p.normalizeDynamicRouteParams(q,!0),r.hasValidParams&&(t=r.params)),!p.defaultRouteMatches||i!==h||r.hasValidParams||p.normalizeDynamicRouteParams({...t},!0).hasValidParams||(t=p.defaultRouteMatches,(0,_requestmeta.addRequestMeta)(e,"didSetDefaultRouteMatches",!0)),t){a=p.interpolateDynamicPath(h,t),e.url=p.interpolateDynamicPath(e.url,t);let r=(0,_requestmeta.getRequestMeta)(e,"segmentPrefetchRSCRequest");r&&(0,_utils1.isDynamicRoute)(r,!1)&&(r=p.interpolateDynamicPath(r,t),e.headers[_approuterheaders.NEXT_ROUTER_SEGMENT_PREFETCH_HEADER.toLowerCase()]=r,(0,_requestmeta.addRequestMeta)(e,"segmentPrefetchRSCRequest",r))}}var u;if(c||R)p.normalizeVercelUrl(e,[..._,...Object.keys((null==(u=p.defaultRouteRegex)?void 0:u.groups)||{})]);if(r.pathname=a,E.pathname=r.pathname,f=await this.normalizeAndAttachMetadata(e,t,r),f)return}catch(r){if(r instanceof _utils.DecodeError||r instanceof _utils.NormalizeError)return t.statusCode=400,this.renderError(null,e,t,"/_error",{});throw r}if((0,_requestmeta.addRequestMeta)(e,"isLocaleDomain",Boolean(R)),v.locale&&(e.url=(0,_url.format)(E),(0,_requestmeta.addRequestMeta)(e,"didStripLocale",!0)),this.minimalMode&&(0,_requestmeta.getRequestMeta)(e,"locale")||(v.locale?(0,_requestmeta.addRequestMeta)(e,"locale",v.locale):g&&((0,_requestmeta.addRequestMeta)(e,"locale",g),(0,_requestmeta.addRequestMeta)(e,"localeInferredFromDefault",!0))),!this.serverOptions.webServerConfig&&!(0,_requestmeta.getRequestMeta)(e,"incrementalCache")){let t="https:";try{t=new URL((0,_requestmeta.getRequestMeta)(e,"initURL")||"/","http://n").protocol}catch{}const r=await this.getIncrementalCache({requestHeaders:Object.assign({},e.headers),requestProtocol:t.substring(0,t.length-1)});r.resetRequestCache(),(0,_requestmeta.addRequestMeta)(e,"incrementalCache",r),globalThis.__incrementalCache=r}const C=(0,_handlers.getCacheHandlers)();if(C){const t=e.headers[_constants2.NEXT_CACHE_REVALIDATED_TAGS_HEADER],r="string"==typeof t?t.split(","):[],a=[];for(const e of C)a.push(e.receiveExpiredTags(...r));a.length>0&&await Promise.all(a)}(0,_requestmeta.getRequestMeta)(e,"serverComponentsHmrCache")||(0,_requestmeta.addRequestMeta)(e,"serverComponentsHmrCache",this.getServerComponentsHmrCache());const P=(0,_requestmeta.getRequestMeta)(e,"invokePath");if(!q&&"edge"!==process.env.NEXT_RUNTIME&&P){var h;const a=(0,_requestmeta.getRequestMeta)(e,"invokeStatus");if(a){const s=(0,_requestmeta.getRequestMeta)(e,"invokeQuery");s&&Object.assign(r.query,s),t.statusCode=a;let i=(0,_requestmeta.getRequestMeta)(e,"invokeError")||null;return this.renderError(i,e,t,"/_error",r.query)}const s=new URL(P||"/","http://n"),i=(0,_getnextpathnameinfo.getNextPathnameInfo)(s.pathname,{nextConfig:this.nextConfig,parseData:!1});i.locale&&(0,_requestmeta.addRequestMeta)(e,"locale",i.locale),r.pathname!==s.pathname&&(r.pathname=s.pathname,(0,_requestmeta.addRequestMeta)(e,"rewroteURL",i.pathname));const n=(0,_normalizelocalepath.normalizeLocalePath)((0,_removepathprefix.removePathPrefix)(r.pathname,this.nextConfig.basePath||""),null==(h=this.nextConfig.i18n)?void 0:h.locales);n.detectedLocale&&(0,_requestmeta.addRequestMeta)(e,"locale",n.detectedLocale),r.pathname=n.pathname;for(const e of Object.keys(r.query))delete r.query[e];const o=(0,_requestmeta.getRequestMeta)(e,"invokeQuery");if(o&&Object.assign(r.query,o),f=await this.normalizeAndAttachMetadata(e,t,r),f)return;return void await this.handleCatchallRenderRequest(e,t,r)}if("edge"!==process.env.NEXT_RUNTIME&&(0,_requestmeta.getRequestMeta)(e,"middlewareInvoke")){if(f=await this.normalizeAndAttachMetadata(e,t,r),f)return;if(f=await this.handleCatchallMiddlewareRequest(e,t,r),f)return;const a=new Error;throw a.result={response:new Response(null,{headers:{"x-middleware-next":"1"}})},a.bubble=!0,a}return!q&&v.basePath&&(r.pathname=(0,_removepathprefix.removePathPrefix)(r.pathname,v.basePath)),t.statusCode=200,await this.run(e,t,r)}catch(r){if(r instanceof NoFallbackError)throw r;if(r&&"object"==typeof r&&"ERR_INVALID_URL"===r.code||r instanceof _utils.DecodeError||r instanceof _utils.NormalizeError)return t.statusCode=400,this.renderError(null,e,t,"/_error",{});if(this.minimalMode||this.renderOpts.dev||(0,_tracer.isBubbledError)(r)&&r.bubble)throw r;this.logError((0,_iserror.getProperError)(r)),t.statusCode=500,t.body("Internal Server Error").send()}}getRequestHandlerWithMetadata(e){const t=this.getRequestHandler();return(r,a,s)=>((0,_requestmeta.setRequestMeta)(r,e),t(r,a,s))}getRequestHandler(){return this.handleRequest.bind(this)}setAssetPrefix(e){this.renderOpts.assetPrefix=e?e.replace(/\/$/,""):""}async prepare(){if(!this.prepared)return null===this.preparedPromise&&(this.instrumentation=await this.loadInstrumentationModule(),this.preparedPromise=this.prepareImpl().then((()=>{this.prepared=!0,this.preparedPromise=null}))),this.preparedPromise}async prepareImpl(){}async loadInstrumentationModule(){}async close(){}getAppPathRoutes(){const e={};return Object.keys(this.appPathsManifest||{}).forEach((t=>{const r=(0,_apppaths.normalizeAppPath)(t);e[r]||(e[r]=[]),e[r].push(t)})),e}async run(e,t,r){return(0,_tracer.getTracer)().trace(_constants1.BaseServerSpan.run,(async()=>this.runImpl(e,t,r)))}async runImpl(e,t,r){await this.handleCatchallRenderRequest(e,t,r)}async pipe(e,t){return(0,_tracer.getTracer)().trace(_constants1.BaseServerSpan.pipe,(async()=>this.pipeImpl(e,t)))}async pipeImpl(e,t){const r=t.req.headers["user-agent"]||"",a=(0,_isbot.isBot)(r),s={...t,renderOpts:{...this.renderOpts,supportsDynamicResponse:!a,botType:(0,_isbot.getBotType)(r),serveStreamingMetadata:(0,_streamingmetadata.shouldServeStreamingMetadata)(r,{streamingMetadata:!!this.renderOpts.streamingMetadata,htmlLimitedBots:this.nextConfig.htmlLimitedBots})}},i=await e(s);if(null===i)return;const{req:n,res:o}=s,l=o.statusCode,{body:d,type:u}=i;let{revalidate:h}=i;if(!o.sent){const{generateEtags:e,poweredByHeader:t,dev:r}=this.renderOpts;r&&(o.setHeader("Cache-Control","no-store, must-revalidate"),h=void 0),await this.sendRenderResult(n,o,{result:d,type:u,generateEtags:e,poweredByHeader:t,revalidate:h,expireTime:this.nextConfig.expireTime}),o.statusCode=l}}async getStaticHTML(e,t){const r={...t,renderOpts:{...this.renderOpts,supportsDynamicResponse:!1}},a=await e(r);return null===a?null:a.body.toUnchunkedString()}async render(e,t,r,a={},s,i=!1){return(0,_tracer.getTracer)().trace(_constants1.BaseServerSpan.render,(async()=>this.renderImpl(e,t,r,a,s,i)))}getWaitUntil(){const e=(0,_builtinrequestcontext.getBuiltinRequestContext)();return e?e.waitUntil:this.minimalMode?void 0:this.getInternalWaitUntil()}getInternalWaitUntil(){}async renderImpl(e,t,r,a={},s,i=!1){var n;return r.startsWith("/")||console.warn(`Cannot render page with path "${r}", did you mean "/${r}"?. See more info here: https://nextjs.org/docs/messages/render-no-starting-slash`),this.serverOptions.customServer&&"/index"===r&&!await this.hasPage("/index")&&(r="/"),i||this.minimalMode||(0,_requestmeta.getRequestMeta)(e,"isNextDataReq")||!((null==(n=e.url)?void 0:n.match(/^\/_next\//))||this.hasStaticDir&&e.url.match(/^\/static\//))?(0,_utils2.isBlockedPage)(r)?this.render404(e,t,s):this.pipe((e=>this.renderToResponse(e)),{req:e,res:t,pathname:r,query:a}):this.handleRequest(e,t,s)}async getStaticPaths({pathname:e}){var t;const r=null==(t=this.getPrerenderManifest().dynamicRoutes[e])?void 0:t.fallback;return{staticPaths:void 0,fallbackMode:(0,_fallback.parseFallbackField)(r)}}async renderToResponseWithComponents(e,t){return(0,_tracer.getTracer)().trace(_constants1.BaseServerSpan.renderToResponseWithComponents,(async()=>this.renderToResponseWithComponentsImpl(e,t)))}pathCouldBeIntercepted(e){return(0,_interceptionroutes.isInterceptionRouteAppPath)(e)||this.interceptionRoutePatterns.some((t=>t.test(e)))}setVaryHeader(e,t,r,a){const s=`${_approuterheaders.RSC_HEADER}, ${_approuterheaders.NEXT_ROUTER_STATE_TREE_HEADER}, ${_approuterheaders.NEXT_ROUTER_PREFETCH_HEADER}, ${_approuterheaders.NEXT_ROUTER_SEGMENT_PREFETCH_HEADER}`,i=(0,_requestmeta.getRequestMeta)(e,"isRSCRequest")??!1;let n=!1;r&&this.pathCouldBeIntercepted(a)?(t.appendHeader("vary",`${s}, ${_approuterheaders.NEXT_URL}`),n=!0):(r||i)&&t.appendHeader("vary",s),n||delete e.headers[_approuterheaders.NEXT_URL]}async renderToResponseWithComponentsImpl({req:e,res:t,pathname:r,renderOpts:a},{components:s,query:i}){var n,o,l,d,u,h;r===_constants.UNDERSCORE_NOT_FOUND_ROUTE&&(r="/404");const c="/_error"===r,p="/404"===r||c&&404===t.statusCode,m="/500"===r||c&&500===t.statusCode,_=!0===s.isAppPath,f=!!s.getServerSideProps;let R=!!s.getStaticPaths;const g=(0,_serveractionrequestmeta.getIsServerAction)(e),E=!!(null==(n=s.Component)?void 0:n.getInitialProps);let v,q,C=!!s.getStaticProps,P=(0,_url.parse)(e.url||"").pathname||"/",b=(0,_requestmeta.getRequestMeta)(e,"rewroteURL")||P;this.setVaryHeader(e,t,_,b);let y=!1;const x=(0,_utils1.isDynamicRoute)(s.page),M=this.getPrerenderManifest();if(_&&x){const t=await this.getStaticPaths({pathname:r,page:s.page,isAppPath:_,requestHeaders:e.headers});if(v=t.staticPaths,q=t.fallbackMode,y=void 0!==q,"export"===this.nextConfig.output){const e=s.page;if(!v)throw Object.defineProperty(new Error(`Page "${e}" is missing exported function "generateStaticParams()", which is required with "output: export" config.`),"__NEXT_ERROR_CODE",{value:"E353",enumerable:!1,configurable:!0});const t=(0,_removetrailingslash.removeTrailingSlash)(b);if(!v.includes(t))throw Object.defineProperty(new Error(`Page "${e}" is missing param "${t}" in "generateStaticParams()", which is required with "output: export" config.`),"__NEXT_ERROR_CODE",{value:"E443",enumerable:!1,configurable:!0})}y&&(R=!0)}y||(null==v?void 0:v.includes(b))||e.headers["x-now-route-matches"]?C=!0:this.renderOpts.dev||(C||=!!M.routes[(0,_toroute.toRoute)(r)]);const T=!!((0,_requestmeta.getRequestMeta)(e,"isNextDataReq")||e.headers["x-nextjs-data"]&&this.serverOptions.webServerConfig)&&(C||f),w=(0,_requestmeta.getRequestMeta)(e,"isPrefetchRSCRequest")??!1,D=(0,_requestmeta.getRequestMeta)(e,"isRSCRequest")??!1;if(!C&&e.headers["x-middleware-prefetch"]&&!p&&"/_error"!==r)return t.setHeader(_constants2.MATCHED_PATH_HEADER,r),t.setHeader("x-middleware-skip","1"),t.setHeader("cache-control","private, no-cache, no-store, max-age=0, must-revalidate"),t.body("{}").send(),null;C&&this.minimalMode&&e.headers[_constants2.MATCHED_PATH_HEADER]&&e.url.startsWith("/_next/data")&&(e.url=this.stripNextDataPath(e.url));const S=(0,_requestmeta.getRequestMeta)(e,"locale"),O=C?null==(o=this.nextConfig.i18n)?void 0:o.defaultLocale:(0,_requestmeta.getRequestMeta)(e,"defaultLocale");let N;!e.headers["x-nextjs-data"]||t.statusCode&&200!==t.statusCode||t.setHeader("x-nextjs-matched-path",`${S?`/${S}`:""}${r}`),s.routeModule&&(N=s.routeModule);const A=this.isAppPPREnabled&&void 0!==N&&(0,_checks.isAppPageRouteModule)(N),I="1"===process.env.__NEXT_EXPERIMENTAL_STATIC_SHELL_DEBUGGING&&void 0!==i.__nextppronly&&A,H=I&&"fallback"===i.__nextppronly,k=A&&("PARTIALLY_STATIC"===(null==(l=M.routes[r]??M.dynamicRoutes[r])?void 0:l.renderingMode)||I&&(!0===this.renderOpts.dev||!0===this.experimentalTestProxy)),L=I&&k,U=L&&!0===this.renderOpts.dev,F=H&&k,z=k?(0,_requestmeta.getRequestMeta)(e,"postponed"):void 0,j=k&&D&&!w,$=(0,_requestmeta.getRequestMeta)(e,"segmentPrefetchRSCRequest"),X=(0,_streamingmetadata.isHtmlBotRequest)(e);if(X&&k&&(C=!1,this.renderOpts.serveStreamingMetadata=!1),!p||T||D||(t.statusCode=404),_constants.STATIC_STATUS_PAGES.includes(r)&&(t.statusCode=parseInt(r.slice(1),10)),!g&&!z&&!p&&!m&&"/_error"!==r&&"HEAD"!==e.method&&"GET"!==e.method&&("string"==typeof s.Component||C))return t.statusCode=405,t.setHeader("Allow",["GET","HEAD"]),await this.renderError(null,e,t,r),null;if("string"==typeof s.Component)return{type:"html",body:_renderresult.default.fromStatic(s.Component)};if("amp"in i&&!i.amp&&delete i.amp,!0===a.supportsDynamicResponse){var B;const t=e.headers["user-agent"]||"",r=(0,_isbot.isBot)(t),n="function"!=typeof(null==(B=s.Document)?void 0:B.getInitialProps)||_constants.NEXT_BUILTIN_DOCUMENT in s.Document;a.supportsDynamicResponse=!C&&!r&&!i.amp&&n}!T&&_&&a.dev&&(a.supportsDynamicResponse=!0);const G=null==(d=this.nextConfig.i18n)?void 0:d.locales;let W,K=!1;if((f||C||_)&&"edge"!==process.env.NEXT_RUNTIME){const{tryGetPreviewData:r}=require("./api-utils/node/try-get-preview-data");W=r(e,t,this.renderOpts.previewProps,!!this.nextConfig.experimental.multiZoneDraftMode),K=!1!==W}!_||a.dev||K||!C||!D||j||(0,_isedgeruntime.isEdgeRuntime)(a.runtime)&&!this.serverOptions.webServerConfig||(0,_stripflightheaders.stripFlightHeaders)(e.headers);let{isOnDemandRevalidate:V,revalidateOnlyGenerated:Y}=(0,_apiutils.checkIsOnDemandRevalidate)(e,this.renderOpts.previewProps);C&&this.minimalMode&&e.headers[_constants2.MATCHED_PATH_HEADER]&&(b=P),P=(0,_removetrailingslash.removeTrailingSlash)(P),b=(0,_removetrailingslash.removeTrailingSlash)(b),this.localeNormalizer&&(b=this.localeNormalizer.normalize(b));const Q=e=>{const r={destination:e.pageProps.__N_REDIRECT,statusCode:e.pageProps.__N_REDIRECT_STATUS,basePath:e.pageProps.__N_REDIRECT_BASE_PATH},a=(0,_redirectstatus.getRedirectStatus)(r),{basePath:s}=this.nextConfig;s&&!1!==r.basePath&&r.destination.startsWith("/")&&(r.destination=`${s}${r.destination}`),r.destination.startsWith("/")&&(r.destination=(0,_utils.normalizeRepeatedSlashes)(r.destination)),t.redirect(r.destination,a).body(r.destination).send()};T&&(b=this.stripNextDataPath(b),P=this.stripNextDataPath(P));let J=null;K||!C||a.supportsDynamicResponse||g||z||j||(J=`${S?`/${S}`:""}${"/"!==r&&"/"!==b||!S?b:""}${i.amp?".amp":""}`),(p||m)&&C&&(J=`${S?`/${S}`:""}${r}${i.amp?".amp":""}`),J&&(J=(0,_decodepathparams.decodePathParams)(J),J="/index"===J&&"/"===r?"/":J);let Z="https:";try{Z=new URL((0,_requestmeta.getRequestMeta)(e,"initURL")||"/","http://n").protocol}catch{}const ee=globalThis.__incrementalCache||await this.getIncrementalCache({requestHeaders:Object.assign({},e.headers),requestProtocol:Z.substring(0,Z.length-1)});ee.resetRequestCache();const te=async({postponed:n,pagesFallback:o=!1,fallbackRouteParams:l})=>{let d=!T&&!0===a.dev||!C&&!R||"string"==typeof n||j;const u=(0,_url.parse)(e.url||"",!0).query;a.params&&Object.keys(a.params).forEach((e=>{delete u[e]}));const h="/"!==P&&this.nextConfig.trailingSlash,c=(0,_url.format)({pathname:`${b}${h?"/":""}`,query:u}),m=!d||X&&k,v={...s,...a,..._?{incrementalCache:ee,isRevalidate:C&&!n&&!j,serverActions:this.nextConfig.experimental.serverActions}:{},isNextDataRequest:T,resolvedUrl:c,locale:S,locales:G,defaultLocale:O,multiZoneDraftMode:this.nextConfig.experimental.multiZoneDraftMode,resolvedAsPath:f||E?(0,_url.format)({pathname:`${P}${h?"/":""}`,query:u}):c,experimental:{...a.experimental,isRoutePPREnabled:k},supportsDynamicResponse:d,shouldWaitOnAllReady:m,isOnDemandRevalidate:V,isDraftMode:K,isServerAction:g,postponed:n,waitUntil:this.getWaitUntil(),onClose:t.onClose.bind(t),onAfterTaskError:void 0,setIsrStatus:this.setIsrStatus};let q;if((L||U)&&(d=!1,v.nextExport=!0,v.supportsDynamicResponse=!1,v.isStaticGeneration=!0,v.isRevalidate=!0,v.isDebugDynamicAccesses=U),N)if((0,_checks.isAppRouteRouteModule)(N)){var y;if("edge"===process.env.NEXT_RUNTIME||!(0,_helpers.isNodeNextRequest)(e)||!(0,_helpers.isNodeNextResponse)(t))throw Object.defineProperty(new Error("Invariant: App Route Route Modules cannot be used in the edge runtime"),"__NEXT_ERROR_CODE",{value:"E130",enumerable:!1,configurable:!0});const s={params:a.params,prerenderManifest:M,renderOpts:{experimental:{dynamicIO:v.experimental.dynamicIO,authInterrupts:v.experimental.authInterrupts},supportsDynamicResponse:d,incrementalCache:ee,cacheLifeProfiles:null==(y=this.nextConfig.experimental)?void 0:y.cacheLife,isRevalidate:C,waitUntil:this.getWaitUntil(),onClose:t.onClose.bind(t),onAfterTaskError:void 0,onInstrumentationRequestError:this.renderOpts.onInstrumentationRequestError},sharedContext:{buildId:this.buildId}};try{const r=_nextrequest.NextRequestAdapter.fromNodeNextRequest(e,(0,_nextrequest.signalFromNodeResponse)(t.originalResponse)),a=await N.handle(r,s);e.fetchMetrics=s.renderOpts.fetchMetrics;const i=s.renderOpts.collectedTags;if(C){const e=await a.blob(),t=(0,_utils3.toNodeOutgoingHttpHeaders)(a.headers);i&&(t[_constants2.NEXT_CACHE_TAGS_HEADER]=i),!t["content-type"]&&e.type&&(t["content-type"]=e.type);const r=!(void 0===s.renderOpts.collectedRevalidate||s.renderOpts.collectedRevalidate>=_constants2.INFINITE_CACHE)&&s.renderOpts.collectedRevalidate;return{value:{kind:_responsecache.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},revalidate:r,isFallback:!1}}let n=s.renderOpts.pendingWaitUntil;return n&&s.renderOpts.waitUntil&&(s.renderOpts.waitUntil(n),n=void 0),await(0,_sendresponse.sendResponse)(e,t,a,s.renderOpts.pendingWaitUntil),null}catch(a){if(await this.instrumentationOnRequestError(a,e,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,_utils4.getRevalidateReason)(v)}),C)throw a;return _log.error(a),await(0,_sendresponse.sendResponse)(e,t,new Response(null,{status:500})),null}}else{if(!(0,_checks.isPagesRouteModule)(N)&&!(0,_checks.isAppPageRouteModule)(N))throw Object.defineProperty(new Error("Invariant: Unknown route module type"),"__NEXT_ERROR_CODE",{value:"E450",enumerable:!1,configurable:!0});if("OPTIONS"===e.method&&!p)return await(0,_sendresponse.sendResponse)(e,t,new Response(null,{status:400})),null;if((0,_checks.isPagesRouteModule)(N)){v.nextFontManifest=this.nextFontManifest,v.clientReferenceManifest=s.clientReferenceManifest;const n=(0,_helpers.isNodeNextRequest)(e)?e.originalRequest:e,l=(0,_helpers.isNodeNextResponse)(t)?t.originalResponse:t;try{q=await N.render(n,l,{page:r,params:a.params,query:i,renderOpts:v,sharedContext:{buildId:this.buildId,deploymentId:this.nextConfig.deploymentId,customServer:this.serverOptions.customServer||void 0},renderContext:{isFallback:o,isDraftMode:v.isDraftMode,developmentNotFoundSourcePage:(0,_requestmeta.getRequestMeta)(e,"developmentNotFoundSourcePage")}})}catch(t){throw await this.instrumentationOnRequestError(t,e,{routerKind:"Pages Router",routePath:r,routeType:"render",revalidateReason:(0,_utils4.getRevalidateReason)({isRevalidate:C,isOnDemandRevalidate:v.isOnDemandRevalidate})}),t}}else{const n=s.routeModule;v.nextFontManifest=this.nextFontManifest;const o={page:p?"/404":r,params:a.params,query:i,fallbackRouteParams:l,renderOpts:v,serverComponentsHmrCache:this.getServerComponentsHmrCache(),sharedContext:{buildId:this.buildId}};if(this.nextConfig.experimental.dynamicIO&&this.renderOpts.dev&&!w&&!g){const r=await n.warmup(e,t,o);r.metadata.devRenderResumeDataCache&&(v.devRenderResumeDataCache=r.metadata.devRenderResumeDataCache)}q=await n.render(e,t,o)}}else q=await this.renderHTML(e,t,r,i,v);const{metadata:x}=q,{headers:D={},fetchTags:A}=x;if(A&&(D[_constants2.NEXT_CACHE_TAGS_HEADER]=A),e.fetchMetrics=x.fetchMetrics,_&&C&&0===x.revalidate&&!this.renderOpts.dev&&!k){const e=x.staticBailoutInfo,t=Object.defineProperty(new Error(`Page changed from static to dynamic at runtime ${P}${(null==e?void 0:e.description)?`, reason: ${e.description}`:""}\nsee more here https://nextjs.org/docs/messages/app-static-to-dynamic-error`),"__NEXT_ERROR_CODE",{value:"E132",enumerable:!1,configurable:!0});if(null==e?void 0:e.stack){const r=e.stack;t.stack=t.message+r.substring(r.indexOf("\n"))}throw t}return"isNotFound"in x&&x.isNotFound?{value:null,revalidate:x.revalidate,isFallback:!1}:x.isRedirect?{value:{kind:_responsecache.CachedRouteKind.REDIRECT,props:x.pageData??x.flightData},revalidate:x.revalidate,isFallback:!1}:q.isNull?null:_?{value:{kind:_responsecache.CachedRouteKind.APP_PAGE,html:q,headers:D,rscData:x.flightData,postponed:x.postponed,status:t.statusCode,segmentData:x.segmentData},revalidate:x.revalidate,isFallback:!!l}:{value:{kind:_responsecache.CachedRouteKind.PAGES,html:q,pageData:x.pageData??x.flightData,headers:D,status:_?t.statusCode:void 0},revalidate:x.revalidate,isFallback:o}};let re=async({hasResolved:n,previousCacheEntry:o,isRevalidating:l})=>{const d=!this.renderOpts.dev,u=n||t.sent;if(!v&&x)if(R){const t=await this.getStaticPaths({pathname:r,requestHeaders:e.headers,isAppPath:_,page:s.page});v=t.staticPaths,q=t.fallbackMode}else v=void 0,q=_fallback.FallbackMode.NOT_FOUND;if(q===_fallback.FallbackMode.PRERENDER&&(0,_isbot.isBot)(e.headers["user-agent"]||"")&&(q=_fallback.FallbackMode.BLOCKING_STATIC_RENDER),V&&Y&&!o&&!this.minimalMode)return await this.render404(e,t),null;-1===(null==o?void 0:o.isStale)&&(V=!0),V&&(q!==_fallback.FallbackMode.NOT_FOUND||o)&&(q=_fallback.FallbackMode.BLOCKING_STATIC_RENDER);let h=J;!h&&a.dev&&_&&(h=(0,_decodepathparams.decodePathParams)(b)),h&&i.amp&&(h=h.replace(/\.amp$/,""));const c=h&&(null==v?void 0:v.includes(h));if(this.nextConfig.experimental.isExperimentalCompile&&(q=_fallback.FallbackMode.BLOCKING_STATIC_RENDER),"edge"!==process.env.NEXT_RUNTIME&&!this.minimalMode&&q!==_fallback.FallbackMode.BLOCKING_STATIC_RENDER&&h&&!u&&!K&&x&&(d||!v||!c)){if((d||v&&(null==v?void 0:v.length)>0)&&q===_fallback.FallbackMode.NOT_FOUND)throw new NoFallbackError;let e;if((0,_checks.isPagesRouteModule)(s.routeModule)&&!T?e=await this.responseCache.get(d?S?`/${S}${r}`:r:null,(async({previousCacheEntry:e=null})=>d?(0,_utils5.toResponseCacheEntry)(e):te({postponed:void 0,pagesFallback:!0,fallbackRouteParams:null})),{routeKind:_routekind.RouteKind.PAGES,incrementalCache:ee,isRoutePPREnabled:k,isFallback:!0}):k&&(0,_checks.isAppPageRouteModule)(s.routeModule)&&!D&&(e=await this.responseCache.get(d?r:null,(async()=>te({postponed:void 0,pagesFallback:void 0,fallbackRouteParams:d||F?(0,_fallbackparams.getFallbackRouteParams)(r):null})),{routeKind:_routekind.RouteKind.APP_PAGE,incrementalCache:ee,isRoutePPREnabled:k,isFallback:!0})),null===e)return null;if(e)return delete e.revalidate,e}const p=V||l||!z?void 0:z;if((L||U)&&void 0!==p)return{revalidate:1,isFallback:!1,value:{kind:_responsecache.CachedRouteKind.PAGES,html:_renderresult.default.fromStatic(""),pageData:{},headers:void 0,status:void 0}};const m=x&&k&&((0,_requestmeta.getRequestMeta)(e,"didSetDefaultRouteMatches")||F)?(0,_fallbackparams.getFallbackRouteParams)(r):null,f=await te({postponed:p,pagesFallback:void 0,fallbackRouteParams:m});return f?{...f,revalidate:f.revalidate}:null};const ae=await this.responseCache.get(J,re,{routeKind:(null==N?void 0:N.definition.kind)??(_?_routekind.RouteKind.APP_PAGE:_routekind.RouteKind.PAGES),incrementalCache:ee,isOnDemandRevalidate:V,isPrefetch:"prefetch"===e.headers.purpose,isRoutePPREnabled:k});if(K&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate"),!ae){if(J&&(!V||!Y))throw Object.defineProperty(new Error("invariant: cache entry required but not generated"),"__NEXT_ERROR_CODE",{value:"E62",enumerable:!1,configurable:!0});return null}J&&!this.minimalMode&&k&&(null==(u=ae.value)?void 0:u.kind)===_responsecache.CachedRouteKind.APP_PAGE&&ae.isFallback&&!V&&!F&&"true"!==process.env.DISABLE_ROUTE_SHELL_GENERATION&&(0,_scheduler.scheduleOnNextTick)((async()=>{try{await this.responseCache.get(J,(()=>te({fallbackRouteParams:null,pagesFallback:void 0,postponed:void 0})),{routeKind:_routekind.RouteKind.APP_PAGE,incrementalCache:ee,isOnDemandRevalidate:!0,isPrefetch:!1,isRoutePPREnabled:!0})}catch(e){console.error("Error occurred while rendering dynamic shell",e)}}));const se=(null==(h=ae.value)?void 0:h.kind)===_responsecache.CachedRouteKind.APP_PAGE&&"string"==typeof ae.value.postponed;!C||j||se&&!w||(this.minimalMode||t.setHeader("x-nextjs-cache",V?"REVALIDATED":ae.isMiss?"MISS":ae.isStale?"STALE":"HIT"),t.setHeader(_approuterheaders.NEXT_IS_PRERENDER_HEADER,"1"));const{value:ie}=ae;if("string"==typeof $&&(null==ie?void 0:ie.kind)===_responsecache.CachedRouteKind.APP_PAGE&&ie.segmentData){t.setHeader(_approuterheaders.NEXT_DID_POSTPONE_HEADER,"2");const e=ie.segmentData.get($);return void 0!==e?{type:"rsc",body:_renderresult.default.fromStatic(e),revalidate:ae.revalidate}:(t.statusCode=204,{type:"rsc",body:_renderresult.default.fromStatic(""),revalidate:null==ae?void 0:ae.revalidate})}if((null==ie?void 0:ie.kind)===_responsecache.CachedRouteKind.IMAGE)throw Object.defineProperty(new Error("invariant SSG should not return an image cache value"),"__NEXT_ERROR_CODE",{value:"E390",enumerable:!1,configurable:!0});let ne;if(z)ne=0;else if(this.minimalMode&&D&&!w&&k)ne=0;else if(!this.renderOpts.dev||f&&!T)if(K)ne=0;else if(C)if(p){const t=(0,_requestmeta.getRequestMeta)(e,"notFoundRevalidate");ne=void 0===t?0:t}else if(m)ne=0;else if("number"==typeof ae.revalidate){if(ae.revalidate<1)throw Object.defineProperty(new Error(`Invalid revalidate configuration provided: ${ae.revalidate} < 1`),"__NEXT_ERROR_CODE",{value:"E22",enumerable:!1,configurable:!0});ne=ae.revalidate}else!1===ae.revalidate&&(ne=_constants2.CACHE_ONE_YEAR);else t.getHeader("Cache-Control")||(ne=0);ae.revalidate=ne;const oe=(0,_requestmeta.getRequestMeta)(e,"onCacheEntry");if(oe){var le,de;if(await oe({...ae,value:{...ae.value,kind:(null==(le=ae.value)?void 0:le.kind)===_responsecache.CachedRouteKind.APP_PAGE?"PAGE":null==(de=ae.value)?void 0:de.kind}},{url:(0,_requestmeta.getRequestMeta)(e,"initURL")}))return null}if(ie){if(ie.kind===_responsecache.CachedRouteKind.REDIRECT)return void 0===ae.revalidate||t.getHeader("Cache-Control")||t.setHeader("Cache-Control",(0,_revalidate.formatRevalidate)({revalidate:ae.revalidate,expireTime:this.nextConfig.expireTime})),T?{type:"json",body:_renderresult.default.fromStatic(JSON.stringify(ie.props)),revalidate:ae.revalidate}:(await Q(ie.props),null);if(ie.kind===_responsecache.CachedRouteKind.APP_ROUTE){const r=(0,_utils3.fromNodeOutgoingHttpHeaders)(ie.headers);return this.minimalMode&&C||r.delete(_constants2.NEXT_CACHE_TAGS_HEADER),void 0===ae.revalidate||t.getHeader("Cache-Control")||r.get("Cache-Control")||r.set("Cache-Control",(0,_revalidate.formatRevalidate)({revalidate:ae.revalidate,expireTime:this.nextConfig.expireTime})),await(0,_sendresponse.sendResponse)(e,t,new Response(ie.body,{headers:r,status:ie.status||200})),null}if(ie.kind===_responsecache.CachedRouteKind.APP_PAGE){var ue;if(se&&z)throw Object.defineProperty(new Error("Invariant: postponed state should not be present on a resume request"),"__NEXT_ERROR_CODE",{value:"E396",enumerable:!1,configurable:!0});if(ie.headers){const e={...ie.headers};this.minimalMode&&C||delete e[_constants2.NEXT_CACHE_TAGS_HEADER];for(let[r,a]of Object.entries(e))if(void 0!==a)if(Array.isArray(a))for(const e of a)t.appendHeader(r,e);else"number"==typeof a?(a=a.toString(),t.appendHeader(r,a)):t.appendHeader(r,a)}if(this.minimalMode&&C&&(null==(ue=ie.headers)?void 0:ue[_constants2.NEXT_CACHE_TAGS_HEADER])&&t.setHeader(_constants2.NEXT_CACHE_TAGS_HEADER,ie.headers[_constants2.NEXT_CACHE_TAGS_HEADER]),!ie.status||D&&k||(t.statusCode=ie.status),se&&t.setHeader(_approuterheaders.NEXT_DID_POSTPONE_HEADER,"1"),D&&!K){if(void 0===ie.rscData){if(ie.postponed)throw Object.defineProperty(new Error("Invariant: Expected postponed to be undefined"),"__NEXT_ERROR_CODE",{value:"E372",enumerable:!1,configurable:!0});return{type:"rsc",body:ie.html,revalidate:j?0:ae.revalidate}}return{type:"rsc",body:_renderresult.default.fromStatic(ie.rscData),revalidate:ae.revalidate}}let e=ie.html;if(!se||this.minimalMode)return{type:"html",body:e,revalidate:ae.revalidate};if(L||U)return e.chain(new ReadableStream({start(e){e.enqueue(_encodedTags.ENCODED_TAGS.CLOSED.BODY_AND_HTML),e.close()}})),{type:"html",body:e,revalidate:0};const r=new TransformStream;return e.chain(r.readable),te({postponed:ie.postponed,pagesFallback:void 0,fallbackRouteParams:null}).then((async e=>{var t,a;if(!e)throw Object.defineProperty(new Error("Invariant: expected a result to be returned"),"__NEXT_ERROR_CODE",{value:"E463",enumerable:!1,configurable:!0});if((null==(t=e.value)?void 0:t.kind)!==_responsecache.CachedRouteKind.APP_PAGE)throw Object.defineProperty(new Error(`Invariant: expected a page response, got ${null==(a=e.value)?void 0:a.kind}`),"__NEXT_ERROR_CODE",{value:"E305",enumerable:!1,configurable:!0});await e.value.html.pipeTo(r.writable)})).catch((e=>{r.writable.abort(e).catch((e=>{console.error("couldn't abort transformer",e)}))})),{type:"html",body:e,revalidate:0}}return T?{type:"json",body:_renderresult.default.fromStatic(JSON.stringify(ie.pageData)),revalidate:ae.revalidate}:{type:"html",body:ie.html,revalidate:ae.revalidate}}return(0,_requestmeta.addRequestMeta)(e,"notFoundRevalidate",ae.revalidate),void 0===ae.revalidate||t.getHeader("Cache-Control")||t.setHeader("Cache-Control",(0,_revalidate.formatRevalidate)({revalidate:ae.revalidate,expireTime:this.nextConfig.expireTime})),T?(t.statusCode=404,t.body('{"notFound":true}').send(),null):(this.renderOpts.dev&&(0,_requestmeta.addRequestMeta)(e,"developmentNotFoundSourcePage",r),await this.render404(e,t,{pathname:r,query:i},!1),null)}stripNextDataPath(e,t=!0){if(e.includes(this.buildId)){const t=e.substring(e.indexOf(this.buildId)+this.buildId.length);e=(0,_denormalizepagepath.denormalizePagePath)(t.replace(/\.json$/,""))}return this.localeNormalizer&&t?this.localeNormalizer.normalize(e):e}getOriginalAppPaths(e){if(this.enabledDirectories.app){var t;const r=null==(t=this.appPathRoutes)?void 0:t[e];return r||null}return null}async renderPageComponent(e,t){var r;const{query:a,pathname:s}=e,i=this.getOriginalAppPaths(s),n=Array.isArray(i);let o=s;n&&(o=i[i.length-1]);const l=await this.findPageComponents({locale:(0,_requestmeta.getRequestMeta)(e.req,"locale"),page:o,query:a,params:e.renderOpts.params||{},isAppPath:n,sriEnabled:!!(null==(r=this.nextConfig.experimental.sri)?void 0:r.algorithm),appPaths:i,shouldEnsure:!1});if(l){(0,_tracer.getTracer)().setRootSpanAttribute("next.route",s);try{return await this.renderToResponseWithComponents(e,l)}catch(e){const r=e instanceof NoFallbackError;if(!r||r&&t)throw e}}return!1}async renderToResponse(e){return(0,_tracer.getTracer)().trace(_constants1.BaseServerSpan.renderToResponse,{spanName:"rendering page",attributes:{"next.route":e.pathname}},(async()=>this.renderToResponseImpl(e)))}async renderToResponseImpl(e){var t;const{req:r,res:a,query:s,pathname:i}=e;let n=i;const o=(0,_requestmeta.getRequestMeta)(e.req,"bubbleNoFallback")??!1;delete s[_approuterheaders.NEXT_RSC_UNION_QUERY];const l={i18n:null==(t=this.i18nProvider)?void 0:t.fromRequest(r,i)};try{for await(const t of this.matchers.matchAll(i,l)){const r=(0,_requestmeta.getRequestMeta)(e.req,"invokeOutput");if(!this.minimalMode&&"string"==typeof r&&(0,_utils1.isDynamicRoute)(r||"")&&r!==t.definition.pathname)continue;const a=await this.renderPageComponent({...e,pathname:t.definition.pathname,renderOpts:{...e.renderOpts,params:t.params}},o);if(!1!==a)return a}if(this.serverOptions.webServerConfig){e.pathname=this.serverOptions.webServerConfig.page;const t=await this.renderPageComponent(e,o);if(!1!==t)return t}}catch(t){const r=(0,_iserror.getProperError)(t);if(t instanceof _utils.MissingStaticPage)throw console.error("Invariant: failed to load static page",JSON.stringify({page:n,url:e.req.url,matchedPath:e.req.headers[_constants2.MATCHED_PATH_HEADER],initUrl:(0,_requestmeta.getRequestMeta)(e.req,"initURL"),didRewrite:!!(0,_requestmeta.getRequestMeta)(e.req,"rewroteURL"),rewroteUrl:(0,_requestmeta.getRequestMeta)(e.req,"rewroteURL")},null,2)),r;if(r instanceof NoFallbackError&&o)throw r;if(r instanceof _utils.DecodeError||r instanceof _utils.NormalizeError)return a.statusCode=400,await this.renderErrorToResponse(e,r);a.statusCode=500,await this.hasPage("/500")&&((0,_requestmeta.addRequestMeta)(e.req,"customErrorRender",!0),await this.renderErrorToResponse(e,r),(0,_requestmeta.removeRequestMeta)(e.req,"customErrorRender"));const s=r instanceof WrappedBuildError;if(!s){if(this.minimalMode&&"edge"!==process.env.NEXT_RUNTIME||this.renderOpts.dev)throw(0,_iserror.default)(r)&&(r.page=n),r;this.logError((0,_iserror.getProperError)(r))}return await this.renderErrorToResponse(e,s?r.innerError:r)}if(await this.getMiddleware()&&e.req.headers["x-nextjs-data"]&&(!a.statusCode||200===a.statusCode||404===a.statusCode)){const e=(0,_requestmeta.getRequestMeta)(r,"locale");return a.setHeader("x-nextjs-matched-path",`${e?`/${e}`:""}${i}`),a.statusCode=200,a.setHeader("content-type","application/json"),a.body("{}"),a.send(),null}return a.statusCode=404,this.renderErrorToResponse(e,null)}async renderToHTML(e,t,r,a={}){return(0,_tracer.getTracer)().trace(_constants1.BaseServerSpan.renderToHTML,(async()=>this.renderToHTMLImpl(e,t,r,a)))}async renderToHTMLImpl(e,t,r,a={}){return this.getStaticHTML((e=>this.renderToResponse(e)),{req:e,res:t,pathname:r,query:a})}async renderError(e,t,r,a,s={},i=!0){return(0,_tracer.getTracer)().trace(_constants1.BaseServerSpan.renderError,(async()=>this.renderErrorImpl(e,t,r,a,s,i)))}async renderErrorImpl(e,t,r,a,s={},i=!0){return i&&r.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate"),this.pipe((async t=>{const a=await this.renderErrorToResponse(t,e);if(this.minimalMode&&500===r.statusCode)throw e;return a}),{req:t,res:r,pathname:a,query:s})}async renderErrorToResponse(e,t){return(0,_tracer.getTracer)().trace(_constants1.BaseServerSpan.renderErrorToResponse,(async()=>this.renderErrorToResponseImpl(e,t)))}async renderErrorToResponseImpl(e,t){if(this.renderOpts.dev&&"/favicon.ico"===e.pathname)return{type:"html",body:_renderresult.default.fromStatic("")};const{res:r,query:a}=e;try{let s=null;const i=404===r.statusCode;let n=!1;i&&(this.enabledDirectories.app&&(s=await this.findPageComponents({locale:(0,_requestmeta.getRequestMeta)(e.req,"locale"),page:_constants.UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,query:a,params:{},isAppPath:!0,shouldEnsure:!0,url:e.req.url}),n=null!==s),!s&&await this.hasPage("/404")&&(s=await this.findPageComponents({locale:(0,_requestmeta.getRequestMeta)(e.req,"locale"),page:"/404",query:a,params:{},isAppPath:!1,shouldEnsure:!0,url:e.req.url}),n=null!==s));let o=`/${r.statusCode}`;if((0,_requestmeta.getRequestMeta)(e.req,"customErrorRender")||s||!_constants.STATIC_STATUS_PAGES.includes(o)||"/500"===o&&this.renderOpts.dev||(s=await this.findPageComponents({locale:(0,_requestmeta.getRequestMeta)(e.req,"locale"),page:o,query:a,params:{},isAppPath:!1,shouldEnsure:!0,url:e.req.url})),s||(s=await this.findPageComponents({locale:(0,_requestmeta.getRequestMeta)(e.req,"locale"),page:"/_error",query:a,params:{},isAppPath:!1,shouldEnsure:!0,url:e.req.url}),o="/_error"),"production"===process.env.NODE_ENV||n||!await this.hasPage("/_error")||await this.hasPage("/404")||this.customErrorNo404Warn(),!s){if(this.renderOpts.dev)return{type:"html",body:_renderresult.default.fromStatic("\n              <pre>missing required error components, refreshing...</pre>\n              <script>\n                async function check() {\n                  const res = await fetch(location.href).catch(() => ({}))\n\n                  if (res.status === 200) {\n                    location.reload()\n                  } else {\n                    setTimeout(check, 1000)\n                  }\n                }\n                check()\n              <\/script>")};throw new WrappedBuildError(Object.defineProperty(new Error("missing required error components"),"__NEXT_ERROR_CODE",{value:"E60",enumerable:!1,configurable:!0}))}s.components.routeModule?(0,_requestmeta.addRequestMeta)(e.req,"match",{definition:s.components.routeModule.definition,params:void 0}):(0,_requestmeta.removeRequestMeta)(e.req,"match");try{return await this.renderToResponseWithComponents({...e,pathname:o,renderOpts:{...e.renderOpts,err:t}},s)}catch(e){if(e instanceof NoFallbackError)throw Object.defineProperty(new Error("invariant: failed to render error page"),"__NEXT_ERROR_CODE",{value:"E55",enumerable:!1,configurable:!0});throw e}}catch(t){const s=(0,_iserror.getProperError)(t),i=s instanceof WrappedBuildError;i||this.logError(s),r.statusCode=500;const n=await this.getFallbackErrorComponents(e.req.url);return n?((0,_requestmeta.addRequestMeta)(e.req,"match",{definition:n.routeModule.definition,params:void 0}),this.renderToResponseWithComponents({...e,pathname:"/_error",renderOpts:{...e.renderOpts,err:i?s.innerError:s}},{query:a,components:n})):{type:"html",body:_renderresult.default.fromStatic("Internal Server Error")}}}async renderErrorToHTML(e,t,r,a,s={}){return this.getStaticHTML((t=>this.renderErrorToResponse(t,e)),{req:t,res:r,pathname:a,query:s})}async render404(e,t,r,a=!0){const{pathname:s,query:i}=r||(0,_url.parse)(e.url,!0);return this.nextConfig.i18n&&((0,_requestmeta.getRequestMeta)(e,"locale")||(0,_requestmeta.addRequestMeta)(e,"locale",this.nextConfig.i18n.defaultLocale),(0,_requestmeta.addRequestMeta)(e,"defaultLocale",this.nextConfig.i18n.defaultLocale)),t.statusCode=404,this.renderError(null,e,t,s,i,a)}}