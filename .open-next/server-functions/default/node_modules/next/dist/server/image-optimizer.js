"use strict";function _export(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{ImageError:function(){return ImageError},ImageOptimizerCache:function(){return ImageOptimizerCache},detectContentType:function(){return detectContentType},extractEtag:function(){return extractEtag},fetchExternalImage:function(){return fetchExternalImage},fetchInternalImage:function(){return fetchInternalImage},getHash:function(){return getHash},getImageEtag:function(){return getImageEtag},getImageSize:function(){return getImageSize},getMaxAge:function(){return getMaxAge},getPreviouslyCachedImageOrNull:function(){return getPreviouslyCachedImageOrNull},getSharp:function(){return getSharp},imageOptimizer:function(){return imageOptimizer},optimizeImage:function(){return optimizeImage},sendResponse:function(){return sendResponse}});const _crypto=require("crypto"),_fs=require("fs"),_accept=require("next/dist/compiled/@hapi/accept"),_contentdisposition=_interop_require_default(require("next/dist/compiled/content-disposition")),_imagesize=_interop_require_default(require("next/dist/compiled/image-size")),_isanimated=_interop_require_default(require("next/dist/compiled/is-animated")),_path=require("path"),_url=_interop_require_default(require("url")),_imageblursvg=require("../shared/lib/image-blur-svg"),_matchlocalpattern=require("../shared/lib/match-local-pattern"),_matchremotepattern=require("../shared/lib/match-remote-pattern"),_mockrequest=require("./lib/mock-request"),_responsecache=require("./response-cache"),_sendpayload=require("./send-payload"),_servestatic=require("./serve-static"),_log=_interop_require_wildcard(require("../build/output/log")),_iserror=_interop_require_default(require("../lib/is-error")),_url1=require("../lib/url");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(_getRequireWildcardCache=function(e){return e?r:t})(e)}function _interop_require_wildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=_getRequireWildcardCache(t);if(r&&r.has(e))return r.get(e);var a={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in e)if("default"!==n&&Object.prototype.hasOwnProperty.call(e,n)){var s=i?Object.getOwnPropertyDescriptor(e,n):null;s&&(s.get||s.set)?Object.defineProperty(a,n,s):a[n]=e[n]}return a.default=e,r&&r.set(e,a),a}const AVIF="image/avif",WEBP="image/webp",PNG="image/png",JPEG="image/jpeg",GIF="image/gif",SVG="image/svg+xml",ICO="image/x-icon",ICNS="image/x-icns",TIFF="image/tiff",BMP="image/bmp",CACHE_VERSION=4,ANIMATABLE_TYPES=[WEBP,PNG,GIF],BYPASS_TYPES=[SVG,ICO,ICNS,BMP],BLUR_IMG_SIZE=8,BLUR_QUALITY=70;let _sharp;function getSharp(e){if(_sharp)return _sharp;try{if(_sharp=require("sharp"),_sharp&&_sharp.concurrency()>1){const t="development"===process.env.NODE_ENV?4:2;_sharp.concurrency(e??Math.floor(Math.max(_sharp.concurrency()/t,1)))}}catch(e){if((0,_iserror.default)(e)&&"MODULE_NOT_FOUND"===e.code)throw Object.defineProperty(new Error("Module `sharp` not found. Please run `npm install --cpu=wasm32 sharp` to install it."),"__NEXT_ERROR_CODE",{value:"E47",enumerable:!1,configurable:!0});throw e}return _sharp}function getSupportedMimeType(e,t=""){const r=(0,_accept.mediaType)(t,e);return t.includes(r)?r:""}function getHash(e){const t=(0,_crypto.createHash)("sha256");for(let r of e)"number"==typeof r?t.update(String(r)):t.update(r);return t.digest("base64url")}function extractEtag(e,t){return e?Buffer.from(e).toString("base64url"):getImageEtag(t)}function getImageEtag(e){return getHash([e])}async function writeToCacheDir(e,t,r,a,i,n,s){const o=(0,_path.join)(e,`${r}.${a}.${n}.${s}.${t}`);await _fs.promises.rm(e,{recursive:!0,force:!0}).catch((()=>{})),await _fs.promises.mkdir(e,{recursive:!0}),await _fs.promises.writeFile(o,i)}function detectContentType(e){return[255,216,255].every(((t,r)=>e[r]===t))?JPEG:[137,80,78,71,13,10,26,10].every(((t,r)=>e[r]===t))?PNG:[71,73,70,56].every(((t,r)=>e[r]===t))?GIF:[82,73,70,70,0,0,0,0,87,69,66,80].every(((t,r)=>!t||e[r]===t))?WEBP:[60,63,120,109,108].every(((t,r)=>e[r]===t))||[60,115,118,103].every(((t,r)=>e[r]===t))?SVG:[0,0,0,0,102,116,121,112,97,118,105,102].every(((t,r)=>!t||e[r]===t))?AVIF:[0,0,1,0].every(((t,r)=>e[r]===t))?ICO:[105,99,110,115].every(((t,r)=>e[r]===t))?ICNS:[73,73,42,0].every(((t,r)=>e[r]===t))?TIFF:[66,77].every(((t,r)=>e[r]===t))?BMP:null}class ImageOptimizerCache{static validateParams(e,t,r,a){var i,n,s;const o=r.images,{deviceSizes:u=[],imageSizes:c=[],domains:l=[],minimumCacheTTL:m=60,formats:g=["image/webp"]}=o,p=(null==(i=r.images)?void 0:i.remotePatterns)||[],f=null==(n=r.images)?void 0:n.localPatterns,d=null==(s=r.images)?void 0:s.qualities,{url:h,w:_,q:y}=t;let E,b;if(l.length>0&&_log.warnOnce('The "images.domains" configuration is deprecated. Please use "images.remotePatterns" configuration instead.'),!h)return{errorMessage:'"url" parameter is required'};if(Array.isArray(h))return{errorMessage:'"url" parameter cannot be an array'};if(h.length>3072)return{errorMessage:'"url" parameter is too long'};if(h.startsWith("//"))return{errorMessage:'"url" parameter cannot be a protocol-relative URL (//)'};if(h.startsWith("/")){var v;if(E=h,b=!1,/\/_next\/image($|\/)/.test(decodeURIComponent((null==(v=(0,_url1.parseUrl)(h))?void 0:v.pathname)??"")))return{errorMessage:'"url" parameter cannot be recursive'};if(!(0,_matchlocalpattern.hasLocalMatch)(f,h))return{errorMessage:'"url" parameter is not allowed'}}else{let e;try{e=new URL(h),E=e.toString(),b=!0}catch(e){return{errorMessage:'"url" parameter is invalid'}}if(!["http:","https:"].includes(e.protocol))return{errorMessage:'"url" parameter is invalid'};if(!(0,_matchremotepattern.hasRemoteMatch)(l,p,e))return{errorMessage:'"url" parameter is not allowed'}}if(!_)return{errorMessage:'"w" parameter (width) is required'};if(Array.isArray(_))return{errorMessage:'"w" parameter (width) cannot be an array'};if(!/^[0-9]+$/.test(_))return{errorMessage:'"w" parameter (width) must be an integer greater than 0'};if(!y)return{errorMessage:'"q" parameter (quality) is required'};if(Array.isArray(y))return{errorMessage:'"q" parameter (quality) cannot be an array'};if(!/^[0-9]+$/.test(y))return{errorMessage:'"q" parameter (quality) must be an integer between 1 and 100'};const w=parseInt(_,10);if(w<=0||isNaN(w))return{errorMessage:'"w" parameter (width) must be an integer greater than 0'};const I=[...u||[],...c||[]];a&&I.push(BLUR_IMG_SIZE);if(!(I.includes(w)||a&&w<=BLUR_IMG_SIZE))return{errorMessage:`"w" parameter (width) of ${w} is not allowed`};const C=parseInt(y,10);if(isNaN(C)||C<1||C>100)return{errorMessage:'"q" parameter (quality) must be an integer between 1 and 100'};if(d&&(a&&d.push(BLUR_QUALITY),!d.includes(C)))return{errorMessage:`"q" parameter (quality) of ${y} is not allowed`};const T=getSupportedMimeType(g||[],e.headers.accept);return{href:E,sizes:I,isAbsolute:b,isStatic:h.startsWith(`${r.basePath||""}/_next/static/media`),width:w,quality:C,mimeType:T,minimumCacheTTL:m}}static getCacheKey({href:e,width:t,quality:r,mimeType:a}){return getHash([CACHE_VERSION,e,t,r,a])}constructor({distDir:e,nextConfig:t}){this.cacheDir=(0,_path.join)(e,"cache","images"),this.nextConfig=t}async get(e){try{const t=(0,_path.join)(this.cacheDir,e),r=await _fs.promises.readdir(t),a=Date.now();for(const e of r){const[r,i,n,s,o]=e.split(".",5),u=await _fs.promises.readFile((0,_path.join)(t,e)),c=Number(i),l=Number(r);return{value:{kind:_responsecache.CachedRouteKind.IMAGE,etag:n,buffer:u,extension:o,upstreamEtag:s},revalidateAfter:1e3*Math.max(l,this.nextConfig.images.minimumCacheTTL)+Date.now(),curRevalidate:l,isStale:a>c,isFallback:!1}}}catch(e){}return null}async set(e,t,{revalidate:r}){if((null==t?void 0:t.kind)!==_responsecache.CachedRouteKind.IMAGE)throw Object.defineProperty(new Error("invariant attempted to set non-image to image-cache"),"__NEXT_ERROR_CODE",{value:"E366",enumerable:!1,configurable:!0});if("number"!=typeof r)throw Object.defineProperty(new Error("invariant revalidate must be a number for image-cache"),"__NEXT_ERROR_CODE",{value:"E346",enumerable:!1,configurable:!0});const a=1e3*Math.max(r,this.nextConfig.images.minimumCacheTTL)+Date.now();try{await writeToCacheDir((0,_path.join)(this.cacheDir,e),t.extension,r,a,t.buffer,t.etag,t.upstreamEtag)}catch(t){_log.error(`Failed to write image to cache ${e}`,t)}}}class ImageError extends Error{constructor(e,t){super(t),this.statusCode=e>=400?e:500}}function parseCacheControl(e){const t=new Map;if(!e)return t;for(let r of e.split(",")){let[e,a]=r.trim().split("=",2);e=e.toLowerCase(),a&&(a=a.toLowerCase()),t.set(e,a)}return t}function getMaxAge(e){const t=parseCacheControl(e);if(t){let e=t.get("s-maxage")||t.get("max-age")||"";e.startsWith('"')&&e.endsWith('"')&&(e=e.slice(1,-1));const r=parseInt(e,10);if(!isNaN(r))return r}return 0}function getPreviouslyCachedImageOrNull(e,t){var r;return"IMAGE"===(null==t||null==(r=t.value)?void 0:r.kind)&&t.value.upstreamEtag!==t.value.etag&&e.etag===t.value.upstreamEtag?t.value:null}async function optimizeImage({buffer:e,contentType:t,quality:r,width:a,height:i,concurrency:n,limitInputPixels:s,sequentialRead:o,timeoutInSeconds:u}){const c=getSharp(n)(e,{limitInputPixels:s,sequentialRead:o??void 0}).timeout({seconds:u??7}).rotate();i?c.resize(a,i):c.resize(a,void 0,{withoutEnlargement:!0}),t===AVIF?c.avif({quality:Math.max(r-20,1),effort:3}):t===WEBP?c.webp({quality:r}):t===PNG?c.png({quality:r}):t===JPEG&&c.jpeg({quality:r,mozjpeg:!0});return await c.toBuffer()}async function fetchExternalImage(e){const t=await fetch(e,{signal:AbortSignal.timeout(7e3)}).catch((e=>e));if(t instanceof Error){const r=t;if("TimeoutError"===r.name)throw _log.error("upstream image response timed out for",e),Object.defineProperty(new ImageError(504,'"url" parameter is valid but upstream response timed out'),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});throw r}if(!t.ok)throw _log.error("upstream image response failed for",e,t.status),Object.defineProperty(new ImageError(t.status,'"url" parameter is valid but upstream response is invalid'),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});const r=Buffer.from(await t.arrayBuffer());return{buffer:r,contentType:t.headers.get("Content-Type"),cacheControl:t.headers.get("Cache-Control"),etag:extractEtag(t.headers.get("ETag"),r)}}async function fetchInternalImage(e,t,r,a){try{const r=(0,_mockrequest.createRequestResponseMocks)({url:e,method:t.method||"GET",headers:t.headers,socket:t.socket});if(await a(r.req,r.res,_url.default.parse(e,!0)),await r.res.hasStreamed,!r.res.statusCode)throw _log.error("image response failed for",e,r.res.statusCode),Object.defineProperty(new ImageError(r.res.statusCode,'"url" parameter is valid but internal response is invalid'),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});const i=Buffer.concat(r.res.buffers),n=r.res.getHeader("Content-Type"),s=r.res.getHeader("Cache-Control");return{buffer:i,contentType:n,cacheControl:s,etag:extractEtag(r.res.getHeader("ETag"),i)}}catch(t){throw _log.error("upstream image response failed for",e,t),Object.defineProperty(new ImageError(500,'"url" parameter is valid but upstream response is invalid'),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0})}}async function imageOptimizer(e,t,r,a){var i;const{href:n,quality:s,width:o,mimeType:u}=t,{buffer:c,etag:l}=e,m=Math.max(r.images.minimumCacheTTL,getMaxAge(e.cacheControl)),g=detectContentType(c)||(null==(i=e.contentType)?void 0:i.toLowerCase().trim());if(g){if(g.startsWith("image/svg")&&!r.images.dangerouslyAllowSVG)throw a.silent||_log.error(`The requested resource "${n}" has type "${g}" but dangerouslyAllowSVG is disabled`),Object.defineProperty(new ImageError(400,'"url" parameter is valid but image type is not allowed'),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});if(ANIMATABLE_TYPES.includes(g)&&(0,_isanimated.default)(c))return a.silent||_log.warnOnce(`The requested resource "${n}" is an animated image so it will not be optimized. Consider adding the "unoptimized" property to the <Image>.`),{buffer:c,contentType:g,maxAge:m,etag:l,upstreamEtag:l};if(BYPASS_TYPES.includes(g))return{buffer:c,contentType:g,maxAge:m,etag:l,upstreamEtag:l};if(!g.startsWith("image/")||g.includes(","))throw a.silent||_log.error("The requested resource isn't a valid image for",n,"received",g),Object.defineProperty(new ImageError(400,"The requested resource isn't a valid image."),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0})}let p;p=u||((null==g?void 0:g.startsWith("image/"))&&(0,_servestatic.getExtension)(g)&&g!==WEBP&&g!==AVIF?g:JPEG);const f=getPreviouslyCachedImageOrNull(e,a.previousCacheEntry);var d;if(f)return{buffer:f.buffer,contentType:p,maxAge:(null==a||null==(d=a.previousCacheEntry)?void 0:d.curRevalidate)||m,etag:f.etag,upstreamEtag:f.upstreamEtag};try{let e=await optimizeImage({buffer:c,contentType:p,quality:s,width:o,concurrency:r.experimental.imgOptConcurrency,limitInputPixels:r.experimental.imgOptMaxInputPixels,sequentialRead:r.experimental.imgOptSequentialRead,timeoutInSeconds:r.experimental.imgOptTimeoutInSeconds});if(a.isDev&&o<=BLUR_IMG_SIZE&&s===BLUR_QUALITY){const t=await getImageSize(e),r={blurWidth:t.width,blurHeight:t.height,blurDataURL:`data:${p};base64,${e.toString("base64")}`};e=Buffer.from(unescape((0,_imageblursvg.getImageBlurSvg)(r))),p="image/svg+xml"}return{buffer:e,contentType:p,maxAge:m,etag:getImageEtag(e),upstreamEtag:l}}catch(e){if(g)return{buffer:c,contentType:g,maxAge:r.images.minimumCacheTTL,etag:l,upstreamEtag:l,error:e};throw Object.defineProperty(new ImageError(400,"Unable to optimize image and unable to fallback to upstream image"),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0})}}function getFileNameWithExtension(e,t){const[r]=e.split("?",1),a=r.split("/").pop();if(!t||!a)return"image.bin";const[i]=a.split(".",1);return`${i}.${(0,_servestatic.getExtension)(t)}`}function setResponseHeaders(e,t,r,a,i,n,s,o,u,c){if(t.setHeader("Vary","Accept"),t.setHeader("Cache-Control",n?"public, max-age=315360000, immutable":`public, max-age=${c?0:u}, must-revalidate`),(0,_sendpayload.sendEtagResponse)(e,t,a))return{finished:!0};i&&t.setHeader("Content-Type",i);const l=getFileNameWithExtension(r,i);return t.setHeader("Content-Disposition",(0,_contentdisposition.default)(l,{type:o.contentDispositionType})),t.setHeader("Content-Security-Policy",o.contentSecurityPolicy),t.setHeader("X-Nextjs-Cache",s),{finished:!1}}function sendResponse(e,t,r,a,i,n,s,o,u,c,l){setResponseHeaders(e,t,r,n,(0,_servestatic.getContentType)(a),s,o,u,c,l).finished||(t.setHeader("Content-Length",Buffer.byteLength(i)),t.end(i))}async function getImageSize(e){const{width:t,height:r}=(0,_imagesize.default)(e);return{width:t,height:r}}