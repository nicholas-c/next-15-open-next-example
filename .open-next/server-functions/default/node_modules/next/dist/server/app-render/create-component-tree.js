"use strict";function _export(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{createComponentTree:function(){return createComponentTree},getRootParams:function(){return getRootParams}});const _jsxruntime=require("react/jsx-runtime"),_react=_interop_require_default(require("react")),_clientandserverreferences=require("../../lib/client-and-server-references"),_appdirmodule=require("../lib/app-dir-module"),_interopdefault=require("./interop-default"),_parseloadertree=require("./parse-loader-tree"),_createcomponentstylesandscripts=require("./create-component-styles-and-scripts"),_getlayerassets=require("./get-layer-assets"),_hasloadingcomponentintree=require("./has-loading-component-in-tree"),_patchfetch=require("../lib/patch-fetch"),_parallelroutedefault=require("../../client/components/parallel-route-default"),_tracer=require("../lib/trace/tracer"),_constants=require("../lib/trace/constants"),_staticgenerationbailout=require("../../client/components/static-generation-bailout"),_workunitasyncstorageexternal=require("./work-unit-async-storage.external"),_metadataconstants=require("../../lib/metadata/metadata-constants"),_segment=require("../../shared/lib/segment");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function createComponentTree(e){return(0,_tracer.getTracer)().trace(_constants.NextNodeServerSpan.createComponentTree,{spanName:"build component tree"},(()=>createComponentTreeInternal(e)))}function errorMissingDefaultExport(e,t){const r="/"===e?"":e;throw Object.defineProperty(new Error(`The default export is not a React Component in "${r}/${t}"`),"__NEXT_ERROR_CODE",{value:"E45",enumerable:!1,configurable:!0})}const cacheNodeKey="c";async function createComponentTreeInternal({loaderTree:e,parentParams:t,rootLayoutIncluded:r,injectedCSS:n,injectedJS:a,injectedFontPreloadTags:o,getViewportReady:s,getMetadataReady:i,ctx:c,missingSlots:l,preloadCallbacks:d,authInterrupts:u,StreamingMetadata:m,StreamingMetadataOutlet:p}){const{renderOpts:{nextConfigOutput:_,experimental:g},workStore:f,componentMod:{HTTPAccessFallbackBoundary:y,LayoutRouter:x,RenderFromTemplateContext:j,OutletBoundary:S,ClientPageRoot:h,ClientSegmentRoot:P,createServerSearchParamsForServerPage:v,createPrerenderSearchParamsForClientPage:C,createServerParamsForServerSegment:E,createPrerenderParamsForClientSegment:R,serverHooks:{DynamicServerError:b},Postpone:O},pagePath:T,getDynamicParamFromSegment:w,isPrefetch:N,query:F}=c,{page:D,layoutOrPagePath:M,segment:q,modules:A,parallelRoutes:L}=(0,_parseloadertree.parseLoaderTree)(e),{layout:k,template:B,error:I,loading:U,"not-found":K,forbidden:J,unauthorized:G}=A,V=new Set(n),$=new Set(a),z=new Set(o),X=(0,_getlayerassets.getLayerAssets)({preloadCallbacks:d,ctx:c,layoutOrPagePath:M,injectedCSS:V,injectedJS:$,injectedFontPreloadTags:z}),[H,Y,W]=B?await(0,_createcomponentstylesandscripts.createComponentStylesAndScripts)({ctx:c,filePath:B[1],getComponent:B[0],injectedCSS:V,injectedJS:$}):[_react.default.Fragment],[Q,Z,ee]=I?await(0,_createcomponentstylesandscripts.createComponentStylesAndScripts)({ctx:c,filePath:I[1],getComponent:I[0],injectedCSS:V,injectedJS:$}):[],[te,re,ne]=U?await(0,_createcomponentstylesandscripts.createComponentStylesAndScripts)({ctx:c,filePath:U[1],getComponent:U[0],injectedCSS:V,injectedJS:$}):[],ae=void 0!==k,oe=void 0!==D,{mod:se,modType:ie}=await(0,_tracer.getTracer)().trace(_constants.NextNodeServerSpan.getLayoutOrPageModule,{hideSpan:!(ae||oe),spanName:"resolve segment modules",attributes:{"next.segment":q}},(()=>(0,_appdirmodule.getLayoutOrPageModule)(e))),ce=ae&&!r,le=r||ce,[de,ue]=K?await(0,_createcomponentstylesandscripts.createComponentStylesAndScripts)({ctx:c,filePath:K[1],getComponent:K[0],injectedCSS:V,injectedJS:$}):[],[me,pe]=u&&J?await(0,_createcomponentstylesandscripts.createComponentStylesAndScripts)({ctx:c,filePath:J[1],getComponent:J[0],injectedCSS:V,injectedJS:$}):[],[_e,ge]=u&&G?await(0,_createcomponentstylesandscripts.createComponentStylesAndScripts)({ctx:c,filePath:G[1],getComponent:G[0],injectedCSS:V,injectedJS:$}):[];let fe=null==se?void 0:se.dynamic;if("export"===_)if(fe&&"auto"!==fe){if("force-dynamic"===fe)throw Object.defineProperty(new _staticgenerationbailout.StaticGenBailoutError('Page with `dynamic = "force-dynamic"` couldn\'t be exported. `output: "export"` requires all pages be renderable statically because there is no runtime server to dynamically render routes in this output format. Learn more: https://nextjs.org/docs/app/building-your-application/deploying/static-exports'),"__NEXT_ERROR_CODE",{value:"E527",enumerable:!1,configurable:!0})}else fe="error";if("string"==typeof fe)if("error"===fe)f.dynamicShouldError=!0;else if("force-dynamic"===fe){if(f.forceDynamic=!0,f.isStaticGeneration&&!g.isRoutePPREnabled){const e=Object.defineProperty(new b('Page with `dynamic = "force-dynamic"` won\'t be rendered statically.'),"__NEXT_ERROR_CODE",{value:"E585",enumerable:!1,configurable:!0});throw f.dynamicUsageDescription=e.message,f.dynamicUsageStack=e.stack,e}}else f.dynamicShouldError=!1,f.forceStatic="force-static"===fe;if("string"==typeof(null==se?void 0:se.fetchCache)&&(f.fetchCache=null==se?void 0:se.fetchCache),void 0!==(null==se?void 0:se.revalidate)&&(0,_patchfetch.validateRevalidate)(null==se?void 0:se.revalidate,f.route),"number"==typeof(null==se?void 0:se.revalidate)){const e=se.revalidate,t=_workunitasyncstorageexternal.workUnitAsyncStorage.getStore();if(t&&("prerender"!==t.type&&"prerender-legacy"!==t.type&&"prerender-ppr"!==t.type&&"cache"!==t.type||t.revalidate>e&&(t.revalidate=e)),!f.forceStatic&&f.isStaticGeneration&&0===e&&!g.isRoutePPREnabled){const e=`revalidate: 0 configured ${q}`;throw f.dynamicUsageDescription=e,Object.defineProperty(new b(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0})}}const ye=f.isStaticGeneration,xe=ye&&!0===g.isRoutePPREnabled;if(f.dynamicUsageErr)throw f.dynamicUsageErr;let je=se?(0,_interopdefault.interopDefault)(se):void 0;if("development"===process.env.NODE_ENV){const{isValidElementType:e}=require("next/dist/compiled/react-is");void 0===je||e(je)||errorMissingDefaultExport(T,ie??"page"),void 0===Q||e(Q)||errorMissingDefaultExport(T,"error"),void 0===te||e(te)||errorMissingDefaultExport(T,"loading"),void 0===de||e(de)||errorMissingDefaultExport(T,"not-found"),void 0===me||e(me)||errorMissingDefaultExport(T,"forbidden"),void 0===_e||e(_e)||errorMissingDefaultExport(T,"unauthorized")}const Se=w(q);let he=t;Se&&null!==Se.value&&(he={...t,[Se.param]:Se.value});const Pe=Se?Se.treeSegment:q,ve=Pe!==_segment.DEFAULT_SEGMENT_KEY,Ce=ve&&m?(0,_jsxruntime.jsx)(m,{}):void 0,Ee=ve&&p?(0,_jsxruntime.jsx)(p,{}):void 0,Re=de?(0,_jsxruntime.jsxs)(_jsxruntime.Fragment,{children:[(0,_jsxruntime.jsx)(de,{}),Ce,ue]}):void 0,be=me?(0,_jsxruntime.jsxs)(_jsxruntime.Fragment,{children:[(0,_jsxruntime.jsx)(me,{}),Ce,pe]}):void 0,Oe=_e?(0,_jsxruntime.jsxs)(_jsxruntime.Fragment,{children:[(0,_jsxruntime.jsx)(_e,{}),Ce,ge]}):void 0,Te=await Promise.all(Object.keys(L).map((async e=>{const t="children"===e,r=L[e],n=t?Re:void 0,a=t?be:void 0,o=t?Oe:void 0;let _=null;if(!N||!te&&(0,_hasloadingcomponentintree.hasLoadingComponentInTree)(r)||g.isRoutePPREnabled){if("development"===process.env.NODE_ENV&&l){var f;(null==(f=(0,_parseloadertree.parseLoaderTree)(r).layoutOrPagePath)?void 0:f.endsWith(_parallelroutedefault.PARALLEL_ROUTE_DEFAULT_PATH))&&l.add(e)}_=await createComponentTreeInternal({loaderTree:r,parentParams:he,rootLayoutIncluded:le,injectedCSS:V,injectedJS:$,injectedFontPreloadTags:z,getMetadataReady:t?i:()=>Promise.resolve(),getViewportReady:t?s:()=>Promise.resolve(),ctx:c,missingSlots:l,preloadCallbacks:d,authInterrupts:u,StreamingMetadata:m,StreamingMetadataOutlet:t?p:null})}else;return[e,(0,_jsxruntime.jsx)(x,{parallelRouterKey:e,error:Q,errorStyles:Z,errorScripts:ee,template:(0,_jsxruntime.jsx)(H,{children:(0,_jsxruntime.jsx)(j,{})}),templateStyles:Y,templateScripts:W,notFound:n,forbidden:a,unauthorized:o}),_]})));let we={},Ne={};for(const e of Te){const[t,r,n]=e;we[t]=r,Ne[t]=n}const Fe=te?[(0,_jsxruntime.jsx)(te,{},"l"),re,ne]:null;if(!je)return[Pe,(0,_jsxruntime.jsxs)(_react.default.Fragment,{children:[X,we.children]},cacheNodeKey),Ne,Fe,xe];const De=je;if(f.isStaticGeneration&&f.forceDynamic&&g.isRoutePPREnabled)return[Pe,(0,_jsxruntime.jsxs)(_react.default.Fragment,{children:[(0,_jsxruntime.jsx)(O,{reason:'dynamic = "force-dynamic" was used',route:f.route}),X]},cacheNodeKey),Ne,Fe,!0];const Me=(0,_clientandserverreferences.isClientReference)(se);if("development"===process.env.NODE_ENV&&"params"in we&&console.error(`"params" is a reserved prop in Layouts and Pages and cannot be used as the name of a parallel route in ${q}`),oe){const e=De;let t;if(Me)if(ye){const r=R(he,f),n=C(f);t=(0,_jsxruntime.jsx)(h,{Component:e,searchParams:F,params:he,promises:[n,r]})}else t=(0,_jsxruntime.jsx)(h,{Component:e,searchParams:F,params:he});else{const r=E(he,f);if(!g.dynamicIO&&(0,_clientandserverreferences.isUseCacheFunction)(e)){const n=e,a=Promise.resolve({});t=(0,_jsxruntime.jsx)(n,{params:r,searchParams:a,$$isPageComponent:!0})}else{const n=v(F,f);t=(0,_jsxruntime.jsx)(e,{params:r,searchParams:n})}}return[Pe,(0,_jsxruntime.jsxs)(_react.default.Fragment,{children:[t,Ce,X,(0,_jsxruntime.jsxs)(S,{children:[(0,_jsxruntime.jsx)(MetadataOutlet,{ready:s}),(0,_jsxruntime.jsx)(MetadataOutlet,{ready:i}),Ee]})]},cacheNodeKey),Ne,Fe,xe]}{const e=De,t=ce&&"children"in L&&Object.keys(L).length>1;let r;if(Me){let n;if(ye){const t=R(he,f);n=(0,_jsxruntime.jsx)(P,{Component:e,slots:we,params:he,promise:t})}else n=(0,_jsxruntime.jsx)(P,{Component:e,slots:we,params:he});if(t){let t,a,o;t=createErrorBoundaryClientSegmentRoot({ErrorBoundaryComponent:de,errorElement:Re,ClientSegmentRoot:P,layerAssets:X,SegmentComponent:e,currentParams:he}),a=createErrorBoundaryClientSegmentRoot({ErrorBoundaryComponent:me,errorElement:be,ClientSegmentRoot:P,layerAssets:X,SegmentComponent:e,currentParams:he}),o=createErrorBoundaryClientSegmentRoot({ErrorBoundaryComponent:_e,errorElement:Oe,ClientSegmentRoot:P,layerAssets:X,SegmentComponent:e,currentParams:he}),r=t||a||o?(0,_jsxruntime.jsxs)(y,{notFound:t,forbidden:a,unauthorized:o,children:[X,n]},cacheNodeKey):(0,_jsxruntime.jsxs)(_react.default.Fragment,{children:[X,n]},cacheNodeKey)}else r=(0,_jsxruntime.jsxs)(_react.default.Fragment,{children:[X,n]},cacheNodeKey)}else{const n=E(he,f);let a=(0,_jsxruntime.jsx)(e,{...we,params:n});r=t?(0,_jsxruntime.jsxs)(y,{notFound:de?(0,_jsxruntime.jsxs)(_jsxruntime.Fragment,{children:[X,(0,_jsxruntime.jsxs)(e,{params:n,children:[ue,(0,_jsxruntime.jsx)(de,{})]}),Ce]}):void 0,children:[X,a]},cacheNodeKey):(0,_jsxruntime.jsxs)(_react.default.Fragment,{children:[X,a]},cacheNodeKey)}return[Pe,r,Ne,Fe,xe]}}async function MetadataOutlet({ready:e}){const t=e();if("rejected"===t.status)throw t.value;return"fulfilled"!==t.status&&await t,null}function createErrorBoundaryClientSegmentRoot({ErrorBoundaryComponent:e,errorElement:t,ClientSegmentRoot:r,layerAssets:n,SegmentComponent:a,currentParams:o}){if(e){const e={children:t};return(0,_jsxruntime.jsxs)(_jsxruntime.Fragment,{children:[n,(0,_jsxruntime.jsx)(r,{Component:a,slots:e,params:o})]})}return null}function getRootParams(e,t){return getRootParamsImpl({},e,t)}function getRootParamsImpl(e,t,r){const{segment:n,modules:{layout:a},parallelRoutes:o}=(0,_parseloadertree.parseLoaderTree)(t),s=r(n);let i=e;s&&null!==s.value&&(i={...e,[s.param]:s.value});return void 0!==a?i:o.children?getRootParamsImpl(i,o.children,r):i}MetadataOutlet.displayName=_metadataconstants.OUTLET_BOUNDARY_NAME;