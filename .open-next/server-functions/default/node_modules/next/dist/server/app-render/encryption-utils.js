"use strict";function _export(e,r){for(var n in r)Object.defineProperty(e,n,{enumerable:!0,get:r[n]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{arrayBufferToString:function(){return arrayBufferToString},decrypt:function(){return decrypt},encrypt:function(){return encrypt},getActionEncryptionKey:function(){return getActionEncryptionKey},getClientReferenceManifestForRsc:function(){return getClientReferenceManifestForRsc},getServerModuleMap:function(){return getServerModuleMap},setReferenceManifestsSingleton:function(){return setReferenceManifestsSingleton},stringToUint8Array:function(){return stringToUint8Array}});const _invarianterror=require("../../shared/lib/invariant-error"),_apppaths=require("../../shared/lib/router/utils/app-paths"),_workasyncstorageexternal=require("./work-async-storage.external");let __next_loaded_action_key;function arrayBufferToString(e){const r=new Uint8Array(e),n=r.byteLength;if(n<65535)return String.fromCharCode.apply(null,r);let t="";for(let e=0;e<n;e++)t+=String.fromCharCode(r[e]);return t}function stringToUint8Array(e){const r=e.length,n=new Uint8Array(r);for(let t=0;t<r;t++)n[t]=e.charCodeAt(t);return n}function encrypt(e,r,n){return crypto.subtle.encrypt({name:"AES-GCM",iv:r},e,n)}function decrypt(e,r,n){return crypto.subtle.decrypt({name:"AES-GCM",iv:r},e,n)}const SERVER_ACTION_MANIFESTS_SINGLETON=Symbol.for("next.server.action-manifests");function setReferenceManifestsSingleton({page:e,clientReferenceManifest:r,serverActionsManifest:n,serverModuleMap:t}){var i;const o=null==(i=globalThis[SERVER_ACTION_MANIFESTS_SINGLETON])?void 0:i.clientReferenceManifestsPerPage;globalThis[SERVER_ACTION_MANIFESTS_SINGLETON]={clientReferenceManifestsPerPage:{...o,[(0,_apppaths.normalizeAppPath)(e)]:r},serverActionsManifest:n,serverModuleMap:t}}function getServerModuleMap(){const e=globalThis[SERVER_ACTION_MANIFESTS_SINGLETON];if(!e)throw Object.defineProperty(new _invarianterror.InvariantError("Missing manifest for Server Actions."),"__NEXT_ERROR_CODE",{value:"E606",enumerable:!1,configurable:!0});return e.serverModuleMap}function getClientReferenceManifestForRsc(){const e=globalThis[SERVER_ACTION_MANIFESTS_SINGLETON];if(!e)throw Object.defineProperty(new _invarianterror.InvariantError("Missing manifest for Server Actions."),"__NEXT_ERROR_CODE",{value:"E606",enumerable:!1,configurable:!0});const{clientReferenceManifestsPerPage:r}=e,n=_workasyncstorageexternal.workAsyncStorage.getStore();if(!n)return mergeClientReferenceManifests(r);const t=r[n.route];if(!t)throw Object.defineProperty(new _invarianterror.InvariantError(`Missing Client Reference Manifest for ${n.route}.`),"__NEXT_ERROR_CODE",{value:"E570",enumerable:!1,configurable:!0});return t}async function getActionEncryptionKey(){if(__next_loaded_action_key)return __next_loaded_action_key;const e=globalThis[SERVER_ACTION_MANIFESTS_SINGLETON];if(!e)throw Object.defineProperty(new _invarianterror.InvariantError("Missing manifest for Server Actions."),"__NEXT_ERROR_CODE",{value:"E606",enumerable:!1,configurable:!0});const r=process.env.NEXT_SERVER_ACTIONS_ENCRYPTION_KEY||e.serverActionsManifest.encryptionKey;if(void 0===r)throw Object.defineProperty(new _invarianterror.InvariantError("Missing encryption key for Server Actions"),"__NEXT_ERROR_CODE",{value:"E571",enumerable:!1,configurable:!0});return __next_loaded_action_key=await crypto.subtle.importKey("raw",stringToUint8Array(atob(r)),"AES-GCM",!0,["encrypt","decrypt"]),__next_loaded_action_key}function mergeClientReferenceManifests(e){const r=Object.values(e),n={clientModules:{},edgeRscModuleMapping:{},rscModuleMapping:{}};for(const e of r)n.clientModules={...n.clientModules,...e.clientModules},n.edgeRscModuleMapping={...n.edgeRscModuleMapping,...e.edgeRscModuleMapping},n.rscModuleMapping={...n.rscModuleMapping,...e.rscModuleMapping};return n}