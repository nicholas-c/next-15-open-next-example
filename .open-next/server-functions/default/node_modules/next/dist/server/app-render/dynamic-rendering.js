"use strict";function _export(e,t){for(var n in t)Object.defineProperty(e,n,{enumerable:!0,get:t[n]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{Postpone:function(){return Postpone},abortAndThrowOnSynchronousRequestDataAccess:function(){return abortAndThrowOnSynchronousRequestDataAccess},abortOnSynchronousPlatformIOAccess:function(){return abortOnSynchronousPlatformIOAccess},accessedDynamicData:function(){return accessedDynamicData},annotateDynamicAccess:function(){return annotateDynamicAccess},consumeDynamicAccess:function(){return consumeDynamicAccess},createDynamicTrackingState:function(){return createDynamicTrackingState},createDynamicValidationState:function(){return createDynamicValidationState},createHangingInputAbortSignal:function(){return createHangingInputAbortSignal},createPostponedAbortSignal:function(){return createPostponedAbortSignal},formatDynamicAPIAccesses:function(){return formatDynamicAPIAccesses},getFirstDynamicReason:function(){return getFirstDynamicReason},isDynamicPostpone:function(){return isDynamicPostpone},isPrerenderInterruptedError:function(){return isPrerenderInterruptedError},markCurrentScopeAsDynamic:function(){return markCurrentScopeAsDynamic},postponeWithTracking:function(){return postponeWithTracking},throwIfDisallowedDynamic:function(){return throwIfDisallowedDynamic},throwToInterruptStaticGeneration:function(){return throwToInterruptStaticGeneration},trackAllowedDynamicAccess:function(){return trackAllowedDynamicAccess},trackDynamicDataInDynamicRender:function(){return trackDynamicDataInDynamicRender},trackFallbackParamAccessed:function(){return trackFallbackParamAccessed},trackSynchronousPlatformIOAccessInDev:function(){return trackSynchronousPlatformIOAccessInDev},trackSynchronousRequestDataAccessInDev:function(){return trackSynchronousRequestDataAccessInDev},useDynamicRouteParams:function(){return useDynamicRouteParams}});const _react=_interop_require_default(require("react")),_hooksservercontext=require("../../client/components/hooks-server-context"),_staticgenerationbailout=require("../../client/components/static-generation-bailout"),_workunitasyncstorageexternal=require("./work-unit-async-storage.external"),_workasyncstorageexternal=require("../app-render/work-async-storage.external"),_dynamicrenderingutils=require("../dynamic-rendering-utils"),_metadataconstants=require("../../lib/metadata/metadata-constants"),_scheduler=require("../../lib/scheduler");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}const hasPostpone="function"==typeof _react.default.unstable_postpone;function createDynamicTrackingState(e){return{isDebugDynamicAccesses:e,dynamicAccesses:[],syncDynamicExpression:void 0,syncDynamicErrorWithStack:null}}function createDynamicValidationState(){return{hasSuspendedDynamic:!1,hasDynamicMetadata:!1,hasDynamicViewport:!1,hasSyncDynamicErrors:!1,dynamicErrors:[]}}function getFirstDynamicReason(e){var t;return null==(t=e.dynamicAccesses[0])?void 0:t.expression}function markCurrentScopeAsDynamic(e,t,n){if((!t||"cache"!==t.type&&"unstable-cache"!==t.type)&&!e.forceDynamic&&!e.forceStatic){if(e.dynamicShouldError)throw Object.defineProperty(new _staticgenerationbailout.StaticGenBailoutError(`Route ${e.route} with \`dynamic = "error"\` couldn't be rendered statically because it used \`${n}\`. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`),"__NEXT_ERROR_CODE",{value:"E553",enumerable:!1,configurable:!0});if(t)if("prerender-ppr"===t.type)postponeWithTracking(e.route,n,t.dynamicTracking);else{if("prerender-legacy"===t.type){t.revalidate=0;const r=Object.defineProperty(new _hooksservercontext.DynamicServerError(`Route ${e.route} couldn't be rendered statically because it used ${n}. See more info here: https://nextjs.org/docs/messages/dynamic-server-error`),"__NEXT_ERROR_CODE",{value:"E550",enumerable:!1,configurable:!0});throw e.dynamicUsageDescription=n,e.dynamicUsageStack=r.stack,r}"development"===process.env.NODE_ENV&&t&&"request"===t.type&&(t.usedDynamic=!0)}}}function trackFallbackParamAccessed(e,t){const n=_workunitasyncstorageexternal.workUnitAsyncStorage.getStore();n&&"prerender-ppr"===n.type&&postponeWithTracking(e.route,t,n.dynamicTracking)}function throwToInterruptStaticGeneration(e,t,n){const r=Object.defineProperty(new _hooksservercontext.DynamicServerError(`Route ${t.route} couldn't be rendered statically because it used \`${e}\`. See more info here: https://nextjs.org/docs/messages/dynamic-server-error`),"__NEXT_ERROR_CODE",{value:"E558",enumerable:!1,configurable:!0});throw n.revalidate=0,t.dynamicUsageDescription=e,t.dynamicUsageStack=r.stack,r}function trackDynamicDataInDynamicRender(e,t){if(t){if("cache"===t.type||"unstable-cache"===t.type)return;"prerender"!==t.type&&"prerender-legacy"!==t.type||(t.revalidate=0),"development"===process.env.NODE_ENV&&"request"===t.type&&(t.usedDynamic=!0)}}function abortOnSynchronousDynamicDataAccess(e,t,n){const r=createPrerenderInterruptedError(`Route ${e} needs to bail out of prerendering at this point because it used ${t}.`);n.controller.abort(r);const a=n.dynamicTracking;a&&a.dynamicAccesses.push({stack:a.isDebugDynamicAccesses?(new Error).stack:void 0,expression:t})}function abortOnSynchronousPlatformIOAccess(e,t,n,r){const a=r.dynamicTracking;return a&&null===a.syncDynamicErrorWithStack&&(a.syncDynamicExpression=t,a.syncDynamicErrorWithStack=n),abortOnSynchronousDynamicDataAccess(e,t,r)}function trackSynchronousPlatformIOAccessInDev(e){e.prerenderPhase=!1}function abortAndThrowOnSynchronousRequestDataAccess(e,t,n,r){const a=r.dynamicTracking;throw a&&null===a.syncDynamicErrorWithStack&&(a.syncDynamicExpression=t,a.syncDynamicErrorWithStack=n,!0===r.validating&&(a.syncDynamicLogged=!0)),abortOnSynchronousDynamicDataAccess(e,t,r),createPrerenderInterruptedError(`Route ${e} needs to bail out of prerendering at this point because it used ${t}.`)}const trackSynchronousRequestDataAccessInDev=trackSynchronousPlatformIOAccessInDev;function Postpone({reason:e,route:t}){const n=_workunitasyncstorageexternal.workUnitAsyncStorage.getStore();postponeWithTracking(t,e,n&&"prerender-ppr"===n.type?n.dynamicTracking:null)}function postponeWithTracking(e,t,n){assertPostpone(),n&&n.dynamicAccesses.push({stack:n.isDebugDynamicAccesses?(new Error).stack:void 0,expression:t}),_react.default.unstable_postpone(createPostponeReason(e,t))}function createPostponeReason(e,t){return`Route ${e} needs to bail out of prerendering at this point because it used ${t}. React throws this special object to indicate where. It should not be caught by your own try/catch. Learn more: https://nextjs.org/docs/messages/ppr-caught-error`}function isDynamicPostpone(e){return"object"==typeof e&&null!==e&&"string"==typeof e.message&&isDynamicPostponeReason(e.message)}function isDynamicPostponeReason(e){return e.includes("needs to bail out of prerendering at this point because it used")&&e.includes("Learn more: https://nextjs.org/docs/messages/ppr-caught-error")}if(!1===isDynamicPostponeReason(createPostponeReason("%%%","^^^")))throw Object.defineProperty(new Error("Invariant: isDynamicPostpone misidentified a postpone reason. This is a bug in Next.js"),"__NEXT_ERROR_CODE",{value:"E296",enumerable:!1,configurable:!0});const NEXT_PRERENDER_INTERRUPTED="NEXT_PRERENDER_INTERRUPTED";function createPrerenderInterruptedError(e){const t=Object.defineProperty(new Error(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});return t.digest=NEXT_PRERENDER_INTERRUPTED,t}function isPrerenderInterruptedError(e){return"object"==typeof e&&null!==e&&e.digest===NEXT_PRERENDER_INTERRUPTED&&"name"in e&&"message"in e&&e instanceof Error}function accessedDynamicData(e){return e.length>0}function consumeDynamicAccess(e,t){return e.dynamicAccesses.push(...t.dynamicAccesses),e.dynamicAccesses}function formatDynamicAPIAccesses(e){return e.filter((e=>"string"==typeof e.stack&&e.stack.length>0)).map((({expression:e,stack:t})=>`Dynamic API Usage Debug - ${e}:\n${t=t.split("\n").slice(4).filter((e=>!e.includes("node_modules/next/")&&(!e.includes(" (<anonymous>)")&&!e.includes(" (node:")))).join("\n")}`))}function assertPostpone(){if(!hasPostpone)throw Object.defineProperty(new Error("Invariant: React.unstable_postpone is not defined. This suggests the wrong version of React was loaded. This is a bug in Next.js"),"__NEXT_ERROR_CODE",{value:"E224",enumerable:!1,configurable:!0})}function createPostponedAbortSignal(e){assertPostpone();const t=new AbortController;try{_react.default.unstable_postpone(e)}catch(e){t.abort(e)}return t.signal}function createHangingInputAbortSignal(e){const t=new AbortController;return e.cacheSignal?e.cacheSignal.inputReady().then((()=>{t.abort()})):(0,_scheduler.scheduleOnNextTick)((()=>t.abort())),t.signal}function annotateDynamicAccess(e,t){const n=t.dynamicTracking;n&&n.dynamicAccesses.push({stack:n.isDebugDynamicAccesses?(new Error).stack:void 0,expression:e})}function useDynamicRouteParams(e){if("undefined"==typeof window){const t=_workasyncstorageexternal.workAsyncStorage.getStore();if(t&&t.isStaticGeneration&&t.fallbackRouteParams&&t.fallbackRouteParams.size>0){const n=_workunitasyncstorageexternal.workUnitAsyncStorage.getStore();n&&("prerender"===n.type?_react.default.use((0,_dynamicrenderingutils.makeHangingPromise)(n.renderSignal,e)):"prerender-ppr"===n.type?postponeWithTracking(t.route,e,n.dynamicTracking):"prerender-legacy"===n.type&&throwToInterruptStaticGeneration(e,t,n))}}}const hasSuspenseRegex=/\n\s+at Suspense \(<anonymous>\)/,hasMetadataRegex=new RegExp(`\\n\\s+at ${_metadataconstants.METADATA_BOUNDARY_NAME}[\\n\\s]`),hasViewportRegex=new RegExp(`\\n\\s+at ${_metadataconstants.VIEWPORT_BOUNDARY_NAME}[\\n\\s]`),hasOutletRegex=new RegExp(`\\n\\s+at ${_metadataconstants.OUTLET_BOUNDARY_NAME}[\\n\\s]`);function trackAllowedDynamicAccess(e,t,n,r,a){if(!hasOutletRegex.test(t))if(hasMetadataRegex.test(t))n.hasDynamicMetadata=!0;else if(hasViewportRegex.test(t))n.hasDynamicViewport=!0;else if(hasSuspenseRegex.test(t))n.hasSuspendedDynamic=!0;else{if(!r.syncDynamicErrorWithStack&&!a.syncDynamicErrorWithStack){const r=createErrorWithComponentStack(`Route "${e}": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a "use cache" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense`,t);return void n.dynamicErrors.push(r)}n.hasSyncDynamicErrors=!0}}function createErrorWithComponentStack(e,t){const n=Object.defineProperty(new Error(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});return n.stack="Error: "+e+t,n}function throwIfDisallowedDynamic(e,t,n,r){let a,o,c;if(n.syncDynamicErrorWithStack?(a=n.syncDynamicErrorWithStack,o=n.syncDynamicExpression,c=!0===n.syncDynamicLogged):r.syncDynamicErrorWithStack?(a=r.syncDynamicErrorWithStack,o=r.syncDynamicExpression,c=!0===r.syncDynamicLogged):(a=null,o=void 0,c=!1),t.hasSyncDynamicErrors&&a)throw c||console.error(a),new _staticgenerationbailout.StaticGenBailoutError;const s=t.dynamicErrors;if(s.length){for(let e=0;e<s.length;e++)console.error(s[e]);throw new _staticgenerationbailout.StaticGenBailoutError}if(!t.hasSuspendedDynamic){if(t.hasDynamicMetadata){if(a)throw console.error(a),Object.defineProperty(new _staticgenerationbailout.StaticGenBailoutError(`Route "${e}" has a \`generateMetadata\` that could not finish rendering before ${o} was used. Follow the instructions in the error for this expression to resolve.`),"__NEXT_ERROR_CODE",{value:"E608",enumerable:!1,configurable:!0});throw Object.defineProperty(new _staticgenerationbailout.StaticGenBailoutError(`Route "${e}" has a \`generateMetadata\` that depends on Request data (\`cookies()\`, etc...) or external data (\`fetch(...)\`, etc...) but the rest of the route was static or only used cached data (\`"use cache"\`). If you expected this route to be prerenderable update your \`generateMetadata\` to not use Request data and only use cached external data. Otherwise, add \`await connection()\` somewhere within this route to indicate explicitly it should not be prerendered.`),"__NEXT_ERROR_CODE",{value:"E534",enumerable:!1,configurable:!0})}if(t.hasDynamicViewport){if(a)throw console.error(a),Object.defineProperty(new _staticgenerationbailout.StaticGenBailoutError(`Route "${e}" has a \`generateViewport\` that could not finish rendering before ${o} was used. Follow the instructions in the error for this expression to resolve.`),"__NEXT_ERROR_CODE",{value:"E573",enumerable:!1,configurable:!0});throw Object.defineProperty(new _staticgenerationbailout.StaticGenBailoutError(`Route "${e}" has a \`generateViewport\` that depends on Request data (\`cookies()\`, etc...) or external data (\`fetch(...)\`, etc...) but the rest of the route was static or only used cached data (\`"use cache"\`). If you expected this route to be prerenderable update your \`generateViewport\` to not use Request data and only use cached external data. Otherwise, add \`await connection()\` somewhere within this route to indicate explicitly it should not be prerendered.`),"__NEXT_ERROR_CODE",{value:"E590",enumerable:!1,configurable:!0})}}}