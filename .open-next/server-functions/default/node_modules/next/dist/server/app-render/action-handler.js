"use strict";function _export(e,r){for(var t in r)Object.defineProperty(e,t,{enumerable:!0,get:r[t]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{handleAction:function(){return handleAction},parseHostHeader:function(){return parseHostHeader}});const _approuterheaders=require("../../client/components/app-router-headers"),_httpaccessfallback=require("../../client/components/http-access-fallback/http-access-fallback"),_redirect=require("../../client/components/redirect"),_redirecterror=require("../../client/components/redirect-error"),_renderresult=_interop_require_default(require("../render-result")),_flightrenderresult=require("./flight-render-result"),_utils=require("../lib/server-ipc/utils"),_requestcookies=require("../web/spec-extension/adapters/request-cookies"),_constants=require("../../lib/constants"),_serveractionrequestmeta=require("../lib/server-action-request-meta"),_csrfprotection=require("./csrf-protection"),_log=require("../../build/output/log"),_cookies=require("../web/spec-extension/cookies"),_headers=require("../web/spec-extension/adapters/headers"),_utils1=require("../web/utils"),_actionutils=require("./action-utils"),_helpers=require("../base-http/helpers"),_redirectstatuscode=require("../../client/components/redirect-status-code"),_requeststore=require("../async-storage/request-store"),_workunitasyncstorageexternal=require("../app-render/work-unit-async-storage.external");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function formDataFromSearchQueryString(e){const r=new URLSearchParams(e),t=new FormData;for(const[e,o]of r)t.append(e,o);return t}function nodeHeadersToRecord(e){const r={};for(const[t,o]of Object.entries(e))void 0!==o&&(r[t]=Array.isArray(o)?o.join(", "):`${o}`);return r}function getForwardedHeaders(e,r){const t=e.headers,o=new _cookies.RequestCookies(_headers.HeadersAdapter.from(t)),a=r.getHeaders(),n=new _cookies.ResponseCookies((0,_utils1.fromNodeOutgoingHttpHeaders)(a)),s=(0,_utils.filterReqHeaders)({...nodeHeadersToRecord(t),...nodeHeadersToRecord(a)},_utils.actionsForbiddenHeaders);return n.getAll().forEach((e=>{void 0===e.value?o.delete(e.name):o.set(e)})),s.cookie=o.toString(),delete s["transfer-encoding"],new Headers(s)}async function addRevalidationHeader(e,{workStore:r,requestStore:t}){var o,a;await Promise.all([null==(o=r.incrementalCache)?void 0:o.revalidateTag(r.revalidatedTags||[]),...Object.values(r.pendingRevalidates||{}),...r.pendingRevalidateWrites||[]]);const n=(null==(a=r.revalidatedTags)?void 0:a.length)?1:0,s=(0,_requestcookies.getModifiedCookieValues)(t.mutableCookies).length?1:0;e.setHeader("x-action-revalidated",JSON.stringify([[],n,s]))}async function createForwardedActionResponse(e,r,t,o,a,n){var s;if(!t)throw Object.defineProperty(new Error("Invariant: Missing `host` header from a forwarded Server Actions request."),"__NEXT_ERROR_CODE",{value:"E226",enumerable:!1,configurable:!0});const i=getForwardedHeaders(e,r);i.set("x-action-forwarded","1");const d=(null==(s=n.incrementalCache)?void 0:s.requestProtocol)||"https",c=process.env.__NEXT_PRIVATE_ORIGIN||`${d}://${t.value}`,l=new URL(`${c}${a}${o}`);try{var u;let t;if("edge"===process.env.NEXT_RUNTIME&&(0,_helpers.isWebNextRequest)(e)){if(!e.body)throw Object.defineProperty(new Error("Invariant: missing request body."),"__NEXT_ERROR_CODE",{value:"E333",enumerable:!1,configurable:!0});t=e.body}else{if("edge"===process.env.NEXT_RUNTIME||!(0,_helpers.isNodeNextRequest)(e))throw Object.defineProperty(new Error("Invariant: Unknown request type."),"__NEXT_ERROR_CODE",{value:"E114",enumerable:!1,configurable:!0});t=e.stream()}const o=await fetch(l,{method:"POST",body:t,duplex:"half",headers:i,redirect:"manual",next:{internal:1}});if(null==(u=o.headers.get("content-type"))?void 0:u.startsWith(_approuterheaders.RSC_CONTENT_TYPE_HEADER)){for(const[e,t]of o.headers)_utils.actionsForbiddenHeaders.includes(e)||r.setHeader(e,t);return new _flightrenderresult.FlightRenderResult(o.body)}var f;null==(f=o.body)||f.cancel()}catch(e){console.error("failed to forward action response",e)}return _renderresult.default.fromStatic("{}")}function getAppRelativeRedirectUrl(e,r,t){if(t.startsWith("/")||t.startsWith("."))return new URL(`${e}${t}`,"http://n");const o=new URL(t);return(null==r?void 0:r.value)!==o.host?null:o.pathname.startsWith(e)?o:null}async function createRedirectRenderResult(e,r,t,o,a,n,s){r.setHeader("x-action-redirect",`${o};${a}`);const i=getAppRelativeRedirectUrl(n,t,o);if(i){var d;if(!t)throw Object.defineProperty(new Error("Invariant: Missing `host` header from a forwarded Server Actions request."),"__NEXT_ERROR_CODE",{value:"E226",enumerable:!1,configurable:!0});const o=getForwardedHeaders(e,r);o.set(_approuterheaders.RSC_HEADER,"1");const a=(null==(d=s.incrementalCache)?void 0:d.requestProtocol)||"https",n=process.env.__NEXT_PRIVATE_ORIGIN||`${a}://${t.value}`,h=new URL(`${n}${i.pathname}${i.search}`);var c,l,u;if(s.revalidatedTags)o.set(_constants.NEXT_CACHE_REVALIDATED_TAGS_HEADER,s.revalidatedTags.join(",")),o.set(_constants.NEXT_CACHE_REVALIDATE_TAG_TOKEN_HEADER,(null==(u=s.incrementalCache)||null==(l=u.prerenderManifest)||null==(c=l.preview)?void 0:c.previewModeId)||"");o.delete(_approuterheaders.NEXT_ROUTER_STATE_TREE_HEADER),o.delete(_approuterheaders.ACTION_HEADER);try{var f;const e=await fetch(h,{method:"GET",headers:o,next:{internal:1}});if(null==(f=e.headers.get("content-type"))?void 0:f.startsWith(_approuterheaders.RSC_CONTENT_TYPE_HEADER)){for(const[t,o]of e.headers)_utils.actionsForbiddenHeaders.includes(t)||r.setHeader(t,o);return new _flightrenderresult.FlightRenderResult(e.body)}var p;null==(p=e.body)||p.cancel()}catch(e){console.error("failed to get redirect response",e)}}return _renderresult.default.fromStatic("{}")}function limitUntrustedHeaderValueForLogs(e){return e.length>100?e.slice(0,100)+"...":e}function parseHostHeader(e,r){var t,o;const a=e["x-forwarded-host"],n=a&&Array.isArray(a)?a[0]:null==a||null==(o=a.split(","))||null==(t=o[0])?void 0:t.trim(),s=e.host;return r?n===r?{type:"x-forwarded-host",value:n}:s===r?{type:"host",value:s}:void 0:n?{type:"x-forwarded-host",value:n}:s?{type:"host",value:s}:void 0}async function handleAction({req:e,res:r,ComponentMod:t,serverModuleMap:o,generateFlight:a,workStore:n,requestStore:s,serverActions:i,ctx:d}){const c=e.headers["content-type"],{serverActionsManifest:l,page:u}=d.renderOpts,{actionId:f,isURLEncodedAction:p,isMultipartAction:h,isFetchAction:_,isServerAction:R}=(0,_serveractionrequestmeta.getServerActionRequestMetadata)(e);if(!R)return;if(n.isStaticGeneration)throw Object.defineProperty(new Error("Invariant: server actions can't be handled during static rendering"),"__NEXT_ERROR_CODE",{value:"E359",enumerable:!1,configurable:!0});let v;const g=(...e)=>((0,_requeststore.synchronizeMutableCookies)(s),s.phase="render",a(...e));s.phase="action",n.fetchCache="default-no-store";const w="string"==typeof e.headers.origin?new URL(e.headers.origin).host:void 0,E=parseHostHeader(e.headers);let m;function y(){m&&(0,_log.warn)(m)}if(w){if(!(E&&w===E.value||(0,_csrfprotection.isCsrfOriginAllowed)(w,null==i?void 0:i.allowedOrigins))){E?console.error(`\`${E.type}\` header with value \`${limitUntrustedHeaderValueForLogs(E.value)}\` does not match \`origin\` header with value \`${limitUntrustedHeaderValueForLogs(w)}\` from a forwarded Server Actions request. Aborting the action.`):console.error("`x-forwarded-host` or `host` headers are not provided. One of these is needed to compare the `origin` header from a forwarded Server Actions request. Aborting the action.");const t=Object.defineProperty(new Error("Invalid Server Actions request."),"__NEXT_ERROR_CODE",{value:"E80",enumerable:!1,configurable:!0});if(_){var b;r.statusCode=500,await Promise.all([null==(b=n.incrementalCache)?void 0:b.revalidateTag(n.revalidatedTags||[]),...Object.values(n.pendingRevalidates||{}),...n.pendingRevalidateWrites||[]]);const o=Promise.reject(t);try{await o}catch{}return{type:"done",result:await g(e,d,s,{actionResult:o,skipFlight:!n.pathWasRevalidated,temporaryReferences:v})}}throw t}}else m="Missing `origin` header from a forwarded Server Actions request.";r.setHeader("Cache-Control","no-cache, no-store, max-age=0, must-revalidate");let T=[];const{actionAsyncStorage:q}=t;let A,O,S;const H=Boolean(e.headers["x-action-forwarded"]);if(f){const t=(0,_actionutils.selectWorkerForForwarding)(f,u,l);if(t)return{type:"done",result:await createForwardedActionResponse(e,r,E,t,d.renderOpts.basePath,n)}}try{return await q.run({isAction:!0},(async()=>{if("edge"===process.env.NEXT_RUNTIME&&(0,_helpers.isWebNextRequest)(e)){if(!e.body)throw Object.defineProperty(new Error("invariant: Missing request body."),"__NEXT_ERROR_CODE",{value:"E364",enumerable:!1,configurable:!0});const{createTemporaryReferenceSet:r,decodeReply:a,decodeAction:n,decodeFormState:i}=t;if(v=r(),h){const r=await e.request.formData();if(!_){const e=await n(r,o);if("function"==typeof e){y();const t=await _workunitasyncstorageexternal.workUnitAsyncStorage.run(s,e);O=await i(t,r,o),s.phase="render"}return}T=await a(r,o,{temporaryReferences:v})}else{try{S=getActionModIdOrError(f,o)}catch(e){return null!==f&&console.error(e),{type:"not-found"}}const r=[],t=e.body.getReader();for(;;){const{done:e,value:o}=await t.read();if(e)break;r.push(o)}const n=Buffer.concat(r).toString("utf-8");if(p){const e=formDataFromSearchQueryString(n);T=await a(e,o,{temporaryReferences:v})}else T=await a(n,o,{temporaryReferences:v})}}else{if("edge"===process.env.NEXT_RUNTIME||!(0,_helpers.isNodeNextRequest)(e))throw Object.defineProperty(new Error("Invariant: Unknown request type."),"__NEXT_ERROR_CODE",{value:"E114",enumerable:!1,configurable:!0});{const{createTemporaryReferenceSet:r,decodeReply:t,decodeReplyFromBusboy:a,decodeAction:n,decodeFormState:d}=require("./react-server.node");v=r();const{Transform:l}=require("node:stream"),u="1 MB",R=(null==i?void 0:i.bodySizeLimit)??u,g=R!==u?require("next/dist/compiled/bytes").parse(R):1048576;let w=0;const E=e.body.pipe(new l({transform(e,r,t){if(w+=Buffer.byteLength(e,r),w>g){const{ApiError:e}=require("../api-utils");t(Object.defineProperty(new e(413,`Body exceeded ${R} limit.\n                To configure the body size limit for Server Actions, see: https://nextjs.org/docs/app/api-reference/next-config-js/serverActions#bodysizelimit`),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0}))}else t(null,e)}}));if(h){if(!_){const e=new Request("http://localhost",{method:"POST",headers:{"Content-Type":c},body:new ReadableStream({start:e=>{E.on("data",(r=>{e.enqueue(new Uint8Array(r))})),E.on("end",(()=>{e.close()})),E.on("error",(r=>{e.error(r)}))}}),duplex:"half"}),r=await e.formData(),t=await n(r,o);if("function"==typeof t){y();const e=await _workunitasyncstorageexternal.workUnitAsyncStorage.run(s,t);O=await d(e,r,o),s.phase="render"}return}{const r=require("busboy")({defParamCharset:"utf8",headers:e.headers,limits:{fieldSize:g}});E.pipe(r),T=await a(r,o,{temporaryReferences:v})}}else{try{S=getActionModIdOrError(f,o)}catch(e){return null!==f&&console.error(e),{type:"not-found"}}const r=[];for await(const t of e.body)r.push(Buffer.from(t));const a=Buffer.concat(r).toString("utf-8");if(p){const e=formDataFromSearchQueryString(a);T=await t(e,o,{temporaryReferences:v})}else T=await t(a,o,{temporaryReferences:v})}}}try{S=S??getActionModIdOrError(f,o)}catch(e){return null!==f&&console.error(e),{type:"not-found"}}const a=(await t.__next_app__.require(S))[f],l=await _workunitasyncstorageexternal.workUnitAsyncStorage.run(s,(()=>a.apply(null,T)));_&&(await addRevalidationHeader(r,{workStore:n,requestStore:s}),A=await g(e,d,s,{actionResult:Promise.resolve(l),skipFlight:!n.pathWasRevalidated||H,temporaryReferences:v}))})),{type:"done",result:A,formState:O}}catch(t){if((0,_redirecterror.isRedirectError)(t)){const o=(0,_redirect.getURLFromRedirectError)(t),a=(0,_redirect.getRedirectTypeFromError)(t);if(await addRevalidationHeader(r,{workStore:n,requestStore:s}),r.statusCode=_redirectstatuscode.RedirectStatusCode.SeeOther,_)return{type:"done",result:await createRedirectRenderResult(e,r,E,o,a,d.renderOpts.basePath,n)};const i=new Headers;return(0,_requestcookies.appendMutableCookies)(i,s.mutableCookies)&&r.setHeader("set-cookie",Array.from(i.values())),r.setHeader("Location",o),{type:"done",result:_renderresult.default.fromStatic("")}}if((0,_httpaccessfallback.isHTTPAccessFallbackError)(t)){if(r.statusCode=(0,_httpaccessfallback.getAccessFallbackHTTPStatus)(t),await addRevalidationHeader(r,{workStore:n,requestStore:s}),_){const r=Promise.reject(t);try{await r}catch{}return{type:"done",result:await g(e,d,s,{skipFlight:!1,actionResult:r,temporaryReferences:v})}}return{type:"not-found"}}if(_){var C;r.statusCode=500,await Promise.all([null==(C=n.incrementalCache)?void 0:C.revalidateTag(n.revalidatedTags||[]),...Object.values(n.pendingRevalidates||{}),...n.pendingRevalidateWrites||[]]);const o=Promise.reject(t);try{await o}catch{}return s.phase="render",{type:"done",result:await a(e,d,s,{actionResult:o,skipFlight:!n.pathWasRevalidated||H,temporaryReferences:v})}}throw t}}function getActionModIdOrError(e,r){try{var t;if(!e)throw Object.defineProperty(new Error("Invariant: Missing 'next-action' header."),"__NEXT_ERROR_CODE",{value:"E416",enumerable:!1,configurable:!0});const o=null==r||null==(t=r[e])?void 0:t.id;if(!o)throw Object.defineProperty(new Error("Invariant: Couldn't find action module ID from module map."),"__NEXT_ERROR_CODE",{value:"E32",enumerable:!1,configurable:!0});return o}catch(r){throw Object.defineProperty(new Error(`Failed to find Server Action "${e}". This request might be from an older or newer deployment. ${r instanceof Error?`Original error: ${r.message}`:""}\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action`),"__NEXT_ERROR_CODE",{value:"E264",enumerable:!1,configurable:!0})}}