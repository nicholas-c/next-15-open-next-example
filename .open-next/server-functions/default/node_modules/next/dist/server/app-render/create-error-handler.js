"use strict";function _export(r,e){for(var t in e)Object.defineProperty(r,t,{enumerable:!0,get:e[t]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{createFlightReactServerErrorHandler:function(){return createFlightReactServerErrorHandler},createHTMLErrorHandler:function(){return createHTMLErrorHandler},createHTMLReactServerErrorHandler:function(){return createHTMLReactServerErrorHandler},getDigestForWellKnownError:function(){return getDigestForWellKnownError},isUserLandError:function(){return isUserLandError}});const _stringhash=_interop_require_default(require("next/dist/compiled/string-hash")),_formatservererror=require("../../lib/format-server-error"),_tracer=require("../lib/trace/tracer"),_pipereadable=require("../pipe-readable"),_bailouttocsr=require("../../shared/lib/lazy-dynamic/bailout-to-csr"),_hooksservercontext=require("../../client/components/hooks-server-context"),_isnextroutererror=require("../../client/components/is-next-router-error"),_iserror=require("../../lib/is-error"),_errortelemetryutils=require("../../lib/error-telemetry-utils");function _interop_require_default(r){return r&&r.__esModule?r:{default:r}}function getDigestForWellKnownError(r){return(0,_bailouttocsr.isBailoutToCSRError)(r)||(0,_isnextroutererror.isNextRouterError)(r)||(0,_hooksservercontext.isDynamicServerError)(r)?r.digest:void 0}function createFlightReactServerErrorHandler(r,e){return t=>{if("string"==typeof t)return(0,_stringhash.default)(t).toString();if((0,_pipereadable.isAbortError)(t))return;const o=getDigestForWellKnownError(t);if(o)return o;const i=(0,_iserror.getProperError)(t);i.digest||(i.digest=(0,_stringhash.default)(i.message+i.stack||"").toString()),r&&(0,_formatservererror.formatServerError)(i);const s=(0,_tracer.getTracer)().getActiveScopeSpan();return s&&(s.recordException(i),s.setStatus({code:_tracer.SpanStatusCode.ERROR,message:i.message})),e(i),(0,_errortelemetryutils.createDigestWithErrorCode)(t,i.digest)}}function createHTMLReactServerErrorHandler(r,e,t,o,i){return s=>{var n;if("string"==typeof s)return(0,_stringhash.default)(s).toString();if((0,_pipereadable.isAbortError)(s))return;const a=getDigestForWellKnownError(s);if(a)return a;const c=(0,_iserror.getProperError)(s);if(c.digest||(c.digest=(0,_stringhash.default)(c.message+(c.stack||"")).toString()),t.has(c.digest)||t.set(c.digest,c),r&&(0,_formatservererror.formatServerError)(c),!e||!(null==c||null==(n=c.message)?void 0:n.includes("The specific message is omitted in production builds to avoid leaking sensitive details."))){const r=(0,_tracer.getTracer)().getActiveScopeSpan();r&&(r.recordException(c),r.setStatus({code:_tracer.SpanStatusCode.ERROR,message:c.message})),o||null==i||i(c)}return(0,_errortelemetryutils.createDigestWithErrorCode)(s,c.digest)}}function createHTMLErrorHandler(r,e,t,o,i,s){return(n,a)=>{var c;let u=!0;if(o.push(n),(0,_pipereadable.isAbortError)(n))return;const l=getDigestForWellKnownError(n);if(l)return l;const d=(0,_iserror.getProperError)(n);if(d.digest?t.has(d.digest)&&(n=t.get(d.digest),u=!1):d.digest=(0,_stringhash.default)(d.message+((null==a?void 0:a.componentStack)||d.stack||"")).toString(),r&&(0,_formatservererror.formatServerError)(d),!e||!(null==d||null==(c=d.message)?void 0:c.includes("The specific message is omitted in production builds to avoid leaking sensitive details."))){const r=(0,_tracer.getTracer)().getActiveScopeSpan();r&&(r.recordException(d),r.setStatus({code:_tracer.SpanStatusCode.ERROR,message:d.message})),!i&&u&&s(d,a)}return(0,_errortelemetryutils.createDigestWithErrorCode)(n,d.digest)}}function isUserLandError(r){return!(0,_pipereadable.isAbortError)(r)&&!(0,_bailouttocsr.isBailoutToCSRError)(r)&&!(0,_isnextroutererror.isNextRouterError)(r)}