"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"walkTreeWithFlightRouterState",{enumerable:!0,get:function(){return walkTreeWithFlightRouterState}});const _matchsegments=require("../../client/components/match-segments"),_getcssinlinedlinktags=require("./get-css-inlined-link-tags"),_getpreloadablefonts=require("./get-preloadable-fonts"),_createflightrouterstatefromloadertree=require("./create-flight-router-state-from-loader-tree"),_hasloadingcomponentintree=require("./has-loading-component-in-tree"),_segment=require("../../shared/lib/segment"),_createcomponenttree=require("./create-component-tree");async function walkTreeWithFlightRouterState({loaderTreeToFilter:e,parentParams:t,flightRouterState:a,parentIsInsideSharedLayout:r,rscHead:n,injectedCSS:o,injectedJS:i,injectedFontPreloadTags:l,rootLayoutIncluded:s,getViewportReady:d,getMetadataReady:c,ctx:g,preloadCallbacks:u,StreamingMetadata:m,StreamingMetadataOutlet:h}){const{renderOpts:{nextFontManifest:S,experimental:p},query:f,isPrefetch:_,getDynamicParamFromSegment:R,parsedRequestHeaders:T}=g,[y,F,P]=e,b=Object.keys(F),{layout:M}=P,j=s||void 0!==M&&!s,k=R(y),w=k&&null!==k.value?{...t,[k.param]:k.value}:t,I=(0,_segment.addSearchParamsIfPageSegment)(k?k.treeSegment:y,f),q=!a||!(0,_matchsegments.matchSegment)(I,a[0])||0===b.length||"refetch"===a[3],L=q||r||"inside-shared-layout"===a[3];if(L&&!p.isRoutePPREnabled&&(T.isRouteTreePrefetchRequest||_&&!Boolean(P.loading)&&!(0,_hasloadingcomponentintree.hasLoadingComponentInTree)(e))){return[[a&&(0,_matchsegments.canSegmentBeOverridden)(I,a[0])?a[0]:I,(0,_createflightrouterstatefromloadertree.createFlightRouterStateFromLoaderTree)(e,R,f),null,[null,null],!1]]}if(q){return[[a&&(0,_matchsegments.canSegmentBeOverridden)(I,a[0])?a[0]:I,(0,_createflightrouterstatefromloadertree.createFlightRouterStateFromLoaderTree)(e,R,f),await(0,_createcomponenttree.createComponentTree)({ctx:g,loaderTree:e,parentParams:w,injectedCSS:o,injectedJS:i,injectedFontPreloadTags:l,rootLayoutIncluded:s,getViewportReady:d,getMetadataReady:c,preloadCallbacks:u,authInterrupts:p.authInterrupts,StreamingMetadata:m,StreamingMetadataOutlet:h}),n,!1]]}const O=null==M?void 0:M[1],C=new Set(o),v=new Set(i),x=new Set(l);O&&((0,_getcssinlinedlinktags.getLinkAndScriptTags)(g.clientReferenceManifest,O,C,v,!0),(0,_getpreloadablefonts.getPreloadableFonts)(S,O,x));const E=[];for(const e of b){const t=F[e],r=await walkTreeWithFlightRouterState({ctx:g,loaderTreeToFilter:t,parentParams:w,flightRouterState:a&&a[1][e],parentIsInsideSharedLayout:L,rscHead:n,injectedCSS:C,injectedJS:v,injectedFontPreloadTags:x,rootLayoutIncluded:j,getViewportReady:d,getMetadataReady:c,preloadCallbacks:u,StreamingMetadata:m,StreamingMetadataOutlet:h});for(const t of r)t[0]===_segment.DEFAULT_SEGMENT_KEY&&a&&a[1][e][0]&&"refetch"!==a[1][e][3]||E.push([I,e,...t])}return E}