"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return ResponseCache}});const _types=_export_star(require("./types"),exports),_batcher=require("../../lib/batcher"),_scheduler=require("../../lib/scheduler"),_utils=require("./utils");function _export_star(e,t){return Object.keys(e).forEach((function(i){"default"===i||Object.prototype.hasOwnProperty.call(t,i)||Object.defineProperty(t,i,{enumerable:!0,get:function(){return e[i]}})})),e}class ResponseCache{constructor(e){this.batcher=_batcher.Batcher.create({cacheKeyFn:({key:e,isOnDemandRevalidate:t})=>`${e}-${t?"1":"0"}`,schedulerFn:_scheduler.scheduleOnNextTick});this["minimalMode"]=e}async get(e,t,i){if(!e)return t({hasResolved:!1,previousCacheEntry:null});const{incrementalCache:a,isOnDemandRevalidate:r=!1,isFallback:n=!1,isRoutePPREnabled:s=!1}=i,l=await this.batcher.batch({key:e,isOnDemandRevalidate:r},(async(l,o)=>{var c;if(this.minimalMode&&(null==(c=this.previousCacheItem)?void 0:c.key)===l&&this.previousCacheItem.expiresAt>Date.now())return this.previousCacheItem.entry;const u=(0,_utils.routeKindToIncrementalCacheKind)(i.routeKind);let h=!1,d=null;try{if(d=this.minimalMode?null:await a.get(e,{kind:u,isRoutePPREnabled:i.isRoutePPREnabled,isFallback:n}),d&&!r){var v;if((null==(v=d.value)?void 0:v.kind)===_types.CachedRouteKind.FETCH)throw Object.defineProperty(new Error("invariant: unexpected cachedResponse of kind fetch in response cache"),"__NEXT_ERROR_CODE",{value:"E30",enumerable:!1,configurable:!0});if(o({...d,revalidate:d.curRevalidate}),h=!0,!d.isStale||i.isPrefetch)return null}const c=await t({hasResolved:h,previousCacheEntry:d,isRevalidating:!0});if(!c)return this.minimalMode&&(this.previousCacheItem=void 0),null;const p=await(0,_utils.fromResponseCacheEntry)({...c,isMiss:!d});return p?(r||h||(o(p),h=!0),void 0!==p.revalidate&&(this.minimalMode?this.previousCacheItem={key:l,entry:p,expiresAt:Date.now()+1e3}:await a.set(e,p.value,{revalidate:p.revalidate,isRoutePPREnabled:s,isFallback:n})),p):(this.minimalMode&&(this.previousCacheItem=void 0),null)}catch(t){if(d&&await a.set(e,d.value,{revalidate:Math.min(Math.max(d.revalidate||3,3),30),isRoutePPREnabled:s,isFallback:n}),h)return console.error(t),null;throw t}}));return(0,_utils.toResponseCacheEntry)(l)}}