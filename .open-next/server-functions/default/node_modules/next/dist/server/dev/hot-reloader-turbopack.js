"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"createHotReloaderTurbopack",{enumerable:!0,get:function(){return createHotReloaderTurbopack}});const _promises=require("fs/promises"),_path=require("path"),_url=require("url"),_ws=_interop_require_default(require("next/dist/compiled/ws")),_store=require("../../build/output/store"),_hotreloadertypes=require("./hot-reloader-types"),_swc=require("../../build/swc"),_log=_interop_require_wildcard(require("../../build/output/log")),_hotreloaderwebpack=require("./hot-reloader-webpack"),_constants=require("../../shared/lib/constants"),_middlewareturbopack=require("../../client/components/react-dev-overlay/server/middleware-turbopack"),_utils=require("../../shared/lib/utils"),_utils1=require("../utils"),_requirecache=require("./require-cache"),_renderserver=require("../lib/render-server"),_denormalizepagepath=require("../../shared/lib/page-path/denormalize-page-path"),_trace=require("../../trace"),_turbopackutils=require("./turbopack-utils"),_setupdevbundler=require("../lib/router-utils/setup-dev-bundler"),_manifestloader=require("../../shared/lib/turbopack/manifest-loader"),_ondemandentryhandler=require("./on-demand-entry-handler"),_entrykey=require("../../shared/lib/turbopack/entry-key"),_messages=require("./messages"),_encryptionutilsserver=require("../app-render/encryption-utils-server"),_apppageroutedefinition=require("../route-definitions/app-page-route-definition"),_apppaths=require("../../shared/lib/router/utils/app-paths"),_utils2=require("../lib/utils"),_ismetadataroute=require("../../lib/metadata/is-metadata-route"),_patcherrorinspect=require("../patch-error-inspect"),_getnexterrorfeedbackmiddleware=require("../../client/components/react-dev-overlay/server/get-next-error-feedback-middleware"),_utils3=require("../../shared/lib/turbopack/utils"),_getdevoverlayfontmiddleware=require("../../client/components/react-dev-overlay/font/get-dev-overlay-font-middleware"),_devindicatorserverstate=require("./dev-indicator-server-state"),_devindicatormiddleware=require("./dev-indicator-middleware");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(_getRequireWildcardCache=function(e){return e?t:r})(e)}function _interop_require_wildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in e)if("default"!==a&&Object.prototype.hasOwnProperty.call(e,a)){var o=s?Object.getOwnPropertyDescriptor(e,a):null;o&&(o.get||o.set)?Object.defineProperty(n,a,o):n[a]=e[a]}return n.default=e,t&&t.set(e,n),n}const wsServer=new _ws.default.Server({noServer:!0}),isTestMode=!!(process.env.NEXT_TEST_MODE||process.env.__NEXT_TEST_MODE||process.env.DEBUG),sessionId=Math.floor(Number.MAX_SAFE_INTEGER*Math.random());function rewriteTurbopackSources(e,r){if("sections"in r)for(const t of r.sections)rewriteTurbopackSources(e,t.map);else for(let t=0;t<r.sources.length;t++)r.sources[t]=(0,_url.pathToFileURL)((0,_path.join)(e,r.sources[t].replace(/turbopack:\/\/\/\[project\]/,""))).toString()}function getSourceMapFromTurbopack(e,r,t){let n=null;try{n=e.getSourceMapSync(t)}catch(e){}if(null!==n){const e=JSON.parse(n);return rewriteTurbopackSources(r,e),e}}async function createHotReloaderTurbopack(e,r,t,n){var s,a,o;const i=!0,c="development",{nextConfig:l,dir:u}=e,{loadBindings:d}=require("../../build/swc");let p=await d();process.env.TURBOPACK&&isTestMode&&require("console").log("Creating turbopack project",{dir:u,testMode:isTestMode});const f=e.fsChecker.rewrites.afterFiles.length>0||e.fsChecker.rewrites.beforeFiles.length>0||e.fsChecker.rewrites.fallback.length>0,_=(0,_trace.trace)("hot-reloader",void 0,{version:"15.2.0"});_.stop();const h=await(0,_encryptionutilsserver.generateEncryptionKeyBase64)({isBuild:!1,distDir:t});let g;l.experimental.clientRouterFilter;const v=["last 1 Chrome versions, last 1 Firefox versions, last 1 Safari versions, last 1 Edge versions"],b=await p.turbo.createProject({projectPath:u,rootPath:(null==(s=e.nextConfig.experimental.turbo)?void 0:s.root)||e.nextConfig.outputFileTracingRoot||u,distDir:t,nextConfig:e.nextConfig,jsConfig:await(0,_utils3.getTurbopackJsConfig)(u,l),watch:{enable:i,pollIntervalMs:null==(a=l.watchOptions)?void 0:a.pollIntervalMs},dev:i,env:process.env,defineEnv:(0,_swc.createDefineEnv)({isTurbopack:!0,clientRouterFilters:g,config:l,dev:i,distDir:t,fetchCacheKeyPrefix:e.nextConfig.experimental.fetchCacheKeyPrefix,hasRewrites:f,middlewareMatchers:void 0}),buildId:c,encryptionKey:h,previewProps:e.fsChecker.prerenderManifest.preview,browserslistQuery:v.join(", "),noMangling:!1},{persistentCaching:(0,_utils3.isPersistentCachingEnabled)(e.nextConfig),memoryLimit:null==(o=e.nextConfig.experimental.turbo)?void 0:o.memoryLimit});(0,_patcherrorinspect.setBundlerFindSourceMapImplementation)(getSourceMapFromTurbopack.bind(null,b,u)),null==e.onDevServerCleanup||e.onDevServerCleanup.call(e,(async()=>{(0,_patcherrorinspect.setBundlerFindSourceMapImplementation)((()=>{})),await b.onExit()}));const w=b.entrypointsSubscribe(),y=new Map,m={global:{app:void 0,document:void 0,error:void 0,middleware:void 0,instrumentation:void 0},page:new Map,app:new Map},E=new Map,k=new Map,S=new _manifestloader.TurbopackManifestLoader({buildId:c,distDir:t,encryptionKey:h}),R=new Map,T=new Map,C=new Set;let O,M=new Promise((e=>O=e));const P=new _turbopackutils.AssetMapper;function I(e,r,{force:s}={}){if(s)for(const{path:e,contentHash:t}of r.serverPaths)T.set(e,t);else{let t=!1;for(const{path:n,contentHash:s}of r.serverPaths){if(n.endsWith(".map"))continue;const r=`${e}:${n}`,a=T.get(r),o=T.get(n);a&&a!==s||o&&o!==s?(t=!0,T.set(e,s),T.set(n,s)):(a||T.set(e,s),o||T.set(n,s))}if(!t)return}n();r.serverPaths.some((({path:e})=>e.startsWith("server/app")))&&(0,_requirecache.deleteAppClientCache)();const a=r.serverPaths.map((({path:e})=>(0,_path.join)(t,e)));for(const e of a)(0,_renderserver.clearModuleContext)(e),(0,_requirecache.deleteCache)(e)}const N=new Set,q=(e,r,t)=>!t&&C.has(e)?()=>{}:(0===N.size&&_store.store.setState({loading:!0,trigger:e,url:r},!0),N.add(e),function(){0!==N.size&&(C.add(e),N.delete(e),0===N.size&&(F=!1,_store.store.setState({loading:!1},!0)))});let F=!1,x=0;const j=new Set,D=new WeakMap;function A(e,r){e.send(JSON.stringify(r))}function H(){for(const[,e]of k)if([...e.values()].filter((e=>"warning"!==e.severity)).length>0)return;for(const e of j){const r=D.get(e);if(r){for(const[,e]of r.clientIssues)if([...e.values()].filter((e=>"warning"!==e.severity)).length>0)return;for(const t of r.hmrPayloads.values())A(e,t);r.hmrPayloads.clear(),r.turbopackUpdates.length>0&&(A(e,{action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_MESSAGE,data:r.turbopackUpdates}),r.turbopackUpdates.length=0)}}}const W=(0,_utils1.debounce)(H,2),B=(e,r)=>{for(const n of j){var t;null==(t=D.get(n))||t.hmrPayloads.set(e,r)}F=!0,W()};function U(e){e.diagnostics=[],e.issues=[];for(const t of j){var r;null==(r=D.get(t))||r.turbopackUpdates.push(e)}F=!0,W()}async function K(e,r,t,n,s){if(R.has(e))return;const{side:a}=(0,_entrykey.splitEntryKey)(e),o=t[`${a}Changed`](r);R.set(e,o);try{const r=await o;for await(const t of r){(0,_utils3.processIssues)(k,e,t,!1,!0);const r=await n(t,String(++x));r&&B(e,r)}}catch(r){R.delete(e);const t=await(null==s?void 0:s(r));return void(t&&B(e,t))}R.delete(e)}async function $(e){const r=await R.get(e);r&&(await(null==r.return?void 0:r.return.call(r)),R.delete(e)),k.delete(e)}async function L(e,r){const t=(0,_entrykey.getEntryKey)("assets","client",r);if(!(0,_turbopackutils.hasEntrypointForKey)(m,t,P))return;const n=D.get(e);if(!n||n.subscriptions.has(r))return;const s=b.hmrEvents(r);n.subscriptions.set(r,s);try{await s.next();for await(const e of s)(0,_utils3.processIssues)(n.clientIssues,t,e,!1,!0),"issues"!==e.type&&U(e)}catch(t){return A(e,{action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.RELOAD_PAGE,data:`error in HMR event subscription for ${r}: ${t}`}),void e.close()}}function z(e,r){const t=D.get(e);if(!t)return;const n=t.subscriptions.get(r);null==n||n.return();const s=(0,_entrykey.getEntryKey)("assets","client",r);t.clientIssues.delete(s)}async function X(){for await(const t of w)O||(M=new Promise((e=>O=e))),(0,_turbopackutils.processTopLevelIssues)(E,t),await(0,_turbopackutils.handleEntrypoints)({entrypoints:t,currentEntrypoints:m,currentEntryIssues:k,manifestLoader:S,devRewrites:e.fsChecker.rewrites,productionRewrites:void 0,logErrors:!0,dev:{assetMapper:P,changeSubscriptions:R,clients:j,clientStates:D,serverFields:r,hooks:{handleWrittenEndpoint:(e,r)=>{y.set(e,r),I(e,r)},propagateServerField:_setupdevbundler.propagateServerField.bind(null,e),sendHmr:B,startBuilding:q,subscribeToChanges:K,unsubscribeFromChanges:$,unsubscribeFromHmrEvents:z}}}),O(),O=void 0}await(0,_promises.mkdir)((0,_path.join)(t,"server"),{recursive:!0}),await(0,_promises.mkdir)((0,_path.join)(t,"static",c),{recursive:!0}),await(0,_promises.writeFile)((0,_path.join)(t,"package.json"),JSON.stringify({type:"commonjs"},null,2));const G=[(0,_middlewareturbopack.getOverlayMiddleware)(b),(0,_middlewareturbopack.getSourceMapMiddleware)(b),(0,_getnexterrorfeedbackmiddleware.getNextErrorFeedbackMiddleware)(e.telemetry),(0,_getdevoverlayfontmiddleware.getDevOverlayFontMiddleware)(),(0,_devindicatormiddleware.getDisableDevIndicatorMiddleware)()],J=(0,_hotreloaderwebpack.getVersionInfo)();let V;if((0,_utils2.getNodeDebugType)()){const e=process.debugPort;let r;try{r=(await fetch(`http://127.0.0.1:${e}/json/list`).then((e=>e.json())))[0]}catch{}r&&(V=r.devtoolsFrontendUrl)}const Q={turbopackProject:b,activeWebpackConfigs:void 0,serverStats:null,edgeServerStats:null,async run(e,r,t){var n;if(null==(n=e.url)?void 0:n.startsWith("/_next/static/chunks/pages/")){const r=(0,_hotreloaderwebpack.matchNextPageBundleRequest)(e.url);if(r){const t=`/${r.path.map((e=>decodeURIComponent(e))).join("/")}`,n=(0,_denormalizepagepath.denormalizePagePath)(t);await Q.ensurePage({page:n,clientOnly:!1,definition:void 0,url:e.url}).catch(console.error)}}for(const t of G){let n=!1;if(await t(e,r,(()=>{n=!0})),!n)return{finished:!0}}return{finished:void 0}},onHMR(e,r,t,n){wsServer.handleUpgrade(e,r,t,(e=>{n(e);const r=new Map,t=new Map;j.add(e),D.set(e,{clientIssues:r,hmrPayloads:new Map,turbopackUpdates:[],subscriptions:t}),e.on("close",(()=>{for(const e of t.values())null==e.return||e.return.call(e);D.delete(e),j.delete(e)})),e.addEventListener("message",(({data:r})=>{const t=JSON.parse("string"!=typeof r?r.toString():r);switch(t.event){case"span-end":_.manualTraceChild(t.spanName,(0,_turbopackutils.msToNs)(t.startTime),(0,_turbopackutils.msToNs)(t.endTime),t.attributes);break;case"client-hmr-latency":_.manualTraceChild(t.event,(0,_turbopackutils.msToNs)(t.startTime),(0,_turbopackutils.msToNs)(t.endTime),{updatedModules:t.updatedModules,page:t.page,isPageHidden:t.isPageHidden});break;case"client-error":case"client-warning":case"client-success":case"server-component-reload-page":case"client-reload-page":case"client-removed-page":case"client-full-reload":const{hadRuntimeError:e,dependencyChain:n}=t;if(e&&_log.warn(_messages.FAST_REFRESH_RUNTIME_RELOAD),Array.isArray(n)&&"string"==typeof n[0]){const e=n[0].replace(/^\[project\]/,".").replace(/ \[.*\] \(.*\)$/,"");_log.warn(`Fast Refresh had to perform a full reload when ${e} changed. Read more: https://nextjs.org/docs/messages/fast-refresh-reload`)}break;case"client-added-page":break;default:if(!t.type)throw Object.defineProperty(new Error(`unrecognized HMR message "${r}"`),"__NEXT_ERROR_CODE",{value:"E155",enumerable:!1,configurable:!0})}switch(t.type){case"turbopack-subscribe":L(e,t.path);break;case"turbopack-unsubscribe":z(e,t.path);break;default:if(!t.event)throw Object.defineProperty(new Error(`unrecognized Turbopack HMR message "${r}"`),"__NEXT_ERROR_CODE",{value:"E492",enumerable:!1,configurable:!0})}}));const s={action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_CONNECTED,data:{sessionId:sessionId}};A(e,s);const a=[];for(const e of k.values())for(const r of e.values())"warning"!==r.severity?a.push({message:(0,_utils3.formatIssue)(r)}):(0,_turbopackutils.printNonFatalIssue)(r);_devindicatorserverstate.devIndicatorServerState.disabledUntil<Date.now()&&(_devindicatorserverstate.devIndicatorServerState.disabledUntil=0),async function(){const r=await J,t={action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.SYNC,errors:a,warnings:[],hash:"",versionInfo:r,debug:{devtoolsFrontendUrl:V},devIndicator:_devindicatorserverstate.devIndicatorServerState};A(e,t)}()}))},send(e){const r=JSON.stringify(e);for(const e of j)e.send(r)},setHmrServerError(e){},clearHmrServerError(){},async start(){},async getCompilationErrors(e){const r=(0,_entrykey.getEntryKey)("app","server",e),t=(0,_entrykey.getEntryKey)("pages","server",e),n=E.values(),s=k.get(r)??k.get(t);if(void 0!==s&&s.size>0)return[...n,...s.values()].map((e=>{const r=(0,_utils3.formatIssue)(e);return"warning"===e.severity?((0,_turbopackutils.printNonFatalIssue)(e),null):((0,_utils3.isWellKnownError)(e)&&_log.error(r),Object.defineProperty(new Error(r),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0}))})).filter((e=>null!==e));const a=[];for(const e of n)"warning"!==e.severity&&a.push(Object.defineProperty(new Error((0,_utils3.formatIssue)(e)),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0}));for(const e of k.values())for(const r of e.values())if("warning"!==r.severity){const e=(0,_utils3.formatIssue)(r);a.push(Object.defineProperty(new Error(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0}))}else(0,_turbopackutils.printNonFatalIssue)(r);return a},async invalidate({reloadAfterInvalidation:e}){if(e){for(const[e,r]of y)I(e,r,{force:!0});await(0,_renderserver.clearAllModuleContexts)(),this.send({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.SERVER_COMPONENT_CHANGES,hash:String(++x)})}},async buildFallbackError(){},ensurePage:async({page:r,appPaths:t,definition:n,isApp:s,url:a})=>_.traceChild("ensure-page",{inputPage:r}).traceAsyncFn((async()=>{if(_constants.BLOCKED_PAGES.includes(r)&&"/_error"!==r)return;await M;let o=n??await(0,_ondemandentryhandler.findPagePathData)(u,r,l.pageExtensions,e.pagesDir,e.appDir);!t&&n&&(0,_apppageroutedefinition.isAppPageRouteDefinition)(n)&&(t=n.appPaths);let c=o.page;if(t){const e=(0,_apppaths.normalizeAppPath)(c),r=t.filter((r=>(0,_apppaths.normalizeAppPath)(r)===e));c=r[r.length-1]}const d=(null==n?void 0:n.pathname)??r;if("/_error"===c){let r=q(d,a,!1);try{await(0,_turbopackutils.handlePagesErrorRoute)({currentEntryIssues:k,entrypoints:m,manifestLoader:S,devRewrites:e.fsChecker.rewrites,productionRewrites:void 0,logErrors:!0,hooks:{subscribeToChanges:K,handleWrittenEndpoint:(e,r)=>{I(e,r),y.set(e,r),P.setPathsForKey(e,r.clientPaths)}}})}finally{r()}return}const p=o.bundlePath.startsWith("app/"),f=(0,_ismetadataroute.isMetadataRouteFile)(o.filename.replace(e.appDir||"",""),l.pageExtensions,!0)?(0,_turbopackutils.normalizedPageToTurbopackStructureRoute)(c,(0,_path.extname)(o.filename)):c,_=p?m.app.get(f):m.page.get(c);if(!_){if("/middleware"===c)return;if("/src/middleware"===c)return;if("/instrumentation"===c)return;if("/src/instrumentation"===c)return;throw new _utils.PageNotFoundError(`route not found ${c}`)}if(s&&"page"===_.type)throw Object.defineProperty(new Error(`mis-matched route type: isApp && page for ${c}`),"__NEXT_ERROR_CODE",{value:"E373",enumerable:!1,configurable:!0});const h=q(d,a,!1);try{await(0,_turbopackutils.handleRouteType)({dev:i,page:c,pathname:d,route:_,currentEntryIssues:k,entrypoints:m,manifestLoader:S,readyIds:C,devRewrites:e.fsChecker.rewrites,productionRewrites:void 0,logErrors:!0,hooks:{subscribeToChanges:K,handleWrittenEndpoint:(e,r)=>{y.set(e,r),I(e,r),P.setPathsForKey(e,r.clientPaths)}}})}finally{h()}})),close(){for(const e of j)e.terminate();j.clear()}};async function Y(){for await(const e of b.updateInfoSubscribe(30))switch(e.updateType){case"start":Q.send({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.BUILDING});break;case"end":{function r(e,r){for(const t of r.values())for(const[r,n]of t){if("warning"===n.severity)continue;if(e.has(r))continue;const t=(0,_utils3.formatIssue)(n);e.set(r,{message:t,details:n.detail?(0,_utils3.renderStyledStringToErrorAnsi)(n.detail):void 0})}}H();const t=new Map;r(t,k);for(const n of j){const s=D.get(n);if(!s)continue;const a=new Map(t);r(a,s.clientIssues),A(n,{action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.BUILT,hash:String(++x),errors:[...a.values()],warnings:[]})}if(F){const o=e.value.duration,i=o>2e3?Math.round(o/100)/10+"s":`${o}ms`;_log.event(`Compiled in ${i}`),F=!1}break}}}return X().catch((e=>{console.error(e),process.exit(1)})),await M,await S.writeManifests({devRewrites:e.fsChecker.rewrites,productionRewrites:void 0,entrypoints:m}),Y().catch((e=>{console.error(e),process.exit(1)})),Q}