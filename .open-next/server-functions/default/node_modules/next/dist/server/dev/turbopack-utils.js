"use strict";function _export(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{AssetMapper:function(){return AssetMapper},addMetadataIdToRoute:function(){return addMetadataIdToRoute},addRouteSuffix:function(){return addRouteSuffix},handleEntrypoints:function(){return handleEntrypoints},handlePagesErrorRoute:function(){return handlePagesErrorRoute},handleRouteType:function(){return handleRouteType},hasEntrypointForKey:function(){return hasEntrypointForKey},msToNs:function(){return msToNs},normalizedPageToTurbopackStructureRoute:function(){return normalizedPageToTurbopackStructureRoute},printNonFatalIssue:function(){return printNonFatalIssue},processTopLevelIssues:function(){return processTopLevelIssues},removeRouteSuffix:function(){return removeRouteSuffix}});const _hotreloadertypes=require("./hot-reloader-types"),_log=_interop_require_wildcard(require("../../build/output/log")),_entrykey=require("../../shared/lib/turbopack/entry-key"),_ismetadataroute=require("../../lib/metadata/is-metadata-route"),_utils=require("../../shared/lib/turbopack/utils");function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(_getRequireWildcardCache=function(e){return e?r:t})(e)}function _interop_require_wildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=_getRequireWildcardCache(t);if(r&&r.has(e))return r.get(e);var a={__proto__:null},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var o=n?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(a,s,o):a[s]=e[s]}return a.default=e,r&&r.set(e,a),a}const onceErrorSet=new Set;function shouldEmitOnceWarning(e){const{severity:t,title:r,stage:a}=e;if("warning"===t&&"Invalid page configuration"===r.value){if(onceErrorSet.has(e))return!1;onceErrorSet.add(e)}if("warning"===t&&"config"===a&&(0,_utils.renderStyledStringToErrorAnsi)(e.title).includes("can't be external")){if(onceErrorSet.has(e))return!1;onceErrorSet.add(e)}return!0}function printNonFatalIssue(e){(0,_utils.isRelevantWarning)(e)&&shouldEmitOnceWarning(e)&&_log.warn((0,_utils.formatIssue)(e))}function processTopLevelIssues(e,t){e.clear();for(const r of t.issues){const t=(0,_utils.getIssueKey)(r);e.set(t,r)}}const MILLISECONDS_IN_NANOSECOND=BigInt(1e6);function msToNs(e){return BigInt(Math.floor(e))*MILLISECONDS_IN_NANOSECOND}async function handleRouteType({dev:e,page:t,pathname:r,route:a,currentEntryIssues:n,entrypoints:s,manifestLoader:o,readyIds:i,devRewrites:l,productionRewrites:d,hooks:u,logErrors:p}){const c=null!=process.env.TURBOPACK_STATS;switch(a.type){case"page":{const _=(0,_entrykey.getEntryKey)("pages","client",t),y=(0,_entrykey.getEntryKey)("pages","server",t);try{if(s.global.app){const e=(0,_entrykey.getEntryKey)("pages","server","_app"),t=await s.global.app.writeToDisk();null==u||u.handleWrittenEndpoint(e,t),(0,_utils.processIssues)(n,e,t,!1,p)}if(await o.loadBuildManifest("_app"),await o.loadPagesManifest("_app"),s.global.document){const e=(0,_entrykey.getEntryKey)("pages","server","_document"),t=await s.global.document.writeToDisk();null==u||u.handleWrittenEndpoint(e,t),(0,_utils.processIssues)(n,e,t,!1,p)}await o.loadPagesManifest("_document");const e=await a.htmlEndpoint.writeToDisk();null==u||u.handleWrittenEndpoint(y,e);const r=null==e?void 0:e.type;await o.loadBuildManifest(t),await o.loadPagesManifest(t),"edge"===r?await o.loadMiddlewareManifest(t,"pages"):o.deleteMiddlewareManifest(y),await o.loadFontManifest("/_app","pages"),await o.loadFontManifest(t,"pages"),c&&await o.loadWebpackStats(t,"pages"),await o.writeManifests({devRewrites:l,productionRewrites:d,entrypoints:s}),(0,_utils.processIssues)(n,y,e,!1,p)}finally{e&&(null==u||u.subscribeToChanges(y,!1,a.dataEndpoint,(()=>(null==i||i.delete(r),{event:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.SERVER_ONLY_CHANGES,pages:[t]})),(e=>({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.RELOAD_PAGE,data:`error in ${t} data subscription: ${e}`}))),null==u||u.subscribeToChanges(_,!1,a.htmlEndpoint,(()=>({event:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.CLIENT_CHANGES})),(e=>({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.RELOAD_PAGE,data:`error in ${t} html subscription: ${e}`}))),s.global.document&&(null==u||u.subscribeToChanges((0,_entrykey.getEntryKey)("pages","server","_document"),!1,s.global.document,(()=>({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.RELOAD_PAGE,data:"_document has changed (page route)"})),(e=>({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.RELOAD_PAGE,data:`error in _document subscription (page route): ${e}`})))))}break}case"page-api":{const e=(0,_entrykey.getEntryKey)("pages","server",t),r=await a.endpoint.writeToDisk();null==u||u.handleWrittenEndpoint(e,r);const i=r.type;await o.loadPagesManifest(t),"edge"===i?await o.loadMiddlewareManifest(t,"pages"):o.deleteMiddlewareManifest(e),await o.writeManifests({devRewrites:l,productionRewrites:d,entrypoints:s}),(0,_utils.processIssues)(n,e,r,!0,p);break}case"app-page":{const _=(0,_entrykey.getEntryKey)("app","server",t),y=await a.htmlEndpoint.writeToDisk();null==u||u.handleWrittenEndpoint(_,y),e&&(null==u||u.subscribeToChanges(_,!0,a.rscEndpoint,((e,t)=>{if(!e.issues.some((e=>"error"===e.severity)))return null==i||i.delete(r),{action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.SERVER_COMPONENT_CHANGES,hash:t}}),(e=>({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.RELOAD_PAGE,data:`error in ${t} app-page subscription: ${e}`}))));"edge"===y.type?await o.loadMiddlewareManifest(t,"app"):o.deleteMiddlewareManifest(_),await o.loadAppBuildManifest(t),await o.loadBuildManifest(t,"app"),await o.loadAppPathsManifest(t),await o.loadActionManifest(t),await o.loadFontManifest(t,"app"),c&&await o.loadWebpackStats(t,"app"),await o.writeManifests({devRewrites:l,productionRewrites:d,entrypoints:s}),(0,_utils.processIssues)(n,_,y,e,p);break}case"app-route":{const e=(0,_entrykey.getEntryKey)("app","server",t),r=await a.endpoint.writeToDisk();null==u||u.handleWrittenEndpoint(e,r);const i=r.type;await o.loadAppPathsManifest(t),"edge"===i?await o.loadMiddlewareManifest(t,"app"):o.deleteMiddlewareManifest(e),await o.writeManifests({devRewrites:l,productionRewrites:d,entrypoints:s}),(0,_utils.processIssues)(n,e,r,!0,p);break}default:throw Object.defineProperty(new Error(`unknown route type ${a.type} for ${t}`),"__NEXT_ERROR_CODE",{value:"E316",enumerable:!1,configurable:!0})}}class AssetMapper{setPathsForKey(e,t){this.delete(e);const r=new Set(t);this.entryMap.set(e,r);for(const t of r){let r=this.assetMap.get(t);r||(r=new Set,this.assetMap.set(t,r)),r.add(e)}}delete(e){for(const t of this.getAssetPathsByKey(e)){const r=this.assetMap.get(t);null==r||r.delete(e),(null==r?void 0:r.size)||this.assetMap.delete(t)}this.entryMap.delete(e)}getAssetPathsByKey(e){return Array.from(this.entryMap.get(e)??[])}getKeysByAsset(e){return Array.from(this.assetMap.get(e)??[])}keys(){return this.entryMap.keys()}constructor(){this.entryMap=new Map,this.assetMap=new Map}}function hasEntrypointForKey(e,t,r){const{type:a,page:n}=(0,_entrykey.splitEntryKey)(t);switch(a){case"app":return e.app.has(n);case"pages":switch(n){case"_app":return null!=e.global.app;case"_document":return null!=e.global.document;case"_error":return null!=e.global.error;default:return e.page.has(n)}case"root":switch(n){case"middleware":return null!=e.global.middleware;case"instrumentation":return null!=e.global.instrumentation;default:return!1}case"assets":return!!r&&r.getKeysByAsset(n).some((t=>hasEntrypointForKey(e,t,r)));default:return!1}}async function handleEntrypoints({entrypoints:e,currentEntrypoints:t,currentEntryIssues:r,manifestLoader:a,devRewrites:n,logErrors:s,dev:o}){t.global.app=e.pagesAppEndpoint,t.global.document=e.pagesDocumentEndpoint,t.global.error=e.pagesErrorEndpoint,t.global.instrumentation=e.instrumentation,t.page.clear(),t.app.clear();for(const[d,u]of e.routes)switch(u.type){case"page":case"page-api":t.page.set(d,u);break;case"app-page":u.pages.forEach((e=>{t.app.set(e.originalName,{type:"app-page",...e})}));break;case"app-route":t.app.set(u.originalName,u);break;default:_log.info(`skipping ${d} (${u.type})`)}o&&await handleEntrypointsDevCleanup({currentEntryIssues:r,currentEntrypoints:t,...o});const{middleware:i,instrumentation:l}=e;if(t.global.middleware&&!i){const p=(0,_entrykey.getEntryKey)("root","server","middleware");await(null==o?void 0:o.hooks.unsubscribeFromChanges(p)),r.delete(p),o.hooks.sendHmr("middleware",{event:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.MIDDLEWARE_CHANGES})}else!t.global.middleware&&i&&o.hooks.sendHmr("middleware",{event:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.MIDDLEWARE_CHANGES});if(t.global.middleware=i,l){const c=async(e,t)=>{const a=(0,_entrykey.getEntryKey)("root","server",e),n=await l[t].writeToDisk();o.hooks.handleWrittenEndpoint(a,n),(0,_utils.processIssues)(r,a,n,!1,s)};await c("instrumentation.nodeJs","nodeJs"),await c("instrumentation.edge","edge"),await a.loadMiddlewareManifest("instrumentation","instrumentation"),await a.writeManifests({devRewrites:n,productionRewrites:void 0,entrypoints:t}),o.serverFields.actualInstrumentationHookFile="/instrumentation",await o.hooks.propagateServerField("actualInstrumentationHookFile",o.serverFields.actualInstrumentationHookFile)}else o.serverFields.actualInstrumentationHookFile=void 0,await o.hooks.propagateServerField("actualInstrumentationHookFile",o.serverFields.actualInstrumentationHookFile);if(i){const _=(0,_entrykey.getEntryKey)("root","server","middleware"),y=i.endpoint;async function g(){var e;const t=await y.writeToDisk();o.hooks.handleWrittenEndpoint(_,t),(0,_utils.processIssues)(r,_,t,!1,s),await a.loadMiddlewareManifest("middleware","middleware");const n=null==(e=a.getMiddlewareManifest(_))?void 0:e.middleware["/"];o&&n&&(o.serverFields.middleware={match:null,page:"/",matchers:n.matchers})}await g(),o&&(null==o||o.hooks.subscribeToChanges(_,!1,y,(async()=>{const e=o.hooks.startBuilding("middleware",void 0,!0);return await g(),await o.hooks.propagateServerField("actualMiddlewareFile",o.serverFields.actualMiddlewareFile),await o.hooks.propagateServerField("middleware",o.serverFields.middleware),await a.writeManifests({devRewrites:n,productionRewrites:void 0,entrypoints:t}),null==e||e(),{event:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.MIDDLEWARE_CHANGES}}),(()=>({event:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.MIDDLEWARE_CHANGES}))))}else a.deleteMiddlewareManifest((0,_entrykey.getEntryKey)("root","server","middleware")),o.serverFields.actualMiddlewareFile=void 0,o.serverFields.middleware=void 0;await o.hooks.propagateServerField("actualMiddlewareFile",o.serverFields.actualMiddlewareFile),await o.hooks.propagateServerField("middleware",o.serverFields.middleware)}async function handleEntrypointsDevCleanup({currentEntryIssues:e,currentEntrypoints:t,assetMapper:r,changeSubscriptions:a,clients:n,clientStates:s,hooks:o}){for(const e of r.keys())hasEntrypointForKey(t,e,r)||r.delete(e);for(const e of a.keys())hasEntrypointForKey(t,e,r)||await o.unsubscribeFromChanges(e);for(const[a]of e)hasEntrypointForKey(t,a,r)||e.delete(a);for(const e of n){const a=s.get(e);if(a){for(const e of a.clientIssues.keys())hasEntrypointForKey(t,e,r)||a.clientIssues.delete(e);for(const n of a.subscriptions.keys())hasEntrypointForKey(t,(0,_entrykey.getEntryKey)("assets","client",n),r)||o.unsubscribeFromHmrEvents(e,n)}}}async function handlePagesErrorRoute({currentEntryIssues:e,entrypoints:t,manifestLoader:r,devRewrites:a,productionRewrites:n,logErrors:s,hooks:o}){if(t.global.app){const r=(0,_entrykey.getEntryKey)("pages","server","_app"),a=await t.global.app.writeToDisk();o.handleWrittenEndpoint(r,a),o.subscribeToChanges(r,!1,t.global.app,(()=>({event:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.CLIENT_CHANGES})),(()=>({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.RELOAD_PAGE,data:"_app has changed (error route)"}))),(0,_utils.processIssues)(e,r,a,!1,s)}if(await r.loadBuildManifest("_app"),await r.loadPagesManifest("_app"),await r.loadFontManifest("_app"),t.global.document){const r=(0,_entrykey.getEntryKey)("pages","server","_document"),a=await t.global.document.writeToDisk();o.handleWrittenEndpoint(r,a),o.subscribeToChanges(r,!1,t.global.document,(()=>({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.RELOAD_PAGE,data:"_document has changed (error route)"})),(e=>({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.RELOAD_PAGE,data:`error in _document subscription (error route): ${e}`}))),(0,_utils.processIssues)(e,r,a,!1,s)}if(await r.loadPagesManifest("_document"),t.global.error){const r=(0,_entrykey.getEntryKey)("pages","server","_error"),a=await t.global.error.writeToDisk();o.handleWrittenEndpoint(r,a),o.subscribeToChanges(r,!1,t.global.error,(()=>({event:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.CLIENT_CHANGES})),(e=>({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.RELOAD_PAGE,data:`error in _error subscription: ${e}`}))),(0,_utils.processIssues)(e,r,a,!1,s)}await r.loadBuildManifest("_error"),await r.loadPagesManifest("_error"),await r.loadFontManifest("_error"),await r.writeManifests({devRewrites:a,productionRewrites:n,entrypoints:t})}function removeRouteSuffix(e){return e.replace(/\/route$/,"")}function addRouteSuffix(e){return e+"/route"}function addMetadataIdToRoute(e){return e+"/[__metadata_id__]"}function normalizedPageToTurbopackStructureRoute(e,t){let r=e;return(0,_ismetadataroute.isMetadataRoute)(r)&&(r=r.endsWith("/route")?r.slice(0,-"/route".length):r,t&&(r.endsWith("/[__metadata_id__]")&&(r=r.slice(0,-"/[__metadata_id__]".length)),r.endsWith("/sitemap.xml")&&".xml"!==t&&(r=r.slice(0,-".xml".length))),r+="/route"),r}