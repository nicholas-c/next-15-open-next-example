"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"WebpackHotMiddleware",{enumerable:!0,get:function(){return WebpackHotMiddleware}});const _utils=require("../../build/utils"),_hotreloadertypes=require("./hot-reloader-types"),_devindicatorserverstate=require("./dev-indicator-server-state");function isMiddlewareStats(t){for(const s of t.compilation.entrypoints.keys())if((0,_utils.isMiddlewareFilename)(s))return!0;return!1}function statsToJson(t){return t?t.toJson({all:!1,errors:!0,hash:!0,warnings:!0}):{}}function getStatsForSyncEvent(t,s){return t?s?s.stats.hasErrors()||s.ts>t.ts?s.stats:t.stats:null==t?void 0:t.stats:null==s?void 0:s.stats}class EventStream{constructor(){this.clients=new Set}close(){for(const t of this.clients)t.terminate();this.clients.clear()}handler(t){this.clients.add(t),t.addEventListener("close",(()=>{this.clients.delete(t)}))}publish(t){for(const s of this.clients)s.send(JSON.stringify(t))}}class WebpackHotMiddleware{constructor(t,s,e){this.onClientInvalid=()=>{var t;this.closed||(null==(t=this.serverLatestStats)?void 0:t.stats.hasErrors())||this.publish({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.BUILDING})},this.onClientDone=t=>{var s;this.clientLatestStats={ts:Date.now(),stats:t},this.closed||(null==(s=this.serverLatestStats)?void 0:s.stats.hasErrors())||this.publishStats(t)},this.onServerInvalid=()=>{var t,s;(null==(t=this.serverLatestStats)?void 0:t.stats.hasErrors())&&(this.serverLatestStats=null,(null==(s=this.clientLatestStats)?void 0:s.stats)&&this.publishStats(this.clientLatestStats.stats))},this.onServerDone=t=>{this.closed||t.hasErrors()&&(this.serverLatestStats={ts:Date.now(),stats:t},this.publishStats(t))},this.onEdgeServerInvalid=()=>{var t,s;(null==(t=this.middlewareLatestStats)?void 0:t.stats.hasErrors())&&(this.middlewareLatestStats=null,(null==(s=this.clientLatestStats)?void 0:s.stats)&&this.publishStats(this.clientLatestStats.stats))},this.onEdgeServerDone=t=>{if(!isMiddlewareStats(t))return this.onServerInvalid(),void this.onServerDone(t);t.hasErrors()&&(this.middlewareLatestStats={ts:Date.now(),stats:t},this.publishStats(t))},this.onHMR=t=>{if(this.closed)return;this.eventStream.handler(t);const s=getStatsForSyncEvent(this.clientLatestStats,this.serverLatestStats);if(s){var e;const t=statsToJson(s),r=statsToJson(null==(e=this.middlewareLatestStats)?void 0:e.stats);_devindicatorserverstate.devIndicatorServerState.disabledUntil<Date.now()&&(_devindicatorserverstate.devIndicatorServerState.disabledUntil=0),this.publish({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.SYNC,hash:t.hash,errors:[...t.errors||[],...r.errors||[]],warnings:[...t.warnings||[],...r.warnings||[]],versionInfo:this.versionInfo,debug:{devtoolsFrontendUrl:this.devtoolsFrontendUrl},devIndicator:_devindicatorserverstate.devIndicatorServerState})}},this.publishStats=t=>{const s=t.toJson({all:!1,hash:!0,warnings:!0,errors:!0,moduleTrace:!0});this.publish({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.BUILT,hash:s.hash,warnings:s.warnings||[],errors:s.errors||[]})},this.publish=t=>{this.closed||this.eventStream.publish(t)},this.close=()=>{this.closed||(this.closed=!0,this.eventStream.close())},this.eventStream=new EventStream,this.clientLatestStats=null,this.middlewareLatestStats=null,this.serverLatestStats=null,this.closed=!1,this.versionInfo=s,this.devtoolsFrontendUrl=e,t[0].hooks.invalid.tap("webpack-hot-middleware",this.onClientInvalid),t[0].hooks.done.tap("webpack-hot-middleware",this.onClientDone),t[1].hooks.invalid.tap("webpack-hot-middleware",this.onServerInvalid),t[1].hooks.done.tap("webpack-hot-middleware",this.onServerDone),t[2].hooks.done.tap("webpack-hot-middleware",this.onEdgeServerDone),t[2].hooks.invalid.tap("webpack-hot-middleware",this.onEdgeServerInvalid)}}