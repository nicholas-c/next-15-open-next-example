"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return DevServer}});const _requestmeta=require("../request-meta"),_fs=_interop_require_default(require("fs")),_jestworker=require("next/dist/compiled/jest-worker"),_path=require("path"),_output=require("../../build/output"),_constants=require("../../lib/constants"),_findpagesdir=require("../../lib/find-pages-dir"),_constants1=require("../../shared/lib/constants"),_nextserver=_interop_require_wildcard(require("../next-server")),_normalizepagepath=require("../../shared/lib/page-path/normalize-page-path"),_pathhasprefix=require("../../shared/lib/router/utils/path-has-prefix"),_removepathprefix=require("../../shared/lib/router/utils/remove-path-prefix"),_storage=require("../../telemetry/storage"),_trace=require("../../trace"),_findpagefile=require("../lib/find-page-file"),_utils=require("../lib/utils"),_coalescedfunction=require("../../lib/coalesced-function"),_loaddefaulterrorcomponents=require("../load-default-error-components"),_utils1=require("../../shared/lib/utils"),_log=_interop_require_wildcard(require("../../build/output/log")),_iserror=_interop_require_wildcard(require("../../lib/is-error")),_utils2=require("../../build/utils"),_formatservererror=require("../../lib/format-server-error"),_devroutematchermanager=require("../route-matcher-managers/dev-route-matcher-manager"),_devpagesroutematcherprovider=require("../route-matcher-providers/dev/dev-pages-route-matcher-provider"),_devpagesapiroutematcherprovider=require("../route-matcher-providers/dev/dev-pages-api-route-matcher-provider"),_devapppageroutematcherprovider=require("../route-matcher-providers/dev/dev-app-page-route-matcher-provider"),_devapprouteroutematcherprovider=require("../route-matcher-providers/dev/dev-app-route-route-matcher-provider"),_nodemanifestloader=require("../route-matcher-providers/helpers/manifest-loaders/node-manifest-loader"),_batchedfilereader=require("../route-matcher-providers/dev/helpers/file-reader/batched-file-reader"),_defaultfilereader=require("../route-matcher-providers/dev/helpers/file-reader/default-file-reader"),_lrucache=require("../lib/lru-cache"),_middlewareroutematcher=require("../../shared/lib/router/utils/middleware-route-matcher"),_detachedpromise=require("../../lib/detached-promise"),_ispostpone=require("../lib/router-utils/is-postpone"),_generateinterceptionroutesrewrites=require("../../lib/generate-interception-routes-rewrites"),_buildcustomroute=require("../../lib/build-custom-route"),_errorsource=require("../../shared/lib/error-source"),_logrequests=require("./log-requests"),_fallback=require("../../lib/fallback");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(_getRequireWildcardCache=function(e){return e?t:r})(e)}function _interop_require_wildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var i={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in e)if("default"!==n&&Object.prototype.hasOwnProperty.call(e,n)){var s=a?Object.getOwnPropertyDescriptor(e,n):null;s&&(s.get||s.set)?Object.defineProperty(i,n,s):i[n]=e[n]}return i.default=e,t&&t.set(e,i),i}let ReactDevOverlayImpl;const ReactDevOverlay=e=>(void 0===ReactDevOverlayImpl&&(ReactDevOverlayImpl=require("../../client/components/react-dev-overlay/pages/pages-dev-overlay").PagesDevOverlay),ReactDevOverlayImpl(e));class DevServer extends _nextserver.default{getStaticPathsWorker(){const e=new _jestworker.Worker(require.resolve("./static-paths-worker"),{maxRetries:1,numWorkers:1,enableWorkerThreads:this.nextConfig.experimental.workerThreads,forkOptions:{env:{...process.env,NODE_OPTIONS:(0,_utils.getFormattedNodeOptionsWithoutInspect)()}}});return e.getStdout().pipe(process.stdout),e.getStderr().pipe(process.stderr),e}constructor(e){var r,t;try{Error.stackTraceLimit=50}catch{}super({...e,dev:!0}),this.ready=new _detachedpromise.DetachedPromise,this.bundlerService=e.bundlerService,this.startServerSpan=e.startServerSpan??(0,_trace.trace)("start-next-dev-server"),this.renderOpts.dev=!0,this.renderOpts.ErrorDebug=ReactDevOverlay,this.staticPathsCache=new _lrucache.LRUCache(5242880,(function(e){var r;return(null==(r=JSON.stringify(e.staticPaths))?void 0:r.length)??0})),this.renderOpts.ampSkipValidation=(null==(t=this.nextConfig.experimental)||null==(r=t.amp)?void 0:r.skipValidation)??!1,this.renderOpts.ampValidator=(e,r)=>{const t=this.nextConfig.experimental&&this.nextConfig.experimental.amp&&this.nextConfig.experimental.amp.validator||require.resolve("next/dist/compiled/amphtml-validator/validator_wasm.js");return require("next/dist/compiled/amphtml-validator").getInstance(t).then((t=>{const i=t.validateString(e);(0,_output.ampValidation)(r,i.errors.filter((e=>"ERROR"===e.severity)).filter((r=>this._filterAmpDevelopmentScript(e,r))),i.errors.filter((e=>"ERROR"!==e.severity)))}))};const{pagesDir:i,appDir:a}=(0,_findpagesdir.findPagesDir)(this.dir);this.pagesDir=i,this.appDir=a,this.nextConfig.experimental.serverComponentsHmrCache&&(this.serverComponentsHmrCache=new _lrucache.LRUCache(this.nextConfig.cacheMaxMemorySize,(function(e){return JSON.stringify(e).length})))}getServerComponentsHmrCache(){return this.serverComponentsHmrCache}getRouteMatchers(){const{pagesDir:e,appDir:r}=(0,_findpagesdir.findPagesDir)(this.dir),t={ensure:async(e,r)=>{await this.ensurePage({definition:e.definition,page:e.definition.page,clientOnly:!1,url:r})}},i=new _devroutematchermanager.DevRouteMatcherManager(super.getRouteMatchers(),t,this.dir),a=this.nextConfig.pageExtensions,n=new RegExp(`\\.(?:${a.join("|")})$`);if(e){const r=new _batchedfilereader.BatchedFileReader(new _defaultfilereader.DefaultFileReader({pathnameFilter:e=>n.test(e)}));i.push(new _devpagesroutematcherprovider.DevPagesRouteMatcherProvider(e,a,r,this.localeNormalizer)),i.push(new _devpagesapiroutematcherprovider.DevPagesAPIRouteMatcherProvider(e,a,r,this.localeNormalizer))}if(r){const e=new _batchedfilereader.BatchedFileReader(new _defaultfilereader.DefaultFileReader({ignorePartFilter:e=>e.startsWith("_")}));i.push(new _devapppageroutematcherprovider.DevAppPageRouteMatcherProvider(r,a,e)),i.push(new _devapprouteroutematcherprovider.DevAppRouteRouteMatcherProvider(r,a,e))}return i}getBuildId(){return"development"}async prepareImpl(){var e;(0,_trace.setGlobal)("distDir",this.distDir),(0,_trace.setGlobal)("phase",_constants1.PHASE_DEVELOPMENT_SERVER);const r=new _storage.Telemetry({distDir:this.distDir});await super.prepareImpl(),await this.matchers.reload(),null==(e=this.ready)||e.resolve(),this.ready=void 0,this.interceptionRoutePatterns=this.getinterceptionRoutePatterns(),(0,_trace.setGlobal)("appDir",this.appDir),(0,_trace.setGlobal)("pagesDir",this.pagesDir),(0,_trace.setGlobal)("telemetry",r),process.on("unhandledRejection",(e=>{(0,_ispostpone.isPostpone)(e)||this.logErrorWithOriginalStack(e,"unhandledRejection")})),process.on("uncaughtException",(e=>{this.logErrorWithOriginalStack(e,"uncaughtException")}))}async hasPage(e){let r;try{r=(0,_normalizepagepath.normalizePagePath)(e)}catch(e){return console.error(e),!1}if((0,_utils2.isMiddlewareFile)(r))return(0,_findpagefile.findPageFile)(this.dir,r,this.nextConfig.pageExtensions,!1).then(Boolean);let t=null,i=null;return this.appDir&&(t=await(0,_findpagefile.findPageFile)(this.appDir,r+"/page",this.nextConfig.pageExtensions,!0)),this.pagesDir&&(i=await(0,_findpagefile.findPageFile)(this.pagesDir,r,this.nextConfig.pageExtensions,!1)),(!t||!i)&&Boolean(t||i)}async runMiddleware(e){try{const r=await super.runMiddleware({...e,onWarning:e=>{this.logErrorWithOriginalStack(e,"warning")}});return"finished"in r||r.waitUntil.catch((e=>{this.logErrorWithOriginalStack(e,"unhandledRejection")})),r}catch(r){if(r instanceof _utils1.DecodeError)throw r;r instanceof _utils1.MiddlewareNotFoundError||this.logErrorWithOriginalStack(r);const t=(0,_iserror.getProperError)(r);(0,_errorsource.decorateServerError)(t,_constants1.COMPILER_NAMES.edgeServer);const{request:i,response:a,parsedUrl:n}=e;return i.url.includes("/_next/static")||i.url.includes("/__nextjs_original-stack-frame")||i.url.includes("/__nextjs_source-map")||i.url.includes("/__nextjs_error_feedback")?{finished:!1}:(a.statusCode=500,await this.renderError(t,i,a,n.pathname),{finished:!0})}}async runEdgeFunction(e){try{return super.runEdgeFunction({...e,onError:e=>this.logErrorWithOriginalStack(e,"app-dir"),onWarning:e=>{this.logErrorWithOriginalStack(e,"warning")}})}catch(r){if(r instanceof _utils1.DecodeError)throw r;this.logErrorWithOriginalStack(r,"warning");const t=(0,_iserror.getProperError)(r),{req:i,res:a,page:n}=e;return a.statusCode=500,await this.renderError(t,i,a,n),null}}getRequestHandler(){const e=super.getRequestHandler();return(r,t,i)=>{const a=this.normalizeReq(r),n=this.normalizeRes(t),s=this.nextConfig.logging;if(!1!==s){const e=Date.now();(0,_requestmeta.getRequestMeta)(r,"middlewareInvoke")||n.originalResponse.once("close",(()=>{(0,_requestmeta.getRequestMeta)(r).match&&(0,_logrequests.logRequests)({request:a,response:n,loggingConfig:s,requestDurationInMs:Date.now()-e})}))}return e(a,n,i)}}async handleRequest(e,r,t){const i=(0,_trace.trace)("handle-request",void 0,{url:e.url}),a=await i.traceAsyncFn((async()=>{var i;return await(null==(i=this.ready)?void 0:i.promise),await super.handleRequest(e,r,t)})),n=process.memoryUsage();return i.traceChild("memory-usage",{url:e.url,"memory.rss":String(n.rss),"memory.heapUsed":String(n.heapUsed),"memory.heapTotal":String(n.heapTotal)}).stop(),a}async run(e,r,t){var i;await(null==(i=this.ready)?void 0:i.promise);const{basePath:a}=this.nextConfig;let n=null;a&&(0,_pathhasprefix.pathHasPrefix)(t.pathname||"/",a)&&(n=t.pathname,t.pathname=(0,_removepathprefix.removePathPrefix)(t.pathname||"/",a));const{pathname:s}=t;if(s.startsWith("/_next")&&_fs.default.existsSync((0,_path.join)(this.publicDir,"_next")))throw Object.defineProperty(new Error(_constants.PUBLIC_DIR_MIDDLEWARE_CONFLICT),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});n&&(t.pathname=n);try{return await super.run(e,r,t)}catch(t){const i=(0,_iserror.getProperError)(t);if((0,_formatservererror.formatServerError)(i),this.logErrorWithOriginalStack(i),!r.sent){r.statusCode=500;try{return await this.renderError(i,e,r,s,{__NEXT_PAGE:(0,_iserror.default)(i)&&i.page||s||""})}catch(e){console.error(e),r.body("Internal Server Error").send()}}}}logErrorWithOriginalStack(e,r){this.bundlerService.logErrorWithOriginalStack(e,r)}getPagesManifest(){return _nodemanifestloader.NodeManifestLoader.require((0,_path.join)(this.serverDistDir,_constants1.PAGES_MANIFEST))??void 0}getAppPathsManifest(){if(this.enabledDirectories.app)return _nodemanifestloader.NodeManifestLoader.require((0,_path.join)(this.serverDistDir,_constants1.APP_PATHS_MANIFEST))??void 0}getinterceptionRoutePatterns(){const e=(0,_generateinterceptionroutesrewrites.generateInterceptionRoutesRewrites)(Object.keys(this.appPathRoutes??{}),this.nextConfig.basePath).map((e=>new RegExp((0,_buildcustomroute.buildCustomRoute)("rewrite",e).regex)));return"export"===this.nextConfig.output&&e.length>0&&(_log.error("Intercepting routes are not supported with static export.\nRead more: https://nextjs.org/docs/app/building-your-application/deploying/static-exports#unsupported-features"),process.exit(1)),e??[]}async getMiddleware(){var e;return null===(null==(e=this.middleware)?void 0:e.match)&&(this.middleware.match=(0,_middlewareroutematcher.getMiddlewareRouteMatcher)(this.middleware.matchers||[])),this.middleware}getNextFontManifest(){}async hasMiddleware(){return this.hasPage(this.actualMiddlewareFile)}async ensureMiddleware(e){return this.ensurePage({page:this.actualMiddlewareFile,clientOnly:!1,definition:void 0,url:e})}async loadInstrumentationModule(){let e;if(this.actualInstrumentationHookFile&&await this.ensurePage({page:this.actualInstrumentationHookFile,clientOnly:!1,definition:void 0}).then((()=>!0)).catch((()=>!1)))try{e=await require((0,_path.join)(this.distDir,"server",_constants.INSTRUMENTATION_HOOK_FILENAME))}catch(e){throw e.message=`An error occurred while loading instrumentation hook: ${e.message}`,e}return e}async runInstrumentationHookIfAvailable(){await this.startServerSpan.traceChild("run-instrumentation-hook").traceAsyncFn((()=>{var e,r;return null==(r=this.instrumentation)||null==(e=r.register)?void 0:e.call(r)}))}async ensureEdgeFunction({page:e,appPaths:r,url:t}){return this.ensurePage({page:e,appPaths:r,clientOnly:!1,definition:void 0,url:t})}generateRoutes(e){}_filterAmpDevelopmentScript(e,r){if("DISALLOWED_SCRIPT_TAG"!==r.code)return!0;const t=e.split("\n");let i;return!(i=e.split("\n")[r.line-1])||!(i=i.substring(r.col))||(i+=t.slice(r.line).join("\n"),i=i.substring(0,i.indexOf("<\/script>")),!i.includes("data-amp-development-mode-only"))}async getStaticPaths({pathname:e,requestHeaders:r,page:t,isAppPath:i}){const a=async()=>{const{configFileName:a,publicRuntimeConfig:n,serverRuntimeConfig:s,httpAgentOptions:o}=this.nextConfig,{locales:l,defaultLocale:u}=this.nextConfig.i18n||{},c=this.getStaticPathsWorker();try{var d;return await c.loadStaticPaths({dir:this.dir,distDir:this.distDir,pathname:e,config:{pprConfig:this.nextConfig.experimental.ppr,configFileName:a,publicRuntimeConfig:n,serverRuntimeConfig:s,dynamicIO:Boolean(this.nextConfig.experimental.dynamicIO)},httpAgentOptions:o,locales:l,defaultLocale:u,page:t,isAppPath:i,requestHeaders:r,cacheHandler:this.nextConfig.cacheHandler,cacheHandlers:this.nextConfig.experimental.cacheHandlers,cacheLifeProfiles:this.nextConfig.experimental.cacheLife,fetchCacheKeyPrefix:this.nextConfig.experimental.fetchCacheKeyPrefix,isrFlushToDisk:this.nextConfig.experimental.isrFlushToDisk,maxMemoryCacheSize:this.nextConfig.cacheMaxMemorySize,nextConfigOutput:this.nextConfig.output,buildId:this.buildId,authInterrupts:Boolean(this.nextConfig.experimental.authInterrupts),sriEnabled:Boolean(null==(d=this.nextConfig.experimental.sri)?void 0:d.algorithm)})}finally{c.end()}},n=this.staticPathsCache.get(e),s=(0,_coalescedfunction.withCoalescedInvoke)(a)(`staticPaths-${e}`,[]).then((r=>{const{prerenderedRoutes:t,fallbackMode:a}=r.value;if(!i&&"export"===this.nextConfig.output){if(a===_fallback.FallbackMode.BLOCKING_STATIC_RENDER)throw Object.defineProperty(new Error('getStaticPaths with "fallback: blocking" cannot be used with "output: export". See more info here: https://nextjs.org/docs/advanced-features/static-html-export'),"__NEXT_ERROR_CODE",{value:"E11",enumerable:!1,configurable:!0});if(a===_fallback.FallbackMode.PRERENDER)throw Object.defineProperty(new Error('getStaticPaths with "fallback: true" cannot be used with "output: export". See more info here: https://nextjs.org/docs/advanced-features/static-html-export'),"__NEXT_ERROR_CODE",{value:"E210",enumerable:!1,configurable:!0})}const n={staticPaths:null==t?void 0:t.map((e=>e.pathname)),fallbackMode:a};return this.staticPathsCache.set(e,n),n})).catch((r=>{if(this.staticPathsCache.remove(e),!n)throw r;_log.error(`Failed to generate static paths for ${e}:`),console.error(r)}));return n||s}async ensurePage(e){await this.bundlerService.ensurePage(e)}async findPageComponents({locale:e,page:r,query:t,params:i,isAppPath:a,appPaths:n=null,shouldEnsure:s,url:o}){var l;await(null==(l=this.ready)?void 0:l.promise);const u=await this.getCompilationError(r);if(u)throw new _nextserver.WrappedBuildError(u);return(s||this.serverOptions.customServer)&&await this.ensurePage({page:r,appPaths:n,clientOnly:!1,definition:void 0,url:o}),this.nextFontManifest=super.getNextFontManifest(),await super.findPageComponents({page:r,query:t,params:i,locale:e,isAppPath:a,shouldEnsure:s,url:o})}async getFallbackErrorComponents(e){return await this.bundlerService.getFallbackErrorComponents(e),await(0,_loaddefaulterrorcomponents.loadDefaultErrorComponents)(this.distDir)}async getCompilationError(e){return await this.bundlerService.getCompilationError(e)}async instrumentationOnRequestError(...e){await super.instrumentationOnRequestError(...e);const r=e[0];this.logErrorWithOriginalStack(r,"app-dir")}}