"use strict";function _export(e,t){for(var n in t)Object.defineProperty(e,n,{enumerable:!0,get:t[n]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{ADDED:function(){return ADDED},BUILDING:function(){return BUILDING},BUILT:function(){return BUILT},EntryTypes:function(){return EntryTypes},findPagePathData:function(){return findPagePathData},getEntries:function(){return getEntries},getEntryKey:function(){return getEntryKey},getInvalidator:function(){return getInvalidator},onDemandEntryHandler:function(){return onDemandEntryHandler}});const _debug=_interop_require_default(require("next/dist/compiled/debug")),_events=require("events"),_findpagefile=require("../lib/find-page-file"),_entries=require("../../build/entries"),_path=require("path"),_normalizepathsep=require("../../shared/lib/page-path/normalize-path-sep"),_normalizepagepath=require("../../shared/lib/page-path/normalize-page-path"),_ensureleadingslash=require("../../shared/lib/page-path/ensure-leading-slash"),_removepagepathtail=require("../../shared/lib/page-path/remove-page-path-tail"),_output=require("../../build/output"),_getroutefromentrypoint=_interop_require_default(require("../get-route-from-entrypoint")),_utils=require("../../build/utils"),_utils1=require("../../shared/lib/utils"),_constants=require("../../shared/lib/constants"),_segment=require("../../shared/lib/segment"),_hotreloadertypes=require("./hot-reloader-types"),_apppageroutedefinition=require("../route-definitions/app-page-route-definition"),_scheduler=require("../../lib/scheduler"),_batcher=require("../../lib/batcher"),_apppaths=require("../../shared/lib/router/utils/app-paths"),_pagetypes=require("../../lib/page-types"),_flightdatahelpers=require("../../client/flight-data-helpers");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}const debug=(0,_debug.default)("next:on-demand-entry-handler"),keys=Object.keys,COMPILER_KEYS=keys(_constants.COMPILER_INDEXES);function treePathToEntrypoint(e,t){const[n,a]=e,i=(t?t+"/":"")+("children"===n||a.startsWith("@")?"":`@${n}/`)+(""===a?"page":a);if(2===e.length)return i;return treePathToEntrypoint((0,_flightdatahelpers.getNextFlightSegmentPath)(e),i)}function convertDynamicParamTypeToSyntax(e,t){switch(e){case"c":case"ci":return`[...${t}]`;case"oc":return`[[...${t}]]`;case"d":case"di":return`[${t}]`;default:throw Object.defineProperty(new Error("Unknown dynamic param type"),"__NEXT_ERROR_CODE",{value:"E378",enumerable:!1,configurable:!0})}}function getEntryKey(e,t,n){return`${e}@${t}@${n.replace(/(@[^/]+)\/children/g,"$1")}`}function getPageBundleType(e){return"/_error"===e?_pagetypes.PAGE_TYPES.PAGES:(0,_utils.isMiddlewareFilename)(e)?_pagetypes.PAGE_TYPES.ROOT:e.startsWith("pages/")?_pagetypes.PAGE_TYPES.PAGES:e.startsWith("app/")?_pagetypes.PAGE_TYPES.APP:_pagetypes.PAGE_TYPES.ROOT}function getEntrypointsFromTree(e,t,n=[]){const[a,i]=e,r=Array.isArray(a)?convertDynamicParamTypeToSyntax(a[2],a[0]):a,s=r.startsWith(_segment.PAGE_SEGMENT_KEY),o=[...n,s?"":r];return!t&&s?[treePathToEntrypoint(o.slice(1))]:Object.keys(i).reduce(((e,t)=>[...e,...getEntrypointsFromTree(i[t],!1,[...o,t])]),[])}const ADDED=Symbol("added"),BUILDING=Symbol("building"),BUILT=Symbol("built");var EntryTypes=function(e){return e[e.ENTRY=0]="ENTRY",e[e.CHILD_ENTRY=1]="CHILD_ENTRY",e}({});const entriesMap=new Map,normalizeOutputPath=e=>e.replace(/[/\\]server$/,""),getEntries=e=>{e=normalizeOutputPath(e);const t=entriesMap.get(e)||{};return entriesMap.set(e,t),t},invalidators=new Map,getInvalidator=e=>(e=normalizeOutputPath(e),invalidators.get(e)),doneCallbacks=new _events.EventEmitter,lastClientAccessPages=[""],lastServerAccessPagesForAppDir=[""];class Invalidator{constructor(e){this.building=new Set,this.rebuildAgain=new Set,this.multiCompiler=e}shouldRebuildAll(){return this.rebuildAgain.size>0}invalidate(e=COMPILER_KEYS){for(const n of e){var t;this.building.has(n)?this.rebuildAgain.add(n):(this.building.add(n),null==(t=this.multiCompiler.compilers[_constants.COMPILER_INDEXES[n]].watching)||t.invalidate())}}startBuilding(e){this.building.add(e)}doneBuilding(e=[]){const t=[];for(const n of e)this.building.delete(n),this.rebuildAgain.has(n)&&(t.push(n),this.rebuildAgain.delete(n));t.length>0&&this.invalidate(t)}willRebuild(e){return this.rebuildAgain.has(e)}}function disposeInactiveEntries(e,t){Object.keys(e).forEach((n=>{const a=e[n],{lastActiveTime:i,status:r,dispose:s,bundlePath:o}=a;1!==a.type&&((0,_utils.isMiddlewareFilename)(o)||(0,_utils.isInstrumentationHookFilename)(o)||s||r===BUILT&&(lastClientAccessPages.includes(n)||lastServerAccessPagesForAppDir.includes(n)||i&&Date.now()-i>t&&(e[n].dispose=!0)))}))}function tryToNormalizePagePath(e){try{return(0,_normalizepagepath.normalizePagePath)(e)}catch(t){throw console.error(t),new _utils1.PageNotFoundError(e)}}async function findPagePathData(e,t,n,a,i){const r=tryToNormalizePagePath(t);let s=null;const o=(0,_utils.isInstrumentationHookFile)(r);if((0,_utils.isMiddlewareFile)(r)||o){if(s=await(0,_findpagefile.findPageFile)(e,r,n,!1),!s)throw new _utils1.PageNotFoundError(r);const a=(0,_ensureleadingslash.ensureLeadingSlash)((0,_removepagepathtail.removePagePathTail)((0,_normalizepathsep.normalizePathSep)(s),{extensions:n}));let i=r,l=_path.posix.normalize(a);return(o||(0,_utils.isMiddlewareFile)(r))&&(i=i.replace("/src",""),l=t.replace("/src","")),{filename:(0,_path.join)(e,s),bundlePath:i.slice(1),page:l}}if(i){if(t===_constants.UNDERSCORE_NOT_FOUND_ROUTE_ENTRY){const e=await(0,_findpagefile.findPageFile)(i,"not-found",n,!0);return e?{filename:(0,_path.join)(i,e),bundlePath:`app${_constants.UNDERSCORE_NOT_FOUND_ROUTE_ENTRY}`,page:_constants.UNDERSCORE_NOT_FOUND_ROUTE_ENTRY}:{filename:require.resolve("next/dist/client/components/not-found-error"),bundlePath:`app${_constants.UNDERSCORE_NOT_FOUND_ROUTE_ENTRY}`,page:_constants.UNDERSCORE_NOT_FOUND_ROUTE_ENTRY}}if(s=await(0,_findpagefile.findPageFile)(i,r,n,!0),s){const e=(0,_ensureleadingslash.ensureLeadingSlash)((0,_removepagepathtail.removePagePathTail)((0,_normalizepathsep.normalizePathSep)(s),{keepIndex:!0,extensions:n}));return{filename:(0,_path.join)(i,s),bundlePath:_path.posix.join("app",e),page:_path.posix.normalize(e)}}}if(!s&&a&&(s=await(0,_findpagefile.findPageFile)(a,r,n,!1)),null!==s&&a){const e=(0,_ensureleadingslash.ensureLeadingSlash)((0,_removepagepathtail.removePagePathTail)((0,_normalizepathsep.normalizePathSep)(s),{extensions:n}));return{filename:(0,_path.join)(a,s),bundlePath:_path.posix.join("pages",(0,_normalizepagepath.normalizePagePath)(e)),page:_path.posix.normalize(e)}}if("/_error"===t)return{filename:require.resolve("next/dist/pages/_error"),bundlePath:t,page:(0,_normalizepathsep.normalizePathSep)(t)};throw new _utils1.PageNotFoundError(r)}function onDemandEntryHandler({hotReloader:e,maxInactiveAge:t,multiCompiler:n,nextConfig:a,pagesBufferLength:i,pagesDir:r,rootDir:s,appDir:o}){const l=!!o;let p=getInvalidator(n.outputPath);const u=getEntries(n.outputPath);p||(p=new Invalidator(n),invalidators.set(n.outputPath,p));const c=e=>{const t=e.name;p.startBuilding(t)};for(const e of n.compilers)e.hooks.make.tap("NextJsOnDemandEntries",c);function d(e,t){const n=[];for(const i of t.values()){const t=(0,_getroutefromentrypoint.default)(i.name,l);if(t){var a;const r=(null==(a=i.name)?void 0:a.startsWith("app/"))?_pagetypes.PAGE_TYPES.APP:_pagetypes.PAGE_TYPES.PAGES;n.push(getEntryKey(e,r,t))}else((0,_utils.isMiddlewareFilename)(i.name)||(0,_utils.isInstrumentationHookFilename)(i.name))&&n.push(getEntryKey(e,_pagetypes.PAGE_TYPES.ROOT,`/${i.name}`))}return n}for(const e of n.compilers)e.hooks.done.tap("NextJsOnDemandEntries",(()=>{var t;return null==(t=getInvalidator(e.outputPath))?void 0:t.doneBuilding([e.name])}));n.hooks.done.tap("NextJsOnDemandEntries",(e=>{var t;const[a,i,r]=e.stats,s=[...d(_constants.COMPILER_NAMES.client,a.compilation.entrypoints),...d(_constants.COMPILER_NAMES.server,i.compilation.entrypoints),...r?d(_constants.COMPILER_NAMES.edgeServer,r.compilation.entrypoints):[]];for(const e of s){const t=u[e];t&&(t.status===BUILDING&&(t.status=BUILT,doneCallbacks.emit(e)))}null==(t=getInvalidator(n.outputPath))||t.doneBuilding([...COMPILER_KEYS])}));const g=Math.max(1e3,Math.min(5e3,t));function _(e){const t=getEntrypointsFromTree(e,!0);for(const e of t)for(const t of[_constants.COMPILER_NAMES.client,_constants.COMPILER_NAMES.server,_constants.COMPILER_NAMES.edgeServer]){const n=getEntryKey(t,_pagetypes.PAGE_TYPES.APP,`/${e}`),a=u[n];a&&(a.status===BUILT&&(lastServerAccessPagesForAppDir.includes(n)||(lastServerAccessPagesForAppDir.unshift(n),lastServerAccessPagesForAppDir.length>i&&lastServerAccessPagesForAppDir.pop()),a.lastActiveTime=Date.now(),a.dispose=!1))}}function h(e){const t=(0,_normalizepathsep.normalizePathSep)(e);for(const e of[_constants.COMPILER_NAMES.client,_constants.COMPILER_NAMES.server,_constants.COMPILER_NAMES.edgeServer]){const n=getEntryKey(e,_pagetypes.PAGE_TYPES.PAGES,t),a=u[n];if(a)a.status===BUILT&&(lastClientAccessPages.includes(n)||(lastClientAccessPages.unshift(n),lastClientAccessPages.length>i&&lastClientAccessPages.pop()),a.lastActiveTime=Date.now(),a.dispose=!1);else if(e===_constants.COMPILER_NAMES.client)return}}async function E({page:e,appPaths:t,definition:n,isApp:i,url:l}){const c=60,d=setTimeout((()=>{debug(`Ensuring ${e} has taken longer than ${c}s, if this continues to stall this may be a bug`)}),1e3*c);try{let c;c=n||await findPagePathData(s,e,a.pageExtensions,r,o);const d=!!o&&c.filename.startsWith(o);if("boolean"==typeof i&&i!==d)throw Error.stackTraceLimit=15,Object.defineProperty(new Error(`Ensure bailed, found path "${c.page}" does not match ensure type (${i?"app":"pages"})`),"__NEXT_ERROR_CODE",{value:"E419",enumerable:!1,configurable:!0});const g=getPageBundleType(c.bundlePath),_=e=>{const n=getEntryKey(e,g,c.page);return u[n]&&!(0,_utils.isInstrumentationHookFilename)(u[n].bundlePath)?(u[n].dispose=!1,u[n].lastActiveTime=Date.now(),u[n].status===BUILT?{entryKey:n,newEntry:!1,shouldInvalidate:!1}:{entryKey:n,newEntry:!1,shouldInvalidate:!0}):(u[n]={type:0,appPaths:t,absolutePagePath:c.filename,request:c.filename,bundlePath:c.bundlePath,dispose:!1,lastActiveTime:Date.now(),status:ADDED},{entryKey:n,newEntry:!0,shouldInvalidate:!0})},h=await(0,_entries.getStaticInfoIncludingLayouts)({page:e,pageFilePath:c.filename,isInsideAppDir:d,pageExtensions:a.pageExtensions,isDev:!0,config:a,appDir:o}),E=new Map,P=d&&h.rsc!==_constants.RSC_MODULE_TYPES.client;let f=h.runtime;(0,_utils.isMiddlewareFile)(e)&&!a.experimental.nodeMiddleware&&(f="edge"),(0,_entries.runDependingOnPageType)({page:c.page,pageRuntime:f,pageType:g,onClient:()=>{P||d||E.set(_constants.COMPILER_NAMES.client,_(_constants.COMPILER_NAMES.client))},onServer:()=>{E.set(_constants.COMPILER_NAMES.server,_(_constants.COMPILER_NAMES.server));const e=getEntryKey(_constants.COMPILER_NAMES.edgeServer,g,c.page);u[e]&&!(0,_utils.isInstrumentationHookFile)(c.page)&&delete u[e]},onEdgeServer:()=>{E.set(_constants.COMPILER_NAMES.edgeServer,_(_constants.COMPILER_NAMES.edgeServer));const e=getEntryKey(_constants.COMPILER_NAMES.server,g,c.page);u[e]&&!(0,_utils.isInstrumentationHookFile)(c.page)&&delete u[e]}});const m=[...E.values()],y=[...E.entries()].filter((([,e])=>e.shouldInvalidate));if(m.some((e=>e.newEntry))){const e=i?c.page:(0,_apppaths.normalizeAppPath)(c.page);(0,_output.reportTrigger)(e,l)}if(y.length>0){const e=Promise.all(y.map((([e,{entryKey:t}])=>new Promise(((n,a)=>{doneCallbacks.once(t,(i=>{if(i)return a(i);p.willRebuild(e)?doneCallbacks.once(t,(e=>{if(e)return a(e);n()})):n()}))})))));p.invalidate([...E.keys()]),await e}}finally{clearTimeout(d)}}setInterval((function(){disposeInactiveEntries(u,t)}),g+1e3).unref();const P=_batcher.Batcher.create({cacheKeyFn:e=>JSON.stringify(e),schedulerFn:_scheduler.scheduleOnNextTick});return{ensurePage:async({page:e,appPaths:t=null,definition:n,isApp:a,url:i})=>(!t&&n&&(0,_apppageroutedefinition.isAppPageRouteDefinition)(n)&&(t=n.appPaths),P.batch({page:e,appPaths:t,definition:n,isApp:a},(async()=>{await E({page:e,appPaths:t,definition:n,isApp:a,url:i})}))),onHMR(t,n){let a=null;t.addEventListener("close",(()=>{a=null})),t.addEventListener("message",(({data:t})=>{try{const i=n();!a&&i&&(e.send({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.SERVER_ERROR,errorJSON:(0,_utils1.stringifyError)(i)}),a=null);const r=JSON.parse("string"!=typeof t?t.toString():t);"ping"===r.event&&(r.appDirRoute?_(r.tree):h(r.page))}catch{}}))}}}