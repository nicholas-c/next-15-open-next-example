"use strict";function _export(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{default:function(){return HotReloaderWebpack},getVersionInfo:function(){return getVersionInfo},matchNextPageBundleRequest:function(){return matchNextPageBundleRequest},renderScriptError:function(){return renderScriptError}});const _webpack=require("next/dist/compiled/webpack/webpack"),_middlewarewebpack=require("../../client/components/react-dev-overlay/server/middleware-webpack"),_hotmiddleware=require("./hot-middleware"),_path=require("path"),_entries=require("../../build/entries"),_output=require("../../build/output"),_log=_interop_require_wildcard(require("../../build/output/log")),_webpackconfig=_interop_require_wildcard(require("../../build/webpack-config")),_constants=require("../../lib/constants"),_recursivedelete=require("../../lib/recursive-delete"),_constants1=require("../../shared/lib/constants"),_pathmatch=require("../../shared/lib/router/utils/path-match"),_findpagefile=require("../lib/find-page-file"),_ondemandentryhandler=require("./on-demand-entry-handler"),_denormalizepagepath=require("../../shared/lib/page-path/denormalize-page-path"),_normalizepathsep=require("../../shared/lib/page-path/normalize-path-sep"),_getroutefromentrypoint=_interop_require_default(require("../get-route-from-entrypoint")),_utils=require("../../build/utils"),_utils1=require("../../shared/lib/utils"),_trace=require("../../trace"),_iserror=require("../../lib/is-error"),_ws=_interop_require_default(require("next/dist/compiled/ws")),_fs=require("fs"),_parseversioninfo=require("./parse-version-info"),_isapiroute=require("../../lib/is-api-route"),_nextrouteloader=require("../../build/webpack/loaders/next-route-loader"),_isinternalcomponent=require("../../lib/is-internal-component"),_routekind=require("../route-kind"),_hotreloadertypes=require("./hot-reloader-types"),_pagetypes=require("../../lib/page-types"),_messages=require("./messages"),_utils2=require("../lib/utils"),_getnexterrorfeedbackmiddleware=require("../../client/components/react-dev-overlay/server/get-next-error-feedback-middleware"),_getdevoverlayfontmiddleware=require("../../client/components/react-dev-overlay/font/get-dev-overlay-font-middleware"),_devindicatormiddleware=require("./dev-indicator-middleware");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(_getRequireWildcardCache=function(e){return e?r:t})(e)}function _interop_require_wildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=_getRequireWildcardCache(t);if(r&&r.has(e))return r.get(e);var i={__proto__:null},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in e)if("default"!==n&&Object.prototype.hasOwnProperty.call(e,n)){var a=s?Object.getOwnPropertyDescriptor(e,n):null;a&&(a.get||a.set)?Object.defineProperty(i,n,a):i[n]=e[n]}return i.default=e,r&&r.set(e,i),i}const MILLISECONDS_IN_NANOSECOND=BigInt(1e6);function diff(e,t){return new Set([...e].filter((e=>!t.has(e))))}const wsServer=new _ws.default.Server({noServer:!0});async function renderScriptError(e,t,{verbose:r=!0}={}){return e.setHeader("Cache-Control","no-cache, no-store, max-age=0, must-revalidate"),"ENOENT"===t.code?{finished:void 0}:(r&&console.error(t.stack),e.statusCode=500,e.end("500 - Internal Error"),{finished:!0})}function addCorsSupport(e,t){return e.url.startsWith("/__next")&&e.headers.origin?(t.setHeader("Access-Control-Allow-Origin",e.headers.origin),t.setHeader("Access-Control-Allow-Methods","OPTIONS, GET"),e.headers["access-control-request-headers"]&&t.setHeader("Access-Control-Allow-Headers",e.headers["access-control-request-headers"]),"OPTIONS"===e.method?(t.writeHead(200),t.end(),{preflight:!0}):{preflight:!1}):{preflight:!1}}const matchNextPageBundleRequest=(0,_pathmatch.getPathMatch)("/_next/static/chunks/pages/:path*.js(\\.map|)");function findEntryModule(e,t){for(;;){const r=t.moduleGraph.getIssuer(e);if(!r)return e;e=r}}function erroredPages(e){const t={};for(const r of e.errors){if(!r.module)continue;const i=findEntryModule(r.module,e),{name:s}=i;if(!s)continue;const n=(0,_getroutefromentrypoint.default)(s);n&&(t[n]||(t[n]=[]),t[n].push(r))}return t}async function getVersionInfo(){let e="0.0.0";try{let t;e=require("next/package.json").version;try{t=await fetch("https://registry.npmjs.org/-/package/next/dist-tags")}catch{}if(!t||!t.ok)return{installed:e,staleness:"unknown"};const{latest:r,canary:i}=await t.json();return(0,_parseversioninfo.parseVersionInfo)({installed:e,latest:r,canary:i})}catch(t){return console.error(t),{installed:e,staleness:"unknown"}}}class HotReloaderWebpack{constructor(e,{config:t,pagesDir:r,distDir:i,buildId:s,encryptionKey:n,previewProps:a,rewrites:o,appDir:l,telemetry:p,resetFetch:d}){this.clientError=null,this.serverError=null,this.hmrServerError=null,this.pagesMapping={},this.versionInfo={staleness:"unknown",installed:"0.0.0"},this.reloadAfterInvalidation=!1,this.hasAmpEntrypoints=!1,this.hasAppRouterEntrypoints=!1,this.hasPagesRouterEntrypoints=!1,this.buildId=s,this.encryptionKey=n,this.dir=e,this.middlewares=[],this.pagesDir=r,this.appDir=l,this.distDir=i,this.clientStats=null,this.serverStats=null,this.edgeServerStats=null,this.serverPrevDocumentHash=null,this.telemetry=p,this.resetFetch=d,this.config=t,this.previewProps=a,this.rewrites=o,this.hotReloaderSpan=(0,_trace.trace)("hot-reloader",void 0,{version:"15.2.0"}),this.hotReloaderSpan.stop()}async run(e,t,r){const{preflight:i}=addCorsSupport(e,t);if(i)return{};const s=async(t,r)=>{const{pathname:i}=r;if(!i)return{};const s=matchNextPageBundleRequest(i);if(!s)return{};let n;try{n=`/${s.path.map((e=>decodeURIComponent(e))).join("/")}`}catch(e){throw Object.defineProperty(new _utils1.DecodeError("failed to decode param"),"__NEXT_ERROR_CODE",{value:"E528",enumerable:!1,configurable:!0})}const a=(0,_denormalizepagepath.denormalizePagePath)(n);if("/_error"===a||-1===_constants1.BLOCKED_PAGES.indexOf(a)){try{await this.ensurePage({page:a,clientOnly:!0,url:e.url})}catch(e){return await renderScriptError(t,(0,_iserror.getProperError)(e))}const r=await this.getCompilationErrors(a);if(r.length>0)return await renderScriptError(t,r[0],{verbose:!1})}return{}},{finished:n}=await s(t,r);for(const r of this.middlewares){let i=!1;if(await r(e,t,(()=>{i=!0})),!i)return{finished:!0}}return{finished:n}}setHmrServerError(e){this.hmrServerError=e}clearHmrServerError(){this.hmrServerError&&(this.setHmrServerError(null),this.send({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.RELOAD_PAGE,data:"clear hmr server error"}))}async refreshServerComponents(e){this.send({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.SERVER_COMPONENT_CHANGES,hash:e})}onHMR(e,t,r,i){wsServer.handleUpgrade(e,e.socket,r,(e=>{var t,r;null==(t=this.webpackHotMiddleware)||t.onHMR(e),null==(r=this.onDemandEntries)||r.onHMR(e,(()=>this.hmrServerError)),i(e),e.addEventListener("message",(({data:e})=>{e="string"!=typeof e?e.toString():e;try{const r=JSON.parse(e);let i;switch(r.event){case"span-end":i={name:r.spanName,startTime:BigInt(Math.floor(r.startTime))*MILLISECONDS_IN_NANOSECOND,attrs:r.attributes,endTime:BigInt(Math.floor(r.endTime))*MILLISECONDS_IN_NANOSECOND};break;case"client-hmr-latency":i={name:r.event,startTime:BigInt(r.startTime)*MILLISECONDS_IN_NANOSECOND,endTime:BigInt(r.endTime)*MILLISECONDS_IN_NANOSECOND,attrs:{updatedModules:r.updatedModules.map((e=>e.replace(`(${_constants.WEBPACK_LAYERS.appPagesBrowser})/`,"").replace(/^\.\//,"[project]/"))),page:r.page,isPageHidden:r.isPageHidden}};break;case"client-reload-page":case"client-success":i={name:r.event};break;case"client-error":i={name:r.event,attrs:{errorCount:r.errorCount}};break;case"client-warning":i={name:r.event,attrs:{warningCount:r.warningCount}};break;case"client-removed-page":case"client-added-page":i={name:r.event,attrs:{page:r.page||""}};break;case"client-full-reload":{const{event:e,stackTrace:s,hadRuntimeError:n}=r;if(i={name:e,attrs:{stackTrace:s??""}},n){_log.warn(_messages.FAST_REFRESH_RUNTIME_RELOAD);break}let a="";if(s){var t;const e=null==(t=/Aborted because (.+) is not accepted/.exec(s))?void 0:t[1];if(e)if(e.startsWith(`(${_constants.WEBPACK_LAYERS.appPagesBrowser})/`)){const t=new URL(e,"file://"),r=process.cwd(),i=t.searchParams.getAll("modules").map((e=>e.slice(r.length+1))).filter((e=>!e.startsWith("node_modules")));i.length>0&&(a=` when ${i.join(", ")} changed`)}else if(e.startsWith(`(${_constants.WEBPACK_LAYERS.pagesDirBrowser})/`)){a=` when ${e.slice(`(${_constants.WEBPACK_LAYERS.pagesDirBrowser})/`.length)} changed`}else a=` when ${e} changed`}_log.warn(`Fast Refresh had to perform a full reload${a}. Read more: https://nextjs.org/docs/messages/fast-refresh-reload`);break}}i&&this.hotReloaderSpan.manualTraceChild(i.name,i.startTime,i.endTime,{...i.attrs,clientId:r.id})}catch(e){}}))}))}async clean(e){return e.traceChild("clean").traceAsyncFn((()=>(0,_recursivedelete.recursiveDelete)((0,_path.join)(this.dir,this.config.distDir),/^cache/)))}async getWebpackConfig(e){const t=e.traceChild("get-webpack-config"),r=this.config.pageExtensions;return t.traceAsyncFn((async()=>{const e=this.pagesDir?await t.traceChild("get-page-paths").traceAsyncFn((()=>Promise.all([(0,_findpagefile.findPageFile)(this.pagesDir,"/_app",r,!1),(0,_findpagefile.findPageFile)(this.pagesDir,"/_document",r,!1)]))):[];this.pagesMapping=await t.traceChild("create-pages-mapping").traceAsyncFn((()=>(0,_entries.createPagesMapping)({isDev:!0,pageExtensions:this.config.pageExtensions,pagesType:_pagetypes.PAGE_TYPES.PAGES,pagePaths:e.filter((e=>"string"==typeof e)),pagesDir:this.pagesDir,appDir:this.appDir})));const i=await t.traceChild("create-entrypoints").traceAsyncFn((()=>(0,_entries.createEntrypoints)({appDir:this.appDir,buildId:this.buildId,config:this.config,envFiles:[],isDev:!0,pages:this.pagesMapping,pagesDir:this.pagesDir,previewMode:this.previewProps,rootDir:this.dir,pageExtensions:this.config.pageExtensions}))),s={dev:!0,buildId:this.buildId,encryptionKey:this.encryptionKey,config:this.config,pagesDir:this.pagesDir,rewrites:this.rewrites,originalRewrites:this.config._originalRewrites,originalRedirects:this.config._originalRedirects,runWebpackSpan:this.hotReloaderSpan,appDir:this.appDir};return t.traceChild("generate-webpack-config").traceAsyncFn((async()=>{const e=await(0,_webpackconfig.loadProjectInfo)({dir:this.dir,config:s.config,dev:!0});return Promise.all([(0,_webpackconfig.default)(this.dir,{...s,compilerType:_constants1.COMPILER_NAMES.client,entrypoints:i.client,...e}),(0,_webpackconfig.default)(this.dir,{...s,compilerType:_constants1.COMPILER_NAMES.server,entrypoints:i.server,...e}),(0,_webpackconfig.default)(this.dir,{...s,compilerType:_constants1.COMPILER_NAMES.edgeServer,entrypoints:i.edgeServer,...e})])}))}))}async buildFallbackError(){if(this.fallbackWatcher)return;const e=await(0,_webpackconfig.loadProjectInfo)({dir:this.dir,config:this.config,dev:!0}),t=await(0,_webpackconfig.default)(this.dir,{runWebpackSpan:this.hotReloaderSpan,dev:!0,compilerType:_constants1.COMPILER_NAMES.client,config:this.config,buildId:this.buildId,encryptionKey:this.encryptionKey,appDir:this.appDir,pagesDir:this.pagesDir,rewrites:{beforeFiles:[],afterFiles:[],fallback:[]},originalRewrites:{beforeFiles:[],afterFiles:[],fallback:[]},originalRedirects:[],isDevFallback:!0,entrypoints:(await(0,_entries.createEntrypoints)({appDir:this.appDir,buildId:this.buildId,config:this.config,envFiles:[],isDev:!0,pages:{"/_app":"next/dist/pages/_app","/_error":"next/dist/pages/_error"},pagesDir:this.pagesDir,previewMode:this.previewProps,rootDir:this.dir,pageExtensions:this.config.pageExtensions})).client,...e}),r=(0,_webpack.webpack)(t);this.fallbackWatcher=await new Promise((e=>{let i=!1;r.watch(t.watchOptions,(t=>{i||(i=!0,e(!0))}))}))}async tracedGetVersionInfo(e){return e.traceChild("get-version-info").traceAsyncFn((async()=>getVersionInfo()))}async start(){const e=this.hotReloaderSpan.traceChild("start");e.stop(),this.versionInfo=await this.tracedGetVersionInfo(e);if((0,_utils2.getNodeDebugType)()&&!this.devtoolsFrontendUrl){const e=process.debugPort;let t;try{t=(await fetch(`http://127.0.0.1:${e}/json/list`).then((e=>e.json())))[0]}catch{}t&&(this.devtoolsFrontendUrl=t.devtoolsFrontendUrl)}await this.clean(e),await _fs.promises.mkdir(this.distDir,{recursive:!0});const t=(0,_path.join)(this.distDir,"package.json");await _fs.promises.writeFile(t,'{"type": "commonjs"}'),this.activeWebpackConfigs=await this.getWebpackConfig(e);for(const e of this.activeWebpackConfigs){const t=e.entry;e.entry=async(...r)=>{var i;const s=(null==(i=this.multiCompiler)?void 0:i.outputPath)||"",n=(0,_ondemandentryhandler.getEntries)(s),a=await t(...r),o=e.name===_constants1.COMPILER_NAMES.client,l=e.name===_constants1.COMPILER_NAMES.server,p=e.name===_constants1.COMPILER_NAMES.edgeServer;return await Promise.all(Object.keys(n).map((async t=>{const r=n[t],{bundlePath:i,dispose:s}=r,d=/^(client|server|edge-server)@(app|pages|root)@(.*)/g.exec(t),[,c,,h]=d;if(c===_constants1.COMPILER_NAMES.client&&!o)return;if(c===_constants1.COMPILER_NAMES.server&&!l)return;if(c===_constants1.COMPILER_NAMES.edgeServer&&!p)return;const u=r.type===_ondemandentryhandler.EntryTypes.ENTRY,g=r.type===_ondemandentryhandler.EntryTypes.CHILD_ENTRY;if(u){if(!(!s&&(0,_fs.existsSync)(r.absolutePagePath)))return void delete n[t]}if(g&&r.absoluteEntryFilePath){if(!(!s&&(0,_fs.existsSync)(r.absoluteEntryFilePath)))return void delete n[t]}"/_error"===h&&(this.hasPagesRouterEntrypoints=!0);const _=!!this.appDir,f=_&&i.startsWith("app/"),m=u?await(0,_entries.getStaticInfoIncludingLayouts)({isInsideAppDir:f,pageExtensions:this.config.pageExtensions,pageFilePath:r.absolutePagePath,appDir:this.appDir,config:this.config,isDev:!0,page:h}):void 0;var E,v,S,y;(null==m?void 0:m.type)===_pagetypes.PAGE_TYPES.PAGES&&(!0!==(null==(v=m.config)||null==(E=v.config)?void 0:E.amp)&&"hybrid"!==(null==(y=m.config)||null==(S=y.config)?void 0:S.amp)||(this.hasAmpEntrypoints=!0));const P=f&&(null==m?void 0:m.rsc)!==_constants1.RSC_MODULE_TYPES.client,w=r.bundlePath.startsWith("pages/")?_pagetypes.PAGE_TYPES.PAGES:r.bundlePath.startsWith("app/")?_pagetypes.PAGE_TYPES.APP:_pagetypes.PAGE_TYPES.ROOT;"pages"===w&&(this.hasPagesRouterEntrypoints=!0),"app"===w&&(this.hasAppRouterEntrypoints=!0);const b=(0,_utils.isInstrumentationHookFile)(h)&&w===_pagetypes.PAGE_TYPES.ROOT;let C=null==m?void 0:m.runtime;(0,_utils.isMiddlewareFile)(h)&&!this.config.experimental.nodeMiddleware&&"nodejs"===C&&(_log.warn("nodejs runtime support for middleware requires experimental.nodeMiddleware be enabled in your next.config"),C="edge"),(0,_entries.runDependingOnPageType)({page:h,pageRuntime:C,pageType:w,onEdgeServer:()=>{if(!p||!u)return;if(n[t].status=_ondemandentryhandler.BUILDING,b){const e=i.replace("src/","");return void(a[e]=(0,_entries.finalizeEntrypoint)({compilerType:_constants1.COMPILER_NAMES.edgeServer,name:e,value:(0,_entries.getInstrumentationEntry)({absolutePagePath:r.absolutePagePath,isEdgeServer:!0,isDev:!0}),isServerComponent:!0,hasAppDir:_}))}const e=f?(0,_entries.getAppEntry)({name:i,page:h,appPaths:r.appPaths,pagePath:_path.posix.join(_constants.APP_DIR_ALIAS,(0,_path.relative)(this.appDir,r.absolutePagePath).replace(/\\/g,"/")),appDir:this.appDir,pageExtensions:this.config.pageExtensions,rootDir:this.dir,isDev:!0,tsconfigPath:this.config.typescript.tsconfigPath,basePath:this.config.basePath,assetPrefix:this.config.assetPrefix,nextConfigOutput:this.config.output,preferredRegion:null==m?void 0:m.preferredRegion,middlewareConfig:Buffer.from(JSON.stringify((null==m?void 0:m.middleware)||{})).toString("base64")}).import:void 0;a[i]=(0,_entries.finalizeEntrypoint)({compilerType:_constants1.COMPILER_NAMES.edgeServer,name:i,value:(0,_entries.getEdgeServerEntry)({absolutePagePath:r.absolutePagePath,rootDir:this.dir,buildId:this.buildId,bundlePath:i,config:this.config,isDev:!0,page:h,pages:this.pagesMapping,isServerComponent:P,appDirLoader:e,pagesType:f?_pagetypes.PAGE_TYPES.APP:_pagetypes.PAGE_TYPES.PAGES,preferredRegion:null==m?void 0:m.preferredRegion}),hasAppDir:_})},onClient:()=>{o&&(g?(n[t].status=_ondemandentryhandler.BUILDING,a[i]=(0,_entries.finalizeEntrypoint)({name:i,compilerType:_constants1.COMPILER_NAMES.client,value:r.request,hasAppDir:_})):(n[t].status=_ondemandentryhandler.BUILDING,a[i]=(0,_entries.finalizeEntrypoint)({name:i,compilerType:_constants1.COMPILER_NAMES.client,value:(0,_entries.getClientEntry)({absolutePagePath:r.absolutePagePath,page:h}),hasAppDir:_})))},onServer:()=>{if(!l||!u)return;n[t].status=_ondemandentryhandler.BUILDING;let s,o=(0,_path.relative)(e.context,r.absolutePagePath);(0,_path.isAbsolute)(o)||o.startsWith("../")||(o=`./${o}`),b?(s=(0,_entries.getInstrumentationEntry)({absolutePagePath:r.absolutePagePath,isEdgeServer:!1,isDev:!0}),a[i]=(0,_entries.finalizeEntrypoint)({compilerType:_constants1.COMPILER_NAMES.server,name:i,isServerComponent:!0,value:s,hasAppDir:_})):s=(0,_utils.isMiddlewareFile)(h)?(0,_entries.getEdgeServerEntry)({absolutePagePath:r.absolutePagePath,rootDir:this.dir,buildId:this.buildId,bundlePath:i,config:this.config,isDev:!0,page:h,pages:this.pagesMapping,isServerComponent:P,pagesType:_pagetypes.PAGE_TYPES.PAGES,preferredRegion:null==m?void 0:m.preferredRegion}):f?(0,_entries.getAppEntry)({name:i,page:h,appPaths:r.appPaths,pagePath:_path.posix.join(_constants.APP_DIR_ALIAS,(0,_path.relative)(this.appDir,r.absolutePagePath).replace(/\\/g,"/")),appDir:this.appDir,pageExtensions:this.config.pageExtensions,rootDir:this.dir,isDev:!0,tsconfigPath:this.config.typescript.tsconfigPath,basePath:this.config.basePath,assetPrefix:this.config.assetPrefix,nextConfigOutput:this.config.output,preferredRegion:null==m?void 0:m.preferredRegion,middlewareConfig:Buffer.from(JSON.stringify((null==m?void 0:m.middleware)||{})).toString("base64")}):(0,_isapiroute.isAPIRoute)(h)?(0,_nextrouteloader.getRouteLoaderEntry)({kind:_routekind.RouteKind.PAGES_API,page:h,absolutePagePath:o,preferredRegion:null==m?void 0:m.preferredRegion,middlewareConfig:(null==m?void 0:m.middleware)||{}}):(0,_utils.isMiddlewareFile)(h)||(0,_isinternalcomponent.isInternalComponent)(o)||(0,_isinternalcomponent.isNonRoutePagesPage)(h)||b?o:(0,_nextrouteloader.getRouteLoaderEntry)({kind:_routekind.RouteKind.PAGES,page:h,pages:this.pagesMapping,absolutePagePath:o,preferredRegion:null==m?void 0:m.preferredRegion,middlewareConfig:(null==m?void 0:m.middleware)??{}}),a[i]=(0,_entries.finalizeEntrypoint)({compilerType:_constants1.COMPILER_NAMES.server,name:i,isServerComponent:P,value:s,hasAppDir:_})}})}))),this.hasAmpEntrypoints||delete a[_constants1.CLIENT_STATIC_FILES_RUNTIME_AMP],this.hasPagesRouterEntrypoints||(delete a[_constants1.CLIENT_STATIC_FILES_RUNTIME_MAIN],delete a["pages/_app"],delete a["pages/_error"],delete a["/_error"],delete a["pages/_document"]),this.hasAmpEntrypoints||this.hasPagesRouterEntrypoints||delete a[_constants1.CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH],this.hasAppRouterEntrypoints||delete a[_constants1.CLIENT_STATIC_FILES_RUNTIME_MAIN_APP],a}}this.activeWebpackConfigs.parallelism=1,this.multiCompiler=(0,_webpack.webpack)(this.activeWebpackConfigs);const r=this.multiCompiler.compilers[0].inputFileSystem;for(const e of this.multiCompiler.compilers)e.inputFileSystem=r,e.fsStartTime=Date.now(),e.hooks.beforeRun.intercept({register:e=>"NodeEnvironmentPlugin"===e.name?null:e});this.multiCompiler.hooks.done.tap("NextjsHotReloader",(()=>{var e;null==r||null==(e=r.purge)||e.call(r)})),(0,_output.watchCompilers)(this.multiCompiler.compilers[0],this.multiCompiler.compilers[1],this.multiCompiler.compilers[2]);const i=new Set,s=new Set,n=new Set,a=new Set,o=new Set,l=new Map,p=new Map,d=new Map,c=new Map,h=new RegExp(`\\.(?:${this.config.pageExtensions.join("|")})$`),u=(e,t,r)=>i=>{try{i.entrypoints.forEach(((s,n)=>{(n.startsWith("pages/")||n.startsWith("app/")||(0,_utils.isMiddlewareFilename)(n))&&s.chunks.forEach((s=>{if(s.id===n){const a=i.chunkGraph.getChunkModulesIterable(s);let l=!1,p=new _webpack.StringXor,d=new _webpack.StringXor;a.forEach((e=>{if(e.resource&&e.resource.replace(/\\/g,"/").includes(n)&&h.test(e.resource)){var t,r;const i=require("crypto").createHash("sha1").update(e.originalSource().buffer()).digest().toString("hex");e.layer===_constants.WEBPACK_LAYERS.reactServerComponents&&"client"!==(null==e||null==(r=e.buildInfo)||null==(t=r.rsc)?void 0:t.type)&&d.add(i),p.add(i)}else{var a,o;const t=i.chunkGraph.getModuleHash(e,s.runtime);if(e.layer===_constants.WEBPACK_LAYERS.reactServerComponents&&"client"!==(null==e||null==(o=e.buildInfo)||null==(a=o.rsc)?void 0:a.type)&&d.add(t),p.add(t),n.startsWith("app/")&&/\.(css|scss|sass)$/.test(e.resource||"")){const r=e.layer+":"+e.resource,i=c.get(r);i&&i!==t&&(l=!0),c.set(r,t)}}}));const u=e.get(n),g=p.toString();if(u&&u!==g&&t.add(n),e.set(n,g),r){const t=_constants.WEBPACK_LAYERS.reactServerComponents+":"+n,i=e.get(t),s=d.toString();i&&i!==s&&r.add(n),e.set(t,s)}l&&o.add(n)}}))}))}catch(e){console.error(e)}};this.multiCompiler.compilers[0].hooks.emit.tap("NextjsHotReloaderForClient",u(l,i)),this.multiCompiler.compilers[1].hooks.emit.tap("NextjsHotReloaderForServer",u(p,s,a)),this.multiCompiler.compilers[2].hooks.emit.tap("NextjsHotReloaderForServer",u(d,n,a)),this.multiCompiler.compilers[1].hooks.failed.tap("NextjsHotReloaderForServer",(e=>{this.serverError=e,this.serverStats=null,this.serverChunkNames=void 0})),this.multiCompiler.compilers[2].hooks.done.tap("NextjsHotReloaderForServer",(e=>{this.serverError=null,this.edgeServerStats=e})),this.multiCompiler.compilers[1].hooks.done.tap("NextjsHotReloaderForServer",(e=>{if(this.serverError=null,this.serverStats=e,!this.pagesDir)return;const{compilation:t}=e,r=t.namedChunks.get("pages/_document");if(r)if(null!==this.serverPrevDocumentHash){if(r.hash!==this.serverPrevDocumentHash){if(this.appDir){const e=new Set(t.namedChunks.keys()),r=(0,_utils.difference)(this.serverChunkNames||new Set,e);if(0===r.length||r.every((e=>e.startsWith("app/"))))return;this.serverChunkNames=e}this.serverPrevDocumentHash=r.hash||null,this.send({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.RELOAD_PAGE,data:"_document has changed"})}}else this.serverPrevDocumentHash=r.hash||null})),this.multiCompiler.hooks.done.tap("NextjsHotReloaderForServer",(e=>{const t=this.reloadAfterInvalidation;this.reloadAfterInvalidation=!1;const r=(0,_utils.difference)(s,i),l=(0,_utils.difference)(n,i),p=r.concat(l).filter((e=>e.startsWith("pages/")));[...Array.from(n),...Array.from(s)].filter((e=>(0,_utils.isMiddlewareFilename)(e))).length>0&&this.send({event:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.MIDDLEWARE_CHANGES}),p.length>0&&this.send({event:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.SERVER_ONLY_CHANGES,pages:r.map((e=>(0,_denormalizepagepath.denormalizePagePath)(e.slice("pages".length))))}),(a.size||o.size||t)&&(this.resetFetch(),this.refreshServerComponents(e.hash)),i.clear(),s.clear(),n.clear(),a.clear(),o.clear()})),this.multiCompiler.compilers[0].hooks.failed.tap("NextjsHotReloaderForClient",(e=>{this.clientError=e,this.clientStats=null})),this.multiCompiler.compilers[0].hooks.done.tap("NextjsHotReloaderForClient",(e=>{this.clientError=null,this.clientStats=e;const{compilation:t}=e,r=new Set([...t.namedChunks.keys()].filter((e=>!!(0,_getroutefromentrypoint.default)(e))));if(this.prevChunkNames){const e=diff(r,this.prevChunkNames),t=diff(this.prevChunkNames,r);if(e.size>0)for(const t of e){const e=(0,_getroutefromentrypoint.default)(t);this.send({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.ADDED_PAGE,data:[e]})}if(t.size>0)for(const e of t){const t=(0,_getroutefromentrypoint.default)(e);this.send({action:_hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.REMOVED_PAGE,data:[t]})}}this.prevChunkNames=r})),this.webpackHotMiddleware=new _hotmiddleware.WebpackHotMiddleware(this.multiCompiler.compilers,this.versionInfo,this.devtoolsFrontendUrl);let g=!1;this.watcher=await new Promise((e=>{var t;const r=null==(t=this.multiCompiler)?void 0:t.watch(this.activeWebpackConfigs.map((e=>e.watchOptions)),(t=>{g||(g=!0,e(r))}))})),this.onDemandEntries=(0,_ondemandentryhandler.onDemandEntryHandler)({hotReloader:this,multiCompiler:this.multiCompiler,pagesDir:this.pagesDir,appDir:this.appDir,rootDir:this.dir,nextConfig:this.config,...this.config.onDemandEntries}),this.middlewares=[(0,_middlewarewebpack.getOverlayMiddleware)({rootDirectory:this.dir,clientStats:()=>this.clientStats,serverStats:()=>this.serverStats,edgeServerStats:()=>this.edgeServerStats}),(0,_middlewarewebpack.getSourceMapMiddleware)({clientStats:()=>this.clientStats,serverStats:()=>this.serverStats,edgeServerStats:()=>this.edgeServerStats}),(0,_getnexterrorfeedbackmiddleware.getNextErrorFeedbackMiddleware)(this.telemetry),(0,_getdevoverlayfontmiddleware.getDevOverlayFontMiddleware)(),(0,_devindicatormiddleware.getDisableDevIndicatorMiddleware)()]}invalidate({reloadAfterInvalidation:e}={reloadAfterInvalidation:!1}){var t;this.reloadAfterInvalidation=e;const r=null==(t=this.multiCompiler)?void 0:t.outputPath;var i;r&&(null==(i=(0,_ondemandentryhandler.getInvalidator)(r))||i.invalidate())}async getCompilationErrors(e){var t,r,i;const s=({compilation:t})=>{var r;const i=erroredPages(t),s=(0,_normalizepathsep.normalizePathSep)(e);return(null==(r=i[s])?void 0:r.length)>0?i[s]:t.errors};return this.clientError?[this.clientError]:this.serverError?[this.serverError]:(null==(t=this.clientStats)?void 0:t.hasErrors())?s(this.clientStats):(null==(r=this.serverStats)?void 0:r.hasErrors())?s(this.serverStats):(null==(i=this.edgeServerStats)?void 0:i.hasErrors())?s(this.edgeServerStats):[]}send(e){this.webpackHotMiddleware.publish(e)}async ensurePage({page:e,clientOnly:t,appPaths:r,definition:i,isApp:s,url:n}){return this.hotReloaderSpan.traceChild("ensure-page",{inputPage:e}).traceAsyncFn((async()=>{var a;if("/_error"!==e&&-1!==_constants1.BLOCKED_PAGES.indexOf(e))return;const o=t?this.clientError:this.serverError||this.clientError;if(o)throw o;return null==(a=this.onDemandEntries)?void 0:a.ensurePage({page:e,appPaths:r,definition:i,isApp:s,url:n})}))}close(){var e;null==(e=this.webpackHotMiddleware)||e.close()}}