"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return NextNodeServer}}),require("./node-environment"),require("./require-hook"),require("./node-polyfill-crypto");const _utils=require("../shared/lib/utils"),_fs=_interop_require_default(require("fs")),_path=require("path"),_routematcher=require("../shared/lib/router/utils/route-matcher"),_requestmeta=require("./request-meta"),_constants=require("../shared/lib/constants"),_findpagesdir=require("../lib/find-pages-dir"),_node=require("./base-http/node"),_sendpayload=require("./send-payload"),_parseurl=require("../shared/lib/router/utils/parse-url"),_log=_interop_require_wildcard(require("../build/output/log")),_baseserver=_interop_require_wildcard(_export_star(require("./base-server"),exports)),_require=require("./require"),_denormalizepagepath=require("../shared/lib/page-path/denormalize-page-path"),_normalizepagepath=require("../shared/lib/page-path/normalize-page-path"),_loadcomponents=require("./load-components"),_iserror=_interop_require_wildcard(require("../lib/is-error")),_utils1=require("./web/utils"),_middlewareroutematcher=require("../shared/lib/router/utils/middleware-route-matcher"),_env=require("@next/env"),_querystring=require("../shared/lib/router/utils/querystring"),_removetrailingslash=require("../shared/lib/router/utils/remove-trailing-slash"),_getnextpathnameinfo=require("../shared/lib/router/utils/get-next-pathname-info"),_bodystreams=require("./body-streams"),_apiutils=require("./api-utils"),_responsecache=_interop_require_wildcard(require("./response-cache")),_incrementalcache=require("./lib/incremental-cache"),_apppaths=require("../shared/lib/router/utils/app-paths"),_setuphttpagentenv=require("./setup-http-agent-env"),_pagesapiroutematch=require("./route-matches/pages-api-route-match"),_constants1=require("../lib/constants"),_tracer=require("./lib/trace/tracer"),_constants2=require("./lib/trace/constants"),_nodefsmethods=require("./lib/node-fs-methods"),_routeregex=require("../shared/lib/router/utils/route-regex"),_pipereadable=require("./pipe-readable"),_mockrequest=require("./lib/mock-request"),_approuterheaders=require("../client/components/app-router-headers"),_nextrequest=require("./web/spec-extension/adapters/next-request"),_routemoduleloader=require("./lib/module-loader/route-module-loader"),_loadmanifest=require("./load-manifest"),_modulerender=require("./route-modules/app-page/module.render"),_modulerender1=require("./route-modules/pages/module.render"),_interopdefault=require("../lib/interop-default"),_formatdynamicimportpath=require("../lib/format-dynamic-import-path"),_generateinterceptionroutesrewrites=require("../lib/generate-interception-routes-rewrites"),_routekind=require("./route-kind"),_invarianterror=require("../shared/lib/invariant-error"),_awaiter=require("./after/awaiter"),_asynccallbackset=require("./lib/async-callback-set"),_handlers=require("./use-cache/handlers");function _export_star(e,t){return Object.keys(e).forEach((function(r){"default"===r||Object.prototype.hasOwnProperty.call(t,r)||Object.defineProperty(t,r,{enumerable:!0,get:function(){return e[r]}})})),e}function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(_getRequireWildcardCache=function(e){return e?r:t})(e)}function _interop_require_wildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=_getRequireWildcardCache(t);if(r&&r.has(e))return r.get(e);var i={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in e)if("default"!==n&&Object.prototype.hasOwnProperty.call(e,n)){var s=a?Object.getOwnPropertyDescriptor(e,n):null;s&&(s.get||s.set)?Object.defineProperty(i,n,s):i[n]=e[n]}return i.default=e,r&&r.set(e,i),i}const dynamicImportEsmDefault=(process.env.NEXT_MINIMAL,e=>import(e).then((e=>e.default||e))),dynamicRequire=process.env.NEXT_MINIMAL?__non_webpack_require__:require,MiddlewareMatcherCache=new WeakMap;function getMiddlewareMatcher(e){const t=MiddlewareMatcherCache.get(e);if(t)return t;if(!Array.isArray(e.matchers))throw Object.defineProperty(new Error(`Invariant: invalid matchers for middleware ${JSON.stringify(e)}`),"__NEXT_ERROR_CODE",{value:"E257",enumerable:!1,configurable:!0});const r=(0,_middlewareroutematcher.getMiddlewareRouteMatcher)(e.matchers);return MiddlewareMatcherCache.set(e,r),r}class NextNodeServer extends _baseserver.default{constructor(e){var t,r;super(e),this.registeredInstrumentation=!1,this.cleanupListeners=new _asynccallbackset.AsyncCallbackSet,this.handleNextImageRequest=async(e,t,r)=>{if(!r.pathname||!r.pathname.startsWith("/_next/image"))return!1;if((0,_requestmeta.getRequestMeta)(e,"middlewareInvoke"))return!1;if(this.minimalMode||"export"===this.nextConfig.output||process.env.NEXT_MINIMAL)return t.statusCode=400,t.body("Bad Request").send(),!0;{const{ImageOptimizerCache:a}=require("./image-optimizer"),n=new a({distDir:this.distDir,nextConfig:this.nextConfig}),{sendResponse:s,ImageError:o}=require("./image-optimizer");if(!this.imageResponseCache)throw Object.defineProperty(new Error("invariant image optimizer cache was not initialized"),"__NEXT_ERROR_CODE",{value:"E160",enumerable:!1,configurable:!0});const d=this.nextConfig.images;if("default"!==d.loader||d.unoptimized)return await this.render404(e,t),!0;const l=a.validateParams(e.originalRequest,r.query,this.nextConfig,!!this.renderOpts.dev);if("errorMessage"in l)return t.statusCode=400,t.body(l.errorMessage).send(),!0;const u=a.getCacheKey(l);try{var i;const{getExtension:r}=require("./serve-static"),a=await this.imageResponseCache.get(u,(async({previousCacheEntry:i})=>{const{buffer:a,contentType:n,maxAge:s,upstreamEtag:o,etag:d}=await this.imageOptimizer(e,t,l,i);return{value:{kind:_responsecache.CachedRouteKind.IMAGE,buffer:a,etag:d,extension:r(n),upstreamEtag:o},isFallback:!1,revalidate:s}}),{routeKind:_routekind.RouteKind.IMAGE,incrementalCache:n,isFallback:!1});if((null==a||null==(i=a.value)?void 0:i.kind)!==_responsecache.CachedRouteKind.IMAGE)throw Object.defineProperty(new Error("invariant did not get entry from image response cache"),"__NEXT_ERROR_CODE",{value:"E518",enumerable:!1,configurable:!0});return s(e.originalRequest,t.originalResponse,l.href,a.value.extension,a.value.buffer,a.value.etag,l.isStatic,a.isMiss?"MISS":a.isStale?"STALE":"HIT",d,a.revalidate||0,Boolean(this.renderOpts.dev)),!0}catch(e){if(e instanceof o)return t.statusCode=e.statusCode,t.body(e.message).send(),!0;throw e}}},this.handleCatchallRenderRequest=async(e,t,r)=>{let{pathname:i,query:a}=r;if(!i)throw Object.defineProperty(new Error("Invariant: pathname is undefined"),"__NEXT_ERROR_CODE",{value:"E409",enumerable:!1,configurable:!0});(0,_requestmeta.addRequestMeta)(e,"bubbleNoFallback",!0);try{var n;i=(0,_removetrailingslash.removeTrailingSlash)(i);const s={i18n:null==(n=this.i18nProvider)?void 0:n.fromRequest(e,i)},o=await this.matchers.match(i,s);if(!o)return await this.render(e,t,i,a,r,!0),!0;(0,_requestmeta.addRequestMeta)(e,"match",o);const d=this.getEdgeFunctionsPages();for(const i of d)if(i===o.definition.page){if("export"===this.nextConfig.output)return await this.render404(e,t,r),!0;delete a[_approuterheaders.NEXT_RSC_UNION_QUERY];try{if(await this.runEdgeFunction({req:e,res:t,query:a,params:o.params,page:o.definition.page,match:o,appPaths:null}))return!0}catch(t){throw await this.instrumentationOnRequestError(t,e,{routePath:o.definition.page,routerKind:"Pages Router",routeType:"route",revalidateReason:void 0}),t}}if((0,_pagesapiroutematch.isPagesAPIRouteMatch)(o)){if("export"===this.nextConfig.output)return await this.render404(e,t,r),!0;if(await this.handleApiRequest(e,t,a,o))return!0}return await this.render(e,t,i,a,r,!0),!0}catch(r){if(r instanceof _baseserver.NoFallbackError)throw r;try{if(this.renderOpts.dev){const{formatServerError:e}=require("../lib/format-server-error");e(r),this.logErrorWithOriginalStack(r)}else this.logError(r);return t.statusCode=500,await this.renderError(r,e,t,i,a),!0}catch{}throw r}},this.handleCatchallMiddlewareRequest=async(e,t,r)=>{const i=(0,_requestmeta.getRequestMeta)(e,"middlewareInvoke");if(!i)return!1;const a=()=>((0,_requestmeta.addRequestMeta)(e,"middlewareInvoke",!0),t.body("").send(),!0),n=await this.getMiddleware();if(!n)return a();const s=(0,_requestmeta.getRequestMeta)(e,"initURL"),o=(0,_parseurl.parseUrl)(s),d=(0,_getnextpathnameinfo.getNextPathnameInfo)(o.pathname,{nextConfig:this.nextConfig,i18nProvider:this.i18nProvider});o.pathname=d.pathname;const l=(0,_removetrailingslash.removeTrailingSlash)(r.pathname||"");if(!n.match(l,e,o.query))return a();let u,h=!1;try{if(await this.ensureMiddleware(e.url),u=await this.runMiddleware({request:e,response:t,parsedUrl:o,parsed:r}),"response"in u){if(i)throw h=!0,Object.defineProperty(new _tracer.BubbledError(!0,u),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});for(const[e,r]of Object.entries((0,_utils1.toNodeOutgoingHttpHeaders)(u.response.headers)))"content-encoding"!==e&&void 0!==r&&t.setHeader(e,r);t.statusCode=u.response.status;const{originalResponse:e}=t;return u.response.body?await(0,_pipereadable.pipeToNodeResponse)(u.response.body,e):e.end(),!0}}catch(i){if(h)throw i;if((0,_iserror.default)(i)&&"ENOENT"===i.code)return await this.render404(e,t,r),!0;if(i instanceof _utils.DecodeError)return t.statusCode=400,await this.renderError(i,e,t,r.pathname||""),!0;const a=(0,_iserror.getProperError)(i);return console.error(a),t.statusCode=500,await this.renderError(a,e,t,r.pathname||""),!0}return u.finished},this.isDev=e.dev??!1,this.sriEnabled=Boolean(null==(r=e.conf.experimental)||null==(t=r.sri)?void 0:t.algorithm),this.renderOpts.optimizeCss&&(process.env.__NEXT_OPTIMIZE_CSS=JSON.stringify(!0)),this.renderOpts.nextScriptWorkers&&(process.env.__NEXT_SCRIPT_WORKERS=JSON.stringify(!0)),process.env.NEXT_DEPLOYMENT_ID=this.nextConfig.deploymentId||"",this.minimalMode||(this.imageResponseCache=new _responsecache.default(this.minimalMode));const{appDocumentPreloading:i}=this.nextConfig.experimental,a=void 0===i;if(e.dev||!0!==i&&this.minimalMode&&a||((0,_loadcomponents.loadComponents)({distDir:this.distDir,page:"/_document",isAppPath:!1,isDev:this.isDev,sriEnabled:this.sriEnabled}).catch((()=>{})),(0,_loadcomponents.loadComponents)({distDir:this.distDir,page:"/_app",isAppPath:!1,isDev:this.isDev,sriEnabled:this.sriEnabled}).catch((()=>{}))),e.dev||this.minimalMode||!this.nextConfig.experimental.preloadEntriesOnStart||this.unstable_preloadEntries(),!e.dev){const{dynamicRoutes:e=[]}=this.getRoutesManifest()??{};this.dynamicRoutes=e.map((e=>{const t=(0,_routeregex.getRouteRegex)(e.page);return{match:(0,_routematcher.getRouteMatcher)(t),page:e.page,re:t.re}}))}if((0,_setuphttpagentenv.setHttpClientAndAgentOptions)(this.nextConfig),this.serverOptions.experimentalTestProxy){process.env.NEXT_PRIVATE_TEST_PROXY="true";const{interceptTestApis:e}=require("next/dist/experimental/testmode/server");e()}this.middlewareManifestPath=(0,_path.join)(this.serverDistDir,_constants.MIDDLEWARE_MANIFEST),e.dev||this.prepare().catch((e=>{console.error("Failed to prepare server",e)}))}async unstable_preloadEntries(){const e=this.getAppPathsManifest(),t=this.getPagesManifest();await this.loadCustomCacheHandlers();for(const e of Object.keys(t||{}))await(0,_loadcomponents.loadComponents)({distDir:this.distDir,page:e,isAppPath:!1,isDev:this.isDev,sriEnabled:this.sriEnabled}).catch((()=>{}));for(const t of Object.keys(e||{}))await(0,_loadcomponents.loadComponents)({distDir:this.distDir,page:t,isAppPath:!0,isDev:this.isDev,sriEnabled:this.sriEnabled}).then((async({ComponentMod:e})=>{e.patchFetch();const t=e.__next_app__.require;if(null==t?void 0:t.m)for(const e of Object.keys(t.m))await t(e)})).catch((()=>{}))}async handleUpgrade(){}async loadInstrumentationModule(){if(!this.serverOptions.dev)try{this.instrumentation=await dynamicRequire((0,_path.resolve)(this.serverOptions.dir||".",this.serverOptions.conf.distDir,"server",_constants1.INSTRUMENTATION_HOOK_FILENAME))}catch(e){if("MODULE_NOT_FOUND"!==e.code)throw Object.defineProperty(new Error("An error occurred while loading the instrumentation hook",{cause:e}),"__NEXT_ERROR_CODE",{value:"E92",enumerable:!1,configurable:!0})}return this.instrumentation}async prepareImpl(){await super.prepareImpl(),await this.runInstrumentationHookIfAvailable()}async runInstrumentationHookIfAvailable(){var e,t;this.registeredInstrumentation||(this.registeredInstrumentation=!0,await(null==(t=this.instrumentation)||null==(e=t.register)?void 0:e.call(t)))}loadEnvConfig({dev:e,forceReload:t,silent:r}){(0,_env.loadEnvConfig)(this.dir,e,r?{info:()=>{},error:()=>{}}:_log,t)}async loadCustomCacheHandlers(){const{cacheHandlers:e}=this.nextConfig.experimental;if(e&&(0,_handlers.initializeCacheHandlers)())for(const[t,r]of Object.entries(e))r&&(0,_handlers.setCacheHandler)(t,(0,_interopdefault.interopDefault)(await dynamicImportEsmDefault((0,_formatdynamicimportpath.formatDynamicImportPath)(this.distDir,r))))}async getIncrementalCache({requestHeaders:e,requestProtocol:t}){const r=!!this.renderOpts.dev;let i;const{cacheHandler:a}=this.nextConfig;return a&&(i=(0,_interopdefault.interopDefault)(await dynamicImportEsmDefault((0,_formatdynamicimportpath.formatDynamicImportPath)(this.distDir,a)))),await this.loadCustomCacheHandlers(),new _incrementalcache.IncrementalCache({fs:this.getCacheFilesystem(),dev:r,requestHeaders:e,requestProtocol:t,allowedRevalidateHeaderKeys:this.nextConfig.experimental.allowedRevalidateHeaderKeys,minimalMode:this.minimalMode,serverDistDir:this.serverDistDir,fetchCacheKeyPrefix:this.nextConfig.experimental.fetchCacheKeyPrefix,maxMemoryCacheSize:this.nextConfig.cacheMaxMemorySize,flushToDisk:!this.minimalMode&&this.nextConfig.experimental.isrFlushToDisk,getPrerenderManifest:()=>this.getPrerenderManifest(),CurCacheHandler:i})}getResponseCache(){return new _responsecache.default(this.minimalMode)}getPublicDir(){return(0,_path.join)(this.dir,_constants.CLIENT_PUBLIC_FILES_PATH)}getHasStaticDir(){return _fs.default.existsSync((0,_path.join)(this.dir,"static"))}getPagesManifest(){return(0,_loadmanifest.loadManifest)((0,_path.join)(this.serverDistDir,_constants.PAGES_MANIFEST))}getAppPathsManifest(){if(this.enabledDirectories.app)return(0,_loadmanifest.loadManifest)((0,_path.join)(this.serverDistDir,_constants.APP_PATHS_MANIFEST))}getinterceptionRoutePatterns(){if(!this.enabledDirectories.app)return[];const e=this.getRoutesManifest();return(null==e?void 0:e.rewrites.beforeFiles.filter(_generateinterceptionroutesrewrites.isInterceptionRouteRewrite).map((e=>new RegExp(e.regex))))??[]}async hasPage(e){var t;return!!(0,_require.getMaybePagePath)(e,this.distDir,null==(t=this.nextConfig.i18n)?void 0:t.locales,this.enabledDirectories.app)}getBuildId(){const e=(0,_path.join)(this.distDir,_constants.BUILD_ID_FILE);try{return _fs.default.readFileSync(e,"utf8").trim()}catch(e){if("ENOENT"===e.code)throw Object.defineProperty(new Error(`Could not find a production build in the '${this.distDir}' directory. Try building your app with 'next build' before starting the production server. https://nextjs.org/docs/messages/production-start-no-build-id`),"__NEXT_ERROR_CODE",{value:"E427",enumerable:!1,configurable:!0});throw e}}getEnabledDirectories(e){const t=e?this.dir:this.serverDistDir;return{app:!!(0,_findpagesdir.findDir)(t,"app"),pages:!!(0,_findpagesdir.findDir)(t,"pages")}}sendRenderResult(e,t,r){return(0,_sendpayload.sendRenderResult)({req:e.originalRequest,res:t.originalResponse,result:r.result,type:r.type,generateEtags:r.generateEtags,poweredByHeader:r.poweredByHeader,revalidate:r.revalidate,expireTime:r.expireTime})}async runApi(e,t,r,i){const a=this.getEdgeFunctionsPages();for(const n of a)if(n===i.definition.pathname){if(await this.runEdgeFunction({req:e,res:t,query:r,params:i.params,page:i.definition.pathname,appPaths:null}))return!0}const n=await _routemoduleloader.RouteModuleLoader.load(i.definition.filename);return r={...r,...i.params},await n.render(e.originalRequest,t.originalResponse,{previewProps:this.renderOpts.previewProps,revalidate:this.revalidate.bind(this),trustHostHeader:this.nextConfig.experimental.trustHostHeader,allowedRevalidateHeaderKeys:this.nextConfig.experimental.allowedRevalidateHeaderKeys,hostname:this.fetchHostname,minimalMode:this.minimalMode,dev:!0===this.renderOpts.dev,query:r,params:i.params,page:i.definition.pathname,onError:this.instrumentationOnRequestError.bind(this),multiZoneDraftMode:this.nextConfig.experimental.multiZoneDraftMode}),!0}async renderHTML(e,t,r,i,a){return(0,_tracer.getTracer)().trace(_constants2.NextNodeServerSpan.renderHTML,(async()=>this.renderHTMLImpl(e,t,r,i,a)))}async renderHTMLImpl(e,t,r,i,a){if(process.env.NEXT_MINIMAL)throw Object.defineProperty(new Error("Invariant: renderHTML should not be called in minimal mode"),"__NEXT_ERROR_CODE",{value:"E472",enumerable:!1,configurable:!0});return a.nextFontManifest=this.nextFontManifest,this.enabledDirectories.app&&a.isAppPath?(0,_modulerender.lazyRenderAppPage)(e,t,r,i,null,a,this.getServerComponentsHmrCache(),!1,{buildId:this.buildId}):(0,_modulerender1.lazyRenderPagesPage)(e.originalRequest,t.originalResponse,r,i,a,{buildId:this.buildId,deploymentId:this.nextConfig.deploymentId,customServer:this.serverOptions.customServer||void 0},{isFallback:!1,isDraftMode:a.isDraftMode,developmentNotFoundSourcePage:(0,_requestmeta.getRequestMeta)(e,"developmentNotFoundSourcePage")})}async imageOptimizer(e,t,r,i){if(process.env.NEXT_MINIMAL)throw Object.defineProperty(new Error("invariant: imageOptimizer should not be called in minimal mode"),"__NEXT_ERROR_CODE",{value:"E506",enumerable:!1,configurable:!0});{const{imageOptimizer:a,fetchExternalImage:n,fetchInternalImage:s}=require("./image-optimizer"),o=async(t,r)=>{if(t.url===e.url)throw Object.defineProperty(new Error("Invariant attempted to optimize _next/image itself"),"__NEXT_ERROR_CODE",{value:"E496",enumerable:!1,configurable:!0});if(!this.routerServerHandler)throw Object.defineProperty(new Error("Invariant missing routerServerHandler"),"__NEXT_ERROR_CODE",{value:"E317",enumerable:!1,configurable:!0});await this.routerServerHandler(t,r)},{isAbsolute:d,href:l}=r;return a(d?await n(l):await s(l,e.originalRequest,t.originalResponse,o),r,this.nextConfig,{isDev:this.renderOpts.dev,previousCacheEntry:i})}}getPagePath(e,t){return(0,_require.getPagePath)(e,this.distDir,t,this.enabledDirectories.app)}async renderPageComponent(e,t){const r=this.getEdgeFunctionsPages()||[];if(r.length){const t=this.getOriginalAppPaths(e.pathname),i=Array.isArray(t);let a=e.pathname;i&&(a=t[0]);for(const i of r)if(i===a)return await this.runEdgeFunction({req:e.req,res:e.res,query:e.query,params:e.renderOpts.params,page:a,appPaths:t}),null}return super.renderPageComponent(e,t)}async findPageComponents({locale:e,page:t,query:r,params:i,isAppPath:a,url:n}){return(0,_tracer.getTracer)().trace(_constants2.NextNodeServerSpan.findPageComponents,{spanName:"resolve page components",attributes:{"next.route":a?(0,_apppaths.normalizeAppPath)(t):t}},(()=>this.findPageComponentsImpl({locale:e,page:t,query:r,params:i,isAppPath:a,url:n})))}async findPageComponentsImpl({locale:e,page:t,query:r,params:i,isAppPath:a,url:n}){const s=[t];r.amp&&s.unshift((a?(0,_apppaths.normalizeAppPath)(t):(0,_normalizepagepath.normalizePagePath)(t))+".amp"),e&&s.unshift(...s.map((t=>`/${e}${"/"===t?"":t}`)));for(const t of s)try{const n=await(0,_loadcomponents.loadComponents)({distDir:this.distDir,page:t,isAppPath:a,isDev:this.isDev,sriEnabled:this.sriEnabled});if(e&&"string"==typeof n.Component&&!t.startsWith(`/${e}/`)&&t!==`/${e}`)continue;return{components:n,query:{...!this.renderOpts.isExperimentalCompile&&n.getStaticProps?{amp:r.amp}:r,...(a?{}:i)||{}}}}catch(e){if(!(e instanceof _utils.PageNotFoundError))throw e}return null}getNextFontManifest(){return(0,_loadmanifest.loadManifest)((0,_path.join)(this.distDir,"server",_constants.NEXT_FONT_MANIFEST+".json"))}logErrorWithOriginalStack(e,t){throw Object.defineProperty(new Error("Invariant: logErrorWithOriginalStack can only be called on the development server"),"__NEXT_ERROR_CODE",{value:"E6",enumerable:!1,configurable:!0})}async ensurePage(e){throw Object.defineProperty(new Error("Invariant: ensurePage can only be called on the development server"),"__NEXT_ERROR_CODE",{value:"E291",enumerable:!1,configurable:!0})}async handleApiRequest(e,t,r,i){return this.runApi(e,t,r,i)}getCacheFilesystem(){return _nodefsmethods.nodeFs}normalizeReq(e){return e instanceof _node.NodeNextRequest?e:new _node.NodeNextRequest(e)}normalizeRes(e){return e instanceof _node.NodeNextResponse?e:new _node.NodeNextResponse(e)}getRequestHandler(){const e=this.makeRequestHandler();if(this.serverOptions.experimentalTestProxy){const{wrapRequestHandlerNode:t}=require("next/dist/experimental/testmode/server");return t(e)}return e}makeRequestHandler(){this.prepare().catch((e=>{console.error("Failed to prepare server",e)}));const e=super.getRequestHandler();return(t,r,i)=>e(this.normalizeReq(t),this.normalizeRes(r),i)}async revalidate({urlPath:e,revalidateHeaders:t,opts:r}){const i=(0,_mockrequest.createRequestResponseMocks)({url:e,headers:t}),a=this.getRequestHandler();if(await a(new _node.NodeNextRequest(i.req),new _node.NodeNextResponse(i.res)),await i.res.hasStreamed,"REVALIDATED"!==i.res.getHeader("x-nextjs-cache")&&200!==i.res.statusCode&&(404!==i.res.statusCode||!r.unstable_onlyGenerated))throw Object.defineProperty(new Error(`Invalid response ${i.res.statusCode}`),"__NEXT_ERROR_CODE",{value:"E175",enumerable:!1,configurable:!0})}async render(e,t,r,i,a,n=!1){return super.render(this.normalizeReq(e),this.normalizeRes(t),r,i,a,n)}async renderToHTML(e,t,r,i){return super.renderToHTML(this.normalizeReq(e),this.normalizeRes(t),r,i)}async renderErrorToResponseImpl(e,t){const{req:r,res:i,query:a}=e;return 404===i.statusCode&&this.enabledDirectories.app&&(this.renderOpts.dev&&await this.ensurePage({page:_constants.UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,clientOnly:!1,url:r.url}).catch((()=>{})),this.getEdgeFunctionsPages().includes(_constants.UNDERSCORE_NOT_FOUND_ROUTE_ENTRY))?(await this.runEdgeFunction({req:r,res:i,query:a||{},params:{},page:_constants.UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,appPaths:null}),null):super.renderErrorToResponseImpl(e,t)}async renderError(e,t,r,i,a,n){return super.renderError(e,this.normalizeReq(t),this.normalizeRes(r),i,a,n)}async renderErrorToHTML(e,t,r,i,a){return super.renderErrorToHTML(e,this.normalizeReq(t),this.normalizeRes(r),i,a)}async render404(e,t,r,i){return super.render404(this.normalizeReq(e),this.normalizeRes(t),r,i)}getMiddlewareManifest(){if(this.minimalMode)return null;return require(this.middlewareManifestPath)}async getMiddleware(){var e;const t=this.getMiddlewareManifest(),r=null==t||null==(e=t.middleware)?void 0:e["/"];if(!r){const e=await this.loadNodeMiddleware();var i;return e?{match:(0,_middlewareroutematcher.getMiddlewareRouteMatcher)((null==(i=e.config)?void 0:i.matchers)||[{regexp:".*",originalSource:"/:path*"}]),page:"/"}:void 0}return{match:getMiddlewareMatcher(r),page:"/"}}getEdgeFunctionsPages(){const e=this.getMiddlewareManifest();return e?Object.keys(e.functions):[]}getEdgeFunctionInfo(e){const t=this.getMiddlewareManifest();if(!t)return null;let r;try{r=(0,_denormalizepagepath.denormalizePagePath)((0,_normalizepagepath.normalizePagePath)(e.page))}catch(e){return null}let i=e.middleware?t.middleware[r]:t.functions[r];if(!i){if(!e.middleware)throw new _utils.PageNotFoundError(r);return null}return{name:i.name,paths:i.files.map((e=>(0,_path.join)(this.distDir,e))),wasm:(i.wasm??[]).map((e=>({...e,filePath:(0,_path.join)(this.distDir,e.filePath)}))),assets:i.assets&&i.assets.map((e=>({...e,filePath:(0,_path.join)(this.distDir,e.filePath)}))),env:i.env}}async loadNodeMiddleware(){if(this.nextConfig.experimental.nodeMiddleware)try{var e;const t=this.renderOpts.dev?{}:require((0,_path.join)(this.distDir,"server",_constants.FUNCTIONS_CONFIG_MANIFEST));if(this.renderOpts.dev||(null==t||null==(e=t.functions)?void 0:e["/_middleware"]))return require((0,_path.join)(this.distDir,"server","middleware.js"))}catch(e){if((0,_iserror.default)(e)&&"ENOENT"!==e.code&&"MODULE_NOT_FOUND"!==e.code)throw e}}async hasMiddleware(e){const t=this.getEdgeFunctionInfo({page:e,middleware:!0}),r=await this.loadNodeMiddleware();return!(t||!r)||Boolean(t&&t.paths.length>0)}async ensureMiddleware(e){}async ensureEdgeFunction(e){}async runMiddleware(e){if(process.env.NEXT_MINIMAL)throw Object.defineProperty(new Error("invariant: runMiddleware should not be called in minimal mode"),"__NEXT_ERROR_CODE",{value:"E276",enumerable:!1,configurable:!0});if((0,_apiutils.checkIsOnDemandRevalidate)(e.request,this.renderOpts.previewProps).isOnDemandRevalidate)return{response:new Response(null,{headers:{"x-middleware-next":"1"}})};let t;if(this.nextConfig.skipMiddlewareUrlNormalize)t=(0,_requestmeta.getRequestMeta)(e.request,"initURL");else{const r=(0,_querystring.urlQueryToSearchParams)(e.parsed.query).toString(),i=(0,_requestmeta.getRequestMeta)(e.request,"locale");t=`${(0,_requestmeta.getRequestMeta)(e.request,"initProtocol")}://${this.fetchHostname||"localhost"}:${this.port}${i?`/${i}`:""}${e.parsed.pathname}${r?`?${r}`:""}`}if(!t.startsWith("http"))throw Object.defineProperty(new Error("To use middleware you must provide a `hostname` and `port` to the Next.js Server"),"__NEXT_ERROR_CODE",{value:"E35",enumerable:!1,configurable:!0});const r={},i=await this.getMiddleware();if(!i)return{finished:!1};if(!await this.hasMiddleware(i.page))return{finished:!1};await this.ensureMiddleware(e.request.url);const a=this.getEdgeFunctionInfo({page:i.page,middleware:!0}),n=(e.request.method||"GET").toUpperCase(),s={headers:e.request.headers,method:n,nextConfig:{basePath:this.nextConfig.basePath,i18n:this.nextConfig.i18n,trailingSlash:this.nextConfig.trailingSlash,experimental:this.nextConfig.experimental},url:t,page:r,body:"GET"!==n&&"HEAD"!==n?(0,_requestmeta.getRequestMeta)(e.request,"clonableBody"):void 0,signal:(0,_nextrequest.signalFromNodeResponse)(e.response.originalResponse),waitUntil:this.getWaitUntil()};let o;if(a){const{run:t}=require("./web/sandbox");o=await t({distDir:this.distDir,name:a.name,paths:a.paths,edgeFunctionEntry:a,request:s,useCache:!0,onWarning:e.onWarning})}else{let e;if(e=await this.loadNodeMiddleware(),!e)throw new _utils.MiddlewareNotFoundError;const t=e.default||e;o=await t({handler:e.middleware||e,request:s,page:"middleware"})}if(this.renderOpts.dev||o.waitUntil.catch((e=>{console.error("Uncaught: middleware waitUntil errored",e)})),!o)return this.render404(e.request,e.response,e.parsed),{finished:!0};if(o.response.headers.has("set-cookie")){const t=o.response.headers.getSetCookie().flatMap((e=>(0,_utils1.splitCookiesString)(e)));o.response.headers.delete("set-cookie");for(const e of t)o.response.headers.append("set-cookie",e);(0,_requestmeta.addRequestMeta)(e.request,"middlewareCookie",t)}return o}getPrerenderManifest(){var e,t;return this._cachedPreviewManifest?this._cachedPreviewManifest:(null==(e=this.renderOpts)?void 0:e.dev)||(null==(t=this.serverOptions)?void 0:t.dev)||"development"===process.env.NODE_ENV||process.env.NEXT_PHASE===_constants.PHASE_PRODUCTION_BUILD?(this._cachedPreviewManifest={version:4,routes:{},dynamicRoutes:{},notFoundRoutes:[],preview:{previewModeId:require("crypto").randomBytes(16).toString("hex"),previewModeSigningKey:require("crypto").randomBytes(32).toString("hex"),previewModeEncryptionKey:require("crypto").randomBytes(32).toString("hex")}},this._cachedPreviewManifest):(this._cachedPreviewManifest=(0,_loadmanifest.loadManifest)((0,_path.join)(this.distDir,_constants.PRERENDER_MANIFEST)),this._cachedPreviewManifest)}getRoutesManifest(){return(0,_tracer.getTracer)().trace(_constants2.NextNodeServerSpan.getRoutesManifest,(()=>{const e=(0,_loadmanifest.loadManifest)((0,_path.join)(this.distDir,_constants.ROUTES_MANIFEST));let t=e.rewrites??{beforeFiles:[],afterFiles:[],fallback:[]};return Array.isArray(t)&&(t={beforeFiles:[],afterFiles:t,fallback:[]}),{...e,rewrites:t}}))}attachRequestMeta(e,t,r){var i;const a=(null==(i=e.headers["x-forwarded-proto"])?void 0:i.includes("https"))?"https":"http",n=this.fetchHostname&&this.port?`${a}://${this.fetchHostname}:${this.port}${e.url}`:this.nextConfig.experimental.trustHostHeader?`https://${e.headers.host||"localhost"}${e.url}`:e.url;(0,_requestmeta.addRequestMeta)(e,"initURL",n),(0,_requestmeta.addRequestMeta)(e,"initQuery",{...t.query}),(0,_requestmeta.addRequestMeta)(e,"initProtocol",a),r||(0,_requestmeta.addRequestMeta)(e,"clonableBody",(0,_bodystreams.getCloneableBody)(e.originalRequest))}async runEdgeFunction(e){if(process.env.NEXT_MINIMAL)throw Object.defineProperty(new Error("Middleware is not supported in minimal mode. Please remove the `NEXT_MINIMAL` environment variable."),"__NEXT_ERROR_CODE",{value:"E58",enumerable:!1,configurable:!0});let t;const{query:r,page:i,match:a}=e;if(a||await this.ensureEdgeFunction({page:i,appPaths:e.appPaths,url:e.req.url}),t=this.getEdgeFunctionInfo({page:i,middleware:!1}),!t)return null;const n=(0,_requestmeta.getRequestMeta)(e.req,"isNextDataReq"),s=new URL((0,_requestmeta.getRequestMeta)(e.req,"initURL")||"/","http://n"),o=(0,_querystring.urlQueryToSearchParams)({...Object.fromEntries(s.searchParams),...r,...e.params}).toString();n&&(e.req.headers["x-nextjs-data"]="1"),s.search=o;const d=s.toString();if(!d.startsWith("http"))throw Object.defineProperty(new Error("To use middleware you must provide a `hostname` and `port` to the Next.js Server"),"__NEXT_ERROR_CODE",{value:"E35",enumerable:!1,configurable:!0});const{run:l}=require("./web/sandbox"),u=await l({distDir:this.distDir,name:t.name,paths:t.paths,edgeFunctionEntry:t,request:{headers:e.req.headers,method:e.req.method,nextConfig:{basePath:this.nextConfig.basePath,i18n:this.nextConfig.i18n,trailingSlash:this.nextConfig.trailingSlash},url:d,page:{name:e.page,...e.params&&{params:e.params}},body:(0,_requestmeta.getRequestMeta)(e.req,"clonableBody"),signal:(0,_nextrequest.signalFromNodeResponse)(e.res.originalResponse),waitUntil:this.getWaitUntil()},useCache:!0,onError:e.onError,onWarning:e.onWarning,incrementalCache:globalThis.__incrementalCache||(0,_requestmeta.getRequestMeta)(e.req,"incrementalCache"),serverComponentsHmrCache:(0,_requestmeta.getRequestMeta)(e.req,"serverComponentsHmrCache")});u.fetchMetrics&&(e.req.fetchMetrics=u.fetchMetrics),(!e.res.statusCode||e.res.statusCode<400)&&(e.res.statusCode=u.response.status,e.res.statusMessage=u.response.statusText),u.response.headers.forEach(((t,r)=>{if("set-cookie"===r.toLowerCase())for(const i of(0,_utils1.splitCookiesString)(t))e.res.appendHeader(r,i);else e.res.appendHeader(r,t)}));const{originalResponse:h}=e.res;return u.response.body?await(0,_pipereadable.pipeToNodeResponse)(u.response.body,h):h.end(),u}get serverDistDir(){if(this._serverDistDir)return this._serverDistDir;const e=(0,_path.join)(this.distDir,_constants.SERVER_DIRECTORY);return this._serverDistDir=e,e}async getFallbackErrorComponents(e){return null}async instrumentationOnRequestError(...e){await super.instrumentationOnRequestError(...e),this.renderOpts.dev||this.logError(e[0])}onServerClose(e){this.cleanupListeners.add(e)}async close(){await this.cleanupListeners.runAll()}getInternalWaitUntil(){return this.internalWaitUntil??=this.createInternalWaitUntil(),this.internalWaitUntil}createInternalWaitUntil(){if(this.minimalMode)throw Object.defineProperty(new _invarianterror.InvariantError("createInternalWaitUntil should never be called in minimal mode"),"__NEXT_ERROR_CODE",{value:"E540",enumerable:!1,configurable:!0});const e=new _awaiter.AwaiterOnce({onError:console.error});return this.onServerClose((()=>e.awaiting())),e.waitUntil}}