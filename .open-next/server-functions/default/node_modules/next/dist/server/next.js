"use strict";function _export(e,r){for(var t in r)Object.defineProperty(e,t,{enumerable:!0,get:r[t]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{NextServer:function(){return NextServer},default:function(){return _default}}),require("./require-hook"),require("./node-polyfill-crypto");const _log=_interop_require_wildcard(require("../build/output/log")),_config=_interop_require_default(require("./config")),_path=_interop_require_wildcard(require("path")),_constants=require("../lib/constants"),_constants1=require("../shared/lib/constants"),_tracer=require("./lib/trace/tracer"),_constants2=require("./lib/trace/constants"),_formaturl=require("../shared/lib/router/utils/format-url"),_asynccallbackset=require("./lib/async-callback-set");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(_getRequireWildcardCache=function(e){return e?t:r})(e)}function _interop_require_wildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var s={__proto__:null},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var i in e)if("default"!==i&&Object.prototype.hasOwnProperty.call(e,i)){var o=n?Object.getOwnPropertyDescriptor(e,i):null;o&&(o.get||o.set)?Object.defineProperty(s,i,o):s[i]=e[i]}return s.default=e,t&&t.set(e,s),s}let ServerImpl;const getServerImpl=async()=>(void 0===ServerImpl&&(ServerImpl=(await Promise.resolve(require("./next-server"))).default),ServerImpl),SYMBOL_LOAD_CONFIG=Symbol("next.load_config");class NextServer{constructor(e){this.options=e}get hostname(){return this.options.hostname}get port(){return this.options.port}getRequestHandler(){return async(e,r,t)=>(0,_tracer.getTracer)().trace(_constants2.NextServerSpan.getRequestHandler,(async()=>(await this.getServerRequestHandler())(e,r,t)))}getUpgradeHandler(){return async(e,r,t)=>{const s=await this.getServer();return s.handleUpgrade.apply(s,[e,r,t])}}setAssetPrefix(e){this.server?this.server.setAssetPrefix(e):this.preparedAssetPrefix=e}logError(...e){this.server&&this.server.logError(...e)}async render(...e){return(await this.getServer()).render(...e)}async renderToHTML(...e){return(await this.getServer()).renderToHTML(...e)}async renderError(...e){return(await this.getServer()).renderError(...e)}async renderErrorToHTML(...e){return(await this.getServer()).renderErrorToHTML(...e)}async render404(...e){return(await this.getServer()).render404(...e)}async prepare(e){const r=await this.getServer();e&&Object.assign(r,e),this.options.dev&&await r.prepare()}async close(){this.server&&await this.server.close()}async createServer(e){let r;r=e.dev?require("./dev/next-dev-server").default:await getServerImpl();return new r(e)}async[SYMBOL_LOAD_CONFIG](){const e=(0,_path.resolve)(this.options.dir||"."),r=await(0,_config.default)(this.options.dev?_constants1.PHASE_DEVELOPMENT_SERVER:_constants1.PHASE_PRODUCTION_SERVER,e,{customConfig:this.options.conf,silent:!0});if("production"===process.env.NODE_ENV)try{const t=require(_path.default.join(e,".next",_constants1.SERVER_FILES_MANIFEST)).config;r.experimental.isExperimentalCompile=t.experimental.isExperimentalCompile}catch(e){}return r}async getServer(){return this.serverPromise||(this.serverPromise=this[SYMBOL_LOAD_CONFIG]().then((async e=>{if(!this.options.dev)if("standalone"===e.output)process.env.__NEXT_PRIVATE_STANDALONE_CONFIG||_log.warn('"next start" does not work with "output: standalone" configuration. Use "node .next/standalone/server.js" instead.');else if("export"===e.output)throw Object.defineProperty(new Error('"next start" does not work with "output: export" configuration. Use "npx serve@latest out" instead.'),"__NEXT_ERROR_CODE",{value:"E375",enumerable:!1,configurable:!0});return this.server=await this.createServer({...this.options,conf:e}),this.preparedAssetPrefix&&this.server.setAssetPrefix(this.preparedAssetPrefix),this.server}))),this.serverPromise}async getServerRequestHandler(){return this.reqHandler?this.reqHandler:(this.reqHandlerPromise||(this.reqHandlerPromise=this.getServer().then((e=>(this.reqHandler=(0,_tracer.getTracer)().wrap(_constants2.NextServerSpan.getServerRequestHandler,e.getRequestHandler().bind(e)),delete this.reqHandlerPromise,this.reqHandler)))),this.reqHandlerPromise)}}class NextCustomServer{constructor(e){this.didWebSocketSetup=!1,this.options=e}getInit(){if(!this.init)throw Object.defineProperty(new Error("prepare() must be called before performing this operation"),"__NEXT_ERROR_CODE",{value:"E355",enumerable:!1,configurable:!0});return this.init}get requestHandler(){return this.getInit().requestHandler}get upgradeHandler(){return this.getInit().upgradeHandler}get server(){return this.getInit().server}get hostname(){return this.options.hostname}get port(){return this.options.port}async prepare(){const{getRequestHandlers:e}=require("./lib/start-server");let r;this.options.dev&&(this.cleanupListeners=new _asynccallbackset.AsyncCallbackSet,r=this.cleanupListeners.add.bind(this.cleanupListeners));const t=await e({dir:this.options.dir,port:this.options.port||3e3,isDev:!!this.options.dev,onDevServerCleanup:r,hostname:this.options.hostname||"localhost",minimalMode:this.options.minimalMode,quiet:this.options.quiet});this.init=t}setupWebSocketHandler(e,r){var t;this.didWebSocketSetup||(this.didWebSocketSetup=!0,(e=e||(null==r||null==(t=r.socket)?void 0:t.server))&&e.on("upgrade",(async(e,r,t)=>{this.upgradeHandler(e,r,t)})))}getRequestHandler(){return async(e,r,t)=>(this.setupWebSocketHandler(this.options.httpServer,e),t&&(e.url=(0,_formaturl.formatUrl)(t)),this.requestHandler(e,r))}async render(...e){let[r,t,s,n,i]=e;this.setupWebSocketHandler(this.options.httpServer,r),s.startsWith("/")||(console.error(`Cannot render page with path "${s}"`),s=`/${s}`),s="/index"===s?"/":s,r.url=(0,_formaturl.formatUrl)({...i,pathname:s,query:n}),await this.requestHandler(r,t)}setAssetPrefix(e){this.server.setAssetPrefix(e)}getUpgradeHandler(){return this.server.getUpgradeHandler()}logError(...e){this.server.logError(...e)}async renderToHTML(...e){return this.server.renderToHTML(...e)}async renderError(...e){return this.server.renderError(...e)}async renderErrorToHTML(...e){return this.server.renderErrorToHTML(...e)}async render404(...e){return this.server.render404(...e)}async close(){var e,r;await Promise.allSettled([null==(e=this.init)?void 0:e.server.close(),null==(r=this.cleanupListeners)?void 0:r.runAll()])}}function createServer(e){if(e&&(e.turbo||e.turbopack)&&(process.env.TURBOPACK="1"),e&&"typescript"in e&&"version"in e.typescript){return require("./next-typescript").createTSPlugin(e)}if(null==e)throw Object.defineProperty(new Error("The server has not been instantiated properly. https://nextjs.org/docs/messages/invalid-server-options"),"__NEXT_ERROR_CODE",{value:"E75",enumerable:!1,configurable:!0});if("isNextDevCommand"in e||!process.env.NODE_ENV||["production","development","test"].includes(process.env.NODE_ENV)||_log.warn(_constants.NON_STANDARD_NODE_ENV),e.dev&&"boolean"!=typeof e.dev&&console.warn("Warning: 'dev' is not a boolean which could introduce unexpected behavior. https://nextjs.org/docs/messages/invalid-server-options"),!1!==e.customServer){const r=(0,_path.resolve)(e.dir||".");return new NextCustomServer({...e,dir:r})}return new NextServer(e)}module.exports=createServer;const _default=createServer;