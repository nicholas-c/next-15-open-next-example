"use strict";function _export(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{NextRequestHint:function(){return NextRequestHint},adapter:function(){return adapter}});const _error=require("./error"),_utils=require("./utils"),_fetchevent=require("./spec-extension/fetch-event"),_request=require("./spec-extension/request"),_response=require("./spec-extension/response"),_relativizeurl=require("../../shared/lib/router/utils/relativize-url"),_nexturl=require("./next-url"),_internalutils=require("../internal-utils"),_apppaths=require("../../shared/lib/router/utils/app-paths"),_approuterheaders=require("../../client/components/app-router-headers"),_globals=require("./globals"),_requeststore=require("../async-storage/request-store"),_workunitasyncstorageexternal=require("../app-render/work-unit-async-storage.external"),_workstore=require("../async-storage/work-store"),_workasyncstorageexternal=require("../app-render/work-async-storage.external"),_tracer=require("../lib/trace/tracer"),_constants=require("../lib/trace/constants"),_webonclose=require("./web-on-close"),_getedgepreviewprops=require("./get-edge-preview-props"),_builtinrequestcontext=require("../after/builtin-request-context");class NextRequestHint extends _request.NextRequest{constructor(e){super(e.input,e.init),this.sourcePage=e.page}get request(){throw Object.defineProperty(new _error.PageSignatureError({page:this.sourcePage}),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0})}respondWith(){throw Object.defineProperty(new _error.PageSignatureError({page:this.sourcePage}),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0})}waitUntil(){throw Object.defineProperty(new _error.PageSignatureError({page:this.sourcePage}),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0})}}const headersGetter={keys:e=>Array.from(e.keys()),get:(e,t)=>e.get(t)??void 0};let propagator=(e,t)=>(0,_tracer.getTracer)().withPropagatedContext(e.headers,t,headersGetter),testApisIntercepted=!1;function ensureTestApisIntercepted(){if(!testApisIntercepted&&(testApisIntercepted=!0,"true"===process.env.NEXT_PRIVATE_TEST_PROXY)){const{interceptTestApis:e,wrapRequestHandler:t}=require("next/dist/experimental/testmode/server-edge");e(),propagator=t(propagator)}}async function adapter(e){var t;ensureTestApisIntercepted(),await(0,_globals.ensureInstrumentationRegistered)();const r=void 0!==globalThis.__BUILD_MANIFEST;e.request.url=(0,_apppaths.normalizeRscURL)(e.request.url);const s=new _nexturl.NextURL(e.request.url,{headers:e.request.headers,nextConfig:e.request.nextConfig}),n=[...s.searchParams.keys()];for(const e of n){const t=s.searchParams.getAll(e),r=(0,_utils.normalizeNextQueryParam)(e);if(r){s.searchParams.delete(r);for(const e of t)s.searchParams.append(r,e);s.searchParams.delete(e)}}const a=s.buildId;s.buildId="";const o=(0,_utils.fromNodeOutgoingHttpHeaders)(e.request.headers),i=o.has("x-nextjs-data"),u="1"===o.get(_approuterheaders.RSC_HEADER);i&&"/index"===s.pathname&&(s.pathname="/");const l=new Map;if(!r)for(const e of _approuterheaders.FLIGHT_HEADERS){const t=e.toLowerCase(),r=o.get(t);null!==r&&(l.set(t,r),o.delete(t))}const c=process.env.__NEXT_NO_MIDDLEWARE_URL_NORMALIZE?new URL(e.request.url):s,d=new NextRequestHint({page:e.page,input:(0,_internalutils.stripInternalSearchParams)(c).toString(),init:{body:e.request.body,headers:o,method:e.request.method,nextConfig:e.request.nextConfig,signal:e.request.signal}});i&&Object.defineProperty(d,"__isData",{enumerable:!1,value:!0}),!globalThis.__incrementalCache&&e.IncrementalCache&&(globalThis.__incrementalCache=new e.IncrementalCache({appDir:!0,fetchCache:!0,minimalMode:"development"!==process.env.NODE_ENV,fetchCacheKeyPrefix:process.env.__NEXT_FETCH_CACHE_KEY_PREFIX,dev:"development"===process.env.NODE_ENV,requestHeaders:e.request.headers,requestProtocol:"https",getPrerenderManifest:()=>({version:-1,routes:{},dynamicRoutes:{},notFoundRoutes:[],preview:(0,_getedgepreviewprops.getEdgePreviewProps)()})}));const p=e.request.waitUntil??(null==(t=(0,_builtinrequestcontext.getBuiltinRequestContext)())?void 0:t.waitUntil),_=new _fetchevent.NextFetchEvent({request:d,page:e.page,context:p?{waitUntil:p}:void 0});let h,g;if(h=await propagator(d,(()=>{if("/middleware"===e.page||"/src/middleware"===e.page){const t=_.waitUntil.bind(_),r=new _webonclose.CloseController;return(0,_tracer.getTracer)().trace(_constants.MiddlewareSpan.execute,{spanName:`middleware ${d.method} ${d.nextUrl.pathname}`,attributes:{"http.target":d.nextUrl.pathname,"http.method":d.method}},(async()=>{try{var s,n,o,i;const u=e=>{g=e},l=(0,_getedgepreviewprops.getEdgePreviewProps)(),c=(0,_requeststore.createRequestStoreForAPI)(d,d.nextUrl,void 0,u,l),p=(0,_workstore.createWorkStore)({page:"/",fallbackRouteParams:null,renderOpts:{cacheLifeProfiles:null==(n=e.request.nextConfig)||null==(s=n.experimental)?void 0:s.cacheLife,experimental:{isRoutePPREnabled:!1,dynamicIO:!1,authInterrupts:!!(null==(i=e.request.nextConfig)||null==(o=i.experimental)?void 0:o.authInterrupts)},supportsDynamicResponse:!0,waitUntil:t,onClose:r.onClose.bind(r),onAfterTaskError:void 0},requestEndedState:{ended:!1},isPrefetchRequest:d.headers.has(_approuterheaders.NEXT_ROUTER_PREFETCH_HEADER),buildId:a??""});return await _workasyncstorageexternal.workAsyncStorage.run(p,(()=>_workunitasyncstorageexternal.workUnitAsyncStorage.run(c,e.handler,d,_)))}finally{setTimeout((()=>{r.dispatchClose()}),0)}}))}return e.handler(d,_)})),h&&!(h instanceof Response))throw Object.defineProperty(new TypeError("Expected an instance of Response to be returned"),"__NEXT_ERROR_CODE",{value:"E567",enumerable:!1,configurable:!0});h&&g&&h.headers.set("set-cookie",g);const E=null==h?void 0:h.headers.get("x-middleware-rewrite");if(h&&E&&(u||!r)){const t=new _nexturl.NextURL(E,{forceLocale:!0,headers:e.request.headers,nextConfig:e.request.nextConfig});process.env.__NEXT_NO_MIDDLEWARE_URL_NORMALIZE||r||t.host===d.nextUrl.host&&(t.buildId=a||t.buildId,h.headers.set("x-middleware-rewrite",String(t)));const{url:n,isRelative:o}=(0,_relativizeurl.parseRelativeURL)(t.toString(),s.toString());r||!i||process.env.__NEXT_EXTERNAL_MIDDLEWARE_REWRITE_RESOLVE&&n.match(/http(s)?:\/\//)||h.headers.set("x-nextjs-rewrite",n),u&&o&&(s.pathname!==t.pathname&&h.headers.set(_approuterheaders.NEXT_REWRITTEN_PATH_HEADER,t.pathname),s.search!==t.search&&h.headers.set(_approuterheaders.NEXT_REWRITTEN_QUERY_HEADER,t.search.slice(1)))}const R=null==h?void 0:h.headers.get("Location");if(h&&R&&!r){const t=new _nexturl.NextURL(R,{forceLocale:!1,headers:e.request.headers,nextConfig:e.request.nextConfig});h=new Response(h.body,h),process.env.__NEXT_NO_MIDDLEWARE_URL_NORMALIZE||t.host===s.host&&(t.buildId=a||t.buildId,h.headers.set("Location",t.toString())),i&&(h.headers.delete("Location"),h.headers.set("x-nextjs-redirect",(0,_relativizeurl.getRelativeURL)(t.toString(),s.toString())))}const x=h||_response.NextResponse.next(),f=x.headers.get("x-middleware-override-headers"),q=[];if(f){for(const[e,t]of l)x.headers.set(`x-middleware-request-${e}`,t),q.push(e);q.length>0&&x.headers.set("x-middleware-override-headers",f+","+q.join(","))}return{response:x,waitUntil:(0,_fetchevent.getWaitUntilPromiseFromEvent)(_)??Promise.resolve(),fetchMetrics:d.fetchMetrics}}