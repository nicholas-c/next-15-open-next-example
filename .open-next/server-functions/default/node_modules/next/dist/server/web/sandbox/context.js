"use strict";function _export(e,r){for(var t in r)Object.defineProperty(e,t,{enumerable:!0,get:r[t]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{clearAllModuleContexts:function(){return clearAllModuleContexts},clearModuleContext:function(){return clearModuleContext},edgeSandboxNextRequestContext:function(){return edgeSandboxNextRequestContext},getModuleContext:function(){return getModuleContext},requestStore:function(){return requestStore}});const _async_hooks=require("async_hooks"),_constants=require("../../../shared/lib/constants"),_edgeruntime=require("next/dist/compiled/edge-runtime"),_fs=require("fs"),_utils=require("../utils"),_pick=require("../../../lib/pick"),_fetchinlineassets=require("./fetch-inline-assets"),_vm=require("vm"),_nodebuffer=_interop_require_default(require("node:buffer")),_nodeevents=_interop_require_default(require("node:events")),_nodeassert=_interop_require_default(require("node:assert")),_nodeutil=_interop_require_default(require("node:util")),_nodeasync_hooks=_interop_require_default(require("node:async_hooks")),_resourcemanagers=require("./resource-managers"),_builtinrequestcontext=require("../../after/builtin-request-context"),_patcherrorinspect=require("../../patch-error-inspect");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}let getServerError,decorateServerError;if("development"===process.env.NODE_ENV){const e=require("../../../client/components/react-dev-overlay/server/middleware-webpack");getServerError=e.getServerError,decorateServerError=require("../../../shared/lib/error-source").decorateServerError}else getServerError=(e,r)=>e,decorateServerError=(e,r)=>{};const moduleContexts=new Map,pendingModuleCaches=new Map;async function clearAllModuleContexts(){_resourcemanagers.intervalsManager.removeAll(),_resourcemanagers.timeoutsManager.removeAll(),moduleContexts.clear(),pendingModuleCaches.clear()}async function clearModuleContext(e){_resourcemanagers.intervalsManager.removeAll(),_resourcemanagers.timeoutsManager.removeAll();const r=(r,t,n)=>{(null==t?void 0:t.paths.has(e))&&n.delete(r)};for(const[e,t]of moduleContexts)r(e,t,moduleContexts);for(const[e,t]of pendingModuleCaches)r(e,await t,pendingModuleCaches)}async function loadWasm(e){const r={};return await Promise.all(e.map((async e=>{const t=await WebAssembly.compile(await _fs.promises.readFile(e.filePath));r[e.name]=t}))),r}function buildEnvironmentVariablesFrom(e){const r=Object.keys(process.env).map((e=>[e,process.env[e]])),t=Object.fromEntries(r);for(const r of Object.keys(e))t[r]=e[r];return t.NEXT_RUNTIME="edge",t}function throwUnsupportedAPIError(e){const r=Object.defineProperty(new Error(`A Node.js API is used (${e}) which is not supported in the Edge Runtime.\nLearn more: https://nextjs.org/docs/api-reference/edge-runtime`),"__NEXT_ERROR_CODE",{value:"E97",enumerable:!1,configurable:!0});throw decorateServerError(r,_constants.COMPILER_NAMES.edgeServer),r}function createProcessPolyfill(e){const r={env:buildEnvironmentVariablesFrom(e)},t={};for(const e of Object.keys(process))"env"!==e&&Object.defineProperty(r,e,{get:()=>void 0!==t[e]?t[e]:"function"==typeof process[e]?()=>throwUnsupportedAPIError(`process.${e}`):void 0,set(r){t[e]=r},enumerable:!1});return r}function addStub(e,r){Object.defineProperty(e,r,{get:()=>function(){throwUnsupportedAPIError(r)},enumerable:!1})}function getDecorateUnhandledError(e){const r=e.evaluate("Error");return e=>{e instanceof r&&decorateServerError(e,_constants.COMPILER_NAMES.edgeServer)}}function getDecorateUnhandledRejection(e){const r=e.evaluate("Error");return e=>{e.reason instanceof r&&decorateServerError(e.reason,_constants.COMPILER_NAMES.edgeServer)}}const NativeModuleMap=(()=>{const e={"node:buffer":(0,_pick.pick)(_nodebuffer.default,["constants","kMaxLength","kStringMaxLength","Buffer","SlowBuffer"]),"node:events":(0,_pick.pick)(_nodeevents.default,["EventEmitter","captureRejectionSymbol","defaultMaxListeners","errorMonitor","listenerCount","on","once"]),"node:async_hooks":(0,_pick.pick)(_nodeasync_hooks.default,["AsyncLocalStorage","AsyncResource"]),"node:assert":(0,_pick.pick)(_nodeassert.default,["AssertionError","deepEqual","deepStrictEqual","doesNotMatch","doesNotReject","doesNotThrow","equal","fail","ifError","match","notDeepEqual","notDeepStrictEqual","notEqual","notStrictEqual","ok","rejects","strict","strictEqual","throws"]),"node:util":(0,_pick.pick)(_nodeutil.default,["_extend","callbackify","format","inherits","promisify","types"])};return new Map(Object.entries(e))})(),requestStore=new _async_hooks.AsyncLocalStorage,edgeSandboxNextRequestContext=(0,_builtinrequestcontext.createLocalRequestContext)();async function createModuleContext(e){const r=new Set,t=new Set,{edgeFunctionEntry:n}=e,o=await loadWasm(n.wasm??[]),a=new _edgeruntime.EdgeRuntime({codeGeneration:"production"!==process.env.NODE_ENV?{strings:!0,wasm:!0}:void 0,extend:a=>{a.process=createProcessPolyfill(n.env),Object.defineProperty(a,"require",{enumerable:!1,value:e=>{const r=NativeModuleMap.get(e);if(!r)throw Object.defineProperty(new TypeError("Native module not found: "+e),"__NEXT_ERROR_CODE",{value:"E546",enumerable:!1,configurable:!0});return r}}),"production"!==process.env.NODE_ENV&&(a.__next_log_error__=function(r){e.onError(r)}),a.__next_eval__=function t(n){const o=n.toString();if(!r.has(o)){const n=getServerError(Object.defineProperty(new Error("Dynamic Code Evaluation (e. g. 'eval', 'new Function') not allowed in Edge Runtime\nLearn More: https://nextjs.org/docs/messages/edge-dynamic-code-evaluation"),"__NEXT_ERROR_CODE",{value:"E149",enumerable:!1,configurable:!0}),_constants.COMPILER_NAMES.edgeServer);n.name="DynamicCodeEvaluationWarning",Error.captureStackTrace(n,t),r.add(o),e.onWarning(n)}return n()},a.__next_webassembly_compile__=function r(n){const o=n.toString();if(!t.has(o)){const n=getServerError(Object.defineProperty(new Error("Dynamic WASM code generation (e. g. 'WebAssembly.compile') not allowed in Edge Runtime.\nLearn More: https://nextjs.org/docs/messages/edge-dynamic-code-evaluation"),"__NEXT_ERROR_CODE",{value:"E184",enumerable:!1,configurable:!0}),_constants.COMPILER_NAMES.edgeServer);n.name="DynamicWasmCodeGenerationWarning",Error.captureStackTrace(n,r),t.add(o),e.onWarning(n)}return n()},a.__next_webassembly_instantiate__=async function r(n){const o=await n(),a=o.hasOwnProperty("module"),s=n.toString();if(a&&!t.has(s)){const n=getServerError(Object.defineProperty(new Error("Dynamic WASM code generation ('WebAssembly.instantiate' with a buffer parameter) not allowed in Edge Runtime.\nLearn More: https://nextjs.org/docs/messages/edge-dynamic-code-evaluation"),"__NEXT_ERROR_CODE",{value:"E40",enumerable:!1,configurable:!0}),_constants.COMPILER_NAMES.edgeServer);n.name="DynamicWasmCodeGenerationWarning",Error.captureStackTrace(n,r),t.add(s),e.onWarning(n)}return o};const s=a.fetch;a.fetch=async(r,t={})=>{var n;const o=Object.defineProperty(new Error("[internal]"),"__NEXT_ERROR_CODE",{value:"E5",enumerable:!1,configurable:!0}),c=await(0,_fetchinlineassets.fetchInlineAsset)({input:r,assets:e.edgeFunctionEntry.assets,distDir:e.distDir,context:a});if(c)return c;t.headers=new Headers(t.headers??{});const i=requestStore.getStore();(null==i?void 0:i.headers.has("x-middleware-subrequest"))&&!t.headers.has("x-middleware-subrequest")&&t.headers.set("x-middleware-subrequest",i.headers.get("x-middleware-subrequest")??"");const u=((null==(n=t.headers.get("x-middleware-subrequest"))?void 0:n.split(":"))||[]).concat(e.moduleName).join(":");t.headers.set("x-middleware-subrequest",u),t.headers.has("user-agent")||t.headers.set("user-agent","Next.js Middleware");const d="object"==typeof r&&"url"in r?s(r.url,{...(0,_pick.pick)(r,["method","body","cache","credentials","integrity","keepalive","mode","redirect","referrer","referrerPolicy","signal"]),...t,headers:{...Object.fromEntries(r.headers),...Object.fromEntries(t.headers)}}):s(String(r),t);return await d.catch((e=>{throw o.message=e.message,e.stack=o.stack,e}))};const c=a.Request;a.Request=class extends c{constructor(e,r){const t="string"!=typeof e&&"url"in e?e.url:String(e);(0,_utils.validateURL)(t),super(t,r),this.next=null==r?void 0:r.next}};const i=a.Response.redirect.bind(a.Response);a.Response.redirect=(...e)=>((0,_utils.validateURL)(e[0]),i(...e));for(const e of _constants.EDGE_UNSUPPORTED_NODE_APIS)addStub(a,e);Object.assign(a,o),a.performance=performance,a.AsyncLocalStorage=_async_hooks.AsyncLocalStorage,a.setInterval=(...e)=>_resourcemanagers.intervalsManager.add(e),a.clearInterval=e=>_resourcemanagers.intervalsManager.remove(e),a.setTimeout=(...e)=>_resourcemanagers.timeoutsManager.add(e),a.clearTimeout=e=>_resourcemanagers.timeoutsManager.remove(e);const u=a.Symbol.for("@next/request-context");return Object.defineProperty(a,u,{enumerable:!1,value:edgeSandboxNextRequestContext}),a}}),s=getDecorateUnhandledError(a);a.context.addEventListener("error",s);const c=getDecorateUnhandledRejection(a);return a.context.addEventListener("unhandledrejection",c),(0,_patcherrorinspect.patchErrorInspectEdgeLite)(a.context.Error),(0,_patcherrorinspect.patchErrorInspectNodeJS)(a.context.Error),{runtime:a,paths:new Map,warnedEvals:new Set}}function getModuleContextShared(e){let r=pendingModuleCaches.get(e.moduleName);return r||(r=createModuleContext(e),pendingModuleCaches.set(e.moduleName,r)),r}async function getModuleContext(e){let r;e.useCache&&(r=moduleContexts.get(e.moduleName)||await getModuleContextShared(e)),r||(r=await createModuleContext(e),moduleContexts.set(e.moduleName,r));const t=r,n=r=>{if(!t.paths.has(r)){const n=(0,_fs.readFileSync)(r,"utf-8");try{(0,_vm.runInContext)(n,t.runtime.context,{filename:r}),t.paths.set(r,n)}catch(n){throw e.useCache&&(null==t||t.paths.delete(r)),n}}};return{...t,evaluateInContext:n}}