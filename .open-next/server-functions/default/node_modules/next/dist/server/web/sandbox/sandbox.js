"use strict";function _export(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{ErrorSource:function(){return ErrorSource},getRuntimeContext:function(){return getRuntimeContext},run:function(){return run}});const _context=require("./context"),_bodystreams=require("../../body-streams"),_approuterheaders=require("../../../client/components/app-router-headers"),_builtinrequestcontext=require("../../after/builtin-request-context"),ErrorSource=Symbol("SandboxError"),FORBIDDEN_HEADERS=["content-length","content-encoding","transfer-encoding"];function withTaggedErrors(e){if("development"===process.env.NODE_ENV){const{getServerError:t}=require("../../../client/components/react-dev-overlay/server/middleware-webpack");return r=>e(r).then((e=>{var r;return{...e,waitUntil:null==e||null==(r=e.waitUntil)?void 0:r.catch((e=>{throw t(e,"edge-server")}))}})).catch((e=>{throw t(e,"edge-server")}))}return e}async function getRuntimeContext(e){const{runtime:t,evaluateInContext:r}=await(0,_context.getModuleContext)({moduleName:e.name,onWarning:e.onWarning??(()=>{}),onError:e.onError??(()=>{}),useCache:!1!==e.useCache,edgeFunctionEntry:e.edgeFunctionEntry,distDir:e.distDir});e.incrementalCache&&(t.context.globalThis.__incrementalCache=e.incrementalCache),e.serverComponentsHmrCache&&(t.context.globalThis.__serverComponentsHmrCache=e.serverComponentsHmrCache);for(const t of e.paths)r(t);return t}const run=withTaggedErrors((async function(e){var t;const r=await getRuntimeContext(e),n=e.request.headers["x-middleware-subrequest"],o=5;if(("string"==typeof n?n.split(":"):[]).reduce(((t,r)=>r===e.name?t+1:t),0)>=o)return{waitUntil:Promise.resolve(),response:new r.context.Response(null,{headers:{"x-middleware-next":"1"}})};const a=(await r.context._ENTRIES[`middleware_${e.name}`]).default,s=["HEAD","GET"].includes(e.request.method)||null==(t=e.request.body)?void 0:t.cloneBodyStream(),i=r.evaluate("Uint8Array"),u=new URL(e.request.url);u.searchParams.delete(_approuterheaders.NEXT_RSC_UNION_QUERY),e.request.url=u.toString();const c=new Headers;for(const[t,r]of Object.entries(e.request.headers))c.set(t,(null==r?void 0:r.toString())??"");try{let t;const n={...(0,_builtinrequestcontext.getBuiltinRequestContext)(),waitUntil:e.request.waitUntil};if(await _context.edgeSandboxNextRequestContext.run(n,(()=>_context.requestStore.run({headers:c},(async()=>{t=await a({request:{...e.request,body:s&&(0,_bodystreams.requestToBodyStream)(r.context,i,s)}});for(const e of FORBIDDEN_HEADERS)t.response.headers.delete(e)})))),!t)throw Object.defineProperty(new Error("Edge function did not return a response"),"__NEXT_ERROR_CODE",{value:"E332",enumerable:!1,configurable:!0});return t}finally{var l;await(null==(l=e.request.body)?void 0:l.finalize())}}));