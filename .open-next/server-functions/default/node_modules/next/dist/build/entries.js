"use strict";function _export(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{createEntrypoints:function(){return createEntrypoints},createPagesMapping:function(){return createPagesMapping},finalizeEntrypoint:function(){return finalizeEntrypoint},getAppEntry:function(){return getAppEntry},getAppLoader:function(){return getAppLoader},getClientEntry:function(){return getClientEntry},getEdgeServerEntry:function(){return getEdgeServerEntry},getInstrumentationEntry:function(){return getInstrumentationEntry},getPageFilePath:function(){return getPageFilePath},getPageFromPath:function(){return getPageFromPath},getStaticInfoIncludingLayouts:function(){return getStaticInfoIncludingLayouts},runDependingOnPageType:function(){return runDependingOnPageType},sortByPageExts:function(){return sortByPageExts}});const _log=_interop_require_wildcard(require("./output/log")),_path=require("path"),_querystring=require("querystring"),_fs=_interop_require_default(require("fs")),_constants=require("../lib/constants"),_isapiroute=require("../lib/is-api-route"),_isedgeruntime=require("../lib/is-edge-runtime"),_constants1=require("../shared/lib/constants"),_utils=require("./utils"),_getpagestaticinfo=require("./analysis/get-page-static-info"),_normalizepathsep=require("../shared/lib/page-path/normalize-path-sep"),_normalizepagepath=require("../shared/lib/page-path/normalize-page-path"),_apppaths=require("../shared/lib/router/utils/app-paths"),_nextmiddlewareloader=require("./webpack/loaders/next-middleware-loader"),_isapprouteroute=require("../lib/is-app-route-route"),_getmetadataroute=require("../lib/metadata/get-metadata-route"),_nextrouteloader=require("./webpack/loaders/next-route-loader"),_isinternalcomponent=require("../lib/is-internal-component"),_ismetadataroute=require("../lib/metadata/is-metadata-route"),_routekind=require("../server/route-kind"),_utils1=require("./webpack/loaders/utils"),_normalizecatchallroutes=require("./normalize-catchall-routes"),_pagetypes=require("../lib/page-types"),_isapppageroute=require("../lib/is-app-page-route");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(_getRequireWildcardCache=function(e){return e?r:t})(e)}function _interop_require_wildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=_getRequireWildcardCache(t);if(r&&r.has(e))return r.get(e);var a={__proto__:null},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var i in e)if("default"!==i&&Object.prototype.hasOwnProperty.call(e,i)){var o=n?Object.getOwnPropertyDescriptor(e,i):null;o&&(o.get||o.set)?Object.defineProperty(a,i,o):a[i]=e[i]}return a.default=e,r&&r.set(e,a),a}function sortByPageExts(e){return(t,r)=>{const a=(0,_path.extname)(t),n=(0,_path.extname)(r);if(t.substring(0,t.length-a.length)!==t.substring(0,r.length-n.length))return 0;const i=e.indexOf(a.substring(1));return e.indexOf(n.substring(1))-i}}async function getStaticInfoIncludingLayouts({isInsideAppDir:e,pageExtensions:t,pageFilePath:r,appDir:a,config:n,isDev:i,page:o}){const s=e?_pagetypes.PAGE_TYPES.APP:_pagetypes.PAGE_TYPES.PAGES,p=await(0,_getpagestaticinfo.getPageStaticInfo)({nextConfig:n,pageFilePath:r,isDev:i,page:o,pageType:s});if(p.type===_pagetypes.PAGE_TYPES.PAGES||!a)return p;const g=[p];if((0,_isapppageroute.isAppPageRoute)(o)){const s=[],p=t.map((e=>"layout."+e));let u=(0,_path.dirname)(r);for(;u.startsWith(a);){for(const e of p){const t=(0,_path.join)(u,e);_fs.default.existsSync(t)&&s.push(t)}u=(0,_path.join)(u,"..")}for(const t of s){const r=await(0,_getpagestaticinfo.getAppPageStaticInfo)({nextConfig:n,pageFilePath:t,isDev:i,page:o,pageType:e?_pagetypes.PAGE_TYPES.APP:_pagetypes.PAGE_TYPES.PAGES});g.unshift(r)}}const u=(0,_utils.reduceAppConfig)(g);return{...p,config:u,runtime:u.runtime,preferredRegion:u.preferredRegion,maxDuration:u.maxDuration}}function getPageFromPath(e,t){let r=(0,_normalizepathsep.normalizePathSep)(e.replace(new RegExp(`\\.+(${t.join("|")})$`),""));return r=r.replace(/\/index$/,""),""===r?"/":r}function getPageFilePath({absolutePagePath:e,pagesDir:t,appDir:r,rootDir:a}){return e.startsWith(_constants.PAGES_DIR_ALIAS)&&t?e.replace(_constants.PAGES_DIR_ALIAS,t):e.startsWith(_constants.APP_DIR_ALIAS)&&r?e.replace(_constants.APP_DIR_ALIAS,r):e.startsWith(_constants.ROOT_DIR_ALIAS)?e.replace(_constants.ROOT_DIR_ALIAS,a):require.resolve(e)}async function createPagesMapping({isDev:e,pageExtensions:t,pagePaths:r,pagesType:a,pagesDir:n,appDir:i}){const o="app"===a,s={},p=r.map((async r=>{if(r.endsWith(".d.ts")&&t.includes("ts"))return;let n=getPageFromPath(r,t);o&&(n=n.replace(/%5F/g,"_"),"/not-found"===n&&(n=_constants1.UNDERSCORE_NOT_FOUND_ROUTE_ENTRY));const p=(0,_normalizepathsep.normalizePathSep)((0,_path.join)("pages"===a?_constants.PAGES_DIR_ALIAS:"app"===a?_constants.APP_DIR_ALIAS:_constants.ROOT_DIR_ALIAS,r));let g="app"===a?(0,_getmetadataroute.normalizeMetadataRoute)(n):n;if("app"===a&&(0,_ismetadataroute.isMetadataRouteFile)(r,t,!0)){const t=(0,_path.join)(i,r),o=await(0,_getpagestaticinfo.getPageStaticInfo)({nextConfig:{},pageFilePath:t,isDev:e,page:n,pageType:a});g=(0,_getmetadataroute.normalizeMetadataPageToRoute)(g,!(!o.generateImageMetadata&&!o.generateSitemaps))}s[g]=p}));switch(await Promise.all(p),a){case _pagetypes.PAGE_TYPES.ROOT:return s;case _pagetypes.PAGE_TYPES.APP:return{...Object.keys(s).some((e=>e.endsWith("/page")))&&{[_constants1.UNDERSCORE_NOT_FOUND_ROUTE_ENTRY]:"next/dist/client/components/not-found-error"},...s};case _pagetypes.PAGE_TYPES.PAGES:{e&&(delete s["/_app"],delete s["/_error"],delete s["/_document"]);const t=e&&n?_constants.PAGES_DIR_ALIAS:"next/dist/pages";return{"/_app":`${t}/_app`,"/_error":`${t}/_error`,"/_document":`${t}/_document`,...s}}default:return{}}}function getEdgeServerEntry(e){var t;if("app"===e.pagesType&&(0,_isapprouteroute.isAppRouteRoute)(e.page)&&e.appDirLoader){const t={absolutePagePath:e.absolutePagePath,page:e.page,appDirLoader:Buffer.from(e.appDirLoader||"").toString("base64"),nextConfig:Buffer.from(JSON.stringify(e.config)).toString("base64"),preferredRegion:e.preferredRegion,middlewareConfig:Buffer.from(JSON.stringify(e.middlewareConfig||{})).toString("base64"),cacheHandlers:JSON.stringify(e.config.experimental.cacheHandlers||{})};return{import:`next-edge-app-route-loader?${(0,_querystring.stringify)(t)}!`,layer:_constants.WEBPACK_LAYERS.reactServerComponents}}if((0,_utils.isMiddlewareFile)(e.page)){var r;const t={absolutePagePath:e.absolutePagePath,page:e.page,rootDir:e.rootDir,matchers:(null==(r=e.middleware)?void 0:r.matchers)?(0,_nextmiddlewareloader.encodeMatchers)(e.middleware.matchers):"",preferredRegion:e.preferredRegion,middlewareConfig:Buffer.from(JSON.stringify(e.middlewareConfig||{})).toString("base64")};return{import:`next-middleware-loader?${(0,_querystring.stringify)(t)}!`,layer:_constants.WEBPACK_LAYERS.middleware}}if((0,_isapiroute.isAPIRoute)(e.page)){const t={absolutePagePath:e.absolutePagePath,page:e.page,rootDir:e.rootDir,preferredRegion:e.preferredRegion,middlewareConfig:Buffer.from(JSON.stringify(e.middlewareConfig||{})).toString("base64")};return`next-edge-function-loader?${(0,_querystring.stringify)(t)}!`}const a={absolute500Path:e.pages["/500"]||"",absoluteAppPath:e.pages["/_app"],absoluteDocumentPath:e.pages["/_document"],absoluteErrorPath:e.pages["/_error"],absolutePagePath:e.absolutePagePath,dev:e.isDev,isServerComponent:e.isServerComponent,page:e.page,stringifiedConfig:Buffer.from(JSON.stringify(e.config)).toString("base64"),pagesType:e.pagesType,appDirLoader:Buffer.from(e.appDirLoader||"").toString("base64"),sriEnabled:!e.isDev&&!!(null==(t=e.config.experimental.sri)?void 0:t.algorithm),cacheHandler:e.config.cacheHandler,preferredRegion:e.preferredRegion,middlewareConfig:Buffer.from(JSON.stringify(e.middlewareConfig||{})).toString("base64"),serverActions:e.config.experimental.serverActions,cacheHandlers:JSON.stringify(e.config.experimental.cacheHandlers||{})};return{import:`next-edge-ssr-loader?${JSON.stringify(a)}!`,layer:e.appDirLoader?_constants.WEBPACK_LAYERS.serverSideRendering:void 0}}function getInstrumentationEntry(e){const t=`${e.isEdgeServer?"edge-":e.isDev?"":"../"}${_constants.INSTRUMENTATION_HOOK_FILENAME}.js`;return{import:e.absolutePagePath,filename:t,layer:_constants.WEBPACK_LAYERS.instrument}}function getAppLoader(){return process.env.BUILTIN_APP_LOADER?"builtin:next-app-loader":"next-app-loader"}function getAppEntry(e){return process.env.NEXT_RSPACK&&process.env.BUILTIN_APP_LOADER&&(e.projectRoot=(0,_path.normalize)((0,_path.join)(__dirname,"../../.."))),{import:`${getAppLoader()}?${(0,_querystring.stringify)(e)}!`,layer:_constants.WEBPACK_LAYERS.reactServerComponents}}function getClientEntry(e){const t={absolutePagePath:e.absolutePagePath,page:e.page},r=`next-client-pages-loader?${(0,_querystring.stringify)(t)}!`;return"/_app"===e.page?[r,require.resolve("../client/router")]:r}function runDependingOnPageType(e){if(e.pageType===_pagetypes.PAGE_TYPES.ROOT&&(0,_utils.isInstrumentationHookFile)(e.page))return e.onServer(),void e.onEdgeServer();if((0,_utils.isMiddlewareFile)(e.page))return"nodejs"===e.pageRuntime?void e.onServer():void e.onEdgeServer();if((0,_isapiroute.isAPIRoute)(e.page))return(0,_isedgeruntime.isEdgeRuntime)(e.pageRuntime)?void e.onEdgeServer():void e.onServer();if("/_document"!==e.page){if("/_app"===e.page||"/_error"===e.page||"/404"===e.page||"/500"===e.page)return e.onClient(),void e.onServer();if((0,_isedgeruntime.isEdgeRuntime)(e.pageRuntime))return e.onClient(),void e.onEdgeServer();e.onClient(),e.onServer()}else e.onServer()}async function createEntrypoints(e){const{config:t,pages:r,pagesDir:a,isDev:n,rootDir:i,rootPaths:o,appDir:s,appPaths:p,pageExtensions:g}=e,u={},l={},_={};let d,c={};if(s&&p){for(const e in p){const t=(0,_apppaths.normalizeAppPath)(e),r=p[e];c[t]||(c[t]=[]),c[t].push(getPageFromPath(r,g).replace(_constants.APP_DIR_ALIAS,""))}(0,_normalizecatchallroutes.normalizeCatchAllRoutes)(c),c=Object.fromEntries(Object.entries(c).map((([e,t])=>[e,t.sort()])))}const P=(o,p)=>async P=>{const f=(0,_normalizepagepath.normalizePagePath)(P),E=_path.posix.join(p,f),m=p===_pagetypes.PAGE_TYPES.PAGES?_path.posix.join("pages",f):p===_pagetypes.PAGE_TYPES.APP?_path.posix.join("app",f):f.slice(1),A=o[P],S=getPageFilePath({absolutePagePath:A,pagesDir:a,appDir:s,rootDir:i}),h=!!s&&(A.startsWith(_constants.APP_DIR_ALIAS)||A.startsWith(s)),y=await getStaticInfoIncludingLayouts({isInsideAppDir:h,pageExtensions:g,pageFilePath:S,appDir:s,config:t,isDev:n,page:P}),R=h&&y.rsc!==_constants1.RSC_MODULE_TYPES.client;var I;(0,_utils.isMiddlewareFile)(P)&&(d=(null==(I=y.middleware)?void 0:I.matchers)??[{regexp:".*",originalSource:"/:path*"}]);const T=(0,_utils.isInstrumentationHookFile)(P)&&p===_pagetypes.PAGE_TYPES.ROOT;let C=null==y?void 0:y.runtime;(0,_utils.isMiddlewareFile)(P)&&!t.experimental.nodeMiddleware&&"nodejs"===C&&(_log.warn("nodejs runtime support for middleware requires experimental.nodeMiddleware be enabled in your next.config"),C="edge"),runDependingOnPageType({page:P,pageRuntime:y.runtime,pageType:p,onClient:()=>{R||h||(_[E]=getClientEntry({absolutePagePath:A,page:P}))},onServer:()=>{if("app"===p&&s){const e=c[(0,_apppaths.normalizeAppPath)(P)];l[m]=getAppEntry({page:P,name:m,pagePath:A,appDir:s,appPaths:e,pageExtensions:g,basePath:t.basePath,assetPrefix:t.assetPrefix,nextConfigOutput:t.output,nextConfigExperimentalUseEarlyImport:!!t.experimental.useEarlyImport||void 0,preferredRegion:y.preferredRegion,middlewareConfig:(0,_utils1.encodeToBase64)(y.middleware||{})})}else T?l[m.replace("src/","")]=getInstrumentationEntry({absolutePagePath:A,isEdgeServer:!1,isDev:!1}):(0,_utils.isMiddlewareFile)(P)?l[m.replace("src/","")]=getEdgeServerEntry({...e,rootDir:i,absolutePagePath:A,bundlePath:E,isDev:!1,isServerComponent:R,page:P,middleware:null==y?void 0:y.middleware,pagesType:p,preferredRegion:y.preferredRegion,middlewareConfig:y.middleware}):(0,_isapiroute.isAPIRoute)(P)?l[m]=[(0,_nextrouteloader.getRouteLoaderEntry)({kind:_routekind.RouteKind.PAGES_API,page:P,absolutePagePath:A,preferredRegion:y.preferredRegion,middlewareConfig:y.middleware||{}})]:(0,_utils.isMiddlewareFile)(P)||(0,_isinternalcomponent.isInternalComponent)(A)||(0,_isinternalcomponent.isNonRoutePagesPage)(P)?l[m]=[A]:l[m]=[(0,_nextrouteloader.getRouteLoaderEntry)({kind:_routekind.RouteKind.PAGES,page:P,pages:r,absolutePagePath:A,preferredRegion:y.preferredRegion,middlewareConfig:y.middleware??{}})]},onEdgeServer:()=>{let r="";if(T)u[m.replace("src/","")]=getInstrumentationEntry({absolutePagePath:A,isEdgeServer:!0,isDev:!1});else{if("app"===p){const e=c[(0,_apppaths.normalizeAppPath)(P)];r=getAppEntry({name:m,page:P,pagePath:A,appDir:s,appPaths:e,pageExtensions:g,basePath:t.basePath,assetPrefix:t.assetPrefix,nextConfigOutput:t.output,preferredRegion:y.preferredRegion,middlewareConfig:Buffer.from(JSON.stringify(y.middleware||{})).toString("base64")}).import}u[m]=getEdgeServerEntry({...e,rootDir:i,absolutePagePath:A,bundlePath:E,isDev:!1,isServerComponent:R,page:P,middleware:null==y?void 0:y.middleware,pagesType:p,appDirLoader:r,preferredRegion:y.preferredRegion,middlewareConfig:y.middleware})}}})},f=[];if(p){const e=P(p,_pagetypes.PAGE_TYPES.APP);f.push(Promise.all(Object.keys(p).map(e)))}return o&&f.push(Promise.all(Object.keys(o).map(P(o,_pagetypes.PAGE_TYPES.ROOT)))),f.push(Promise.all(Object.keys(r).map(P(r,_pagetypes.PAGE_TYPES.PAGES)))),await Promise.all(f),u.instrumentation&&1===Object.keys(u).length&&delete u.instrumentation,{client:_,server:l,edgeServer:u,middlewareMatchers:d}}function finalizeEntrypoint({name:e,compilerType:t,value:r,isServerComponent:a,hasAppDir:n}){const i="object"!=typeof r||Array.isArray(r)?{import:r}:r,o=e.startsWith("pages/api/"),s=(0,_utils.isInstrumentationHookFilename)(e);switch(t){case _constants1.COMPILER_NAMES.server:return{publicPath:o?"":void 0,runtime:o?"webpack-api-runtime":"webpack-runtime",layer:o?_constants.WEBPACK_LAYERS.api:s?_constants.WEBPACK_LAYERS.instrument:a?_constants.WEBPACK_LAYERS.reactServerComponents:e.startsWith("pages/")?_constants.WEBPACK_LAYERS.pagesDirNode:void 0,...i};case _constants1.COMPILER_NAMES.edgeServer:return{layer:o?_constants.WEBPACK_LAYERS.api:(0,_utils.isMiddlewareFilename)(e)||s?_constants.WEBPACK_LAYERS.middleware:e.startsWith("pages/")?_constants.WEBPACK_LAYERS.pagesDirEdge:void 0,library:{name:["_ENTRIES","middleware_[name]"],type:"assign"},runtime:_constants1.EDGE_RUNTIME_WEBPACK,asyncChunks:!1,...i};case _constants1.COMPILER_NAMES.client:{const t=n&&(e===_constants1.CLIENT_STATIC_FILES_RUNTIME_MAIN_APP||e===_constants1.APP_CLIENT_INTERNALS||e.startsWith("app/"));return e!==_constants1.CLIENT_STATIC_FILES_RUNTIME_POLYFILLS&&e!==_constants1.CLIENT_STATIC_FILES_RUNTIME_MAIN&&e!==_constants1.CLIENT_STATIC_FILES_RUNTIME_MAIN_APP&&e!==_constants1.CLIENT_STATIC_FILES_RUNTIME_AMP&&e!==_constants1.CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH?t?{dependOn:_constants1.CLIENT_STATIC_FILES_RUNTIME_MAIN_APP,layer:_constants.WEBPACK_LAYERS.appPagesBrowser,...i}:{dependOn:e.startsWith("pages/")&&"pages/_app"!==e?"pages/_app":_constants1.CLIENT_STATIC_FILES_RUNTIME_MAIN,layer:_constants.WEBPACK_LAYERS.pagesDirBrowser,...i}:t?{layer:_constants.WEBPACK_LAYERS.appPagesBrowser,...i}:{layer:_constants.WEBPACK_LAYERS.pagesDirBrowser,...i}}default:throw Object.defineProperty(new Error("Invalid compiler type"),"__NEXT_ERROR_CODE",{value:"E498",enumerable:!1,configurable:!0})}}