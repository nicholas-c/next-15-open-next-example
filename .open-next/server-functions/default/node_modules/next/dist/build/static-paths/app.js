"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"buildAppStaticPaths",{enumerable:!0,get:function(){return buildAppStaticPaths}});const _path=_interop_require_default(require("path")),_runwithafter=require("../../server/after/run-with-after"),_workstore=require("../../server/async-storage/work-store"),_fallback=require("../../lib/fallback"),_routematcher=require("../../shared/lib/router/utils/route-matcher"),_routeregex=require("../../shared/lib/router/utils/route-regex"),_utils=require("./utils"),_escapepathdelimiters=_interop_require_default(require("../../shared/lib/router/utils/escape-path-delimiters")),_createincrementalcache=require("../../export/helpers/create-incremental-cache");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function areParamValuesEqual(e,r){return e===r||!(!Array.isArray(e)||!Array.isArray(r))&&(e.length===r.length&&e.every((e=>r.includes(e))))}function filterUniqueParams(e,r){const a=[];for(const t of r){let r=0;for(;r<a.length;r++){const n=a[r];let o=0;for(;o<e.length;o++){const r=e[o];if(!areParamValuesEqual(n[r],t[r]))break}if(o===e.length)break}r<a.length||a.push(t)}return a}function filterRootParamsCombinations(e,r){const a=[];for(const t of r){const r={};let n=0;for(;n<e.length;n++){const a=e[n];if(!t[a])break;r[a]=t[a]}n<e.length||a.push(r)}return a}function validateParams(e,r,a,t,n,o){const i=[];if(a&&n.length>0&&(0===o.length||n.some((e=>o.some((r=>!(e in r))))))){if(1===n.length)throw Object.defineProperty(new Error(`A required root parameter (${n[0]}) was not provided in generateStaticParams for ${e}, please provide at least one value.`),"__NEXT_ERROR_CODE",{value:"E622",enumerable:!1,configurable:!0});throw Object.defineProperty(new Error(`Required root params (${n.join(", ")}) were not provided in generateStaticParams for ${e}, please provide at least one value for each.`),"__NEXT_ERROR_CODE",{value:"E621",enumerable:!1,configurable:!0})}for(const n of o){const o={};for(const i of t){const{repeat:t,optional:c}=r.groups[i];let l=n[i];if(c&&n.hasOwnProperty(i)&&(null==l||!1===l)&&(l=[]),!l&&a)break;if(t){if(!Array.isArray(l))throw Object.defineProperty(new Error(`A required parameter (${i}) was not provided as an array received ${typeof l} in generateStaticParams for ${e}`),"__NEXT_ERROR_CODE",{value:"E618",enumerable:!1,configurable:!0})}else if("string"!=typeof l)throw Object.defineProperty(new Error(`A required parameter (${i}) was not provided as a string received ${typeof l} in generateStaticParams for ${e}`),"__NEXT_ERROR_CODE",{value:"E617",enumerable:!1,configurable:!0});o[i]=l}i.push(o)}return i}async function buildAppStaticPaths({dir:e,page:r,distDir:a,dynamicIO:t,authInterrupts:n,segments:o,isrFlushToDisk:i,cacheHandler:c,cacheLifeProfiles:l,requestHeaders:s,cacheHandlers:u,maxMemoryCacheSize:f,fetchCacheKeyPrefix:d,nextConfigOutput:p,ComponentMod:h,isRoutePPREnabled:m=!1,buildId:_,rootParamKeys:g}){if(o.some((e=>{var r;return!0===(null==(r=e.config)?void 0:r.dynamicParams)}))&&"export"===p)throw Object.defineProperty(new Error('"dynamicParams: true" cannot be used with "output: export". See more info here: https://nextjs.org/docs/app/building-your-application/deploying/static-exports'),"__NEXT_ERROR_CODE",{value:"E393",enumerable:!1,configurable:!0});h.patchFetch();const b=await(0,_createincrementalcache.createIncrementalCache)({dir:e,distDir:a,cacheHandler:c,cacheHandlers:u,requestHeaders:s,fetchCacheKeyPrefix:d,flushToDisk:i,cacheMaxMemorySize:f}),P=(0,_routeregex.getRouteRegex)(r),R=Object.keys((0,_routematcher.getRouteMatcher)(P)(r)||{}),y=new _runwithafter.AfterRunner,E=(0,_workstore.createWorkStore)({page:r,fallbackRouteParams:null,renderOpts:{incrementalCache:b,cacheLifeProfiles:l,supportsDynamicResponse:!0,isRevalidate:!1,experimental:{dynamicIO:t,authInterrupts:n},waitUntil:y.context.waitUntil,onClose:y.context.onClose,onAfterTaskError:y.context.onTaskError},buildId:_}),v=await h.workAsyncStorage.run(E,(async()=>{async function e(r=[],a=0){if(a===o.length)return r;const t=o[a];if("function"!=typeof t.generateStaticParams&&a<o.length)return e(r,a+1);const n=[];var i;if(t.generateStaticParams)if(void 0!==(null==(i=t.config)?void 0:i.fetchCache)&&(E.fetchCache=t.config.fetchCache),r.length>0)for(const e of r){const r=await t.generateStaticParams({params:e});for(const a of r)n.push({...e,...a})}else{const e=await t.generateStaticParams({params:{}});n.push(...e)}return a<o.length?e(n,a+1):n}return e()}));let k=!1;for(const r of o){var O;if(r.param&&r.isDynamicSegment&&!1===(null==(O=r.config)?void 0:O.dynamicParams))for(const a of v){if(r.param in a)continue;const t=r.filePath?_path.default.relative(e,r.filePath):void 0;throw Object.defineProperty(new Error(`Segment "${t}" exports "dynamicParams: false" but the param "${r.param}" is missing from the generated route params.`),"__NEXT_ERROR_CODE",{value:"E280",enumerable:!1,configurable:!0})}r.isDynamicSegment&&"function"!=typeof r.generateStaticParams?k=!1:"function"==typeof r.generateStaticParams&&(k=!0)}const w=0===R.length||v.length>0&&v.every((e=>{for(const r of R)if(!(r in e))return!1;return!0})),C=o.every((e=>{var r;return!1!==(null==(r=e.config)?void 0:r.dynamicParams)})),S=w||"production"===process.env.NODE_ENV,q=C?S?m?_fallback.FallbackMode.PRERENDER:_fallback.FallbackMode.BLOCKING_STATIC_RENDER:void 0:_fallback.FallbackMode.NOT_FOUND,x={fallbackMode:q,prerenderedRoutes:k?[]:void 0};return(w||m)&&(m&&(v.unshift(...filterRootParamsCombinations(g,v)),x.prerenderedRoutes??=[],x.prerenderedRoutes.push({pathname:r,encodedPathname:r,fallbackRouteParams:R,fallbackMode:C?g.length>0?_fallback.FallbackMode.BLOCKING_STATIC_RENDER:q:_fallback.FallbackMode.NOT_FOUND,fallbackRootParams:g})),filterUniqueParams(R,validateParams(r,P,m,R,g,v)).forEach((e=>{let a=r,t=r;const n=[];for(const r of R){if(n.length>0){n.push(r);continue}let o=e[r];if(!o){if(m){n.push(r);continue}return}const{repeat:i,optional:c}=P.groups[r];let l=`[${i?"...":""}${r}]`;c&&(l=`[${l}]`),a=a.replace(l,(0,_utils.encodeParam)(o,(e=>(0,_escapepathdelimiters.default)(e,!0)))),t=t.replace(l,(0,_utils.encodeParam)(o,encodeURIComponent))}const o=g.filter((e=>n.includes(e)));x.prerenderedRoutes??=[],x.prerenderedRoutes.push({pathname:(0,_utils.normalizePathname)(a),encodedPathname:(0,_utils.normalizePathname)(t),fallbackRouteParams:n,fallbackMode:C?o.length>0?_fallback.FallbackMode.BLOCKING_STATIC_RENDER:q:_fallback.FallbackMode.NOT_FOUND,fallbackRootParams:o})}))),await y.executeAfter(),x}