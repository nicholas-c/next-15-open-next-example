"use strict";function _export(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{getAppPageStaticInfo:function(){return getAppPageStaticInfo},getMiddlewareMatchers:function(){return getMiddlewareMatchers},getPageStaticInfo:function(){return getPageStaticInfo},getPagesPageStaticInfo:function(){return getPagesPageStaticInfo},getRSCModuleInformation:function(){return getRSCModuleInformation},hadUnsupportedValue:function(){return hadUnsupportedValue}});const _fs=require("fs"),_lrucache=require("../../server/lib/lru-cache"),_extractconstvalue=require("./extract-const-value"),_parsemodule=require("./parse-module"),_log=_interop_require_wildcard(require("../output/log")),_constants=require("../../lib/constants"),_trytoparsepath=require("../../lib/try-to-parse-path"),_isapiroute=require("../../lib/is-api-route"),_isedgeruntime=require("../../lib/is-edge-runtime"),_constants1=require("../../shared/lib/constants"),_pagetypes=require("../../lib/page-types"),_appsegmentconfig=require("../segment-config/app/app-segment-config"),_zod=require("../../shared/lib/zod"),_pagessegmentconfig=require("../segment-config/pages/pages-segment-config"),_middlewareconfig=require("../segment-config/middleware/middleware-config"),_apppaths=require("../../shared/lib/router/utils/app-paths"),_normalizepagepath=require("../../shared/lib/page-path/normalize-page-path");function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(_getRequireWildcardCache=function(e){return e?r:t})(e)}function _interop_require_wildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=_getRequireWildcardCache(t);if(r&&r.has(e))return r.get(e);var a={__proto__:null},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var i=n?Object.getOwnPropertyDescriptor(e,o):null;i&&(i.get||i.set)?Object.defineProperty(a,o,i):a[o]=e[o]}return a.default=e,r&&r.set(e,a),a}const PARSE_PATTERN=/(?<!(_jsx|jsx-))runtime|preferredRegion|getStaticProps|getServerSideProps|generateStaticParams|export const|generateImageMetadata|generateSitemaps/,CLIENT_MODULE_LABEL=/\/\* __next_internal_client_entry_do_not_use__ ([^ ]*) (cjs|auto) \*\//,ACTION_MODULE_LABEL=/\/\* __next_internal_action_entry_do_not_use__ (\{[^}]+\}) \*\//,CLIENT_DIRECTIVE="use client",SERVER_ACTION_DIRECTIVE="use server";function getRSCModuleInformation(e,t){const r=e.match(ACTION_MODULE_LABEL),a=r?JSON.parse(r[1]):void 0,n=e.match(CLIENT_MODULE_LABEL),o=!!n;if(!t)return{type:_constants1.RSC_MODULE_TYPES.client,actionIds:a,isClientRef:o};const i=null==n?void 0:n[1],s=i?i.split(","):[],c=null==n?void 0:n[2];return{type:n?_constants1.RSC_MODULE_TYPES.client:_constants1.RSC_MODULE_TYPES.server,actionIds:a,clientRefs:s,clientEntryType:c,isClientRef:o}}function checkExports(e,t,r){const a=new Set(["getStaticProps","getServerSideProps","generateImageMetadata","generateSitemaps","generateStaticParams"]);if(!Array.isArray(null==e?void 0:e.body))return{};try{let d=!1,g=!1,f=!1,_=!1,m=!1,E=new Set,P=new Set,S=!1;for(const h of e.body){var n,o,i,s,c;if("ExpressionStatement"===h.type&&"StringLiteral"===h.expression.type){if(!S){const e=h.expression.value;CLIENT_DIRECTIVE===e&&P.add("client"),SERVER_ACTION_DIRECTIVE===e&&P.add("server")}}else S=!0;if("ExportDeclaration"===h.type&&"VariableDeclaration"===(null==(n=h.declaration)?void 0:n.type))for(const e of null==(c=h.declaration)?void 0:c.declarations)t.includes(e.id.value)&&E.add(e.id.value);if("ExportDeclaration"===h.type&&"FunctionDeclaration"===(null==(o=h.declaration)?void 0:o.type)&&a.has(null==(i=h.declaration.identifier)?void 0:i.value)){const e=h.declaration.identifier.value;g="getServerSideProps"===e,d="getStaticProps"===e,f="generateImageMetadata"===e,_="generateSitemaps"===e,m="generateStaticParams"===e}if("ExportDeclaration"===h.type&&"VariableDeclaration"===(null==(s=h.declaration)?void 0:s.type)){var p,u;const e=null==(u=h.declaration)||null==(p=u.declarations[0])?void 0:p.id.value;a.has(e)&&(g="getServerSideProps"===e,d="getStaticProps"===e,f="generateImageMetadata"===e,_="generateSitemaps"===e,m="generateStaticParams"===e)}if("ExportNamedDeclaration"===h.type)for(const e of h.specifiers){var l;if("ExportSpecifier"===e.type&&"Identifier"===(null==(l=e.orig)?void 0:l.type)){const a=e.orig.value;g||"getServerSideProps"!==a||(g=!0),d||"getStaticProps"!==a||(d=!0),f||"generateImageMetadata"!==a||(f=!0),_||"generateSitemaps"!==a||(_=!0),m||"generateStaticParams"!==a||(m=!0),t.includes(a)&&!E.has(a)&&_log.warn(`Next.js can't recognize the exported \`${a}\` field in "${r}", it may be re-exported from another file. The default config will be used instead.`)}}}return{getStaticProps:d,getServerSideProps:g,generateImageMetadata:f,generateSitemaps:_,generateStaticParams:m,directives:P,exports:E}}catch{}return{}}async function tryToReadFile(e,t){try{return await _fs.promises.readFile(e,{encoding:"utf8"})}catch(r){if(t)throw r.message=`Next.js ERROR: Failed to read file ${e}:\n${r.message}`,r}}function getMiddlewareMatchers(e,t){const r=Array.isArray(e)?e:[e],{i18n:a}=t;return r.map((e=>{const r=(e="string"==typeof e?{source:e}:e).source;let{source:n,...o}=e;const i="/"===n;(null==a?void 0:a.locales)&&!1!==e.locale&&(n=`/:nextInternalLocale((?!_next/)[^/.]{1,})${i?"":n}`),n=`/:nextData(_next/data/[^/]{1,})?${n}${i?`(${t.i18n?"|\\.json|":""}/?index|/?index\\.json)?`:"{(\\.json)}?"}`,t.basePath&&(n=`${t.basePath}${n}`);const s=_middlewareconfig.SourceSchema.safeParse(n);return s.success||((0,_zod.reportZodError)("Failed to parse middleware source",s.error),process.exit(1)),{...o,regexp:(0,_trytoparsepath.tryToParsePath)(s.data).regexStr,originalSource:r||n}}))}function parseMiddlewareConfig(e,t,r){if("object"!=typeof t||!t)return{};const a=_middlewareconfig.MiddlewareConfigInputSchema.safeParse(t);a.success||((0,_zod.reportZodError)(`${e} contains invalid middleware config`,a.error),process.exit(1));const n={};return a.data.matcher&&(n.matchers=getMiddlewareMatchers(a.data.matcher,r)),a.data.unstable_allowDynamic&&(n.unstable_allowDynamic=Array.isArray(a.data.unstable_allowDynamic)?a.data.unstable_allowDynamic:[a.data.unstable_allowDynamic]),a.data.regions&&(n.regions=a.data.regions),n}const apiRouteWarnings=new _lrucache.LRUCache(250);function warnAboutExperimentalEdge(e){"production"===process.env.NODE_ENV&&"1"===process.env.NEXT_PRIVATE_BUILD_WORKER||apiRouteWarnings.has(e)||(_log.warn(e?`${e} provided runtime 'experimental-edge'. It can be updated to 'edge' instead.`:"You are using an experimental edge runtime, the API might change."),apiRouteWarnings.set(e,1))}let hadUnsupportedValue=!1;const warnedUnsupportedValueMap=new _lrucache.LRUCache(250,(()=>1));function warnAboutUnsupportedValue(e,t,r){hadUnsupportedValue=!0;const a="production"===process.env.NODE_ENV;if("server"!==process.env.NEXT_COMPILER_NAME||a&&warnedUnsupportedValueMap.has(e))return;warnedUnsupportedValueMap.set(e,!0);const n="Next.js can't recognize the exported `config` field in "+(t?`route "${t}"`:`"${e}"`)+":\n"+r.message+(r.path?` at "${r.path}"`:"")+".\nRead More - https://nextjs.org/docs/messages/invalid-page-config";if(!a)throw Object.defineProperty(new Error(n),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});_log.error(n)}async function getAppPageStaticInfo({pageFilePath:e,nextConfig:t,isDev:r,page:a}){const n=await tryToReadFile(e,!r);if(!n||!PARSE_PATTERN.test(n))return{type:_pagetypes.PAGE_TYPES.APP,config:void 0,runtime:void 0,preferredRegion:void 0,maxDuration:void 0};const o=await(0,_parsemodule.parseModule)(e,n),{generateStaticParams:i,generateImageMetadata:s,generateSitemaps:c,exports:p,directives:u}=checkExports(o,_appsegmentconfig.AppSegmentConfigSchemaKeys,a),{type:l}=getRSCModuleInformation(n,!0),d={};if(p)for(const t of p)try{d[t]=(0,_extractconstvalue.extractExportedConstValue)(o,t)}catch(t){t instanceof _extractconstvalue.UnsupportedValueError&&warnAboutUnsupportedValue(e,a,t)}try{d.config=(0,_extractconstvalue.extractExportedConstValue)(o,"config")}catch(t){t instanceof _extractconstvalue.UnsupportedValueError&&warnAboutUnsupportedValue(e,a,t)}const g=(0,_apppaths.normalizeAppPath)(a),f=(0,_appsegmentconfig.parseAppSegmentConfig)(d,g);if((0,_isedgeruntime.isEdgeRuntime)(f.runtime)&&i)throw Object.defineProperty(new Error(`Page "${a}" cannot use both \`export const runtime = 'edge'\` and export \`generateStaticParams\`.`),"__NEXT_ERROR_CODE",{value:"E42",enumerable:!1,configurable:!0});if((null==u?void 0:u.has("client"))&&i)throw Object.defineProperty(new Error(`Page "${a}" cannot use both "use client" and export function "generateStaticParams()".`),"__NEXT_ERROR_CODE",{value:"E475",enumerable:!1,configurable:!0});return{type:_pagetypes.PAGE_TYPES.APP,rsc:l,generateImageMetadata:s,generateSitemaps:c,generateStaticParams:i,config:f,middleware:parseMiddlewareConfig(a,d.config,t),runtime:f.runtime,preferredRegion:f.preferredRegion,maxDuration:f.maxDuration}}async function getPagesPageStaticInfo({pageFilePath:e,nextConfig:t,isDev:r,page:a}){var n,o,i;const s=await tryToReadFile(e,!r);if(!s||!PARSE_PATTERN.test(s))return{type:_pagetypes.PAGE_TYPES.PAGES,config:void 0,runtime:void 0,preferredRegion:void 0,maxDuration:void 0};const c=await(0,_parsemodule.parseModule)(e,s),{getServerSideProps:p,getStaticProps:u,exports:l}=checkExports(c,_pagessegmentconfig.PagesSegmentConfigSchemaKeys,a),{type:d}=getRSCModuleInformation(s,!0),g={};if(l)for(const t of l)try{g[t]=(0,_extractconstvalue.extractExportedConstValue)(c,t)}catch(t){t instanceof _extractconstvalue.UnsupportedValueError&&warnAboutUnsupportedValue(e,a,t)}try{g.config=(0,_extractconstvalue.extractExportedConstValue)(c,"config")}catch(t){t instanceof _extractconstvalue.UnsupportedValueError&&warnAboutUnsupportedValue(e,a,t)}const f=(0,_normalizepagepath.normalizePagePath)(a),_=(0,_pagessegmentconfig.parsePagesSegmentConfig)(g,f),m=(0,_isapiroute.isAPIRoute)(f),E=_.runtime??(null==(n=_.config)?void 0:n.runtime);if(E===_constants.SERVER_RUNTIME.experimentalEdge&&warnAboutExperimentalEdge(m?a:null),E===_constants.SERVER_RUNTIME.edge&&a&&!m){const e=`Page ${a} provided runtime 'edge', the edge runtime for rendering is currently experimental. Use runtime 'experimental-edge' instead.`;if(!r)throw Object.defineProperty(new Error(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});_log.error(e)}return{type:_pagetypes.PAGE_TYPES.PAGES,getStaticProps:u,getServerSideProps:p,rsc:d,config:_,middleware:parseMiddlewareConfig(a,g.config,t),runtime:E,preferredRegion:null==(o=_.config)?void 0:o.regions,maxDuration:_.maxDuration??(null==(i=_.config)?void 0:i.maxDuration)}}async function getPageStaticInfo(e){return e.pageType===_pagetypes.PAGE_TYPES.APP?getAppPageStaticInfo(e):getPagesPageStaticInfo(e)}