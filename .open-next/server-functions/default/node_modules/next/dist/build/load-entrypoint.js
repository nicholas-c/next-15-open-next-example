"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"loadEntrypoint",{enumerable:!0,get:function(){return loadEntrypoint}});const _promises=_interop_require_default(require("fs/promises")),_path=_interop_require_default(require("path"));function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}const PACKAGE_ROOT=_path.default.normalize(_path.default.join(__dirname,"../../..")),TEMPLATE_FOLDER=_path.default.join(__dirname,"templates"),TEMPLATES_ESM_FOLDER=_path.default.normalize(_path.default.join(__dirname,"../../dist/esm/build/templates"));async function loadEntrypoint(e,t,r,n){const a=_path.default.resolve(_path.default.join(TEMPLATES_ESM_FOLDER,`${e}.js`));let i=await _promises.default.readFile(a,"utf8"),o=0;if(i=i.replaceAll(/from '(\..*)'|import '(\..*)'/g,(function(e,t,r){o++;const n=_path.default.relative(PACKAGE_ROOT,_path.default.resolve(TEMPLATE_FOLDER,t??r)).replace(/\\/g,"/");if(!n.startsWith("next/"))throw Object.defineProperty(new Error(`Invariant: Expected relative import to start with "next/", found "${n}"`),"__NEXT_ERROR_CODE",{value:"E214",enumerable:!1,configurable:!0});return t?`from ${JSON.stringify(n)}`:`import ${JSON.stringify(n)}`})),0===o)throw Object.defineProperty(new Error("Invariant: Expected to replace at least one import"),"__NEXT_ERROR_CODE",{value:"E363",enumerable:!1,configurable:!0});const l=new Set;i=i.replaceAll(new RegExp(`${Object.keys(t).map((e=>`'${e}'`)).join("|")}`,"g"),(e=>{const r=JSON.parse(e.replace(/'/g,'"'));if(!(r in t))throw Object.defineProperty(new Error(`Invariant: Unexpected template variable ${r}`),"__NEXT_ERROR_CODE",{value:"E9",enumerable:!1,configurable:!0});return l.add(r),JSON.stringify(t[r])}));let _=i.match(/VAR_[A-Z_]+/g);if(_)throw Object.defineProperty(new Error(`Invariant: Expected to replace all template variables, found ${_.join(", ")}`),"__NEXT_ERROR_CODE",{value:"E415",enumerable:!1,configurable:!0});if(l.size!==Object.keys(t).length){const e=Object.keys(t).filter((e=>!l.has(e)));throw Object.defineProperty(new Error(`Invariant: Expected to replace all template variables, missing ${e.join(", ")} in template`),"__NEXT_ERROR_CODE",{value:"E196",enumerable:!1,configurable:!0})}const E=new Set;if(r&&(i=i.replaceAll(new RegExp(`// INJECT:(${Object.keys(r).join("|")})`,"g"),((e,t)=>{if(!(t in r))throw Object.defineProperty(new Error(`Invariant: Unexpected injection ${t}`),"__NEXT_ERROR_CODE",{value:"E26",enumerable:!1,configurable:!0});return E.add(t),`const ${t} = ${r[t]}`}))),_=i.match(/\/\/ INJECT:[A-Za-z0-9_]+/g),_)throw Object.defineProperty(new Error(`Invariant: Expected to inject all injections, found ${_.join(", ")}`),"__NEXT_ERROR_CODE",{value:"E84",enumerable:!1,configurable:!0});if(E.size!==Object.keys(r??{}).length){const e=Object.keys(r??{}).filter((e=>!E.has(e)));throw Object.defineProperty(new Error(`Invariant: Expected to inject all injections, missing ${e.join(", ")} in template`),"__NEXT_ERROR_CODE",{value:"E382",enumerable:!1,configurable:!0})}const c=new Set;if(n&&(i=i.replaceAll(new RegExp(`// OPTIONAL_IMPORT:(\\* as )?(${Object.keys(n).join("|")})`,"g"),((e,t="",r)=>{if(!(r in n))throw Object.defineProperty(new Error(`Invariant: Unexpected optional import ${r}`),"__NEXT_ERROR_CODE",{value:"E85",enumerable:!1,configurable:!0});return c.add(r),n[r]?`import ${t}${r} from ${JSON.stringify(n[r])}`:`const ${r} = null`}))),_=i.match(/\/\/ OPTIONAL_IMPORT:(\* as )?[A-Za-z0-9_]+/g),_)throw Object.defineProperty(new Error(`Invariant: Expected to inject all imports, found ${_.join(", ")}`),"__NEXT_ERROR_CODE",{value:"E384",enumerable:!1,configurable:!0});if(c.size!==Object.keys(n??{}).length){const e=Object.keys(n??{}).filter((e=>!c.has(e)));throw Object.defineProperty(new Error(`Invariant: Expected to inject all imports, missing ${e.join(", ")} in template`),"__NEXT_ERROR_CODE",{value:"E150",enumerable:!1,configurable:!0})}return i}