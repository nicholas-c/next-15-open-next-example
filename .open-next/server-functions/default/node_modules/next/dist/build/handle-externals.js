"use strict";function _export(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{isResourceInPackages:function(){return isResourceInPackages},makeExternalHandler:function(){return makeExternalHandler},resolveExternal:function(){return resolveExternal}});const _requirehook=require("../server/require-hook"),_constants=require("../shared/lib/constants"),_path=_interop_require_default(require("../shared/lib/isomorphic/path")),_webpackconfig=require("./webpack-config"),_utils=require("./utils"),_normalizepathsep=require("../shared/lib/page-path/normalize-path-sep");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}const reactPackagesRegex=/^(react|react-dom|react-server-dom-webpack)($|\/)/,pathSeparators="[/\\\\]",optionalEsmPart=`((${pathSeparators}esm)?${pathSeparators})`,externalFileEnd="(\\.external(\\.js)?)$",nextDist=`next${pathSeparators}dist`,externalPattern=new RegExp(`${nextDist}${optionalEsmPart}.*${externalFileEnd}`),nodeModulesRegex=/node_modules[/\\].*\.[mc]?js$/;function isResourceInPackages(e,t,r){return!!t&&t.some((t=>r&&r.has(t)?e.startsWith(r.get(t)+_path.default.sep):e.includes(_path.default.sep+_path.default.join("node_modules",t.replace(/\//g,_path.default.sep))+_path.default.sep)))}async function resolveExternal(e,t,r,s,n,a,i,o,l=!0,c=_webpackconfig.NODE_ESM_RESOLVE_OPTIONS,u=_webpackconfig.NODE_RESOLVE_OPTIONS,p=_webpackconfig.NODE_BASE_ESM_RESOLVE_OPTIONS,d=_webpackconfig.NODE_BASE_RESOLVE_OPTIONS){const x="loose"===t;let f=null,m=!1;const _=!!t&&n?[!0,!1]:[!1];for(const t of _){const a=i(t?c:u);try{[f,m]=await a(r,s)}catch(e){f=null}if(f&&(n||!m||x)){if(o)return{localRes:o(f)};if(l){let t,r;try{const n=i(m?p:d);[t,r]=await n(e,s)}catch(e){t=null,r=!1}if(t!==f||m!==r){f=null;continue}}break}}return{res:f,isEsm:m}}function makeExternalHandler({config:e,optOutBundlingPackages:t,optOutBundlingPackageRegex:r,transpiledPackages:s,dir:n}){var a;let i;const o="loose"===(null==(a=e.experimental)?void 0:a.esmExternals);return async function(a,l,c,u,p){const d=l.startsWith(".")||_path.default.posix.isAbsolute(l)||"win32"===process.platform&&_path.default.win32.isAbsolute(l);if("next"===l)return"commonjs next/dist/lib/import-next-warning";const x=(0,_utils.isWebpackBundledLayer)(u);if(!d){if(/^next$/.test(l))return`commonjs ${l}`;if(reactPackagesRegex.test(l)&&!x)return`commonjs ${l}`;if(/^(?:private-next-pages\/|next\/(?:dist\/pages\/|(?:app|document|link|form|image|legacy\/image|constants|dynamic|script|navigation|headers|router)$)|string-hash|private-next-rsc-action-validate|private-next-rsc-action-client-wrapper|private-next-rsc-server-reference|private-next-rsc-cache-wrapper$)/.test(l))return}if(l.includes("@swc/helpers"))return;if(l.startsWith(_constants.BARREL_OPTIMIZATION_PREFIX))return;const f="esm"===c;if((0,_utils.isWebpackServerOnlyLayer)(u)&&"next/dist/compiled/@vercel/og/index.node.js"===l)return`module ${l}`;if(l.startsWith("next/dist/")){if(/^next[\\/]dist[\\/]shared[\\/]lib[\\/]image-loader/.test(l))return;return/^next[\\/]dist[\\/]compiled[\\/]next-server/.test(l)||(/^next[\\/]dist[\\/]shared[\\/](?!lib[\\/]router[\\/]router)/.test(l)||/^next[\\/]dist[\\/]compiled[\\/].*\.c?js$/.test(l))?`commonjs ${l}`:/^next[\\/]dist[\\/]esm[\\/]shared[\\/](?!lib[\\/]router[\\/]router)/.test(l)||/^next[\\/]dist[\\/]compiled[\\/].*\.mjs$/.test(l)?`module ${l}`:resolveNextExternal(l)}const m=await resolveExternal(n,e.experimental.esmExternals,a,l,f,t,p,d?resolveNextExternal:void 0);if("localRes"in m)return m.localRes;"styled-jsx/style"===l&&(m.res=_requirehook.defaultOverrides["styled-jsx/style"]);const{res:_,isEsm:g}=m;if(!_)return;const E=r.test(_);if(!E&&x)return;if(!f&&g&&!o&&!d)throw Object.defineProperty(new Error(`ESM packages (${l}) need to be imported. Use 'import' to reference the package instead. https://nextjs.org/docs/messages/import-esm-externals`),"__NEXT_ERROR_CODE",{value:"E310",enumerable:!1,configurable:!0});const h=g?"module":"commonjs";if(/node_modules[/\\]@babel[/\\]runtime[/\\]/.test(_))return;if(/node_modules[/\\]webpack/.test(_)||/node_modules[/\\]css-loader/.test(_))return;if(s&&!i){i=new Map;for(const r of s){const s=await resolveExternal(n,e.experimental.esmExternals,a,r+"/package.json",f,t,p,d?resolveNextExternal:void 0);s.res&&i.set(r,_path.default.dirname(s.res))}}const v=resolveBundlingOptOutPackages({resolvedRes:_,config:e,resolvedExternalPackageDirs:i,isAppLayer:x,externalType:h,isOptOutBundling:E,request:l,transpiledPackages:s});return v||void 0}}function resolveBundlingOptOutPackages({resolvedRes:e,config:t,resolvedExternalPackageDirs:r,isAppLayer:s,externalType:n,isOptOutBundling:a,request:i,transpiledPackages:o}){if(nodeModulesRegex.test(e)){if(!(!s&&t.bundlePagesRouterDependencies&&!a||isResourceInPackages(e,o,r)))return`${n} ${i}`}}function resolveNextExternal(e){if(externalPattern.test(e))return`commonjs ${(0,_normalizepathsep.normalizePathSep)(e.replace(/.*?next[/\\]dist/,"next/dist"))}`}