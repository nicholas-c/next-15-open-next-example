"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return getConfig}});const _fs=require("fs"),_json5=_interop_require_default(require("next/dist/compiled/json5")),_core=require("next/dist/compiled/babel/core"),_corelibconfig=_interop_require_default(require("next/dist/compiled/babel/core-lib-config")),_util=require("./util"),_log=_interop_require_wildcard(require("../../output/log")),_pluginsyntaxjsx=_interop_require_default(require("next/dist/compiled/babel/plugin-syntax-jsx"));function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(_getRequireWildcardCache=function(e){return e?r:t})(e)}function _interop_require_wildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=_getRequireWildcardCache(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}const nextDistPath=/(next[\\/]dist[\\/]shared[\\/]lib)|(next[\\/]dist[\\/]client)|(next[\\/]dist[\\/]pages)/,fileExtensionRegex=/\.([a-z]+)$/;function getCacheCharacteristics(e,t,r){var n;const{isServer:i,pagesDir:o}=e;return{isServer:i,isPageFile:r.startsWith(o),isNextDist:nextDistPath.test(r),hasModuleExports:-1!==t.indexOf("module.exports"),fileExt:(null==(n=fileExtensionRegex.exec(r))?void 0:n[1])||"unknown"}}function getPlugins(e,t){const{isServer:r,isPageFile:n,isNextDist:i,hasModuleExports:o}=t,{development:s}=e,l="standalone"!==e.transformMode&&e.hasReactRefresh,a=o?(0,_core.createConfigItem)(require("../plugins/commonjs"),{type:"plugin"}):null;return[l?(0,_core.createConfigItem)([require("next/dist/compiled/react-refresh/babel"),{skipEnvCheck:!0}],{type:"plugin"}):null,!r&&n?(0,_core.createConfigItem)([require("../plugins/next-page-config")],{type:"plugin"}):null,!r&&n?(0,_core.createConfigItem)([require("../plugins/next-page-disallow-re-export-all-exports")],{type:"plugin"}):null,a,(0,_core.createConfigItem)([require.resolve("next/dist/compiled/babel/plugin-transform-define"),{"process.env.NODE_ENV":s?"development":"production","typeof window":r?"undefined":"object","process.browser":!r},"next-js-transform-define-instance"],{type:"plugin"}),!r&&n?(0,_core.createConfigItem)([require.resolve("../plugins/next-ssg-transform")],{type:"plugin"}):null,i?(0,_core.createConfigItem)(require("next/dist/compiled/babel/plugin-transform-modules-commonjs"),{type:"plugin"}):null,(0,_core.createConfigItem)([require("../plugins/next-font-unsupported")],{type:"plugin"})].filter(Boolean)}const isJsonFile=/\.(json|babelrc)$/,isJsFile=/\.js$/;function getCustomBabelConfig(e){if(isJsonFile.exec(e)){const t=(0,_fs.readFileSync)(e,"utf8");return _json5.default.parse(t)}if(isJsFile.exec(e))return require(e);throw Object.defineProperty(new Error("The Next.js Babel loader does not support .mjs or .cjs config files."),"__NEXT_ERROR_CODE",{value:"E477",enumerable:!1,configurable:!0})}let babelConfigWarned=!1;function checkCustomBabelConfigDeprecation(e){if(!e||0===Object.keys(e).length)return;const{plugins:t,presets:r,...n}=e;if(Object.keys(n??{}).length>0)return;if(babelConfigWarned)return;babelConfigWarned=!0;const i=!r||0===r.length||1===r.length&&"next/babel"===r[0],o=[],s=[];if(Array.isArray(t))for(const e of t){const t=Array.isArray(e)?e[0]:e;switch(t){case"styled-components":case"babel-plugin-styled-components":o.push("\t- 'styled-components' can be enabled via 'compiler.styledComponents' in 'next.config.js'");break;case"@emotion/babel-plugin":o.push("\t- '@emotion/babel-plugin' can be enabled via 'compiler.emotion' in 'next.config.js'");break;case"babel-plugin-relay":o.push("\t- 'babel-plugin-relay' can be enabled via 'compiler.relay' in 'next.config.js'");break;case"react-remove-properties":o.push("\t- 'react-remove-properties' can be enabled via 'compiler.reactRemoveProperties' in 'next.config.js'");break;case"transform-remove-console":o.push("\t- 'transform-remove-console' can be enabled via 'compiler.removeConsole' in 'next.config.js'");break;default:s.push(t)}}i&&0===s.length&&(_log.warn("It looks like there is a custom Babel configuration that can be removed"+(o.length>0?":":".")),o.length>0&&(_log.warn("Next.js supports the following features natively: "),_log.warn(o.join("")),_log.warn("For more details configuration options, please refer https://nextjs.org/docs/architecture/nextjs-compiler#supported-features")))}function getFreshConfig(e,t,r,n,i){const o=!(t.reactCompilerPlugins&&0===t.reactCompilerPlugins.length||/[/\\]node_modules[/\\]/.test(n)||t.reactCompilerExclude&&t.reactCompilerExclude(n))?t.reactCompilerPlugins??[]:[];let{isServer:s,pagesDir:l,srcDir:a,development:c}=t,u={babelrc:!1,cloneInputAst:!1,filename:n,inputSourceMap:i||void 0,sourceFileName:n,sourceMaps:this.sourceMap};const p={name:"next-babel-turbo-loader",supportsStaticESM:!0,supportsDynamicImport:!0,target:r,supportsTopLevelAwait:!0,isServer:s,srcDir:a,pagesDir:l,isDev:c,...t.caller};if("standalone"===t.transformMode){if(!o.length)return null;u.plugins=[_pluginsyntaxjsx.default,...o],u.presets=[[require("next/dist/compiled/babel/preset-typescript"),{allowNamespaces:!0}]],u.caller=p}else{let{configFile:r,hasJsxRuntime:n}=t,i=r?getCustomBabelConfig(r):void 0;checkCustomBabelConfigDeprecation(i),u.sourceMaps=void 0===t.sourceMaps?this.sourceMap:t.sourceMaps,u.plugins=[...getPlugins(t,e),...o,...(null==i?void 0:i.plugins)||[]],u.target=s||null==i?void 0:i.target,u.env=null==i?void 0:i.env,u.presets=(null==i?void 0:i.presets)?i.presets:i?void 0:["next/babel"],u.overrides=t.overrides,u.caller={...p,hasJsxRuntime:n}}void 0===u.target&&delete u.target,Object.defineProperty(u.caller,"onWarning",{enumerable:!1,writable:!1,value:e=>{e instanceof Error||(e=Object.defineProperty(new Error(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0})),this.emitWarning(e)}});const f=(0,_core.loadOptions)(u);return(0,_util.consumeIterator)((0,_corelibconfig.default)(f))}function getCacheKey(e){const{isServer:t,isPageFile:r,isNextDist:n,hasModuleExports:i,fileExt:o}=e;return o+(0|(t?1:0)|(r?2:0)|(n?4:0)|(i?8:0))}const configCache=new Map,configFiles=new Set;function getConfig({source:e,target:t,loaderOptions:r,filename:n,inputSourceMap:i}){const o=getCacheCharacteristics(r,e,n);"default"===r.transformMode&&r.configFile&&this.addDependency(r.configFile);const s=getCacheKey(o);if(configCache.has(s)){const e=configCache.get(s);return e?{...e,options:{...e.options,cwd:r.cwd,root:r.cwd,filename:n,sourceFileName:n}}:null}"default"===r.transformMode&&r.configFile&&!configFiles.has(r.configFile)&&(configFiles.add(r.configFile),_log.info(`Using external babel configuration from ${r.configFile}`));const l=getFreshConfig.call(this,o,r,t,n,i);return configCache.set(s,l),l}