"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return loader}});const _Warning=_interop_require_default(require("./Warning")),_Error=_interop_require_default(require("./Error")),_utils=require("./utils");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}async function loader(e,t,r){const s=this.currentTraceSpan.traceChild("postcss-loader"),n=this.async();s.traceAsyncFn((async()=>{const n=this.getOptions(),a=this.resourcePath,i=void 0!==n.sourceMap?n.sourceMap:this.sourceMap,o={from:a,to:a};let c;i&&(o.map={inline:!1,annotation:!1,...o.map}),t&&o.map&&(o.map.prev=s.traceChild("normalize-source-map").traceFn((()=>(0,_utils.normalizeSourceMap)(t,this.context)))),r&&r.ast&&"postcss"===r.ast.type&&(({root:c}=r.ast),s.setAttribute("astUsed","true"));const{postcssWithPlugins:d}=await n.postcss();let l;try{l=await s.traceChild("postcss-process").traceAsyncFn((()=>d.process(c||e,o)))}catch(e){if(e.file&&this.addDependency(e.file),"CssSyntaxError"===e.name)throw Object.defineProperty(new _Error.default(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});throw e}for(const e of l.warnings())this.emitWarning(Object.defineProperty(new _Warning.default(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0}));for(const e of l.messages)switch(e.type){case"dependency":this.addDependency(e.file);break;case"build-dependency":this.addBuildDependency(e.file);break;case"missing-dependency":this.addMissingDependency(e.file);break;case"context-dependency":this.addContextDependency(e.file);break;case"dir-dependency":this.addContextDependency(e.dir);break;case"asset":e.content&&e.file&&this.emitFile(e.file,e.content,e.sourceMap,e.info)}let u=l.map?l.map.toJSON():void 0;u&&i&&(u=(0,_utils.normalizeSourceMapAfterPostcss)(u,this.context));const p={type:"postcss",version:l.processor.version,root:l.root};return[l.css,u,{ast:p}]})).then((([e,t,{ast:r}])=>{null==n||n(null,e,t,{ast:r})}),(e=>{null==n||n(e)}))}