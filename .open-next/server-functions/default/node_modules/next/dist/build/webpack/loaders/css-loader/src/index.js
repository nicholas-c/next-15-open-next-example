"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return loader}});const _CssSyntaxError=_interop_require_default(require("./CssSyntaxError")),_Warning=_interop_require_default(require("../../postcss-loader/src/Warning")),_stringifyrequest=require("../../../stringify-request");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}const moduleRegExp=/\.module\.\w+$/i;function getModulesOptions(e,t){const{resourcePath:o}=t;if(void 0===e.modules){if(!moduleRegExp.test(o))return!1}else if("boolean"==typeof e.modules&&!1===e.modules)return!1;let s={compileType:e.icss?"icss":"module",auto:!0,mode:"local",exportGlobals:!1,localIdentName:"[hash:base64]",localIdentContext:t.rootContext,localIdentHashPrefix:"",localIdentRegExp:void 0,namedExport:!1,exportLocalsConvention:"asIs",exportOnlyLocals:!1};if("boolean"==typeof e.modules||"string"==typeof e.modules)s.mode="string"==typeof e.modules?e.modules:"local";else{if(e.modules){if("boolean"==typeof e.modules.auto){if(!(e.modules.auto&&moduleRegExp.test(o)))return!1}else if(e.modules.auto instanceof RegExp){if(!e.modules.auto.test(o))return!1}else if("function"==typeof e.modules.auto){if(!e.modules.auto(o))return!1}!0===e.modules.namedExport&&void 0===e.modules.exportLocalsConvention&&(s.exportLocalsConvention="camelCaseOnly")}s={...s,...e.modules||{}}}if("function"==typeof s.mode&&(s.mode=s.mode(t.resourcePath)),!0===s.namedExport){if(!1===e.esModule)throw Object.defineProperty(new Error('The "modules.namedExport" option requires the "esModules" option to be enabled'),"__NEXT_ERROR_CODE",{value:"E103",enumerable:!1,configurable:!0});if("camelCaseOnly"!==s.exportLocalsConvention)throw Object.defineProperty(new Error('The "modules.namedExport" option requires the "modules.exportLocalsConvention" option to be "camelCaseOnly"'),"__NEXT_ERROR_CODE",{value:"E23",enumerable:!1,configurable:!0})}return s}function normalizeOptions(e,t){e.icss&&t.emitWarning(Object.defineProperty(new Error('The "icss" option is deprecated, use "modules.compileType: "icss"" instead'),"__NEXT_ERROR_CODE",{value:"E476",enumerable:!1,configurable:!0}));const o=getModulesOptions(e,t);return{url:void 0===e.url||e.url,import:void 0===e.import||e.import,modules:o,icss:void 0!==e.icss&&e.icss,sourceMap:"boolean"==typeof e.sourceMap?e.sourceMap:t.sourceMap,importLoaders:"string"==typeof e.importLoaders?parseInt(e.importLoaders,10):e.importLoaders,esModule:void 0===e.esModule||e.esModule,fontLoader:e.fontLoader}}async function loader(e,t,o){const s=this.getOptions(),r=[],i=this.async(),n=this.currentTraceSpan.traceChild("css-loader");n.traceAsyncFn((async()=>{let i;try{i=normalizeOptions(s,this)}catch(e){throw e}const{postcss:l}=await s.postcss(),{shouldUseModulesPlugins:u,shouldUseImportPlugin:a,shouldUseURLPlugin:d,shouldUseIcssPlugin:c,getPreRequester:p,getExportCode:m,getFilter:f,getImportCode:h,getModuleCode:_,getModulesPlugins:y,normalizeSourceMap:g,sort:x}=require("./utils"),{icssParser:E,importParser:R,urlParser:C}=require("./plugins"),O=[],b=i.fontLoader?o.exports:[];u(i)&&r.push(...y(i,this,o));const v=[],P=[];if(a(i)){const e=this.getResolve({conditionNames:["style"],extensions:[".css"],mainFields:["css","style","main","..."],mainFiles:["index","..."],restrictions:[/\.css$/i]});r.push(R({imports:v,api:P,context:this.context,rootContext:this.rootContext,filter:f(i.import,this.resourcePath),resolver:e,urlHandler:e=>(0,_stringifyrequest.stringifyRequest)(this,p(this)(i.importLoaders)+e)}))}const q=[];if(d(i)){const e=this.getResolve({conditionNames:["asset"],mainFields:["asset"],mainFiles:[],extensions:[]});r.push(C({imports:q,replacements:O,context:this.context,rootContext:this.rootContext,filter:f(i.url,this.resourcePath),resolver:e,urlHandler:e=>(0,_stringifyrequest.stringifyRequest)(this,e)}))}const M=[],L=[];if(c(i)){const e=this.getResolve({conditionNames:["style"],extensions:[],mainFields:["css","style","main","..."],mainFiles:["index","..."]});r.push(E({imports:M,api:L,replacements:O,exports:b,context:this.context,rootContext:this.rootContext,resolver:e,urlHandler:e=>(0,_stringifyrequest.stringifyRequest)(this,p(this)(i.importLoaders)+e)}))}if(o){const{ast:t}=o;t&&"postcss"===t.type&&(e=t.root,n.setAttribute("astUsed","true"))}const{resourcePath:w}=this;let T;try{T=await l(r).process(e,{from:w,to:w,map:!!i.sourceMap&&{prev:t?g(t,w):null,inline:!1,annotation:!1}})}catch(e){throw e.file&&this.addDependency(e.file),"CssSyntaxError"===e.name?Object.defineProperty(new _CssSyntaxError.default(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0}):e}for(const e of T.warnings())this.emitWarning(Object.defineProperty(new _Warning.default(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0}));const I=[...M.sort(x),...v.sort(x),...q.sort(x)],N=[...P.sort(x),...L.sort(x)];!0!==i.modules.exportOnlyLocals&&I.unshift({importName:"___CSS_LOADER_API_IMPORT___",url:(0,_stringifyrequest.stringifyRequest)(this,require.resolve("./runtime/api"))});return`${h(I,i)}${_(T,N,O,i,this)}${m(b,O,i)}`})).then((e=>{i(null,e)}),(e=>{i(e)}))}