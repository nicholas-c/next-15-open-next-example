"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"ClientReferenceManifestPlugin",{enumerable:!0,get:function(){return ClientReferenceManifestPlugin}});const _path=_interop_require_wildcard(require("path")),_webpack=require("next/dist/compiled/webpack/webpack"),_constants=require("../../../shared/lib/constants"),_buildcontext=require("../../build-context"),_constants1=require("../../../lib/constants"),_normalizepagepath=require("../../../shared/lib/page-path/normalize-page-path"),_deploymentid=require("../../deployment-id"),_utils=require("../utils"),_encodeuripath=require("../../../shared/lib/encode-uri-path");function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(_getRequireWildcardCache=function(e){return e?n:t})(e)}function _interop_require_wildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=_getRequireWildcardCache(t);if(n&&n.has(e))return n.get(e);var s={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var r=i?Object.getOwnPropertyDescriptor(e,o):null;r&&(r.get||r.set)?Object.defineProperty(s,o,r):s[o]=e[o]}return s.default=e,n&&n.set(e,s),s}const pluginState=(0,_buildcontext.getProxiedPluginState)({ssrModules:{},edgeSsrModules:{},rscModules:{},edgeRscModules:{}});function getAppPathRequiredChunks(e,t){const n=(0,_deploymentid.getDeploymentIdQueryOrEmptyString)(),s=[];return e.chunks.forEach((e=>{if(_constants.SYSTEM_ENTRYPOINTS.has(e.name||""))return null;if(null!=e.id){const i=""+e.id;e.files.forEach((e=>e.endsWith(".js")?e.endsWith(".hot-update.js")||t.has(e)?null:s.push(i,(0,_encodeuripath.encodeURIPath)(e)+n):null))}})),s}function entryNameToGroupName(e){let t=e.slice(0,e.lastIndexOf("/")).replace(/\/@[^/]+/g,"").replace(/\/\([^/]+\)(?=(\/|$))/g,"").replace(/\/\[?\[\.\.\.[^\]]*]]?/g,"");for(t=t.replace(/^.+\/\(\.\.\.\)/g,"app/").replace(/\/\(\.\)/g,"/");/\/[^/]+\/\(\.\.\)/.test(t);)t=t.replace(/\/[^/]+\/\(\.\.\)/g,"/");return t}function mergeManifest(e,t){Object.assign(e.clientModules,t.clientModules),Object.assign(e.ssrModuleMapping,t.ssrModuleMapping),Object.assign(e.edgeSSRModuleMapping,t.edgeSSRModuleMapping),Object.assign(e.entryCSSFiles,t.entryCSSFiles),Object.assign(e.rscModuleMapping,t.rscModuleMapping),Object.assign(e.edgeRscModuleMapping,t.edgeRscModuleMapping)}const PLUGIN_NAME="ClientReferenceManifestPlugin";class ClientReferenceManifestPlugin{constructor(e){this.dev=!1,this.dev=e.dev,this.appDir=e.appDir,this.appDirBase=_path.default.dirname(this.appDir)+_path.default.sep,this.experimentalInlineCss=e.experimentalInlineCss}apply(e){e.hooks.compilation.tap(PLUGIN_NAME,(t=>{t.hooks.processAssets.tap({name:PLUGIN_NAME,stage:_webpack.webpack.Compilation.PROCESS_ASSETS_STAGE_OPTIMIZE_HASH},(()=>this.createAsset(t,e.context)))}))}createAsset(e,t){var n;const s=new Map,i=[],o=e.outputOptions.crossOriginLoading,r="string"==typeof o?"use-credentials"===o?o:"anonymous":null;if("string"!=typeof e.outputOptions.publicPath)throw Object.defineProperty(new Error("Expected webpack publicPath to be a string when using App Router. To customize where static assets are loaded from, use the `assetPrefix` option in next.config.js. If you are customizing your webpack config please make sure you are not modifying or removing the publicPath configuration option"),"__NEXT_ERROR_CODE",{value:"E136",enumerable:!1,configurable:!0});const a=e.outputOptions.publicPath||"",l=new Set;null==(n=e.entrypoints.get(_constants.CLIENT_STATIC_FILES_RUNTIME_MAIN_APP))||n.getFiles().forEach((e=>{/(?<!\.hot-update)\.(js|css)($|\?)/.test(e)&&l.add(e.replace(/\\/g,"/"))}));for(let[c,u]of e.entrypoints){if(c===_constants.CLIENT_STATIC_FILES_RUNTIME_MAIN_APP||c===_constants.APP_CLIENT_INTERNALS)c="";else if(!/^app[\\/]/.test(c))continue;const p={moduleLoading:{prefix:a,crossOrigin:r},ssrModuleMapping:{},edgeSSRModuleMapping:{},clientModules:{},entryCSSFiles:{},rscModuleMapping:{},edgeRscModuleMapping:{}},d=(this.appDirBase+c).replace(/[\\/]/g,_path.default.sep);p.entryCSSFiles[d]=u.getFiles().filter((e=>!e.startsWith("static/css/pages/")&&e.endsWith(".css"))).map((t=>{const n=e.getAsset(t).source.source();return this.experimentalInlineCss&&!this.dev?{inlined:!0,path:t,content:"string"==typeof n?n:n.toString()}:{inlined:!1,path:t}}));const g=getAppPathRequiredChunks(u,l),M=(n,s)=>{var i,o,r;let a="css/mini-extract"===s.type?s.identifier().slice(s.identifier().lastIndexOf("!")+1):s.resource;if(!a)return;const l=p.clientModules,c=p.ssrModuleMapping,u=p.edgeSSRModuleMapping,d=p.rscModuleMapping,M=p.edgeRscModuleMapping;let f=(0,_path.relative)(t,(null==(i=s.resourceResolveData)?void 0:i.path)||a);const h=(0,_path.relative)(t,(null==(o=s.resourceResolveData)?void 0:o.path)||a);f.startsWith(".")||(f=`./${f.replace(/\\/g,"/")}`);const _=/[\\/]next[\\/]dist[\\/]/.test(a)?a.replace(/[\\/]next[\\/]dist[\\/]/,"/next/dist/esm/".replace(/\//g,_path.default.sep)):null;function S(){var t,i;const o=Boolean(e.moduleGraph.isAsync(s)||(null==(t=pluginState.ssrModules[f])?void 0:t.async)||(null==(i=pluginState.edgeSsrModules[f])?void 0:i.async)),r=a;if(p.clientModules[r]={id:n,name:"*",chunks:g,async:o},_){const e=_;p.clientModules[e]=p.clientModules[r]}}function m(){const e=a,t=pluginState.ssrModules[f];t&&(c[n]=c[n]||{},c[n]["*"]={...p.clientModules[e],chunks:[],id:t.moduleId,async:t.async});const s=pluginState.edgeSsrModules[f];s&&(u[n]=u[n]||{},u[n]["*"]={...p.clientModules[e],chunks:[],id:s.moduleId,async:s.async})}function y(){const e=a,t=pluginState.rscModules[h];t&&(d[n]=d[n]||{},d[n]["*"]={...p.clientModules[e],chunks:[],id:t.moduleId,async:t.async});const s=pluginState.ssrModules[h];s&&(M[n]=M[n]||{},M[n]["*"]={...p.clientModules[e],chunks:[],id:s.moduleId,async:s.async})}(null==(r=s.matchResource)?void 0:r.startsWith(_constants.BARREL_OPTIMIZATION_PREFIX))&&(f=(0,_utils.formatBarrelOptimizedResource)(f,s.matchResource),a=(0,_utils.formatBarrelOptimizedResource)(a,s.matchResource)),S(),m(),y(),p.clientModules=l,p.ssrModuleMapping=c,p.edgeSSRModuleMapping=u,p.rscModuleMapping=d,p.edgeRscModuleMapping=M},f=new Set,h=new Set;function _(t){if(!f.has(t)){f.add(t),t.chunks.forEach((t=>{if(h.has(t))return;h.add(t);const n=e.chunkGraph.getChunkEntryModulesIterable(t);for(const t of n){if(t.layer!==_constants1.WEBPACK_LAYERS.appPagesBrowser)continue;const n=t.request;if(!n||!n.includes("next-flight-client-entry-loader.js?"))continue;const o=(0,_utils.getModuleReferencesInOrder)(t,e.moduleGraph);for(const t of o){const n=t.dependency;if(!n)continue;const o=e.moduleGraph.getResolvedModule(n),r=e.chunkGraph.getModuleId(o);var s,i;if(null!==r)M(r,o);else if("ConcatenatedModule"===(null==(s=t.module)?void 0:s.constructor.name)||Boolean(process.env.NEXT_RSPACK)&&"ConcatenatedModule"===(null==(i=t.module)?void 0:i.constructorName)){const n=t.module,s=e.chunkGraph.getModuleId(n);s&&M(s,o)}}}}));for(const e of t.childrenIterable)_(e)}}_(u),/\/page(\.[^/]+)?$/.test(c)&&i.push(c.replace(/\/page(\.[^/]+)?$/,"/page")),/\/route$/.test(c)&&i.push(c);const S=entryNameToGroupName(c);s.has(S)||s.set(S,[]),s.get(S).push(p)}for(const m of i){const y={moduleLoading:{prefix:a,crossOrigin:r},ssrModuleMapping:{},edgeSSRModuleMapping:{},clientModules:{},entryCSSFiles:{},rscModuleMapping:{},edgeRscModuleMapping:{}},R=[...entryNameToGroupName(m).split("/"),"page"];let I="";for(const O of R){for(const C of s.get(I)||[])mergeManifest(y,C);I+=(I?"/":"")+O}const b=JSON.stringify(y),E=m.replace(/%5F/g,"_"),P=(0,_normalizepagepath.normalizePagePath)(E.slice("app".length));e.emitAsset("server/app"+P+"_"+_constants.CLIENT_REFERENCE_MANIFEST+".js",new _webpack.sources.RawSource(`globalThis.__RSC_MANIFEST=(globalThis.__RSC_MANIFEST||{});globalThis.__RSC_MANIFEST[${JSON.stringify(E.slice("app".length))}]=${b}`))}}}