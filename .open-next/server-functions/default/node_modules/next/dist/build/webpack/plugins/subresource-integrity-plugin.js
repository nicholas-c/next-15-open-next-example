"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"SubresourceIntegrityPlugin",{enumerable:!0,get:function(){return SubresourceIntegrityPlugin}});const _webpack=require("next/dist/compiled/webpack/webpack"),_crypto=_interop_require_default(require("crypto")),_constants=require("../../../shared/lib/constants");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}const PLUGIN_NAME="SubresourceIntegrityPlugin";class SubresourceIntegrityPlugin{constructor(e){this.algorithm=e}apply(e){e.hooks.make.tap(PLUGIN_NAME,(e=>{e.hooks.afterOptimizeAssets.tap({name:PLUGIN_NAME,stage:_webpack.webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS},(()=>{let t=new Set;for(const r of e.getAssets())t.add(r.name);const r={};for(const s of t.values()){const t=e.getAsset(s);if(!t)throw Object.defineProperty(new Error(`could not get asset: ${s}`),"__NEXT_ERROR_CODE",{value:"E349",enumerable:!1,configurable:!0});const o=t.source.buffer(),n=_crypto.default.createHash(this.algorithm).update(o).digest().toString("base64");r[s]=`${this.algorithm}-${n}`}const s=JSON.stringify(r,null,2),o="server/"+_constants.SUBRESOURCE_INTEGRITY_MANIFEST;e.emitAsset(o+".js",new _webpack.sources.RawSource(`self.__SUBRESOURCE_INTEGRITY_MANIFEST=${JSON.stringify(s)}`)),e.emitAsset(o+".json",new _webpack.sources.RawSource(s))}))}))}}