"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"FlightClientEntryPlugin",{enumerable:!0,get:function(){return FlightClientEntryPlugin}});const _webpack=require("next/dist/compiled/webpack/webpack"),_querystring=require("querystring"),_path=_interop_require_default(require("path")),_ondemandentryhandler=require("../../../server/dev/on-demand-entry-handler"),_constants=require("../../../lib/constants"),_constants1=require("../../../shared/lib/constants"),_utils=require("../loaders/utils"),_utils1=require("../utils"),_normalizepathsep=require("../../../shared/lib/page-path/normalize-path-sep"),_buildcontext=require("../../build-context"),_pagetypes=require("../../../lib/page-types"),_getmodulebuildinfo=require("../loaders/get-module-build-info"),_nextflightloader=require("../loaders/next-flight-loader"),_isapprouteroute=require("../../../lib/is-app-route-route"),_ismetadataroute=require("../../../lib/metadata/is-metadata-route");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}const PLUGIN_NAME="FlightClientEntryPlugin",pluginState=(0,_buildcontext.getProxiedPluginState)({serverActions:{},edgeServerActions:{},serverActionModules:{},edgeServerActionModules:{},ssrModules:{},edgeSsrModules:{},rscModules:{},edgeRscModules:{},injectedClientEntries:{}});function deduplicateCSSImportsForEntry(e){const t=Object.entries(e).sort(((e,t)=>{const[n]=e,[s]=t,r=n.split("/").length,o=s.split("/").length;if(r!==o)return r-o;const i=_path.default.parse(n).name,a=_path.default.parse(s).name,l=["template","layout"].indexOf(i),c=["template","layout"].indexOf(a);return-1===l?1:-1===c?-1:l-c})),n={},s=new Set;for(const[e,r]of t)for(const t of r){if(s.has(t))continue;const r=_path.default.parse(e).name;["template","layout"].includes(r)&&s.add(t),n[e]||(n[e]=[]),n[e].push(t)}return n}class FlightClientEntryPlugin{constructor(e){this.dev=e.dev,this.appDir=e.appDir,this.isEdgeServer=e.isEdgeServer,this.assetPrefix=this.dev||this.isEdgeServer?"":"../",this.encryptionKey=e.encryptionKey,this.webpackRuntime=this.isEdgeServer?_constants1.EDGE_RUNTIME_WEBPACK:_constants1.DEFAULT_RUNTIME_WEBPACK}apply(e){e.hooks.finishMake.tapPromise(PLUGIN_NAME,(t=>this.createClientEntries(e,t))),e.hooks.afterCompile.tap(PLUGIN_NAME,(t=>{const n=(n,s)=>{var r,o;const i=s.matchResource||(null==(r=s.resourceResolveData)?void 0:r.path),a=(null==(o=s.resourceResolveData)?void 0:o.query)||"",l=i?i.startsWith(_constants1.BARREL_OPTIMIZATION_PREFIX)?(0,_utils1.formatBarrelOptimizedResource)(s.resource,i):i+a:s.resource;if(void 0!==n&&l&&s.layer===_constants.WEBPACK_LAYERS.reactServerComponents){const r=_path.default.relative(e.context,l).replace(/\/next\/dist\/esm\//,"/next/dist/"),o={moduleId:n,async:t.moduleGraph.isAsync(s)};this.isEdgeServer?pluginState.edgeRscModules[r]=o:pluginState.rscModules[r]=o}if(s.layer===_constants.WEBPACK_LAYERS.serverSideRendering&&void 0!==n&&l){let r=_path.default.relative(e.context,l);r.startsWith(".")||(r=`./${(0,_normalizepathsep.normalizePathSep)(r)}`);const o={moduleId:n,async:t.moduleGraph.isAsync(s)};this.isEdgeServer?pluginState.edgeSsrModules[r.replace(/\/next\/dist\/esm\//,"/next/dist/")]=o:pluginState.ssrModules[r]=o}};(0,_utils1.traverseModules)(t,((e,t,s,r)=>{r&&n(r,e)}))})),e.hooks.make.tap(PLUGIN_NAME,(e=>{e.hooks.processAssets.tapPromise({name:PLUGIN_NAME,stage:_webpack.webpack.Compilation.PROCESS_ASSETS_STAGE_OPTIMIZE_HASH},(()=>this.createActionAssets(e)))}))}async createClientEntries(e,t){const n=[],s={},r=[],o={},i=new Set;(0,_utils1.forEachEntryModule)(t,(({name:r,entryModule:i})=>{const a={},l=new Map,c=[],d={};for(const n of(0,_utils1.getModuleReferencesInOrder)(i,t.moduleGraph)){let s=n.dependency.request;if(s.endsWith(_constants.WEBPACK_RESOURCE_QUERIES.metadataRoute)){const{filePath:e,isDynamicRouteExtension:t}=getMetadataRouteResource(s);"1"===t&&(s=e)}const{clientComponentImports:o,actionImports:i,cssImports:u}=this.collectComponentInfoFromServerEntryDependency({entryRequest:s,compilation:t,resolvedModule:n.resolvedModule});i.forEach((([e,t])=>l.set(e,t)));const p=_path.default.isAbsolute(s);if(!p){Object.keys(o).forEach((e=>a[e]=new Set));continue}const _=p?_path.default.relative(t.options.context,s):s;let m=(0,_normalizepathsep.normalizePathSep)(_.replace(/\.[^.\\/]+$/,"").replace(/^src[\\/]/,""));(0,_ismetadataroute.isMetadataRoute)(m)&&(m=r),Object.assign(d,u),c.push({compiler:e,compilation:t,entryName:r,clientComponentImports:o,bundlePath:m,absolutePagePath:s}),r===`app${_constants1.UNDERSCORE_NOT_FOUND_ROUTE_ENTRY}`&&"app/not-found"===m&&c.push({compiler:e,compilation:t,entryName:r,clientComponentImports:{},bundlePath:`app${_constants1.UNDERSCORE_NOT_FOUND_ROUTE_ENTRY}`,absolutePagePath:s})}const u=deduplicateCSSImportsForEntry(d);for(const e of c){const t=this.injectClientEntryAndSSRModules({...e,clientImports:{...e.clientComponentImports,...(u[e.absolutePagePath]||[]).reduce(((e,t)=>(e[t]=new Set,e)),{})}});s[e.entryName]||(s[e.entryName]=[]),s[e.entryName].push(t[3]),n.push(t)}(0,_isapprouteroute.isAppRouteRoute)(r)||n.push(this.injectClientEntryAndSSRModules({compiler:e,compilation:t,entryName:r,clientImports:{...a},bundlePath:_constants1.APP_CLIENT_INTERNALS})),l.size>0&&(o[r]||(o[r]=new Map),o[r]=new Map([...o[r],...l]))}));for(const[n,s]of Object.entries(o))r.push(this.injectActionEntry({compiler:e,compilation:t,actions:s,entryName:n,bundlePath:n,createdActionIds:i}));const a=(0,_ondemandentryhandler.getInvalidator)(e.outputPath);a&&n.some((([e])=>!0===e))&&a.invalidate([_constants1.COMPILER_NAMES.client]),await Promise.all(n.flatMap((e=>[e[1],e[2]]))),await Promise.all(r);const l=[],c={};for(const[e,n]of Object.entries(s)){const s=this.collectClientActionsFromDependencies({compilation:t,dependencies:n});s.size>0&&(c[e]||(c[e]=new Map),c[e]=new Map([...c[e],...s]))}for(const[n,s]of Object.entries(c)){let r=!1;const o=new Map;for(const[e,t]of s){const s=[];for(const e of t)i.has(n+"@"+e.id)||s.push(e);s.length>0&&(o.set(e,s),r=!0)}r&&l.push(this.injectActionEntry({compiler:e,compilation:t,actions:o,entryName:n,bundlePath:n,fromClient:!0,createdActionIds:i}))}await Promise.all(l)}collectClientActionsFromDependencies({compilation:e,dependencies:t}){const n=new Map,s=new Set,r=new Set,o=({entryRequest:t,resolvedModule:r})=>{const o=t=>{var r;if(!t)return;const i=getModuleResource(t);if(!i)return;if(s.has(i))return;s.add(i);const a=null==(r=(0,_getmodulebuildinfo.getModuleBuildInfo)(t).rsc)?void 0:r.actionIds;a&&n.set(i,Object.entries(a).map((([e,t])=>({id:e,exportedName:t})))),(0,_utils1.getModuleReferencesInOrder)(t,e.moduleGraph).forEach((e=>{o(e.resolvedModule)}))};t&&!t.includes("next-flight-action-entry-loader")&&o(r)};for(const n of t){const t=e.moduleGraph.getResolvedModule(n);for(const n of(0,_utils1.getModuleReferencesInOrder)(t,e.moduleGraph)){const e=n.dependency.request;r.has(e)||(r.add(e),o({entryRequest:e,resolvedModule:n.resolvedModule}))}}return n}collectComponentInfoFromServerEntryDependency({entryRequest:e,compilation:t,resolvedModule:n}){const s=new Set,r={},o=[],i=new Set,a=(e,n)=>{var l;if(!e)return;const c=getModuleResource(e);if(!c)return;if(s.has(c))return void(r[c]&&addClientImport(e,c,r,n,!1));s.add(c);const d=null==(l=(0,_getmodulebuildinfo.getModuleBuildInfo)(e).rsc)?void 0:l.actionIds;if(d&&o.push([c,Object.entries(d).map((([e,t])=>({id:e,exportedName:t})))]),(0,_utils.isCSSMod)(e)){if(e.factoryMeta&&e.factoryMeta.sideEffectFree){if(!t.moduleGraph.getExportsInfo(e).isModuleUsed(this.webpackRuntime))return}i.add(c)}else if((0,_utils.isClientComponentEntryModule)(e))return r[c]||(r[c]=new Set),void addClientImport(e,c,r,n,!0);(0,_utils1.getModuleReferencesInOrder)(e,t.moduleGraph).forEach((e=>{var t;let n=[];(null==(t=e.dependency)?void 0:t.ids)?n.push(...e.dependency.ids):n=["*"],a(e.resolvedModule,n)}))};return a(n,[]),{clientComponentImports:r,cssImports:i.size?{[e]:Array.from(i)}:{},actionImports:o}}injectClientEntryAndSSRModules({compiler:e,compilation:t,entryName:n,clientImports:s,bundlePath:r,absolutePagePath:o}){let i=!1;const a=Object.keys(s).sort(((e,t)=>_utils.regexCSS.test(t)?1:e.localeCompare(t))).map((e=>({request:e,ids:[...s[e]]}))),l=`next-flight-client-entry-loader?${(0,_querystring.stringify)({modules:(this.isEdgeServer?a.map((({request:e,ids:t})=>({request:e.replace(/[\\/]next[\\/]dist[\\/]esm[\\/]/,"/next/dist/".replace(/\//g,_path.default.sep)),ids:t}))):a).map((e=>JSON.stringify(e))),server:!1})}!`,c=`next-flight-client-entry-loader?${(0,_querystring.stringify)({modules:a.map((e=>JSON.stringify(e))),server:!0})}!`;if(this.dev){const t=(0,_ondemandentryhandler.getEntries)(e.outputPath),s=(0,_ondemandentryhandler.getEntryKey)(_constants1.COMPILER_NAMES.client,_pagetypes.PAGE_TYPES.APP,r);if(t[s]){const e=t[s];e.request!==l&&(e.request=l,i=!0),e.type===_ondemandentryhandler.EntryTypes.CHILD_ENTRY&&e.parentEntries.add(n),e.dispose=!1,e.lastActiveTime=Date.now()}else t[s]={type:_ondemandentryhandler.EntryTypes.CHILD_ENTRY,parentEntries:new Set([n]),absoluteEntryFilePath:o,bundlePath:r,request:l,dispose:!1,lastActiveTime:Date.now()},i=!0}else pluginState.injectedClientEntries[r]=l;const d=_webpack.webpack.EntryPlugin.createDependency(c,{name:r}),u=_webpack.webpack.EntryPlugin.createDependency(c,{name:r});return[i,this.addEntry(t,e.context,d,{name:n,layer:_constants.WEBPACK_LAYERS.serverSideRendering}),this.addEntry(t,e.context,u,{name:n,layer:_constants.WEBPACK_LAYERS.reactServerComponents}),d]}injectActionEntry({compiler:e,compilation:t,actions:n,entryName:s,bundlePath:r,fromClient:o,createdActionIds:i}){const a=Array.from(n.entries());for(const[,e]of n)for(const{id:t}of e)i.add(s+"@"+t);if(0===a.length)return Promise.resolve();const l=`next-flight-action-entry-loader?${(0,_querystring.stringify)({actions:JSON.stringify(a),__client_imported__:o})}!`,c=this.isEdgeServer?pluginState.edgeServerActions:pluginState.serverActions;for(const[,e]of a)for(const{id:t}of e)void 0===c[t]&&(c[t]={workers:{},layer:{}}),c[t].workers[r]={moduleId:"",async:!1},c[t].layer[r]=o?_constants.WEBPACK_LAYERS.actionBrowser:_constants.WEBPACK_LAYERS.reactServerComponents;const d=_webpack.webpack.EntryPlugin.createDependency(l,{name:r});return this.addEntry(t,e.context,d,{name:s,layer:o?_constants.WEBPACK_LAYERS.actionBrowser:_constants.WEBPACK_LAYERS.reactServerComponents})}addEntry(e,t,n,s){return new Promise(((r,o)=>{if("rspack"in e.compiler)e.addInclude(t,n,s,((t,n)=>t?o(t):(e.moduleGraph.getExportsInfo(n).setUsedInUnknownWay(this.isEdgeServer?_constants1.EDGE_RUNTIME_WEBPACK:_constants1.DEFAULT_RUNTIME_WEBPACK),r(n))));else{const i=e.entries.get(s.name);i.includeDependencies.push(n),e.hooks.addEntry.call(i,s),e.addModuleTree({context:t,dependency:n,contextInfo:{issuerLayer:s.layer}},((t,i)=>t?(e.hooks.failedEntry.call(n,s,t),o(t)):(e.hooks.succeedEntry.call(n,s,i),e.moduleGraph.getExportsInfo(i).setUsedInUnknownWay(this.isEdgeServer?_constants1.EDGE_RUNTIME_WEBPACK:_constants1.DEFAULT_RUNTIME_WEBPACK),r(i))))}}))}async createActionAssets(e){const t={},n={};(0,_utils1.traverseModules)(e,((t,n,s,r)=>{if(s.name&&t.request&&r&&/next-flight-action-entry-loader/.test(t.request)){const n=/&__client_imported__=true/.test(t.request),o=this.isEdgeServer?pluginState.edgeServerActionModules:pluginState.serverActionModules;o[s.name]||(o[s.name]={}),o[s.name][n?"client":"server"]={moduleId:r,async:e.moduleGraph.isAsync(t)}}}));for(let e in pluginState.serverActions){const n=pluginState.serverActions[e];for(let e in n.workers){const t=pluginState.serverActionModules[e][n.layer[e]===_constants.WEBPACK_LAYERS.actionBrowser?"client":"server"];n.workers[e]=t}t[e]=n}for(let e in pluginState.edgeServerActions){const t=pluginState.edgeServerActions[e];for(let e in t.workers){const n=pluginState.edgeServerActionModules[e][t.layer[e]===_constants.WEBPACK_LAYERS.actionBrowser?"client":"server"];t.workers[e]=n}n[e]=t}const s={node:t,edge:n,encryptionKey:this.encryptionKey},r={...s,encryptionKey:"process.env.NEXT_SERVER_ACTIONS_ENCRYPTION_KEY"},o=JSON.stringify(s,null,this.dev?2:void 0),i=JSON.stringify(r,null,this.dev?2:void 0);e.emitAsset(`${this.assetPrefix}${_constants1.SERVER_REFERENCE_MANIFEST}.js`,new _webpack.sources.RawSource(`self.__RSC_SERVER_MANIFEST=${JSON.stringify(i)}`)),e.emitAsset(`${this.assetPrefix}${_constants1.SERVER_REFERENCE_MANIFEST}.json`,new _webpack.sources.RawSource(o))}}function addClientImport(e,t,n,s,r){var o;const i="cjs"===(null==(o=(0,_getmodulebuildinfo.getModuleBuildInfo)(e).rsc)?void 0:o.clientEntryType),a=(0,_nextflightloader.getAssumedSourceType)(e,i?"commonjs":"auto"),l=n[t];if("*"===s[0])r||"*"===[...l][0]||(n[t]=new Set(["*"]));else{if("auto"===a)n[t]=new Set(["*"]);else for(const e of s){i&&"default"===e&&n[t].add("__esModule"),n[t].add(e)}}}function getModuleResource(e){var t,n,s;let r=((null==(t=e.resourceResolveData)?void 0:t.path)||"")+((null==(n=e.resourceResolveData)?void 0:n.query)||"");return"ContextModule"===e.constructor.name&&(r=e.identifier()),(null==(s=e.matchResource)?void 0:s.startsWith(_constants1.BARREL_OPTIMIZATION_PREFIX))&&(r=e.matchResource+":"+r),e.resource===`?${_constants.WEBPACK_RESOURCE_QUERIES.metadataRoute}`?getMetadataRouteResource(e.rawRequest).filePath:r}function getMetadataRouteResource(e){const t=e.split("!")[0].split("next-metadata-route-loader?")[1];return(0,_querystring.parse)(t)}