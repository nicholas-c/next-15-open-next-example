"use strict";function _export(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{default:function(){return PagesManifestPlugin},edgeServerAppPaths:function(){return edgeServerAppPaths},edgeServerPages:function(){return edgeServerPages},nodeServerAppPaths:function(){return nodeServerAppPaths},nodeServerPages:function(){return nodeServerPages}});const _path=_interop_require_default(require("path")),_promises=_interop_require_default(require("fs/promises")),_webpack=require("next/dist/compiled/webpack/webpack"),_constants=require("../../../shared/lib/constants"),_getroutefromentrypoint=_interop_require_default(require("../../../server/get-route-from-entrypoint")),_normalizepathsep=require("../../../shared/lib/page-path/normalize-path-sep");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}let edgeServerPages={},nodeServerPages={},edgeServerAppPaths={},nodeServerAppPaths={};class PagesManifestPlugin{constructor({dev:e,distDir:t,isEdgeRuntime:r,appDirEnabled:s}){this.dev=e,this.distDir=t,this.isEdgeRuntime=r,this.appDirEnabled=s}async createAssets(e){const t=e.entrypoints,r={},s={};for(const e of t.values()){const t=(0,_getroutefromentrypoint.default)(e.name,this.appDirEnabled);if(!t)continue;const i=e.getFiles().filter((e=>!e.includes("webpack-runtime")&&!e.includes("webpack-api-runtime")&&e.endsWith(".js")));if(!i.length)continue;let a=i[i.length-1];this.dev||this.isEdgeRuntime||(a=a.slice(3)),a=(0,_normalizepathsep.normalizePathSep)(a),e.name.startsWith("app/")?s[t]=a:r[t]=a}this.isEdgeRuntime?(edgeServerPages=r,edgeServerAppPaths=s):(nodeServerPages=r,nodeServerAppPaths=s);const i=async(e,t)=>{await _promises.default.mkdir(_path.default.dirname(e),{recursive:!0}),await _promises.default.writeFile(e,JSON.stringify({...await _promises.default.readFile(e,"utf8").then((e=>JSON.parse(e))).catch((()=>({}))),...t},null,2))};if(this.distDir){const e=_path.default.join(this.distDir,"server",_constants.PAGES_MANIFEST);await i(e,{...edgeServerPages,...nodeServerPages})}else{const t=(this.dev||this.isEdgeRuntime?"":"../")+_constants.PAGES_MANIFEST;e.emitAsset(t,new _webpack.sources.RawSource(JSON.stringify({...edgeServerPages,...nodeServerPages},null,2)))}if(this.appDirEnabled)if(this.distDir){const e=_path.default.join(this.distDir,"server",_constants.APP_PATHS_MANIFEST);await i(e,{...edgeServerAppPaths,...nodeServerAppPaths})}else e.emitAsset((this.dev||this.isEdgeRuntime?"":"../")+_constants.APP_PATHS_MANIFEST,new _webpack.sources.RawSource(JSON.stringify({...edgeServerAppPaths,...nodeServerAppPaths},null,2)))}apply(e){e.hooks.make.tap("NextJsPagesManifest",(e=>{e.hooks.processAssets.tapPromise({name:"NextJsPagesManifest",stage:_webpack.webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS},(()=>this.createAssets(e)))}))}}