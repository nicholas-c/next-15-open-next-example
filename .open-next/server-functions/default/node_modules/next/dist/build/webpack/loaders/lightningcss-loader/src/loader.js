"use strict";function _export(e,t){for(var s in t)Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{LightningCssLoader:function(){return LightningCssLoader},raw:function(){return raw}});const _utils=require("./utils"),_codegen=require("./codegen"),_utils1=require("../../css-loader/src/utils"),_stringifyrequest=require("../../../stringify-request"),_interface=require("./interface"),encoder=new TextEncoder;function createUrlAndImportVisitor(e,t,s,r,i,o){const n=new Map;let l=!1;const _=new Map,u=new Map;let a=-1,c=-1;function p(t){let o=t.url;if(!e.urlFilter(o))return t;if((0,_utils1.isDataUrl)(o))return t;a++,i.set(a,o),o=`__NEXT_LIGHTNINGCSS_LOADER_URL_REPLACE_${a}__`;const[,n,c]=o.split(/(\?)?#/,3),p=o.split("!");let m;p.length>1&&(o=p.pop(),m=p.join("!"));let f=n?"?":"";f+=c?`#${c}`:"",l||(s.push({type:"get_url_import",importName:"___CSS_LOADER_GET_URL_IMPORT___",url:JSON.stringify(require.resolve("../../css-loader/src/runtime/getUrl.js")),index:-1}),l=!0);const d=m?`${m}!${o}`:o;let g=_.get(d);g||(g=`___CSS_LOADER_URL_IMPORT_${_.size}___`,_.set(d,g),s.push({type:"url",importName:g,url:JSON.stringify(d),index:a}));const h=!1,R=JSON.stringify({newUrl:d,hash:f,needQuotes:h});let E=u.get(R);return E||(E=`___CSS_LOADER_URL_REPLACEMENT_${u.size}___`,u.set(R,E),r.push({replacementName:E,importName:g,hash:f,needQuotes:h})),{loc:t.loc,url:E}}return{Rule:{import(r){if(e.importFilter){if(!e.importFilter(r.value.url,r.value.media))return r}let i=r.value.url;c++,o.set(c,i),i=`__NEXT_LIGHTNINGCSS_LOADER_IMPORT_URL_REPLACE_${c}__`;const l=r.value.media.mediaQueries.length?JSON.stringify(r.value.media.mediaQueries):void 0,_=(0,_utils1.isUrlRequestable)(i);let u;if(_){const e=i.split("!");e.length>1&&(i=e.pop(),u=e.join("!"))}if(!_)return t.push({url:i,media:l}),{type:"ignored",value:""};const a=u?`${u}!${i}`:i;let p=n.get(a);if(!p){p=`___CSS_LOADER_AT_RULE_IMPORT_${n.size}___`,n.set(a,p);const t=e.urlHandler(a);s.push({type:"rule_import",importName:p,url:t})}return t.push({importName:p,media:l}),{type:"ignored",value:""}}},Url:e=>p(e)}}function createIcssVisitor({apis:e,imports:t,replacements:s,replacedUrls:r,urlHandler:i}){let o=-1,n=-1;return{Declaration:{composes(l){if("unparsed"===l.property)return;const _=l.value.from;if("file"!==(null==_?void 0:_.type))return;let u=_.value;if(!u)return;o++,r.set(o,u),u=`__NEXT_LIGHTNINGCSS_LOADER_ICSS_URL_REPLACE_${o}__`;const a=`___CSS_LOADER_ICSS_IMPORT_${t.length}___`;t.push({type:"icss_import",importName:a,icss:!0,url:i(u),index:o}),e.push({importName:a,dedupe:!0,index:o});const c=[];for(const e of l.value.names){n++;const t=`___CSS_LOADER_ICSS_IMPORT_${o}_REPLACEMENT_${n}___`;s.push({replacementName:t,importName:a,localName:e}),c.push(t)}return{property:"composes",value:{loc:l.value.loc,names:c,from:_}}}}}}const LOADER_NAME="lightningcss-loader";async function LightningCssLoader(e,t){var s;const r=this.async(),i=this.getOptions(),{implementation:o,targets:n,...l}=i;if(i.modules??={},o&&"function"!=typeof o.transformCss)return void r(Object.defineProperty(new TypeError(`[${LOADER_NAME}]: options.implementation.transformCss must be an 'lightningcss' transform function. Received ${typeof o.transformCss}`),"__NEXT_ERROR_CODE",{value:"E560",enumerable:!1,configurable:!0}));if(i.postcss){var _;const{postcssWithPlugins:e}=await i.postcss();if((null==e||null==(_=e.plugins)?void 0:_.length)>0)throw Object.defineProperty(new Error(`[${LOADER_NAME}]: experimental.useLightningcss does not work with postcss plugins. Please remove 'useLightningcss: true' from your configuration.`),"__NEXT_ERROR_CODE",{value:"E519",enumerable:!1,configurable:!0})}const u=[],a=[],c=[],p=[],m=[];!0!==(null==(s=i.modules)?void 0:s.exportOnlyLocals)&&a.unshift({type:"api_import",importName:"___CSS_LOADER_API_IMPORT___",url:(0,_stringifyrequest.stringifyRequest)(this,require.resolve("../../css-loader/src/runtime/api"))});const{loadBindings:f}=require("next/dist/build/swc"),d=(null==o?void 0:o.transformCss)??(await f()).css.lightning.transform,g=new Map,h=new Map,R=new Map,E={...createUrlAndImportVisitor({urlHandler:e=>(0,_stringifyrequest.stringifyRequest)(this,(0,_utils1.getPreRequester)(this)(i.importLoaders??0)+e),urlFilter:(0,_utils1.getFilter)(i.url,this.resourcePath),importFilter:(0,_utils1.getFilter)(i.import,this.resourcePath),context:this.context},p,a,m,g,R),...createIcssVisitor({apis:p,imports:c,replacements:m,replacedUrls:h,urlHandler:e=>(0,_stringifyrequest.stringifyRequest)(this,(0,_utils1.getPreRequester)(this)(i.importLoaders)+e)})};try{const{code:s,map:o,exports:_}=d({...l,visitor:E,cssModules:i.modules?{pattern:process.env.__NEXT_TEST_MODE?"[name]__[local]":"[name]__[hash]__[local]"}:void 0,filename:this.resourcePath,code:encoder.encode(e),sourceMap:this.sourceMap,targets:(0,_utils.getTargets)({targets:n,key:_interface.ECacheKey.loader}),inputSourceMap:this.sourceMap&&t?JSON.stringify(t):void 0,include:1});let f=s.toString();if(_)for(const e in _)if(Object.prototype.hasOwnProperty.call(_,e)){const t=_[e];let s=t.name;for(const e of t.composes)s+=` ${e.name}`;u.push({name:e,value:s})}if(0!==g.size){const e=this.getResolve({conditionNames:["asset"],mainFields:["asset"],mainFiles:[],extensions:[]});for(const[t,s]of g.entries()){const[r]=s.split(/(\?)?#/,3),i=(0,_utils1.requestify)(r,this.rootContext),o=await(0,_utils1.resolveRequests)(e,this.context,[...new Set([i,s])]);for(const e of a)e.url=e.url.replace(`__NEXT_LIGHTNINGCSS_LOADER_URL_REPLACE_${t}__`,o??s)}}if(0!==R.size){const e=this.getResolve({conditionNames:["style"],extensions:[".css"],mainFields:["css","style","main","..."],mainFiles:["index","..."],restrictions:[/\.css$/i]});for(const[t,s]of R.entries()){const[r]=s.split(/(\?)?#/,3),i=(0,_utils1.requestify)(r,this.rootContext),o=await(0,_utils1.resolveRequests)(e,this.context,[...new Set([i,s])]);for(const e of a)e.url=e.url.replace(`__NEXT_LIGHTNINGCSS_LOADER_IMPORT_URL_REPLACE_${t}__`,o??s)}}if(0!==h.size){const e=this.getResolve({conditionNames:["style"],extensions:[],mainFields:["css","style","main","..."],mainFiles:["index","..."]});for(const[t,s]of h.entries()){const[r]=s.split(/(\?)?#/,3),i=(0,_utils1.requestify)(r,this.rootContext),o=await(0,_utils1.resolveRequests)(e,this.context,[...new Set([s,i])]);for(const e of c)e.url=e.url.replace(`__NEXT_LIGHTNINGCSS_LOADER_ICSS_URL_REPLACE_${t}__`,o??s)}}a.push(...c);const L=(0,_codegen.getImportCode)(a,i),N=(0,_codegen.getModuleCode)({css:f,map:o},p,m,i,this),S=(0,_codegen.getExportCode)(u,m,i);r(null,`${L}${N}${S}`,o&&JSON.parse(o.toString()))}catch(e){console.error("lightningcss-loader error",e),r(e)}}const raw=!0;