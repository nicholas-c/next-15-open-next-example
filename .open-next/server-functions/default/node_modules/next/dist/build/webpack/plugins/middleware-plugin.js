"use strict";function _export(e,n){for(var t in n)Object.defineProperty(e,t,{enumerable:!0,get:n[t]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{SUPPORTED_NATIVE_MODULES:function(){return SUPPORTED_NATIVE_MODULES},default:function(){return MiddlewarePlugin},getEdgePolyfilledModules:function(){return getEdgePolyfilledModules},handleWebpackExternalForEdgeRuntime:function(){return handleWebpackExternalForEdgeRuntime}});const _routeregex=require("../../../shared/lib/router/utils/route-regex"),_getmodulebuildinfo=require("../loaders/get-module-build-info"),_utils=require("../../../shared/lib/router/utils"),_webpack=require("next/dist/compiled/webpack/webpack"),_picomatch=_interop_require_default(require("next/dist/compiled/picomatch")),_path=_interop_require_default(require("path")),_constants=require("../../../shared/lib/constants"),_shared=require("../../../trace/shared"),_events=require("../../../telemetry/events"),_apppaths=require("../../../shared/lib/router/utils/app-paths"),_constants1=require("../../../lib/constants"),_generateinterceptionroutesrewrites=require("../../../lib/generate-interception-routes-rewrites"),_parsedynamiccodeevaluationerror=require("./wellknown-errors-plugin/parse-dynamic-code-evaluation-error"),_utils1=require("../utils");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}const KNOWN_SAFE_DYNAMIC_PACKAGES=require("../../../lib/known-edge-safe-packages.json"),NAME="MiddlewarePlugin",MANIFEST_VERSION=3;function isUsingIndirectEvalAndUsedByExports(e){const{moduleGraph:n,runtime:t,module:o,usingIndirectEval:r,wp:i}=e;if("boolean"==typeof r)return r;const s=n.getExportsInfo(o);for(const e of r)if(s.getUsed(e,t)!==i.UsageState.Unused)return!0;return!1}function getEntryFiles(e,n,t,o){const r=[];return n.edgeSSR&&(n.edgeSSR.isServerComponent&&(r.push(`server/${_constants.SERVER_REFERENCE_MANIFEST}.js`),o.sriEnabled&&r.push(`server/${_constants.SUBRESOURCE_INTEGRITY_MANIFEST}.js`),r.push(...e.filter((e=>e.startsWith("app/")&&!e.endsWith(".hot-update.js"))).map((e=>"server/"+e.replace(/\.js$/,"_"+_constants.CLIENT_REFERENCE_MANIFEST+".js"))))),o.dev||n.edgeSSR.isAppDir||r.push(`server/${_constants.DYNAMIC_CSS_MANIFEST}.js`),r.push(`server/${_constants.MIDDLEWARE_BUILD_MANIFEST}.js`,`server/${_constants.MIDDLEWARE_REACT_LOADABLE_MANIFEST}.js`,`server/${_constants.NEXT_FONT_MANIFEST}.js`,`server/${_constants.INTERCEPTION_ROUTE_REWRITE_MANIFEST}.js`)),t&&r.push(`server/edge-${_constants1.INSTRUMENTATION_HOOK_FILENAME}.js`),r.push(...e.filter((e=>!e.endsWith(".hot-update.js"))).map((e=>"server/"+e))),r}function getCreateAssets(e){const{compilation:n,metadataByEntry:t,opts:o}=e;return()=>{const e={version:MANIFEST_VERSION,middleware:{},functions:{},sortedMiddleware:[]},r=n.entrypoints.has(_constants1.INSTRUMENTATION_HOOK_FILENAME),i=JSON.stringify(o.rewrites.beforeFiles.filter(_generateinterceptionroutesrewrites.isInterceptionRouteRewrite));n.emitAsset(`${_constants.INTERCEPTION_ROUTE_REWRITE_MANIFEST}.js`,new _webpack.sources.RawSource(`self.__INTERCEPTION_ROUTE_REWRITE_MANIFEST=${JSON.stringify(i)}`));for(const i of n.entrypoints.values()){var s,a,d,l,u;if(!i.name)continue;const n=t.get(i.name),c=(null==n||null==(s=n.edgeMiddleware)?void 0:s.page)||(null==n||null==(a=n.edgeSSR)?void 0:a.page)||(null==n||null==(d=n.edgeApiFunction)?void 0:d.page);if(!c)continue;const p=(null==(l=n.edgeSSR)?void 0:l.isAppDir)?(0,_apppaths.normalizeAppPath)(c):c,E=!n.edgeSSR&&!n.edgeApiFunction,{namedRegex:g}=(0,_routeregex.getNamedMiddlewareRegex)(p,{catchAll:E}),m=(null==n||null==(u=n.edgeMiddleware)?void 0:u.matchers)??[{regexp:g,originalSource:"/"===c&&E?"/:path*":p}],_=!(!n.edgeApiFunction&&!n.edgeSSR),f={files:getEntryFiles(i.getFiles(),n,r,o),name:i.name,page:c,matchers:m,wasm:Array.from(n.wasmBindings,(([e,n])=>({name:e,filePath:n}))),assets:Array.from(n.assetBindings,(([e,n])=>({name:e,filePath:n}))),env:o.edgeEnvironments,...n.regions&&{regions:n.regions}};_?e.functions[c]=f:e.middleware[c]=f}e.sortedMiddleware=(0,_utils.getSortedRoutes)(Object.keys(e.middleware)),n.emitAsset(_constants.MIDDLEWARE_MANIFEST,new _webpack.sources.RawSource(JSON.stringify(e,null,2)))}}function buildWebpackError({message:e,loc:n,compilation:t,entryModule:o,parser:r}){const i=new t.compiler.webpack.WebpackError(e);i.name=NAME;const s=o??(null==r?void 0:r.state.current);return s&&(i.module=s),i.loc=n,i}function isInMiddlewareLayer(e){var n;const t=null==(n=e.state.module)?void 0:n.layer;return t===_constants1.WEBPACK_LAYERS.middleware||t===_constants1.WEBPACK_LAYERS.api}function isNodeJsModule(e){return require("module").builtinModules.includes(e)}function isDynamicCodeEvaluationAllowed(e,n,t){if(KNOWN_SAFE_DYNAMIC_PACKAGES.some((n=>e.includes(`/node_modules/${n}/`.replace(/\//g,_path.default.sep)))))return!0;const o=e.replace(t??"","");return(0,_picomatch.default)((null==n?void 0:n.unstable_allowDynamic)??[],{dot:!0})(o)}function buildUnsupportedApiError({apiName:e,loc:n,...t}){return buildWebpackError({message:`A Node.js API is used (${e} at line: ${n.start.line}) which is not supported in the Edge Runtime.\nLearn more: https://nextjs.org/docs/api-reference/edge-runtime`,loc:n,...t})}function registerUnsupportedApiHooks(e,n){for(const t of _constants.EDGE_UNSUPPORTED_NODE_APIS){const o=o=>{if(isInMiddlewareLayer(e))return n.warnings.push(buildUnsupportedApiError({compilation:n,parser:e,apiName:t,...o})),!0};e.hooks.call.for(t).tap(NAME,o),e.hooks.expression.for(t).tap(NAME,o),e.hooks.callMemberChain.for(t).tap(NAME,o),e.hooks.expressionMemberChain.for(t).tap(NAME,o)}const t=(t,[o])=>{if(isInMiddlewareLayer(e)&&"env"!==o)return n.warnings.push(buildUnsupportedApiError({compilation:n,parser:e,apiName:`process.${o}`,...t})),!0};e.hooks.callMemberChain.for("process").tap(NAME,t),e.hooks.expressionMemberChain.for("process").tap(NAME,t)}function getCodeAnalyzer(e){return n=>{const{dev:t,compiler:{webpack:o},compilation:r}=e,{hooks:i}=n,s=()=>{isInMiddlewareLayer(n)&&o.optimize.InnerGraph.onUsage(n.state,((e=!0)=>{const t=(0,_getmodulebuildinfo.getModuleBuildInfo)(n.state.module);!0!==t.usingIndirectEval&&!1!==e&&(t.usingIndirectEval&&!0!==e?t.usingIndirectEval=new Set([...Array.from(t.usingIndirectEval),...Array.from(e)]):t.usingIndirectEval=e)}))},a=e=>{if(!isInMiddlewareLayer(n))return;const{ConstDependency:t}=o.dependencies,r=new t("__next_eval__(function() { return ",e.range[0]);r.loc=e.loc,n.state.module.addPresentationalDependency(r);const i=new t("})",e.range[1]);return i.loc=e.loc,n.state.module.addPresentationalDependency(i),s(),!0},d=e=>{if(!isInMiddlewareLayer(n))return;const{ConstDependency:t}=o.dependencies,r=new t("__next_webassembly_compile__(function() { return ",e.range[0]);r.loc=e.loc,n.state.module.addPresentationalDependency(r);const i=new t("})",e.range[1]);i.loc=e.loc,n.state.module.addPresentationalDependency(i),s()},l=e=>{if(isInMiddlewareLayer(n)&&t){const{ConstDependency:t}=o.dependencies,r=new t("__next_webassembly_instantiate__(function() { return ",e.range[0]);r.loc=e.loc,n.state.module.addPresentationalDependency(r);const i=new t("})",e.range[1]);i.loc=e.loc,n.state.module.addPresentationalDependency(i)}},u=e=>{var o;if(isInMiddlewareLayer(n)&&(null==(o=e.source)?void 0:o.value)&&(null==e?void 0:e.loc)){var i;const{module:o,source:s}=n.state,a=(0,_getmodulebuildinfo.getModuleBuildInfo)(o);a.importLocByPath||(a.importLocByPath=new Map);const d=null==(i=e.source.value)?void 0:i.toString();a.importLocByPath.set(d,{sourcePosition:{...e.loc.start,source:o.identifier()},sourceContent:s.toString()}),t||!isNodeJsModule(d)||SUPPORTED_NATIVE_MODULES.includes(d)||r.warnings.push(buildWebpackError({message:`A Node.js module is loaded ('${d}' at line ${e.loc.start.line}) which is not supported in the Edge Runtime.\nLearn More: https://nextjs.org/docs/messages/node-module-in-edge-runtime`,compilation:r,parser:n,...e}))}},c=()=>!!isInMiddlewareLayer(n)||void 0;for(const e of["","global."])i.expression.for(`${e}Function.prototype`).tap(NAME,c),i.expression.for(`${e}Function.bind`).tap(NAME,c),i.call.for(`${e}eval`).tap(NAME,a),i.call.for(`${e}Function`).tap(NAME,a),i.new.for(`${e}Function`).tap(NAME,a),i.call.for(`${e}WebAssembly.compile`).tap(NAME,d),i.call.for(`${e}WebAssembly.instantiate`).tap(NAME,l);i.importCall.tap(NAME,u),i.import.tap(NAME,u),t||registerUnsupportedApiHooks(n,r)}}function getExtractMetadata(e){const{dev:n,compilation:t,metadataByEntry:o,compiler:r}=e,{webpack:i}=r;return async()=>{o.clear();const e=_shared.traceGlobals.get("telemetry");for(const[l,u]of t.entries){var s,a;if(u.options.runtime!==_constants.EDGE_RUNTIME_WEBPACK)continue;const c=null==(s=u.dependencies)?void 0:s[0],p=t.moduleGraph.getResolvedModule(c);if(!p)continue;const{rootDir:E,route:g}=(0,_getmodulebuildinfo.getModuleBuildInfo)(p),{moduleGraph:m}=t,_=new Set,f=e=>{const n=m.getModule(e);n&&_.add(n)};u.dependencies.forEach(f),u.includeDependencies.forEach(f);const A={wasmBindings:new Map,assetBindings:new Map};if((null==g||null==(a=g.middlewareConfig)?void 0:a.regions)&&(A.regions=g.middlewareConfig.regions),null==g?void 0:g.preferredRegion){const e=g.preferredRegion;A.regions="string"==typeof e?[e]:e}let M=0;for(const o of _){const s=(0,_getmodulebuildinfo.getModuleBuildInfo)(o);if(!n){const e=o.resource;e&&/[\\/]node_modules[\\/]@vercel[\\/]og[\\/]dist[\\/]index\.(edge|node)\.js$|[\\/]next[\\/]dist[\\/](esm[\\/])?server[\\/]og[\\/]image-response\.js$/.test(e)&&M++}if(!n&&s.usingIndirectEval&&isUsingIndirectEvalAndUsedByExports({module:o,moduleGraph:m,runtime:i.util.runtime.getEntryRuntime(t,l),usingIndirectEval:s.usingIndirectEval,wp:i})){var d;const n=o.identifier();if(/node_modules[\\/]regenerator-runtime[\\/]runtime\.js/.test(n))continue;if((null==g||null==(d=g.middlewareConfig)?void 0:d.unstable_allowDynamic)&&(null==e||e.record({eventName:"NEXT_EDGE_ALLOW_DYNAMIC_USED",payload:{file:null==g?void 0:g.absolutePagePath.replace(E??"",""),config:null==g?void 0:g.middlewareConfig,fileWithDynamicCode:o.userRequest.replace(E??"","")}})),!isDynamicCodeEvaluationAllowed(o.userRequest,null==g?void 0:g.middlewareConfig,E)){const e=`Dynamic Code Evaluation (e. g. 'eval', 'new Function', 'WebAssembly.compile') not allowed in Edge Runtime ${"boolean"!=typeof s.usingIndirectEval?`\nUsed by ${Array.from(s.usingIndirectEval).join(", ")}`:""}\nLearn More: https://nextjs.org/docs/messages/edge-dynamic-code-evaluation`;t.errors.push((0,_parsedynamiccodeevaluationerror.getDynamicCodeEvaluationError)(e,o,t,r))}}(null==s?void 0:s.nextEdgeSSR)?A.edgeSSR=s.nextEdgeSSR:(null==s?void 0:s.nextEdgeMiddleware)?A.edgeMiddleware=s.nextEdgeMiddleware:(null==s?void 0:s.nextEdgeApiFunction)&&(A.edgeApiFunction=s.nextEdgeApiFunction),(null==s?void 0:s.nextWasmMiddlewareBinding)&&A.wasmBindings.set(s.nextWasmMiddlewareBinding.name,s.nextWasmMiddlewareBinding.filePath),(null==s?void 0:s.nextAssetMiddlewareBinding)&&A.assetBindings.set(s.nextAssetMiddlewareBinding.name,s.nextAssetMiddlewareBinding.filePath);for(const e of(0,_utils1.getModuleReferencesInOrder)(o,m))e.module&&_.add(e.module)}null==e||e.record({eventName:_events.EVENT_BUILD_FEATURE_USAGE,payload:{featureName:"vercelImageGeneration",invocationCount:M}}),o.set(l,A)}}}class MiddlewarePlugin{constructor({dev:e,sriEnabled:n,rewrites:t,edgeEnvironments:o}){this.dev=e,this.sriEnabled=n,this.rewrites=t,this.edgeEnvironments=o}apply(e){e.hooks.compilation.tap(NAME,((n,t)=>{const{hooks:o}=t.normalModuleFactory,r=getCodeAnalyzer({dev:this.dev,compiler:e,compilation:n});process.env.NEXT_RSPACK||(o.parser.for("javascript/auto").tap(NAME,r),o.parser.for("javascript/dynamic").tap(NAME,r),o.parser.for("javascript/esm").tap(NAME,r));const i=new Map;n.hooks.finishModules.tapPromise(NAME,getExtractMetadata({compilation:n,compiler:e,dev:this.dev,metadataByEntry:i})),n.hooks.processAssets.tap({name:"NextJsMiddlewareManifest",stage:_webpack.webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS},getCreateAssets({compilation:n,metadataByEntry:i,opts:{sriEnabled:this.sriEnabled,rewrites:this.rewrites,edgeEnvironments:this.edgeEnvironments,dev:this.dev}}))}))}}const SUPPORTED_NATIVE_MODULES=["buffer","events","assert","util","async_hooks"],supportedEdgePolyfills=new Set(SUPPORTED_NATIVE_MODULES);function getEdgePolyfilledModules(){const e={};for(const n of SUPPORTED_NATIVE_MODULES)e[n]=`commonjs node:${n}`,e[`node:${n}`]=`commonjs node:${n}`;return e}async function handleWebpackExternalForEdgeRuntime({request:e,context:n,contextInfo:t,getResolve:o}){if((t.issuerLayer===_constants1.WEBPACK_LAYERS.middleware||t.issuerLayer===_constants1.WEBPACK_LAYERS.api)&&isNodeJsModule(e)&&!supportedEdgePolyfills.has(e))try{await o()(n,e)}catch{return`root globalThis.__import_unsupported('${e}')`}}