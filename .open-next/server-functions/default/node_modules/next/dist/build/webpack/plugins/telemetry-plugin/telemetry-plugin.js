"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"TelemetryPlugin",{enumerable:!0,get:function(){return TelemetryPlugin}});const _webpack=require("next/dist/compiled/webpack/webpack"),_usecachetrackerutils=require("./use-cache-tracker-utils"),FEATURE_MODULE_MAP=new Map([["next/image","/next/image.js"],["next/future/image","/next/future/image.js"],["next/legacy/image","/next/legacy/image.js"],["next/script","/next/script.js"],["next/dynamic","/next/dynamic.js"]]),FEATURE_MODULE_REGEXP_MAP=new Map([["@next/font/google",/\/@next\/font\/google\/target.css?.+$/],["@next/font/local",/\/@next\/font\/local\/target.css?.+$/],["next/font/google",/\/next\/font\/google\/target.css?.+$/],["next/font/local",/\/next\/font\/local\/target.css?.+$/]]),BUILD_FEATURES=["swcLoader","swcRelay","swcStyledComponents","swcReactRemoveProperties","swcExperimentalDecorators","swcRemoveConsole","swcImportSource","swcEmotion","swc/target/x86_64-apple-darwin","swc/target/x86_64-unknown-linux-gnu","swc/target/x86_64-pc-windows-msvc","swc/target/i686-pc-windows-msvc","swc/target/aarch64-unknown-linux-gnu","swc/target/armv7-unknown-linux-gnueabihf","swc/target/aarch64-apple-darwin","swc/target/aarch64-linux-android","swc/target/arm-linux-androideabi","swc/target/x86_64-unknown-freebsd","swc/target/x86_64-unknown-linux-musl","swc/target/aarch64-unknown-linux-musl","swc/target/aarch64-pc-windows-msvc","turbotrace","transpilePackages","skipMiddlewareUrlNormalize","skipTrailingSlashRedirect","modularizeImports","esmExternals","webpackPlugins"],eliminatedPackages=new Set,useCacheTracker=(0,_usecachetrackerutils.createUseCacheTracker)();function findFeatureInModule(e){if("javascript/auto"!==e.type)return;for(const[t,n]of FEATURE_MODULE_MAP)if(e.resource.endsWith(n))return t;const t=e.identifier().replace(/\\/g,"/");for(const[e,n]of FEATURE_MODULE_REGEXP_MAP)if(n.test(t))return e}function findUniqueOriginModulesInConnections(e,t){const n=new Set;for(const a of e)n.has(a.originModule)||a.originModule===t||n.add(a.originModule);return n}class TelemetryPlugin{constructor(e){this.usageTracker=new Map;for(const t of BUILD_FEATURES)this.usageTracker.set(t,{featureName:t,invocationCount:e.get(t)?1:0});for(const e of FEATURE_MODULE_MAP.keys())this.usageTracker.set(e,{featureName:e,invocationCount:0});for(const e of FEATURE_MODULE_REGEXP_MAP.keys())this.usageTracker.set(e,{featureName:e,invocationCount:0})}addUsage(e,t){this.usageTracker.set(e,{featureName:e,invocationCount:t})}apply(e){e.hooks.make.tapAsync(TelemetryPlugin.name,(async(e,t)=>{e.hooks.finishModules.tapAsync(TelemetryPlugin.name,(async(t,n)=>{for(const n of t){const t=findFeatureInModule(n);if(!t)continue;const a=findUniqueOriginModulesInConnections(e.moduleGraph.getIncomingConnections(n),n);this.usageTracker.get(t).invocationCount=a.size}n()})),t()})),"production"!==e.options.mode||e.watchMode||e.hooks.thisCompilation.tap(TelemetryPlugin.name,(e=>{_webpack.NormalModule.getCompilationHooks(e).loader.tap(TelemetryPlugin.name,(e=>{e.eliminatedPackages=eliminatedPackages,e.useCacheTracker=useCacheTracker}))}))}usages(){return[...this.usageTracker.values()]}packagesUsedInServerSideProps(){return Array.from(eliminatedPackages)}getUseCacheTracker(){return Object.fromEntries(useCacheTracker)}}