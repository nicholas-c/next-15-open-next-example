"use strict";function _export(e,a){for(var t in a)Object.defineProperty(e,t,{enumerable:!0,get:a[t]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{ProfilingPlugin:function(){return ProfilingPlugin},spans:function(){return spans},webpackInvalidSpans:function(){return webpackInvalidSpans}});const _webpack=require("next/dist/compiled/webpack/webpack"),_path=_interop_require_default(require("path"));function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}const pluginName="ProfilingPlugin",spans=new WeakMap,moduleSpansByCompilation=new WeakMap,makeSpanByCompilation=new WeakMap,sealSpanByCompilation=new WeakMap,webpackInvalidSpans=new WeakMap,TRACE_LABELS_SEAL=["module assets","create chunk assets","asset render","asset emit","store asset"];function inTraceLabelsSeal(e){return TRACE_LABELS_SEAL.some((a=>e.startsWith(a)))}class ProfilingPlugin{constructor({runWebpackSpan:e,rootDir:a}){this.runWebpackSpan=e,this.rootDir=a}apply(e){this.traceTopLevelHooks(e),this.traceCompilationHooks(e),this.compiler=e}traceHookPair(e,a,t,{parentSpan:o,attrs:n,onStart:s,onStop:i}={}){let p;a.tap({name:pluginName,stage:-1/0},((...a)=>{const t="function"==typeof e?e():e,i=n?n(...a):n;p=o?o(...a).traceChild(t,i):this.runWebpackSpan.traceChild(t,i),s&&s(p,...a)})),t.tap({name:pluginName,stage:1/0},((...e)=>{p&&(i&&i(p,...e),p.stop())}))}traceTopLevelHooks(e){this.traceHookPair("webpack-compilation",e.hooks.compilation,e.hooks.afterCompile,{parentSpan:()=>webpackInvalidSpans.get(e)||this.runWebpackSpan,attrs:()=>({name:e.name}),onStart:(a,t)=>{spans.set(t,a),spans.set(e,a),moduleSpansByCompilation.set(t,new WeakMap)}}),"development"===e.options.mode&&this.traceHookPair((()=>`webpack-invalidated-${e.name}`),e.hooks.invalid,e.hooks.done,{onStart:a=>webpackInvalidSpans.set(e,a),onStop:()=>webpackInvalidSpans.delete(e),attrs:e=>({trigger:e?_path.default.relative(this.rootDir,e).replaceAll(_path.default.sep,"/"):"manual"})})}traceCompilationHooks(e){this.traceHookPair("emit",e.hooks.emit,e.hooks.afterEmit,{parentSpan:()=>webpackInvalidSpans.get(e)||this.runWebpackSpan}),this.traceHookPair("make",e.hooks.make,e.hooks.finishMake,{parentSpan:a=>{const t=spans.get(a);return t||(webpackInvalidSpans.get(e)||this.runWebpackSpan)},onStart:(e,a)=>{makeSpanByCompilation.set(a,e)},onStop:(e,a)=>{makeSpanByCompilation.delete(a)}}),e.hooks.compilation.tap({name:pluginName,stage:-1/0},(e=>{e.hooks.buildModule.tap(pluginName,(a=>{var t;const o=(()=>{const e=a.userRequest;if(!e||e.endsWith("!"))return"";{const a=e.split("!").pop(),t=/^[^?]+\.([^?]+)$/.exec(a);return t?t[1]:""}})(),n=null==e||null==(t=e.moduleGraph)?void 0:t.getIssuer(a);let s;const i=moduleSpansByCompilation.get(e),p="build-module"+(o?`-${o}`:""),r=n&&(null==i?void 0:i.get(n));if(r)s=r.traceChild(p);else{let t;for(const o of e.moduleGraph.getIncomingConnections(a)){const e=spans.get(o.dependency);if(e){t=e;break}}if(!t){const a=spans.get(e);if(!a)return;t=a}s=t.traceChild(p)}s.setAttribute("name",a.userRequest),s.setAttribute("layer",a.layer),i.set(a,s)}));const a=_webpack.NormalModule.getCompilationHooks(e);a.readResource.for(void 0).intercept({register(e){const a=e.fn;return e.fn=(e,t)=>{a(e,((e,a)=>{t(e,a)}))},e}}),a.loader.tap(pluginName,((a,t)=>{var o;const n=null==(o=moduleSpansByCompilation.get(e))?void 0:o.get(t);a.currentTraceSpan=n})),e.hooks.succeedModule.tap(pluginName,(a=>{var t,o;null==moduleSpansByCompilation||null==(o=moduleSpansByCompilation.get(e))||null==(t=o.get(a))||t.stop()})),e.hooks.failedModule.tap(pluginName,(a=>{var t,o;null==moduleSpansByCompilation||null==(o=moduleSpansByCompilation.get(e))||null==(t=o.get(a))||t.stop()})),this.traceHookPair("seal",e.hooks.seal,e.hooks.afterSeal,{parentSpan:()=>spans.get(e),onStart(a){sealSpanByCompilation.set(e,a)},onStop(){sealSpanByCompilation.delete(e)}}),e.hooks.addEntry.tap(pluginName,(a=>{const t=makeSpanByCompilation.get(e)||spans.get(e);if(!t)return;const o=t.traceChild("add-entry");o.setAttribute("request",a.request),spans.set(a,o)})),e.hooks.succeedEntry.tap(pluginName,(e=>{var a;null==(a=spans.get(e))||a.stop(),spans.delete(e)})),e.hooks.failedEntry.tap(pluginName,(e=>{var a;null==(a=spans.get(e))||a.stop(),spans.delete(e)})),this.traceHookPair("chunk-graph",e.hooks.beforeChunks,e.hooks.afterChunks,{parentSpan:()=>sealSpanByCompilation.get(e)||spans.get(e)}),this.traceHookPair("optimize",e.hooks.optimize,e.hooks.reviveModules,{parentSpan:()=>sealSpanByCompilation.get(e)||spans.get(e)}),this.traceHookPair("optimize-modules",e.hooks.optimizeModules,e.hooks.afterOptimizeModules,{parentSpan:()=>sealSpanByCompilation.get(e)||spans.get(e)}),this.traceHookPair("optimize-chunks",e.hooks.optimizeChunks,e.hooks.afterOptimizeChunks,{parentSpan:()=>sealSpanByCompilation.get(e)||spans.get(e)}),this.traceHookPair("optimize-tree",e.hooks.optimizeTree,e.hooks.afterOptimizeTree,{parentSpan:()=>sealSpanByCompilation.get(e)||spans.get(e)}),this.traceHookPair("optimize-chunk-modules",e.hooks.optimizeChunkModules,e.hooks.afterOptimizeChunkModules,{parentSpan:()=>sealSpanByCompilation.get(e)||spans.get(e)}),this.traceHookPair("module-hash",e.hooks.beforeModuleHash,e.hooks.afterModuleHash,{parentSpan:()=>sealSpanByCompilation.get(e)||spans.get(e)}),this.traceHookPair("code-generation",e.hooks.beforeCodeGeneration,e.hooks.afterCodeGeneration,{parentSpan:()=>sealSpanByCompilation.get(e)||spans.get(e)}),this.traceHookPair("hash",e.hooks.beforeHash,e.hooks.afterHash,{parentSpan:()=>sealSpanByCompilation.get(e)||spans.get(e)}),this.traceHookPair("code-generation-jobs",e.hooks.afterHash,e.hooks.beforeModuleAssets,{parentSpan:()=>sealSpanByCompilation.get(e)||spans.get(e)});const t=new Map,o=e.logger.time,n=e.logger.timeEnd;e.logger.time=a=>{if(!inTraceLabelsSeal(a))return o.call(e.logger,a);const n=sealSpanByCompilation.get(e);return n&&t.set(a,n.traceChild(a.replace(/ /g,"-"))),o.call(e.logger,a)},e.logger.timeEnd=a=>{if(!inTraceLabelsSeal(a))return n.call(e.logger,a);const o=t.get(a);return o&&(o.stop(),t.delete(a)),n.call(e.logger,a)}}))}}