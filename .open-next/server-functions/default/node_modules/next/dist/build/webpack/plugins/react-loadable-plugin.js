"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"ReactLoadablePlugin",{enumerable:!0,get:function(){return ReactLoadablePlugin}});const _path=_interop_require_default(require("path")),_webpack=require("next/dist/compiled/webpack/webpack"),_constants=require("../../../shared/lib/constants");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function getModuleId(e,t){return e.chunkGraph.getModuleId(t)}function getModuleFromDependency(e,t){return e.moduleGraph.getModule(t)}function getOriginModuleFromDependency(e,t){return e.moduleGraph.getParentModule(t)}function getChunkGroupFromBlock(e,t){return e.chunkGraph.getBlockChunkGroup(t)}function buildManifest(e,t,s,n,r){if(!s)return{reactLoadableManifest:{},dynamicCssManifest:[]};const i=new Set;let a={};const o=e=>{e.blocks.forEach(o);const c=getChunkGroupFromBlock(t,e);for(const o of e.dependencies)if(o.type.startsWith("import()")){const e=getModuleFromDependency(t,o);if(!e)return;const u=getOriginModuleFromDependency(t,o),d=null==u?void 0:u.resource;if(!d)return;const l=`${_path.default.relative(s,d)} -> ${o.request}`,f=new Set;if(a[l])for(const e of a[l].files)f.add(e);if(c)for(const e of c.chunks)e.files.forEach((e=>{(e.endsWith(".js")||e.endsWith(".css"))&&e.match(/^static\/(chunks|css)\//)&&(f.add(e),r&&e.endsWith(".css")&&i.add(e))}));const p=n?l:getModuleId(t,e);a[l]={id:p,files:Array.from(f)}}};for(const e of t.modules)e.blocks.forEach(o);return a=Object.keys(a).sort().reduce(((e,t)=>(e[t]=a[t],e)),{}),{reactLoadableManifest:a,dynamicCssManifest:Array.from(i)}}class ReactLoadablePlugin{constructor(e){this.filename=e.filename,this.pagesOrAppDir=e.pagesDir||e.appDir,this.isPagesDir=Boolean(e.pagesDir),this.runtimeAsset=e.runtimeAsset,this.dev=e.dev}createAssets(e,t){const s=this.pagesOrAppDir?_path.default.dirname(this.pagesOrAppDir):void 0,n=!this.dev&&this.isPagesDir,{reactLoadableManifest:r,dynamicCssManifest:i}=buildManifest(e,t,s,this.dev,n);t.emitAsset(this.filename,new _webpack.sources.RawSource(JSON.stringify(r,null,2))),this.runtimeAsset&&t.emitAsset(this.runtimeAsset,new _webpack.sources.RawSource(`self.__REACT_LOADABLE_MANIFEST=${JSON.stringify(JSON.stringify(r))}`)),n&&(t.emitAsset(`${_constants.DYNAMIC_CSS_MANIFEST}.json`,new _webpack.sources.RawSource(JSON.stringify(i,null,2))),t.emitAsset(`server/${_constants.DYNAMIC_CSS_MANIFEST}.js`,new _webpack.sources.RawSource(`self.__DYNAMIC_CSS_MANIFEST=${JSON.stringify(JSON.stringify(i))}`)))}apply(e){e.hooks.make.tap("ReactLoadableManifest",(t=>{t.hooks.processAssets.tap({name:"ReactLoadableManifest",stage:_webpack.webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS},(()=>{this.createAssets(e,t)}))}))}}