"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return _default}});const _postcssvalueparser=_interop_require_default(require("next/dist/compiled/postcss-value-parser")),_utils=require("../utils");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}const isUrlFunc=/url/i,isImageSetFunc=/^(?:-webkit-)?image-set$/i,needParseDeclaration=/(?:url|(?:-webkit-)?image-set)\(/i;function getNodeFromUrlFunc(e){return e.nodes&&e.nodes[0]}function getWebpackIgnoreCommentValue(e,t,r){if(0===e&&void 0!==r)return r;let n=t[e-1];if(!n)return;if("space"===n.type){if(!t[e-2])return;n=t[e-2]}if("comment"!==n.type)return;const s=n.value.match(_utils.WEBPACK_IGNORE_COMMENT_REGEXP);return s&&"true"===s[2]}function shouldHandleURL(e,t,r,n){if(0===e.length)return r.warn(`Unable to find uri in '${t.toString()}'`,{node:t}),!1;if((0,_utils.isDataUrl)(e)&&n){try{decodeURIComponent(e)}catch(e){return!1}return!0}return!!(0,_utils.isUrlRequestable)(e)}function parseDeclaration(e,t,r,n){if(!needParseDeclaration.test(e[t]))return;const s=(0,_postcssvalueparser.default)(e.raws&&e.raws.value&&e.raws.value.raw?e.raws.value.raw:e[t]);let i;if(e.raws&&e.raws.between){const t=e.raws.between.lastIndexOf("/*"),r=e.raws.between.slice(t).match(_utils.WEBPACK_IGNORE_COMMENT_REGEXP);r&&(i="true"===r[2])}let o=!1;const l=e.prev();if(l&&"comment"===l.type){const e=l.text.match(_utils.WEBPACK_IGNORE_COMMENT_REGEXP);e&&(o="true"===e[2])}let u;const a=[];return s.walk(((t,l,c)=>{if("function"===t.type){if(isUrlFunc.test(t.value)){if(u=getWebpackIgnoreCommentValue(l,c,i),o&&void 0===u||u)return void(u&&(u=void 0));const{nodes:p}=t,d=0!==p.length&&"string"===p[0].type;let _=d?p[0].value:_postcssvalueparser.default.stringify(p);if(_=(0,_utils.normalizeUrl)(_,d),!shouldHandleURL(_,e,r,n))return!1;const f=_.split("!");let m;return f.length>1&&(_=f.pop(),m=f.join("!")),a.push({declaration:e,parsed:s,node:getNodeFromUrlFunc(t),prefix:m,url:_,needQuotes:!1}),!1}if(isImageSetFunc.test(t.value)){for(const[i,l]of t.nodes.entries()){const{type:c,value:p}=l;if("function"===c&&isUrlFunc.test(p)){if(u=getWebpackIgnoreCommentValue(i,t.nodes),o&&void 0===u||u){u&&(u=void 0);continue}const{nodes:c}=l,p=0!==c.length&&"string"===c[0].type;let d=p?c[0].value:_postcssvalueparser.default.stringify(c);if(d=(0,_utils.normalizeUrl)(d,p),!shouldHandleURL(d,e,r,n))return!1;const _=d.split("!");let f;_.length>1&&(d=_.pop(),f=_.join("!")),a.push({declaration:e,parsed:s,node:getNodeFromUrlFunc(l),prefix:f,url:d,needQuotes:!1})}else if("string"===c){if(u=getWebpackIgnoreCommentValue(i,t.nodes),o&&void 0===u||u){u&&(u=void 0);continue}let c=(0,_utils.normalizeUrl)(p,!0);if(!shouldHandleURL(c,e,r,n))return!1;const d=c.split("!");let _;d.length>1&&(c=d.pop(),_=d.join("!")),a.push({declaration:e,parsed:s,node:l,prefix:_,url:c,needQuotes:!0})}}return!1}}})),a}const plugin=(e={})=>({postcssPlugin:"postcss-url-parser",prepare(t){const r=[];return{Declaration(n){const{isSupportDataURLInNewURL:s}=e,i=parseDeclaration(n,"value",t,s);i&&r.push(...i)},async OnceExit(){if(0===r.length)return;const t=await Promise.all(r.map((async t=>{const{url:r}=t;if(e.filter){if(!await e.filter(r))return}if((0,_utils.isDataUrl)(r))return t;const[n,s,i]=r.split(/(\?)?#/,3);let o=s?"?":"";o+=i?`#${i}`:"";const{needToResolveURL:l,rootContext:u}=e,a=(0,_utils.requestify)(n,u,l);if(!l)return{...t,url:a,hash:o};const{resolver:c,context:p}=e,d=await(0,_utils.resolveRequests)(c,p,[...new Set([a,r])]);return d?{...t,url:d,hash:o}:void 0}))),n=new Map,s=new Map;let i=!1;for(let r=0;r<=t.length-1;r++){const o=t[r];if(!o)continue;i||(e.imports.push({type:"get_url_import",importName:"___CSS_LOADER_GET_URL_IMPORT___",url:e.urlHandler(require.resolve("../runtime/getUrl.js")),index:-1}),i=!0);const{url:l,prefix:u}=o,a=u?`${u}!${l}`:l;let c=n.get(a);c||(c=`___CSS_LOADER_URL_IMPORT_${n.size}___`,n.set(a,c),e.imports.push({type:"url",importName:c,url:e.needToResolveURL?e.urlHandler(a):JSON.stringify(a),index:r}));const{hash:p,needQuotes:d}=o,_=JSON.stringify({newUrl:a,hash:p,needQuotes:d});let f=s.get(_);f||(f=`___CSS_LOADER_URL_REPLACEMENT_${s.size}___`,s.set(_,f),e.replacements.push({replacementName:f,importName:c,hash:p,needQuotes:d})),o.node.type="word",o.node.value=f,o.declaration.value=o.parsed.toString()}}}}});plugin.postcss=!0;const _default=plugin;