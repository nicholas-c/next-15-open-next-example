"use strict";function _export(e,t){for(var n in t)Object.defineProperty(e,n,{enumerable:!0,get:t[n]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{TRACE_IGNORES:function(){return TRACE_IGNORES},TraceEntryPointsPlugin:function(){return TraceEntryPointsPlugin},getFilesMapFromReasons:function(){return getFilesMapFromReasons}});const _path=_interop_require_default(require("path")),_profilingplugin=require("./profiling-plugin"),_iserror=_interop_require_default(require("../../../lib/is-error")),_nft=require("next/dist/compiled/@vercel/nft"),_constants=require("../../../shared/lib/constants"),_webpack=require("next/dist/compiled/webpack/webpack"),_webpackconfig=require("../../webpack-config"),_picomatch=_interop_require_default(require("next/dist/compiled/picomatch")),_getmodulebuildinfo=require("../loaders/get-module-build-info"),_entries=require("../../entries"),_handleexternals=require("../../handle-externals"),_ismetadataroute=require("../../../lib/metadata/is-metadata-route");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}const PLUGIN_NAME="TraceEntryPointsPlugin",TRACE_IGNORES=["**/*/next/dist/server/next.js","**/*/next/dist/bin/next"],NOT_TRACEABLE=[".wasm",".png",".jpg",".jpeg",".gif",".webp",".avif",".ico",".bmp",".svg"];function getModuleFromDependency(e,t){return e.moduleGraph.getModule(t)}function getFilesMapFromReasons(e,t,n){const s=new Map;function i(e,r,o=new Set){for(const a of e||[])if(!o.has(a)){o.add(a);let e=s.get(a);e||(e=new Map,s.set(a,e));const c=Boolean(null==n?void 0:n(r,a));e.set(r,{ignored:c});const l=t.get(a);(null==l?void 0:l.parents)&&i(l.parents,r,o)}}for(const n of e){const e=t.get(n),s=1===(null==e?void 0:e.type.length)&&e.type.includes("initial");!e||!e.parents||s&&0===e.parents.size||i(e.parents,n)}return s}class TraceEntryPointsPlugin{constructor({rootDir:e,appDir:t,pagesDir:n,compilerType:s,optOutBundlingPackages:i,appDirEnabled:r,traceIgnores:o,esmExternals:a,outputFileTracingRoot:c}){this.buildTraceContext={},this.rootDir=e,this.appDir=t,this.pagesDir=n,this.entryTraces=new Map,this.esmExternals=a,this.appDirEnabled=r,this.traceIgnores=o||[],this.tracingRoot=c||e,this.optOutBundlingPackages=i,this.compilerType=s}async createTraceAssets(e,t){const n=e.outputOptions.path||"";await t.traceChild("create-trace-assets").traceAsyncFn((async()=>{const t=new Map,s=new Set,i=new Map,r=e=>!NOT_TRACEABLE.some((t=>e.endsWith(t)));for(const o of e.entrypoints.values()){const e=new Set;for(const t of process.env.NEXT_RSPACK?o.chunks:o.getEntrypointChunk().getAllReferencedChunks()){for(const i of t.files)if(r(i)){const t=_path.default.join(n,i);s.add(t),e.add(t)}for(const i of t.auxiliaryFiles)if(r(i)){const t=_path.default.join(n,i);s.add(t),e.add(t)}}t.set(o,e),i.set(o.name||"",[...e])}this.buildTraceContext.chunksTrace={action:{action:"annotate",input:[...s],contextDirectory:this.tracingRoot,processCwd:this.rootDir},outputPath:n,entryNameFilesMap:Object.fromEntries(i)};const o="server"===this.compilerType?"../":"";for(const[s,i]of t){var a;const t=`${o}${s.name}.js.nft.json`,r=_path.default.dirname(_path.default.join(n,t));if(i.delete(_path.default.join(n,`${o}${s.name}.js`)),s.name.startsWith("app/")&&this.appDir){var c,l;const e=null==(l=this.buildTraceContext.entriesTrace)||null==(c=l.absolutePathByEntryName[s.name])?void 0:c.replace(this.appDir,"");e&&(0,_ismetadataroute.isStaticMetadataRoute)(e)||i.add(_path.default.join(n,o,s.name.replace(/%5F/g,"_")+"_"+_constants.CLIENT_REFERENCE_MANIFEST+".js"))}const u=[];await Promise.all([...new Set([...i,...(null==(a=this.entryTraces.get(s.name))?void 0:a.keys())||[]])].map((async e=>{var t;const n=null==(t=this.entryTraces.get(s.name))?void 0:t.get(e),i=_path.default.relative(r,e).replace(/\\/g,"/");e&&((null==n?void 0:n.bundled)||u.push(i))}))),e.emitAsset(t,new _webpack.sources.RawSource(JSON.stringify({version:_constants.TRACE_OUTPUT_VERSION,files:u})))}}))}tapfinishModules(e,t,n,s,i){e.hooks.finishModules.tapAsync(PLUGIN_NAME,(async(r,o)=>{const a=t.traceChild("finish-modules");await a.traceAsyncFn((async()=>{const t=new Map,r=new Map,o=new Map,c=new Map,l=new Map;await a.traceChild("get-entries").traceAsyncFn((async()=>{for(const[n,s]of e.entries.entries()){const i=null==n?void 0:n.replace(/\\/g,"/"),a=i.startsWith("pages/");if(this.appDirEnabled&&i.startsWith("app/")||a)for(const i of s.dependencies){if(!i)continue;const s=getModuleFromDependency(e,i);if(s&&""===s.resource){const e=(0,_getmodulebuildinfo.getModuleBuildInfo)(s);if(e.route){const i=(0,_entries.getPageFilePath)({absolutePagePath:e.route.absolutePagePath,rootDir:this.rootDir,appDir:this.appDir,pagesDir:this.pagesDir});(this.pagesDir&&i.startsWith(this.pagesDir)||this.appDir&&i.startsWith(this.appDir))&&(r.set(i,s),t.set(i,n),c.set(n,i))}if(s.request){let e=o.get(n);e||(e=new Map,o.set(n,e)),l.set(s.request,s),e.set(s.resource,s)}}if(s&&s.resource){t.set(s.resource,n),r.set(s.resource,s);let e=o.get(n);e||(e=new Map,o.set(n,e)),l.set(s.resource,s),e.set(s.resource,s)}}}}));const u=async e=>{var t,n;const s=l.get(e)||r.get(e);return(null==s||null==(n=s.originalSource)||null==(t=n.call(s))?void 0:t.buffer())||""},p=Array.from(r.keys()),d=async(t,n)=>{if(t&&t.dependencies)for(const s of t.dependencies){const t=getModuleFromDependency(e,s);(null==t?void 0:t.resource)&&!l.get(t.resource)&&(l.set(t.resource,t),await d(t,n))}},f=[...p];for(const e of p){await d(r.get(e),e);const n=t.get(e),s=o.get(n);s&&f.push(...s.keys())}const h=this.tracingRoot,g=[...f];let _,m;this.buildTraceContext.entriesTrace={action:{action:"print",input:g,contextDirectory:h,processCwd:this.rootDir},appDir:this.rootDir,depModArray:Array.from(l.keys()),entryNameMap:Object.fromEntries(t),absolutePathByEntryName:Object.fromEntries(c),outputPath:e.outputOptions.path};const y=[...TRACE_IGNORES,...this.traceIgnores,"**/node_modules/**"],E=(0,_picomatch.default)(y,{contains:!0,dot:!0}),w=e=>E(e);await a.traceChild("node-file-trace-plugin",{traceEntryCount:f.length+""}).traceAsyncFn((async()=>{const e=await(0,_nft.nodeFileTrace)(f,{base:this.tracingRoot,processCwd:this.rootDir,readFile:u,readlink:s,stat:i,resolve:n?async(e,t,s,i)=>n(e,t,s,!i):void 0,ignore:w,mixedModules:!0});_=e.fileList,e.esmFileList.forEach((e=>_.add(e))),m=e.reasons})),await a.traceChild("collect-traced-files").traceAsyncFn((()=>{const e=getFilesMapFromReasons(_,m,(e=>{var t;e=_path.default.join(this.tracingRoot,e);const n=l.get(e);return!(null==(t=m.get(_path.default.relative(this.tracingRoot,e)))?void 0:t.type.includes("asset"))&&Array.isArray(null==n?void 0:n.loaders)&&n.loaders.length>0}));for(const i of p){var n;const r=t.get(i),a=_path.default.relative(this.tracingRoot,i),c=o.get(r),l=new Map;l.set(i,{bundled:!0});for(const[t,s]of(null==(n=e.get(a))?void 0:n.entries())||[])l.set(_path.default.join(this.tracingRoot,t),{bundled:s.ignored});if(c)for(const t of c.keys()){var s;const n=_path.default.relative(this.tracingRoot,t);l.set(t,{bundled:!1});for(const[t,i]of(null==(s=e.get(n))?void 0:s.entries())||[])l.set(_path.default.join(this.tracingRoot,t),{bundled:i.ignored})}this.entryTraces.set(r,l)}}))})).then((()=>o()),(e=>o(e)))}))}apply(e){e.hooks.compilation.tap(PLUGIN_NAME,(t=>{if(t.hooks.processAssets.tapAsync({name:PLUGIN_NAME,stage:_webpack.webpack.Compilation.PROCESS_ASSETS_STAGE_SUMMARIZE},((e,n)=>{this.createTraceAssets(t,i).then((()=>n())).catch((e=>n(e)))})),process.env.NEXT_RSPACK)return;const n=async e=>{try{return await new Promise(((n,s)=>{t.inputFileSystem.readlink(e,((e,t)=>{if(e)return s(e);n(t)}))}))}catch(e){if((0,_iserror.default)(e)&&("EINVAL"===e.code||"ENOENT"===e.code||"UNKNOWN"===e.code))return null;throw e}},s=async e=>{try{return await new Promise(((n,s)=>{t.inputFileSystem.stat(e,((e,t)=>{if(e)return s(e);n(t)}))}))}catch(e){if((0,_iserror.default)(e)&&("ENOENT"===e.code||"ENOTDIR"===e.code))return null;throw e}},i=(_profilingplugin.spans.get(t)||_profilingplugin.spans.get(e)).traceChild("next-trace-entrypoint-plugin");i.traceFn((()=>{t.hooks.processAssets.tapAsync({name:PLUGIN_NAME,stage:_webpack.webpack.Compilation.PROCESS_ASSETS_STAGE_SUMMARIZE},((e,n)=>{this.createTraceAssets(t,i).then((()=>n())).catch((e=>n(e)))}));let e=t.resolverFactory.get("normal");function r(e){const t=e.split("/");return"@"===e[0]&&t.length>1?t.length>1?t.slice(0,2).join("/"):null:t.length?t[0]:null}const o=n=>{const s=e.withOptions(n);return(e,i,o)=>new Promise(((a,c)=>{const l=_path.default.dirname(e);s.resolve({},l,i,{fileDependencies:t.fileDependencies,missingDependencies:t.missingDependencies,contextDependencies:t.contextDependencies},(async(t,s,l)=>{if(t)return c(t);if(!s)return c(Object.defineProperty(new Error("module not found"),"__NEXT_ERROR_CODE",{value:"E512",enumerable:!1,configurable:!0}));(s.includes("?")||s.includes("!"))&&(s=(null==l?void 0:l.path)||s);try{if(s.includes("node_modules")){let t=s.replace(/\\/g,"/").replace(/\0/g,"");var u;if(!_path.default.isAbsolute(i)&&i.includes("/")&&(null==l?void 0:l.descriptionFileRoot))t=(l.descriptionFileRoot+i.slice((null==(u=r(i))?void 0:u.length)||0)+_path.default.sep+"package.json").replace(/\\/g,"/").replace(/\0/g,"");const n=t.indexOf("/");let a;for(;(a=t.lastIndexOf("/"))>n;){t=t.slice(0,a);const n=`${t}/package.json`;await o.isFile(n)&&await o.emitFile(await o.realpath(n),"resolve",e)}}}catch(e){}a([s,"esm"===n.dependencyType])}))}))},a={..._webpackconfig.NODE_RESOLVE_OPTIONS,fullySpecified:void 0,modules:void 0,extensions:void 0},c={...a,alias:!1},l={..._webpackconfig.NODE_ESM_RESOLVE_OPTIONS,fullySpecified:void 0,modules:void 0,extensions:void 0},u={...l,alias:!1},p=async(e,t,n,s)=>{const i=_path.default.dirname(t),{res:r}=await(0,_handleexternals.resolveExternal)(this.rootDir,this.esmExternals,i,e,s,this.optOutBundlingPackages,(e=>(s,i)=>o(e)(t,i,n)),void 0,void 0,l,a,u,c);if(!r)throw Object.defineProperty(new Error(`failed to resolve ${e} from ${t}`),"__NEXT_ERROR_CODE",{value:"E361",enumerable:!1,configurable:!0});return r.replace(/\0/g,"")};this.tapfinishModules(t,i,p,n,s)}))}))}}