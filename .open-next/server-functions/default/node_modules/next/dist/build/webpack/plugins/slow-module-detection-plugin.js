"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return SlowModuleDetectionPlugin}});const _picocolors=require("../../../lib/picocolors"),PLUGIN_NAME="SlowModuleDetectionPlugin",TreeSymbols={VERTICAL_LINE:"│  ",BRANCH:"├─ "},PATH_TRUNCATION_LENGTH=120,NODE_MODULES_PATH_PATTERN=/node_modules(?:\/\.pnpm)?\/(.*)/,getModuleIdentifier=e=>{const t=e.debugId;return String(t)},getModuleDisplayName=e=>{const t="resource"in e&&"string"==typeof e.resource?e.resource:void 0;if(!t)return;let o=t.replace(process.cwd(),".");const i=o.match(NODE_MODULES_PATH_PATTERN);return i?i[1]:o};function truncatePath(e,t){if(e.length<=t)return e;const o=t-3,i=Math.ceil(o/2),s=Math.floor(o/2);return`${e.slice(0,i)}...${e.slice(-s)}`}class ModuleBuildTimeAnalyzer{constructor(e){this.options=e,this.pendingModules=[],this.modules=new Map,this.moduleParents=new Map,this.moduleChildren=new Map,this.isFinalized=!1,this.moduleBuildTimes=new WeakMap,this.buildTimeThresholdMs=e.buildTimeThresholdMs}recordModuleBuildTime(e,t){if(this.isFinalized)throw Object.defineProperty(new Error("Invariant (SlowModuleDetectionPlugin): Module is recorded after the report is generated. This is a Next.js internal bug."),"__NEXT_ERROR_CODE",{value:"E630",enumerable:!1,configurable:!0});t<this.buildTimeThresholdMs||(this.moduleBuildTimes.set(e,t),this.pendingModules.push(e))}prepareReport(e){for(const t of this.pendingModules){const o=new Set;{let i=t;for(o.add(i);;){const t=e.moduleGraph.getIssuer(i);if(!t)break;if(o.has(t))throw Object.defineProperty(new Error("Invariant (SlowModuleDetectionPlugin): Circular dependency detected in module graph. This is a Next.js internal bug."),"__NEXT_ERROR_CODE",{value:"E631",enumerable:!1,configurable:!0});o.add(t),i=t}}let i=null;for(const e of o){const t=getModuleIdentifier(e);if(this.modules.has(t)||this.modules.set(t,e),i){this.moduleParents.set(i,e);let t=this.moduleChildren.get(e);t||(t=new Map,this.moduleChildren.set(e,t)),t.set(getModuleIdentifier(i),i)}i=e}}this.isFinalized=!0}generateReport(e){this.isFinalized||this.prepareReport(e);const t=[...this.modules.values()].filter((e=>!this.moduleParents.has(e))),o=(e,t)=>{const o=getModuleDisplayName(e)||"";if(!o)return i(e,t);const s=" "+TreeSymbols.VERTICAL_LINE.repeat(t)+TreeSymbols.BRANCH,r=(0,_picocolors.blue)(truncatePath(o,PATH_TRUNCATION_LENGTH-s.length)),l=this.moduleBuildTimes.get(e);return s+r+(l?(0,_picocolors.yellow)(` (${Math.ceil(l)}ms)`):"")+"\n"+i(e,t+1)},i=(e,t)=>{const i=this.moduleChildren.get(e);return i?[...i].map((([e,i])=>o(i,t))).join(""):""},s=t.map((e=>o(e,0))).join("");s&&console.log((0,_picocolors.green)(`🐌 Detected slow modules while compiling ${this.options.compilerType}:`)+"\n"+s)}}class SlowModuleDetectionPlugin{constructor(e){this.options=e,this.apply=e=>{e.hooks.compilation.tap(PLUGIN_NAME,(e=>{const t=new ModuleBuildTimeAnalyzer(this.options),o=new WeakMap;e.hooks.buildModule.tap(PLUGIN_NAME,(e=>{o.set(e,performance.now())})),e.hooks.succeedModule.tap(PLUGIN_NAME,(e=>{const i=o.get(e);if(!i)throw Object.defineProperty(new Error("Invariant (SlowModuleDetectionPlugin): Unable to find the start time for a module build. This is a Next.js internal bug."),"__NEXT_ERROR_CODE",{value:"E629",enumerable:!1,configurable:!0});t.recordModuleBuildTime(e,performance.now()-i)})),e.hooks.finishModules.tap(PLUGIN_NAME,(()=>{t.generateReport(e)}))}))}}}