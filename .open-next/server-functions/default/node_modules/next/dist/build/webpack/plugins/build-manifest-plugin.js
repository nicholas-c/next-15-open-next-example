"use strict";function _export(e,t){for(var i in t)Object.defineProperty(e,i,{enumerable:!0,get:t[i]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{default:function(){return BuildManifestPlugin},generateClientManifest:function(){return generateClientManifest},getEntrypointFiles:function(){return getEntrypointFiles},normalizeRewritesForBuildManifest:function(){return normalizeRewritesForBuildManifest},processRoute:function(){return processRoute},srcEmptySsgManifest:function(){return srcEmptySsgManifest}});const _devalue=_interop_require_default(require("next/dist/compiled/devalue")),_webpack=require("next/dist/compiled/webpack/webpack"),_constants=require("../../../shared/lib/constants"),_getroutefromentrypoint=_interop_require_default(require("../../../server/get-route-from-entrypoint")),_nextdropclientpageplugin=require("./next-drop-client-page-plugin"),_utils=require("../../../shared/lib/router/utils"),_profilingplugin=require("./profiling-plugin"),_rspackprofilingplugin=require("./rspack-profiling-plugin"),_trace=require("../../../trace");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}const compilationSpans=process.env.NEXT_RSPACK?_rspackprofilingplugin.compilationSpans:_profilingplugin.spans,srcEmptySsgManifest="self.__SSG_MANIFEST=new Set;self.__SSG_MANIFEST_CB&&self.__SSG_MANIFEST_CB()";function buildNodejsLowPriorityPath(e,t){return`${_constants.CLIENT_STATIC_FILES_PATH}/${t}/${e}`}function createEdgeRuntimeManifest(e){const t=["_buildManifest.js","_ssgManifest.js"],i={...e,lowPriorityFiles:[]};return`globalThis.__BUILD_MANIFEST = ${JSON.stringify(i,null,2)};\n`+("globalThis.__BUILD_MANIFEST.lowPriorityFiles = [\n"+t.map((e=>`"/static/" + process.env.__NEXT_BUILD_ID + "/${e}",\n`)).join(",")+"\n];")}function normalizeRewrite(e){return{has:e.has,source:e.source,destination:e.destination}}function normalizeRewritesForBuildManifest(e){var t,i,s,n,r,o;return{afterFiles:null==(i=e.afterFiles)||null==(t=i.map(processRoute))?void 0:t.map((e=>normalizeRewrite(e))),beforeFiles:null==(n=e.beforeFiles)||null==(s=n.map(processRoute))?void 0:s.map((e=>normalizeRewrite(e))),fallback:null==(o=e.fallback)||null==(r=o.map(processRoute))?void 0:r.map((e=>normalizeRewrite(e)))}}function generateClientManifest(e,t,i,s,n){const r=n?compilationSpans.get(n):s?compilationSpans.get(s):new _trace.Span({name:"client-manifest"}),o=null==r?void 0:r.traceChild("NextJsBuildManifest-generateClientManifest");return null==o?void 0:o.traceFn((()=>{const s={__rewrites:normalizeRewritesForBuildManifest(t),__routerFilterStatic:null==i?void 0:i.staticFilter,__routerFilterDynamic:null==i?void 0:i.dynamicFilter},n=new Set(e.pages["/_app"]),r=(0,_utils.getSortedRoutes)(Object.keys(e.pages));return r.forEach((t=>{const i=e.pages[t];if("/_app"===t)return;const r=i.filter((e=>!n.has(e)));r.length&&(s[t]=r)})),s.sortedPages=r,(0,_devalue.default)(s)}))}function getEntrypointFiles(e){return(null==e?void 0:e.getFiles().filter((e=>/(?<!\.hot-update)\.(js|css)($|\?)/.test(e))).map((e=>e.replace(/\\/g,"/"))))??[]}const processRoute=e=>{var t;const i={...e};return(null==i||null==(t=i.destination)?void 0:t.startsWith("/"))||delete i.destination,i};class BuildManifestPlugin{constructor(e){this.buildId=e.buildId,this.isDevFallback=!!e.isDevFallback,this.rewrites={beforeFiles:[],afterFiles:[],fallback:[]},this.appDirEnabled=e.appDirEnabled,this.clientRouterFilters=e.clientRouterFilters,this.rewrites.beforeFiles=e.rewrites.beforeFiles.map(processRoute),this.rewrites.afterFiles=e.rewrites.afterFiles.map(processRoute),this.rewrites.fallback=e.rewrites.fallback.map(processRoute)}createAssets(e,t){const i=compilationSpans.get(t)??compilationSpans.get(e);if(!i)throw Object.defineProperty(new Error("No span found for compilation"),"__NEXT_ERROR_CODE",{value:"E646",enumerable:!1,configurable:!0});return i.traceChild("NextJsBuildManifest-createassets").traceFn((()=>{const i=t.entrypoints,s={polyfillFiles:[],devFiles:[],ampDevFiles:[],lowPriorityFiles:[],rootMainFiles:[],rootMainFilesTree:{},pages:{"/_app":[]},ampFirstPages:[]},n=_nextdropclientpageplugin.ampFirstEntryNamesMap.get(t);if(n)for(const e of n){const t=(0,_getroutefromentrypoint.default)(e);t&&s.ampFirstPages.push(t)}const r=new Set(getEntrypointFiles(i.get(_constants.CLIENT_STATIC_FILES_RUNTIME_MAIN)));this.appDirEnabled&&(s.rootMainFiles=[...new Set(getEntrypointFiles(i.get(_constants.CLIENT_STATIC_FILES_RUNTIME_MAIN_APP)))]);const o=t.getAssets();s.polyfillFiles=o.filter((e=>!!e.name.endsWith(".js")&&(e.info&&_constants.CLIENT_STATIC_FILES_RUNTIME_POLYFILLS_SYMBOL in e.info))).map((e=>e.name)),s.devFiles=getEntrypointFiles(i.get(_constants.CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH)).filter((e=>!r.has(e))),s.ampDevFiles=getEntrypointFiles(i.get(_constants.CLIENT_STATIC_FILES_RUNTIME_AMP));for(const e of t.entrypoints.values()){if(_constants.SYSTEM_ENTRYPOINTS.has(e.name))continue;const t=(0,_getroutefromentrypoint.default)(e.name);if(!t)continue;const i=getEntrypointFiles(e);s.pages[t]=[...new Set([...r,...i])]}if(!this.isDevFallback){const e=buildNodejsLowPriorityPath("_buildManifest.js",this.buildId),i=buildNodejsLowPriorityPath("_ssgManifest.js",this.buildId);s.lowPriorityFiles.push(e,i),t.emitAsset(i,new _webpack.sources.RawSource(srcEmptySsgManifest))}s.pages=Object.keys(s.pages).sort().reduce(((e,t)=>(e[t]=s.pages[t],e)),{});let a=_constants.BUILD_MANIFEST;this.isDevFallback&&(a=`fallback-${_constants.BUILD_MANIFEST}`),t.emitAsset(a,new _webpack.sources.RawSource(JSON.stringify(s,null,2))),t.emitAsset(`server/${_constants.MIDDLEWARE_BUILD_MANIFEST}.js`,new _webpack.sources.RawSource(`${createEdgeRuntimeManifest(s)}`)),this.isDevFallback||t.emitAsset(`${_constants.CLIENT_STATIC_FILES_PATH}/${this.buildId}/_buildManifest.js`,new _webpack.sources.RawSource(`self.__BUILD_MANIFEST = ${generateClientManifest(s,this.rewrites,this.clientRouterFilters,e,t)};self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()`))}))}apply(e){e.hooks.make.tap("NextJsBuildManifest",(t=>{t.hooks.processAssets.tap({name:"NextJsBuildManifest",stage:_webpack.webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS},(()=>{this.createAssets(e,t)}))}))}}