"use strict";function _export(e,r){for(var t in r)Object.defineProperty(e,t,{enumerable:!0,get:r[t]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{formatTrigger:function(){return formatTrigger},store:function(){return store}});const _unistore=_interop_require_default(require("next/dist/compiled/unistore")),_stripansi=_interop_require_default(require("next/dist/compiled/strip-ansi")),_trace=require("../../trace"),_swc=require("../swc"),_log=_interop_require_wildcard(require("./log"));function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(_getRequireWildcardCache=function(e){return e?t:r})(e)}function _interop_require_wildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var i={__proto__:null},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var a=n?Object.getOwnPropertyDescriptor(e,o):null;a&&(a.get||a.set)?Object.defineProperty(i,o,a):i[o]=e[o]}return i.default=e,t&&t.set(e,i),i}const MAX_LOG_SKIP_DURATION=500;function formatTrigger(e){return e.includes("[__metadata_id__]")&&(e=e.replace("/[__metadata_id__]","/[id]")),e.length>1&&e.endsWith("/")&&(e=e.slice(0,-1)),e}const store=(0,_unistore.default)({appUrl:null,bindAddr:null,bootstrap:!0,logging:!0});let lastStore={appUrl:null,bindAddr:null,bootstrap:!0,logging:!0};function hasStoreChanged(e){return![...new Set([...Object.keys(lastStore),...Object.keys(e)])].every((r=>Object.is(lastStore[r],e[r])))&&(lastStore=e,!0)}let triggerUrl,startTime=0,trigger="",loadingLogTimer=null,traceSpan=null,logging=!0;store.subscribe((e=>{if("logging"in e&&(logging=e.logging),!logging)return;if(!hasStoreChanged(e))return;if(e.bootstrap)return;if(e.loading)return e.trigger&&(trigger=formatTrigger(e.trigger),triggerUrl=e.url,"initial"!==trigger&&(traceSpan=(0,_trace.trace)("compile-path",void 0,{trigger:trigger}),loadingLogTimer||(loadingLogTimer=setTimeout((()=>{triggerUrl&&triggerUrl!==trigger&&process.env.NEXT_TRIGGER_URL?_log.wait(`Compiling ${trigger} (${triggerUrl}) ...`):_log.wait(`Compiling ${trigger} ...`)}),MAX_LOG_SKIP_DURATION)))),void(0===startTime&&(startTime=Date.now()));if(e.errors){_log.error(e.errors[0]);const r=(0,_stripansi.default)(e.errors[0]);if(r.indexOf("SyntaxError")>-1){const e=r.match(/\[.*\]=/);if(e){for(const r of e){const e=(r.split("]").shift()||"").slice(1);console.log(`AMP bind syntax [${e}]='' is not supported in JSX, use 'data-amp-bind-${e}' instead. https://nextjs.org/docs/messages/amp-bind-jsx-alt`)}return}}return startTime=0,(0,_trace.flushAllTraces)(),void(0,_swc.teardownTraceSubscriber)()}let r="";if(startTime){const e=Date.now()-startTime;startTime=0,r=" "+(e>2e3?`in ${Math.round(e/100)/10}s`:`in ${e}ms`)}let t="";if(e.totalModulesCount&&(t=` (${e.totalModulesCount} modules)`),e.warnings)return _log.warn(e.warnings.join("\n\n")),(0,_trace.flushAllTraces)(),void(0,_swc.teardownTraceSubscriber)();e.typeChecking?_log.info(`bundled ${trigger}${r}${t}, type checking...`):("initial"===trigger||(loadingLogTimer&&(clearTimeout(loadingLogTimer),loadingLogTimer=null),traceSpan&&(traceSpan.stop(),traceSpan=null),_log.event(`Compiled${trigger?" "+trigger:""}${r}${t}`)),trigger="",(0,_trace.flushAllTraces)(),(0,_swc.teardownTraceSubscriber)())}));