"use strict";function _export(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{ampValidation:function(){return ampValidation},formatAmpMessages:function(){return formatAmpMessages},reportTrigger:function(){return reportTrigger},watchCompilers:function(){return watchCompilers}});const _picocolors=require("../../lib/picocolors"),_stripansi=_interop_require_default(require("next/dist/compiled/strip-ansi")),_texttable=_interop_require_default(require("next/dist/compiled/text-table")),_unistore=_interop_require_default(require("next/dist/compiled/unistore")),_formatwebpackmessages=_interop_require_default(require("../../client/components/react-dev-overlay/utils/format-webpack-messages")),_store=require("./store"),_constants=require("../../shared/lib/constants");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function formatAmpMessages(e){let t=(0,_picocolors.bold)("Amp Validation")+"\n\n",r=[];const o=(0,_picocolors.red)("error");function n(e,t){r.push([e,o,t.message,t.specUrl||""])}const i=(0,_picocolors.yellow)("warn");function s(e,t){r.push([e,i,t.message,t.specUrl||""])}for(const t in e){let{errors:o,warnings:i}=e[t];const l=e=>"DEV_MODE_ONLY"!==e.code;if(o=o.filter(l),i=i.filter(l),o.length||i.length){if(o.length){n(t,o[0]);for(let e=1;e<o.length;++e)n("",o[e])}if(i.length){s(o.length?"":t,i[0]);for(let e=1;e<i.length;++e)s("",i[e])}r.push(["","","",""])}}return r.length?(t+=(0,_texttable.default)(r,{align:["l","l","l","l"],stringLength:e=>(0,_stripansi.default)(e).length}),t):""}const buildStore=(0,_unistore.default)({client:{},server:{},edgeServer:{}});let buildWasDone=!1,clientWasLoading=!0,serverWasLoading=!0,edgeServerWasLoading=!1;function ampValidation(e,t,r){const{amp:o}=buildStore.getState();if(!t.length&&!r.length)return void buildStore.setState({amp:Object.keys(o).filter((t=>t!==e)).sort().reduce(((e,t)=>(e[t]=o[t],e)),{})});const n={...o,[e]:{errors:t,warnings:r}};buildStore.setState({amp:Object.keys(n).sort().reduce(((e,t)=>(e[t]=n[t],e)),{})})}function watchCompilers(e,t,r){function o(e,t,r){t.hooks.invalid.tap(`NextJsInvalid-${e}`,(()=>{r({loading:!0})})),t.hooks.done.tap(`NextJsDone-${e}`,(e=>{buildStore.setState({amp:{}});const{errors:t,warnings:o}=(0,_formatwebpackmessages.default)(e.toJson({preset:"errors-warnings",moduleTrace:!0})),n=!!(null==t?void 0:t.length),i=!!(null==o?void 0:o.length);r({loading:!1,totalModulesCount:e.compilation.modules.size,errors:n?t:null,warnings:i?o:null})}))}buildStore.setState({client:{loading:!0},server:{loading:!0},edgeServer:{loading:!0},trigger:"initial",url:void 0}),o(_constants.COMPILER_NAMES.client,e,(e=>{!e.loading&&!buildStore.getState().server.loading&&!buildStore.getState().edgeServer.loading&&e.totalModulesCount>0?buildStore.setState({client:e,trigger:void 0,url:void 0}):buildStore.setState({client:e})})),o(_constants.COMPILER_NAMES.server,t,(e=>{!e.loading&&!buildStore.getState().client.loading&&!buildStore.getState().edgeServer.loading&&e.totalModulesCount>0?buildStore.setState({server:e,trigger:void 0,url:void 0}):buildStore.setState({server:e})})),o(_constants.COMPILER_NAMES.edgeServer,r,(e=>{!e.loading&&!buildStore.getState().client.loading&&!buildStore.getState().server.loading&&e.totalModulesCount>0?buildStore.setState({edgeServer:e,trigger:void 0,url:void 0}):buildStore.setState({edgeServer:e})}))}function reportTrigger(e,t){buildStore.setState({trigger:e,url:t})}buildStore.subscribe((e=>{const{amp:t,client:r,server:o,edgeServer:n,trigger:i,url:s}=e,{appUrl:l}=_store.store.getState();if(r.loading||o.loading||(null==n?void 0:n.loading))return _store.store.setState({bootstrap:!1,appUrl:l,loading:!0,trigger:i,url:s},!0),clientWasLoading=!buildWasDone&&clientWasLoading||r.loading,serverWasLoading=!buildWasDone&&serverWasLoading||o.loading,edgeServerWasLoading=!buildWasDone&&edgeServerWasLoading||n.loading,void(buildWasDone=!1);buildWasDone=!0;let a={bootstrap:!1,appUrl:l,loading:!1,typeChecking:!1,totalModulesCount:(clientWasLoading?r.totalModulesCount:0)+(serverWasLoading?o.totalModulesCount:0)+(edgeServerWasLoading&&(null==n?void 0:n.totalModulesCount)||0),hasEdgeServer:!!n};if(r.errors&&clientWasLoading)_store.store.setState({...a,errors:r.errors,warnings:null},!0);else if(o.errors&&serverWasLoading)_store.store.setState({...a,errors:o.errors,warnings:null},!0);else if(n.errors&&edgeServerWasLoading)_store.store.setState({...a,errors:n.errors,warnings:null},!0);else{const e=[...r.warnings||[],...o.warnings||[],...n.warnings||[]].concat(formatAmpMessages(t)||[]);_store.store.setState({...a,errors:null,warnings:0===e.length?null:e},!0)}}));