"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"collectSegments",{enumerable:!0,get:function(){return collectSegments}});const _appsegmentconfig=require("./app-segment-config"),_invarianterror=require("../../../shared/lib/invariant-error"),_checks=require("../../../server/route-modules/checks"),_clientandserverreferences=require("../../../lib/client-and-server-references"),_getsegmentparam=require("../../../server/app-render/get-segment-param"),_appdirmodule=require("../../../server/lib/app-dir-module"),_segment=require("../../../shared/lib/segment");function attach(e,t,r){if("object"!=typeof t||null===t)return;const n=(0,_appsegmentconfig.parseAppSegmentConfig)(t,r);var a;if((Object.keys(n).length>0&&(e.config=n),"generateStaticParams"in t&&"function"==typeof t.generateStaticParams)&&(e.generateStaticParams=t.generateStaticParams,"edge"===(null==(a=e.config)?void 0:a.runtime)))throw Object.defineProperty(new Error("Edge runtime is not supported with `generateStaticParams`."),"__NEXT_ERROR_CODE",{value:"E502",enumerable:!1,configurable:!0})}async function collectAppPageSegments(e){const t=new Map,r=[[e.userland.loaderTree,[]]];for(;r.length>0;){var n;const[a,i]=r.shift(),[o,c]=a,{mod:s,filePath:l}=await(0,_appdirmodule.getLayoutOrPageModule)(a),m=s&&(0,_clientandserverreferences.isClientReference)(s),g=null==(n=(0,_getsegmentparam.getSegmentParam)(o))?void 0:n.param,u={name:o,param:g,filePath:l,config:void 0,isDynamicSegment:!!g,generateStaticParams:void 0};m||attach(u,s,e.definition.pathname);const p=getSegmentKey(u);t.has(p)||t.set(p,u);const f=[...i,u];o===_segment.PAGE_SEGMENT_KEY&&f.forEach((e=>{const r=getSegmentKey(e);t.set(r,e)}));for(const e in c){const t=c[e];r.push([t,f])}}return Array.from(t.values())}function getSegmentKey(e){return`${e.name}-${e.filePath??""}-${e.param??""}`}function collectAppRouteSegments(e){const t=e.definition.pathname.split("/").slice(1);if(0===t.length)throw Object.defineProperty(new _invarianterror.InvariantError("Expected at least one segment"),"__NEXT_ERROR_CODE",{value:"E580",enumerable:!1,configurable:!0});const r=t.map((e=>{var t;const r=null==(t=(0,_getsegmentparam.getSegmentParam)(e))?void 0:t.param;return{name:e,param:r,filePath:void 0,isDynamicSegment:!!r,config:void 0,generateStaticParams:void 0}})),n=r[r.length-1];return n.filePath=e.definition.filename,attach(n,e.userland,e.definition.pathname),r}function collectSegments({routeModule:e}){if((0,_checks.isAppRouteRouteModule)(e))return collectAppRouteSegments(e);if((0,_checks.isAppPageRouteModule)(e))return collectAppPageSegments(e);throw Object.defineProperty(new _invarianterror.InvariantError("Expected a route module to be one of app route or page"),"__NEXT_ERROR_CODE",{value:"E568",enumerable:!1,configurable:!0})}