"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"TurbopackManifestLoader",{enumerable:!0,get:function(){return TurbopackManifestLoader}});const _interop_require_default=require("@swc/helpers/_/_interop_require_default"),_pathtoregexp=require("next/dist/compiled/path-to-regexp"),_constants=require("../constants"),_path=require("path"),_promises=require("fs/promises"),_requirecache=require("../../../server/dev/require-cache"),_writeatomic=require("../../../lib/fs/write-atomic"),_generateinterceptionroutesrewrites=require("../../../lib/generate-interception-routes-rewrites"),_buildmanifestplugin=require("../../../build/webpack/plugins/build-manifest-plugin"),_getassetpathfromroute=_interop_require_default._(require("../router/utils/get-asset-path-from-route")),_entrykey=require("./entry-key"),_utils=require("../router/utils"),_fs=require("fs"),_turbopackutils=require("../../../server/dev/turbopack-utils"),_trytoparsepath=require("../../../lib/try-to-parse-path"),getManifestPath=(e,t,i,s)=>_path.posix.join(t,"server",s,"middleware"===s||"instrumentation"===s?"":"app"===s?e:(0,_getassetpathfromroute.default)(e),i);async function readPartialManifest(e,t,i,s){void 0===s&&(s="pages");const a=i,r=/[\\/]sitemap(.xml)?\/route$/.test(a);let n=getManifestPath(a,e,t,s);if(r&&!(0,_fs.existsSync)(n)&&(n=getManifestPath(i.replace(/\/sitemap\/route$/,"/sitemap.xml/route"),e,t,s)),!(0,_fs.existsSync)(n)&&a.endsWith("/route")){let i=(0,_turbopackutils.addRouteSuffix)((0,_turbopackutils.addMetadataIdToRoute)((0,_turbopackutils.removeRouteSuffix)(a)));n=getManifestPath(i,e,t,s)}return JSON.parse(await(0,_promises.readFile)(_path.posix.join(n),"utf-8"))}class TurbopackManifestLoader{delete(e){this.actionManifests.delete(e),this.appBuildManifests.delete(e),this.appPathsManifests.delete(e),this.buildManifests.delete(e),this.fontManifests.delete(e),this.middlewareManifests.delete(e),this.pagesManifests.delete(e),this.webpackStats.delete(e)}async loadActionManifest(e){this.actionManifests.set((0,_entrykey.getEntryKey)("app","server",e),await readPartialManifest(this.distDir,_constants.SERVER_REFERENCE_MANIFEST+".json",e,"app"))}async mergeActionManifests(e){const t={node:{},edge:{},encryptionKey:this.encryptionKey};function i(e,t){for(const r in t){var i,s,a;const n=null!=(a=(i=e)[s=r])?a:i[s]={workers:{},layer:{}};Object.assign(n.workers,t[r].workers),Object.assign(n.layer,t[r].layer)}}for(const s of e)i(t.node,s.node),i(t.edge,s.edge);return t}async writeActionManifest(){const e=await this.mergeActionManifests(this.actionManifests.values()),t=(0,_path.join)(this.distDir,"server",_constants.SERVER_REFERENCE_MANIFEST+".json"),i=(0,_path.join)(this.distDir,"server",_constants.SERVER_REFERENCE_MANIFEST+".js"),s=JSON.stringify(e,null,2);(0,_requirecache.deleteCache)(t),(0,_requirecache.deleteCache)(i),await(0,_writeatomic.writeFileAtomic)(t,s),await(0,_writeatomic.writeFileAtomic)(i,"self.__RSC_SERVER_MANIFEST="+JSON.stringify(s))}async loadAppBuildManifest(e){this.appBuildManifests.set((0,_entrykey.getEntryKey)("app","server",e),await readPartialManifest(this.distDir,_constants.APP_BUILD_MANIFEST,e,"app"))}mergeAppBuildManifests(e){const t={pages:{}};for(const i of e)Object.assign(t.pages,i.pages);return t}async writeAppBuildManifest(){const e=this.mergeAppBuildManifests(this.appBuildManifests.values()),t=(0,_path.join)(this.distDir,_constants.APP_BUILD_MANIFEST);(0,_requirecache.deleteCache)(t),await(0,_writeatomic.writeFileAtomic)(t,JSON.stringify(e,null,2))}async loadAppPathsManifest(e){this.appPathsManifests.set((0,_entrykey.getEntryKey)("app","server",e),await readPartialManifest(this.distDir,_constants.APP_PATHS_MANIFEST,e,"app"))}async writeAppPathsManifest(){const e=this.mergePagesManifests(this.appPathsManifests.values()),t=(0,_path.join)(this.distDir,"server",_constants.APP_PATHS_MANIFEST);(0,_requirecache.deleteCache)(t),await(0,_writeatomic.writeFileAtomic)(t,JSON.stringify(e,null,2))}async writeWebpackStats(){const e=this.mergeWebpackStats(this.webpackStats.values()),t=(0,_path.join)(this.distDir,"server",_constants.WEBPACK_STATS);(0,_requirecache.deleteCache)(t),await(0,_writeatomic.writeFileAtomic)(t,JSON.stringify(e,null,2))}async loadBuildManifest(e,t){void 0===t&&(t="pages"),this.buildManifests.set((0,_entrykey.getEntryKey)(t,"server",e),await readPartialManifest(this.distDir,_constants.BUILD_MANIFEST,e,t))}async loadWebpackStats(e,t){void 0===t&&(t="pages"),this.webpackStats.set((0,_entrykey.getEntryKey)(t,"client",e),await readPartialManifest(this.distDir,_constants.WEBPACK_STATS,e,t))}mergeWebpackStats(e){const t={},i=new Map,s=new Map,a=new Map;for(const r of e){if(r.entrypoints)for(const[e,i]of Object.entries(r.entrypoints))t[e]||(t[e]=i);if(r.assets)for(const e of r.assets)i.has(e.name)||i.set(e.name,e);if(r.chunks)for(const e of r.chunks)s.has(e.name)||s.set(e.name,e);if(r.modules)for(const e of r.modules){const t=e.id;if(null!=t){const i=a.get(t);if(null==i)a.set(t,e);else if(null!=e.chunks&&null!=i.chunks)for(const t of e.chunks)i.chunks.includes(t)||i.chunks.push(t)}}}return{entrypoints:t,assets:[...i.values()],chunks:[...s.values()],modules:[...a.values()]}}mergeBuildManifests(e){const t={pages:{"/_app":[]},devFiles:[],ampDevFiles:[],polyfillFiles:[],lowPriorityFiles:["static/"+this.buildId+"/_ssgManifest.js","static/"+this.buildId+"/_buildManifest.js"],rootMainFiles:[],ampFirstPages:[]};for(const i of e)Object.assign(t.pages,i.pages),i.rootMainFiles.length&&(t.rootMainFiles=i.rootMainFiles),i.polyfillFiles.length&&(t.polyfillFiles=i.polyfillFiles);return t}async writeBuildManifest(e,t,i){var s,a,r;const n=null!=i?i:{...t,beforeFiles:(null!=(s=null==t?void 0:t.beforeFiles)?s:[]).map(_buildmanifestplugin.processRoute),afterFiles:(null!=(a=null==t?void 0:t.afterFiles)?a:[]).map(_buildmanifestplugin.processRoute),fallback:(null!=(r=null==t?void 0:t.fallback)?r:[]).map(_buildmanifestplugin.processRoute)},o=this.mergeBuildManifests(this.buildManifests.values()),l=(0,_path.join)(this.distDir,_constants.BUILD_MANIFEST),c=(0,_path.join)(this.distDir,"server",_constants.MIDDLEWARE_BUILD_MANIFEST+".js"),d=(0,_path.join)(this.distDir,"server",_constants.INTERCEPTION_ROUTE_REWRITE_MANIFEST+".js");(0,_requirecache.deleteCache)(l),(0,_requirecache.deleteCache)(c),(0,_requirecache.deleteCache)(d),await(0,_writeatomic.writeFileAtomic)(l,JSON.stringify(o,null,2)),await(0,_writeatomic.writeFileAtomic)(c,"globalThis.__BUILD_MANIFEST="+JSON.stringify(o)+";");const u=JSON.stringify(n.beforeFiles.filter(_generateinterceptionroutesrewrites.isInterceptionRouteRewrite));await(0,_writeatomic.writeFileAtomic)(d,"self.__INTERCEPTION_ROUTE_REWRITE_MANIFEST="+JSON.stringify(u)+";");const f=[...e.page.keys()];e.global.app&&f.push("/_app"),e.global.error&&f.push("/_error");const p=(0,_utils.getSortedRoutes)(f),_={__rewrites:(0,_buildmanifestplugin.normalizeRewritesForBuildManifest)(n),...Object.fromEntries(p.map((e=>[e,["static/chunks/pages"+("/"===e?"/index":e)+".js"]]))),sortedPages:p},h="self.__BUILD_MANIFEST = "+JSON.stringify(_)+";self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()";await(0,_writeatomic.writeFileAtomic)((0,_path.join)(this.distDir,"static",this.buildId,"_buildManifest.js"),h),await(0,_writeatomic.writeFileAtomic)((0,_path.join)(this.distDir,"static",this.buildId,"_ssgManifest.js"),_buildmanifestplugin.srcEmptySsgManifest)}async writeClientMiddlewareManifest(){var e;const t=this.mergeMiddlewareManifests(this.middlewareManifests.values()),i=(null==t||null==(e=t.middleware["/"])?void 0:e.matchers)||[],s=(0,_path.join)(this.distDir,"static",this.buildId,""+_constants.TURBOPACK_CLIENT_MIDDLEWARE_MANIFEST);(0,_requirecache.deleteCache)(s),await(0,_writeatomic.writeFileAtomic)(s,JSON.stringify(i,null,2))}async writeFallbackBuildManifest(){const e=this.mergeBuildManifests([this.buildManifests.get((0,_entrykey.getEntryKey)("pages","server","_app")),this.buildManifests.get((0,_entrykey.getEntryKey)("pages","server","_error"))].filter(Boolean)),t=(0,_path.join)(this.distDir,"fallback-"+_constants.BUILD_MANIFEST);(0,_requirecache.deleteCache)(t),await(0,_writeatomic.writeFileAtomic)(t,JSON.stringify(e,null,2))}async loadFontManifest(e,t){void 0===t&&(t="pages"),this.fontManifests.set((0,_entrykey.getEntryKey)(t,"server",e),await readPartialManifest(this.distDir,_constants.NEXT_FONT_MANIFEST+".json",e,t))}mergeFontManifests(e){const t={app:{},appUsingSizeAdjust:!1,pages:{},pagesUsingSizeAdjust:!1};for(const i of e)Object.assign(t.app,i.app),Object.assign(t.pages,i.pages),t.appUsingSizeAdjust=t.appUsingSizeAdjust||i.appUsingSizeAdjust,t.pagesUsingSizeAdjust=t.pagesUsingSizeAdjust||i.pagesUsingSizeAdjust;return t}async writeNextFontManifest(){const e=this.mergeFontManifests(this.fontManifests.values()),t=JSON.stringify(e,null,2),i=(0,_path.join)(this.distDir,"server",_constants.NEXT_FONT_MANIFEST+".json"),s=(0,_path.join)(this.distDir,"server",_constants.NEXT_FONT_MANIFEST+".js");(0,_requirecache.deleteCache)(i),(0,_requirecache.deleteCache)(s),await(0,_writeatomic.writeFileAtomic)(i,t),await(0,_writeatomic.writeFileAtomic)(s,"self.__NEXT_FONT_MANIFEST="+JSON.stringify(t))}async loadMiddlewareManifest(e,t){this.middlewareManifests.set((0,_entrykey.getEntryKey)("middleware"===t||"instrumentation"===t?"root":t,"server",e),await readPartialManifest(this.distDir,_constants.MIDDLEWARE_MANIFEST,e,t))}getMiddlewareManifest(e){return this.middlewareManifests.get(e)}deleteMiddlewareManifest(e){return this.middlewareManifests.delete(e)}mergeMiddlewareManifests(e){const t={version:3,middleware:{},sortedMiddleware:[],functions:{}};let i;for(const s of e)Object.assign(t.functions,s.functions),Object.assign(t.middleware,s.middleware),s.instrumentation&&(i=s.instrumentation);const s=e=>{var t;return{...e,files:[...null!=(t=null==i?void 0:i.files)?t:[],...e.files]}};for(const e of Object.keys(t.middleware)){const i=t.middleware[e];t.middleware[e]=s(i)}for(const e of Object.keys(t.functions)){const i=t.functions[e];t.functions[e]=s(i)}for(const e of Object.values(t.functions).concat(Object.values(t.middleware)))for(const t of e.matchers)t.regexp||(t.regexp=(0,_pathtoregexp.pathToRegexp)(t.originalSource,[],{delimiter:"/",sensitive:!1,strict:!0}).source.replaceAll("\\/","/"));return t.sortedMiddleware=Object.keys(t.middleware),t}async writeMiddlewareManifest(){const e=this.mergeMiddlewareManifests(this.middlewareManifests.values());for(const t in e.middleware)e.middleware[t].matchers.forEach((e=>{if(!e.regexp.startsWith("^")){const t=(0,_trytoparsepath.tryToParsePath)(e.regexp);if(t.error||!t.regexStr)throw Object.defineProperty(new Error("Invalid source: "+e.regexp),"__NEXT_ERROR_CODE",{value:"E442",enumerable:!1,configurable:!0});e.regexp=t.regexStr}}));const t=(0,_path.join)(this.distDir,"server",_constants.MIDDLEWARE_MANIFEST);(0,_requirecache.deleteCache)(t),await(0,_writeatomic.writeFileAtomic)(t,JSON.stringify(e,null,2))}async loadPagesManifest(e){this.pagesManifests.set((0,_entrykey.getEntryKey)("pages","server",e),await readPartialManifest(this.distDir,_constants.PAGES_MANIFEST,e))}mergePagesManifests(e){const t={};for(const i of e)Object.assign(t,i);return t}async writePagesManifest(){const e=this.mergePagesManifests(this.pagesManifests.values()),t=(0,_path.join)(this.distDir,"server",_constants.PAGES_MANIFEST);(0,_requirecache.deleteCache)(t),await(0,_writeatomic.writeFileAtomic)(t,JSON.stringify(e,null,2))}async writeManifests(e){let{devRewrites:t,productionRewrites:i,entrypoints:s}=e;await this.writeActionManifest(),await this.writeAppBuildManifest(),await this.writeAppPathsManifest(),await this.writeBuildManifest(s,t,i),await this.writeFallbackBuildManifest(),await this.writeMiddlewareManifest(),await this.writeClientMiddlewareManifest(),await this.writeNextFontManifest(),await this.writePagesManifest(),null!=process.env.TURBOPACK_STATS&&await this.writeWebpackStats()}constructor({distDir:e,buildId:t,encryptionKey:i}){this.actionManifests=new Map,this.appBuildManifests=new Map,this.appPathsManifests=new Map,this.buildManifests=new Map,this.fontManifests=new Map,this.middlewareManifests=new Map,this.pagesManifests=new Map,this.webpackStats=new Map,this.distDir=e,this.buildId=t,this.encryptionKey=i}}