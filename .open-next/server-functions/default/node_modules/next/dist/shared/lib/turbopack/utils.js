"use strict";function _export(e,r){for(var n in r)Object.defineProperty(e,n,{enumerable:!0,get:r[n]})}Object.defineProperty(exports,"__esModule",{value:!0}),_export(exports,{ModuleBuildError:function(){return ModuleBuildError},TurbopackInternalError:function(){return TurbopackInternalError},formatIssue:function(){return formatIssue},getIssueKey:function(){return getIssueKey},getTurbopackJsConfig:function(){return getTurbopackJsConfig},isPersistentCachingEnabled:function(){return isPersistentCachingEnabled},isRelevantWarning:function(){return isRelevantWarning},isWellKnownError:function(){return isWellKnownError},processIssues:function(){return processIssues},renderStyledStringToErrorAnsi:function(){return renderStyledStringToErrorAnsi}});const _interop_require_default=require("@swc/helpers/_/_interop_require_default"),_interop_require_wildcard=require("@swc/helpers/_/_interop_require_wildcard"),_picocolors=require("../../../lib/picocolors"),_isinternal=_interop_require_default._(require("../is-internal")),_magicidentifier=require("../magic-identifier"),_log=_interop_require_wildcard._(require("../../../build/output/log")),_loadjsconfig=_interop_require_default._(require("../../../build/load-jsconfig"));class ModuleBuildError extends Error{constructor(...e){super(...e),this.name="ModuleBuildError"}}class TurbopackInternalError extends Error{constructor(e){super(e.message),this.name="TurbopackInternalError",this.stack=e.stack}}function isWellKnownError(e){const{title:r}=e,n=renderStyledStringToErrorAnsi(r);return!(!n.includes("Module not found")&&!n.includes("Unknown module type"))}function getIssueKey(e){return e.severity+"-"+e.filePath+"-"+JSON.stringify(e.title)+"-"+JSON.stringify(e.description)}async function getTurbopackJsConfig(e,r){const{jsConfig:n}=await(0,_loadjsconfig.default)(e,r);return null!=n?n:{compilerOptions:{}}}function processIssues(e,r,n,t,i){const o=new Map;e.set(r,o);const s=new Set;for(const e of n.issues){if("error"!==e.severity&&"fatal"!==e.severity&&"warning"!==e.severity)continue;const r=getIssueKey(e);if(o.set(r,e),"warning"!==e.severity)if(t){const r=formatIssue(e);s.add(r)}else if(i&&isWellKnownError(e)){const r=formatIssue(e);_log.error(r)}}if(s.size&&t)throw Object.defineProperty(new ModuleBuildError([...s].join("\n\n")),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0})}function formatIssue(e){const{filePath:r,title:n,description:t,source:i}=e;let{documentationLink:o}=e,s=renderStyledStringToErrorAnsi(n).replace(/\n/g,"\n    ");s.includes("Module not found")&&(o="https://nextjs.org/docs/messages/module-not-found");let u=r.replace("[project]/","./").replaceAll("/./","/").replace("\\\\?\\",""),l="";if(i&&i.range){const{start:e}=i.range;l=u+":"+(e.line+1)+":"+(e.column+1)+"\n"+s}else l=u?u+"\n"+s:s;if(l+="\n",(null==i?void 0:i.range)&&i.source.content&&!(0,_isinternal.default)(r)){const{start:e,end:r}=i.range,{codeFrameColumns:n}=require("next/dist/compiled/babel/code-frame");l+=n(i.source.content,{start:{line:e.line+1,column:e.column+1},end:{line:r.line+1,column:r.column+1}},{forceColor:!0}).trim()+"\n\n"}return t&&(l+=renderStyledStringToErrorAnsi(t)+"\n\n"),o&&(l+=o+"\n\n"),l}function isRelevantWarning(e){return"warning"===e.severity&&!isNodeModulesIssue(e)}function isNodeModulesIssue(e){return("warning"!==e.severity||"config"!==e.stage||!renderStyledStringToErrorAnsi(e.title).includes("can't be external"))&&("warning"===e.severity&&(null!==e.filePath.match(/^(?:.*[\\/])?node_modules(?:[\\/].*)?$/)||e.filePath.startsWith("[project]/packages/next/")))}function renderStyledStringToErrorAnsi(e){function r(e){return e.replaceAll(_magicidentifier.MAGIC_IDENTIFIER_REGEX,(e=>{try{return(0,_picocolors.magenta)("{"+(0,_magicidentifier.decodeMagicIdentifier)(e)+"}")}catch(r){return(0,_picocolors.magenta)("{"+e+" (decoding failed: "+r+")}")}}))}switch(e.type){case"text":return r(e.value);case"strong":return(0,_picocolors.bold)((0,_picocolors.red)(r(e.value)));case"code":return(0,_picocolors.green)(r(e.value));case"line":return e.value.map(renderStyledStringToErrorAnsi).join("");case"stack":return e.value.map(renderStyledStringToErrorAnsi).join("\n");default:throw Object.defineProperty(new Error("Unknown StyledString type",e),"__NEXT_ERROR_CODE",{value:"E138",enumerable:!1,configurable:!0})}}function isPersistentCachingEnabled(e){var r;return(null==(r=e.experimental.turbo)?void 0:r.unstablePersistentCaching)||!1}