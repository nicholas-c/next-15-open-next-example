"use strict";const{Writable:Writable}=require("stream"),{getDecoder:getDecoder}=require("../utils.js");class URLEncoded extends Writable{constructor(t){super({autoDestroy:!0,emitClose:!0,highWaterMark:"number"==typeof t.highWaterMark?t.highWaterMark:void 0});let e=t.defCharset||"utf8";t.conType.params&&"string"==typeof t.conType.params.charset&&(e=t.conType.params.charset),this.charset=e;const s=t.limits;this.fieldSizeLimit=s&&"number"==typeof s.fieldSize?s.fieldSize:1048576,this.fieldsLimit=s&&"number"==typeof s.fields?s.fields:1/0,this.fieldNameSizeLimit=s&&"number"==typeof s.fieldNameSize?s.fieldNameSize:100,this._inKey=!0,this._keyTrunc=!1,this._valTrunc=!1,this._bytesKey=0,this._bytesVal=0,this._fields=0,this._key="",this._val="",this._byte=-2,this._lastPos=0,this._encode=0,this._decoder=getDecoder(e)}static detect(t){return"application"===t.type&&"x-www-form-urlencoded"===t.subtype}_write(t,e,s){if(this._fields>=this.fieldsLimit)return s();let i=0;const h=t.length;if(this._lastPos=0,-2!==this._byte){if(i=readPctEnc(this,t,i,h),-1===i)return s(new Error("Malformed urlencoded form"));if(i>=h)return s();this._inKey?++this._bytesKey:++this._bytesVal}t:for(;i<h;)if(this._inKey){for(i=skipKeyBytes(this,t,i,h);i<h;){switch(t[i]){case 61:this._lastPos<i&&(this._key+=t.latin1Slice(this._lastPos,i)),this._lastPos=++i,this._key=this._decoder(this._key,this._encode),this._encode=0,this._inKey=!1;continue t;case 38:if(this._lastPos<i&&(this._key+=t.latin1Slice(this._lastPos,i)),this._lastPos=++i,this._key=this._decoder(this._key,this._encode),this._encode=0,this._bytesKey>0&&this.emit("field",this._key,"",{nameTruncated:this._keyTrunc,valueTruncated:!1,encoding:this.charset,mimeType:"text/plain"}),this._key="",this._val="",this._keyTrunc=!1,this._valTrunc=!1,this._bytesKey=0,this._bytesVal=0,++this._fields>=this.fieldsLimit)return this.emit("fieldsLimit"),s();continue;case 43:this._lastPos<i&&(this._key+=t.latin1Slice(this._lastPos,i)),this._key+=" ",this._lastPos=i+1;break;case 37:if(0===this._encode&&(this._encode=1),this._lastPos<i&&(this._key+=t.latin1Slice(this._lastPos,i)),this._lastPos=i+1,this._byte=-1,i=readPctEnc(this,t,i+1,h),-1===i)return s(new Error("Malformed urlencoded form"));if(i>=h)return s();++this._bytesKey,i=skipKeyBytes(this,t,i,h);continue}++i,++this._bytesKey,i=skipKeyBytes(this,t,i,h)}this._lastPos<i&&(this._key+=t.latin1Slice(this._lastPos,i))}else{for(i=skipValBytes(this,t,i,h);i<h;){switch(t[i]){case 38:if(this._lastPos<i&&(this._val+=t.latin1Slice(this._lastPos,i)),this._lastPos=++i,this._inKey=!0,this._val=this._decoder(this._val,this._encode),this._encode=0,(this._bytesKey>0||this._bytesVal>0)&&this.emit("field",this._key,this._val,{nameTruncated:this._keyTrunc,valueTruncated:this._valTrunc,encoding:this.charset,mimeType:"text/plain"}),this._key="",this._val="",this._keyTrunc=!1,this._valTrunc=!1,this._bytesKey=0,this._bytesVal=0,++this._fields>=this.fieldsLimit)return this.emit("fieldsLimit"),s();continue t;case 43:this._lastPos<i&&(this._val+=t.latin1Slice(this._lastPos,i)),this._val+=" ",this._lastPos=i+1;break;case 37:if(0===this._encode&&(this._encode=1),this._lastPos<i&&(this._val+=t.latin1Slice(this._lastPos,i)),this._lastPos=i+1,this._byte=-1,i=readPctEnc(this,t,i+1,h),-1===i)return s(new Error("Malformed urlencoded form"));if(i>=h)return s();++this._bytesVal,i=skipValBytes(this,t,i,h);continue}++i,++this._bytesVal,i=skipValBytes(this,t,i,h)}this._lastPos<i&&(this._val+=t.latin1Slice(this._lastPos,i))}s()}_final(t){if(-2!==this._byte)return t(new Error("Malformed urlencoded form"));(!this._inKey||this._bytesKey>0||this._bytesVal>0)&&(this._inKey?this._key=this._decoder(this._key,this._encode):this._val=this._decoder(this._val,this._encode),this.emit("field",this._key,this._val,{nameTruncated:this._keyTrunc,valueTruncated:this._valTrunc,encoding:this.charset,mimeType:"text/plain"})),t()}}function readPctEnc(t,e,s,i){if(s>=i)return i;if(-1===t._byte){const h=HEX_VALUES[e[s++]];if(-1===h)return-1;if(h>=8&&(t._encode=2),s<i){const i=HEX_VALUES[e[s++]];if(-1===i)return-1;t._inKey?t._key+=String.fromCharCode((h<<4)+i):t._val+=String.fromCharCode((h<<4)+i),t._byte=-2,t._lastPos=s}else t._byte=h}else{const i=HEX_VALUES[e[s++]];if(-1===i)return-1;t._inKey?t._key+=String.fromCharCode((t._byte<<4)+i):t._val+=String.fromCharCode((t._byte<<4)+i),t._byte=-2,t._lastPos=s}return s}function skipKeyBytes(t,e,s,i){if(t._bytesKey>t.fieldNameSizeLimit){for(t._keyTrunc||t._lastPos<s&&(t._key+=e.latin1Slice(t._lastPos,s-1)),t._keyTrunc=!0;s<i;++s){const i=e[s];if(61===i||38===i)break;++t._bytesKey}t._lastPos=s}return s}function skipValBytes(t,e,s,i){if(t._bytesVal>t.fieldSizeLimit){for(t._valTrunc||t._lastPos<s&&(t._val+=e.latin1Slice(t._lastPos,s-1)),t._valTrunc=!0;s<i&&38!==e[s];++s)++t._bytesVal;t._lastPos=s}return s}const HEX_VALUES=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];module.exports=URLEncoded;