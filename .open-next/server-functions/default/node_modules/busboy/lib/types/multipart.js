"use strict";const{Readable:Readable,Writable:Writable}=require("stream"),StreamSearch=require("streamsearch"),{basename:basename,convertToUTF8:convertToUTF8,getDecoder:getDecoder,parseContentType:parseContentType,parseDisposition:parseDisposition}=require("../utils.js"),BUF_CRLF=Buffer.from("\r\n"),BUF_CR=Buffer.from("\r"),BUF_DASH=Buffer.from("-");function noop(){}const MAX_HEADER_PAIRS=2e3,MAX_HEADER_SIZE=16384,HPARSER_NAME=0,HPARSER_PRE_OWS=1,HPARSER_VALUE=2;class HeaderParser{constructor(e){this.header=Object.create(null),this.pairCount=0,this.byteCount=0,this.state=HPARSER_NAME,this.name="",this.value="",this.crlf=0,this.cb=e}reset(){this.header=Object.create(null),this.pairCount=0,this.byteCount=0,this.state=HPARSER_NAME,this.name="",this.value="",this.crlf=0}push(e,t,i){let r=t;for(;t<i;)switch(this.state){case HPARSER_NAME:{let s=!1;for(;t<i;++t){if(this.byteCount===MAX_HEADER_SIZE)return-1;++this.byteCount;const i=e[t];if(1!==TOKEN[i]){if(58!==i)return-1;if(this.name+=e.latin1Slice(r,t),0===this.name.length)return-1;++t,s=!0,this.state=HPARSER_PRE_OWS;break}}if(!s){this.name+=e.latin1Slice(r,t);break}}case HPARSER_PRE_OWS:{let s=!1;for(;t<i;++t){if(this.byteCount===MAX_HEADER_SIZE)return-1;++this.byteCount;const i=e[t];if(32!==i&&9!==i){r=t,s=!0,this.state=HPARSER_VALUE;break}}if(!s)break}case HPARSER_VALUE:switch(this.crlf){case 0:for(;t<i;++t){if(this.byteCount===MAX_HEADER_SIZE)return-1;++this.byteCount;const i=e[t];if(1!==FIELD_VCHAR[i]){if(13!==i)return-1;++this.crlf;break}}this.value+=e.latin1Slice(r,t++);break;case 1:if(this.byteCount===MAX_HEADER_SIZE)return-1;if(++this.byteCount,10!==e[t++])return-1;++this.crlf;break;case 2:{if(this.byteCount===MAX_HEADER_SIZE)return-1;++this.byteCount;const i=e[t];32===i||9===i?(r=t,this.crlf=0):(++this.pairCount<MAX_HEADER_PAIRS&&(this.name=this.name.toLowerCase(),void 0===this.header[this.name]?this.header[this.name]=[this.value]:this.header[this.name].push(this.value)),13===i?(++this.crlf,++t):(r=t,this.crlf=0,this.state=HPARSER_NAME,this.name="",this.value=""));break}case 3:{if(this.byteCount===MAX_HEADER_SIZE)return-1;if(++this.byteCount,10!==e[t++])return-1;const i=this.header;return this.reset(),this.cb(i),t}}}return t}}class FileStream extends Readable{constructor(e,t){super(e),this.truncated=!1,this._readcb=null,this.once("end",(()=>{if(this._read(),0==--t._fileEndsLeft&&t._finalcb){const e=t._finalcb;t._finalcb=null,process.nextTick(e)}}))}_read(e){const t=this._readcb;t&&(this._readcb=null,t())}}const ignoreData={push:(e,t)=>{},destroy:()=>{}};function callAndUnsetCb(e,t){const i=e._writecb;e._writecb=null,t?e.destroy(t):i&&i()}function nullDecoder(e,t){return e}class Multipart extends Writable{constructor(e){if(super({autoDestroy:!0,emitClose:!0,highWaterMark:"number"==typeof e.highWaterMark?e.highWaterMark:void 0}),!e.conType.params||"string"!=typeof e.conType.params.boundary)throw new Error("Multipart: Boundary not found");const t=e.conType.params.boundary,i="string"==typeof e.defParamCharset&&e.defParamCharset?getDecoder(e.defParamCharset):nullDecoder,r=e.defCharset||"utf8",s=e.preservePath,a={autoDestroy:!0,emitClose:!0,highWaterMark:"number"==typeof e.fileHwm?e.fileHwm:void 0},n=e.limits,o=n&&"number"==typeof n.fieldSize?n.fieldSize:1048576,h=n&&"number"==typeof n.fileSize?n.fileSize:1/0,l=n&&"number"==typeof n.files?n.files:1/0,f=n&&"number"==typeof n.fields?n.fields:1/0,c=n&&"number"==typeof n.parts?n.parts:1/0;let u=-1,m=0,_=0,p=!1;this._fileEndsLeft=0,this._fileStream=void 0,this._complete=!1;let d,b,E,S,y,A=0,R=0,C=!1,w=!1,v=!1;this._hparser=null;const H=new HeaderParser((e=>{let t;if(this._hparser=null,p=!1,S="text/plain",b=r,E="7bit",y=void 0,C=!1,!e["content-disposition"])return void(p=!0);const n=parseDisposition(e["content-disposition"][0],i);if(n&&"form-data"===n.type){if(n.params&&(n.params.name&&(y=n.params.name),n.params["filename*"]?t=n.params["filename*"]:n.params.filename&&(t=n.params.filename),void 0===t||s||(t=basename(t))),e["content-type"]){const t=parseContentType(e["content-type"][0]);t&&(S=`${t.type}/${t.subtype}`,t.params&&"string"==typeof t.params.charset&&(b=t.params.charset.toLowerCase()))}if(e["content-transfer-encoding"]&&(E=e["content-transfer-encoding"][0].toLowerCase()),"application/octet-stream"===S||void 0!==t){if(_===l)return w||(w=!0,this.emit("filesLimit")),void(p=!0);if(++_,0===this.listenerCount("file"))return void(p=!0);A=0,this._fileStream=new FileStream(a,this),++this._fileEndsLeft,this.emit("file",y,this._fileStream,{filename:t,encoding:E,mimeType:S})}else{if(m===f)return v||(v=!0,this.emit("fieldsLimit")),void(p=!0);if(++m,0===this.listenerCount("field"))return void(p=!0);d=[],R=0}}else p=!0}));let D=0;const k=(e,t,i,r,s)=>{e:for(;t;){if(null!==this._hparser){const e=this._hparser.push(t,i,r);if(-1===e){this._hparser=null,H.reset(),this.emit("error",new Error("Malformed part header"));break}i=e}if(i===r)break;if(0!==D){if(1===D){switch(t[i]){case 45:D=2,++i;break;case 13:D=3,++i;break;default:D=0}if(i===r)return}if(2===D){if(D=0,45===t[i])return this._complete=!0,void(this._bparser=ignoreData);const e=this._writecb;this._writecb=noop,k(!1,BUF_DASH,0,1,!1),this._writecb=e}else if(3===D){if(D=0,10===t[i]){if(++i,u>=c)break;if(this._hparser=H,i===r)break;continue e}{const e=this._writecb;this._writecb=noop,k(!1,BUF_CR,0,1,!1),this._writecb=e}}}if(!p)if(this._fileStream){let e;const a=Math.min(r-i,h-A);s?e=t.slice(i,i+a):(e=Buffer.allocUnsafe(a),t.copy(e,0,i,i+a)),A+=e.length,A===h?(e.length>0&&this._fileStream.push(e),this._fileStream.emit("limit"),this._fileStream.truncated=!0,p=!0):this._fileStream.push(e)||(this._writecb&&(this._fileStream._readcb=this._writecb),this._writecb=null)}else if(void 0!==d){let e;const a=Math.min(r-i,o-R);s?e=t.slice(i,i+a):(e=Buffer.allocUnsafe(a),t.copy(e,0,i,i+a)),R+=a,d.push(e),R===o&&(p=!0,C=!0)}break}if(e){if(D=1,this._fileStream)this._fileStream.push(null),this._fileStream=null;else if(void 0!==d){let e;switch(d.length){case 0:e="";break;case 1:e=convertToUTF8(d[0],b,0);break;default:e=convertToUTF8(Buffer.concat(d,R),b,0)}d=void 0,R=0,this.emit("field",y,e,{nameTruncated:!1,valueTruncated:C,encoding:E,mimeType:S})}++u===c&&this.emit("partsLimit")}};this._bparser=new StreamSearch(`\r\n--${t}`,k),this._writecb=null,this._finalcb=null,this.write(BUF_CRLF)}static detect(e){return"multipart"===e.type&&"form-data"===e.subtype}_write(e,t,i){this._writecb=i,this._bparser.push(e,0),this._writecb&&callAndUnsetCb(this)}_destroy(e,t){this._hparser=null,this._bparser=ignoreData,e||(e=checkEndState(this));const i=this._fileStream;i&&(this._fileStream=null,i.destroy(e)),t(e)}_final(e){if(this._bparser.destroy(),!this._complete)return e(new Error("Unexpected end of form"));this._fileEndsLeft?this._finalcb=finalcb.bind(null,this,e):finalcb(this,e)}}function finalcb(e,t,i){if(i)return t(i);t(i=checkEndState(e))}function checkEndState(e){if(e._hparser)return new Error("Malformed part header");const t=e._fileStream;return t&&(e._fileStream=null,t.destroy(new Error("Unexpected end of file"))),e._complete?void 0:new Error("Unexpected end of form")}const TOKEN=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],FIELD_VCHAR=[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];module.exports=Multipart;